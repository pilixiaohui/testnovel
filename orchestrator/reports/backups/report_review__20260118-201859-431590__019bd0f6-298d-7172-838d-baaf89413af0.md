已阅读审阅行为规范  
iteration: 1  

结论：PASS  
阻塞：无  

## 证据（可复现命令 + 关键输出摘要）
- 文档行数（用于评估阅读/抽取策略）  
  - 命令：`wc -l doc/backup_old/graph_refactor_final_plan.md doc/长篇小说生成系统设计.md doc/topone接口文档.md`  
  - 输出：`2198 / 475 / 92`
- Topone 集成位置（入口与关键文件）  
  - 命令：`rg -n "Topone|TOPONE" -S project/backend/app project/backend/tests | head -n 50`  
  - 命中示例：`project/backend/app/main.py:955`、`project/backend/app/services/topone_client.py:17`、`project/backend/app/llm/topone_gateway.py:70`
- Kùzu 使用证据（存储实现仍为 Kùzu）  
  - 命令：`rg -n "kuzu" -S project/backend/app project/backend/tests | head -n 50`  
  - 命中示例：`project/backend/app/storage/graph.py:12`、`project/backend/app/main.py:292`
- 最小验证：后端测试全量通过  
  - 命令（在 `project/backend` 下）：`python -m pytest -q`  
  - 输出摘要：`93 passed, 3 warnings in 13.48s`

## 文档取证（3 份）与“project 重构”映射
### 1) `doc/长篇小说生成系统设计.md`
**关键信息（摘取）**
- Phase 1 范围：仅后端，聚焦 Snowflake 编排 + Memgraph 图存储，交付 REST API（`doc/长篇小说生成系统设计.md:7`、`doc/长篇小说生成系统设计.md:9`）。  
- 重构方向：以 Memgraph 替代 Kùzu，目标能力包含“高并发、时序记忆、完整版本控制”等（`doc/长篇小说生成系统设计.md:5`、`doc/长篇小说生成系统设计.md:11`）。  
- 数据层关键机制：时序边 `start_scene_seq/end_scene_seq` + `WorldSnapshot` 快照（`doc/长篇小说生成系统设计.md:68`、`doc/长篇小说生成系统设计.md:115`、`doc/长篇小说生成系统设计.md:134`）。  
- 云端集成：Topone API（Gemini Flash）用于实体消解/状态提取（`doc/长篇小说生成系统设计.md:197`、`doc/长篇小说生成系统设计.md:383`）。

**与现有代码映射**
- Snowflake 领域模型：`SnowflakeRoot/CharacterSheet/SceneNode` 已在 `project/backend/app/models.py:11`、`project/backend/app/models.py:22`、`project/backend/app/models.py:40` 定义。  
- Snowflake 编排：`SnowflakeManager` 在 `project/backend/app/logic/snowflake_manager.py:25`，Step4 会持久化到图存储（`project/backend/app/logic/snowflake_manager.py:99`）。  
- 入口 API：FastAPI 在 `project/backend/app/main.py:1`，Snowflake step1-4 路由在 `project/backend/app/main.py:334`/`:326`/`:341`/`:348`。  
- 设计文档要求的 Memgraph/时序边/快照：当前代码未出现 Memgraph/GQLAlchemy（搜索无命中），存储仍为 Kùzu（见下文与 `project/backend/app/storage/graph.py:12`）。

### 2) `doc/backup_old/graph_refactor_final_plan.md`
**关键信息（摘取）**
- 目标：Kùzu（嵌入式）→ Memgraph（高并发分布式），补齐“缺失的 72% 核心功能”（`doc/backup_old/graph_refactor_final_plan.md:14`）。  
- 现状评估：功能完整性 28%（`doc/backup_old/graph_refactor_final_plan.md:18`）。  
- Kùzu 架构限制与用户体验差异（`doc/backup_old/graph_refactor_final_plan.md:196`）。  
- 强调 TDD 分层测试与实施节奏（`doc/backup_old/graph_refactor_final_plan.md:1090`、`doc/backup_old/graph_refactor_final_plan.md:1605`）。

**与现有代码映射/偏差点**
- 计划文档指出“语义状态覆盖写导致历史丢失”，现代码确实为覆盖写：`apply_semantic_states_patch` 读-改-写 JSON（`project/backend/app/storage/graph.py:2424`）。  
- 计划文档指出“logic_check 依赖前端传入 world_state 容易过期”，现 `logic_check_endpoint` 仍直接把请求 payload 交给网关（`project/backend/app/main.py:1012`），未从图谱构建 world_state。  
- 文档部分代码片段存在“文档漂移”：例如文档内提到 `apply_local_scene_fix` 为空/占位，但现已实现并会批量 commit（`project/backend/app/storage/graph.py:2799`）。

### 3) `doc/topone接口文档.md`
**接口要点（摘取）**
- Endpoint：`/v1beta/models/gemini-3-pro-preview-11-2025:generateContent`（`doc/topone接口文档.md:12`）。  
- 认证：query 参数 `key`（`doc/topone接口文档.md:19`）。  
- Server：`https://api.toponeapi.top`（`doc/topone接口文档.md:88`）。

**与现有代码映射**
- Base URL 默认值：`project/backend/app/config.py:29` 为 `https://api.toponeapi.top`。  
- 请求路径与 key 传参：`project/backend/app/services/topone_client.py:106`、`project/backend/app/services/topone_client.py:107`。  
- 原生透传 API：`/api/v1/llm/topone/generate` 在 `project/backend/app/main.py:955`。

## 代码现状取证：project 相关模块清单（入口/领域/集成/基础设施）
**入口（API/CLI）**
- FastAPI 入口：`project/backend/app/main.py:1`  
- 存储迁移 CLI：`project/backend/app/storage/migrations.py:1`  
- 脚本入口：`project/scripts/graph_health_check.py`、`project/scripts/cyberpunk_integration_test.py` 等（`project/scripts/`）

**领域（Domain / Workflow）**
- 雪花编排：`project/backend/app/logic/snowflake_manager.py:25`  
- 领域模型：`project/backend/app/models.py:11`

**集成（Integration）**
- Topone 客户端：`project/backend/app/services/topone_client.py:17`  
- Topone 网关（结构化 JSON→Pydantic 快速失败）：`project/backend/app/llm/topone_gateway.py:65`  
- 本地/真实 LLM 引擎：`project/backend/app/services/llm_engine.py:17`

**基础设施（Storage）**
- Kùzu 图存储：`project/backend/app/storage/graph.py:12`（`GraphStorage` 单文件 2998 行，见下文问题）

## 至少 1 条“入口→核心逻辑”调用链证据
### 调用链 A：Snowflake step4 生成场景并落库
- API 入口：`project/backend/app/main.py:348` (`/api/v1/snowflake/step4`)  
- 依赖注入：`project/backend/app/main.py:301` (`get_snowflake_manager` 注入 `GraphStorage`)  
- 业务编排：`project/backend/app/logic/snowflake_manager.py:69` (`execute_step_4_scenes`)  
- 持久化调用：`project/backend/app/logic/snowflake_manager.py:99` (`storage.save_snowflake`)  
- 核心存储实现：`project/backend/app/storage/graph.py:1124` (`save_snowflake` 创建 Root/Branch/Commit 等)

### 调用链 B：Topone 原生接口透传（与接口文档对齐）
- API 入口：`project/backend/app/main.py:955` (`/api/v1/llm/topone/generate`)  
- 客户端请求：`project/backend/app/services/topone_client.py:106`、`project/backend/app/services/topone_client.py:107`  
- Base URL 默认值：`project/backend/app/config.py:29`  
- 接口文档：`doc/topone接口文档.md:12`、`doc/topone接口文档.md:19`、`doc/topone接口文档.md:88`

## 发现（结构性问题，按严重度降序，<=10）
1) P0 设计要求“Memgraph + 时序边 + 快照”与现实现“Kùzu + JSON 覆盖写”冲突  
- 证据：设计目标（`doc/长篇小说生成系统设计.md:5`、`doc/长篇小说生成系统设计.md:68`），现状（`project/backend/app/storage/graph.py:12`、`project/backend/app/storage/graph.py:2424`）  
- 影响：无法时间旅行查询/一致性校验；重构路线与代码现实不一致，后续实现成本不可控  
- 建议：先抽象存储接口并引入 Memgraph 并行实现（见“重构拆解建议”）

2) P0 `logic_check` 仍使用请求体携带的 `world_state`，未从图谱构建真实状态  
- 证据：`project/backend/app/main.py:1012` 直接 `gateway.logic_check(normalized_payload)`；未见基于 `scene_id` 的状态查询  
- 影响：逻辑检察官推理基于过期/不真实状态，违背文档“一致性检查”目标  
- 建议：新增 `WorldStateService`（或等价服务）从图存储构建 world_state，并将请求体 world_state 变为“只读调试字段”或直接移除（快速失败）

3) P1 `GraphStorage` 单体过大（2998 行），职责混杂（schema/分支/commit/场景/状态/diff/gc）  
- 证据：`wc -l project/backend/app/storage/graph.py` → 2998  
- 影响：SRP 违背，导致迁移 Memgraph、替换存储、补齐时序边等工作难以增量推进  
- 建议：按“结构子图/叙事子图/运维迁移”拆分模块；对外只暴露接口（DIP）

4) P1 FastAPI `main.py` 体积大（1177 行），API/DTO/业务/工具函数混在一起  
- 证据：`wc -l project/backend/app/main.py` → 1177；路由密集（示例：`project/backend/app/main.py:326` 起大量 endpoints）  
- 影响：难以测试与复用；重构时容易引入回归  
- 建议：拆分 `api/routes/*` + `api/deps.py` + `services/*`（SRP）

5) P1 Entity/semantic_states 与分支隔离不一致：多个读写路径强制 `entity_branch_id = DEFAULT_BRANCH_ID`  
- 证据：`project/backend/app/storage/graph.py:2325`（以及同类多处）  
- 影响：分支世界观差异难表达，潜在跨分支“状态串味”；与设计文档“branch_id 隔离”目标不一致（`doc/长篇小说生成系统设计.md:246`）  
- 建议：状态与分支绑定（更推荐：按文档改为时序边并携带 branch_id）

6) P2 文档与实现存在漂移（计划文档部分片段与现状不一致）  
- 证据：计划文档提及 `apply_local_scene_fix` 未实现，但现实现存在（`project/backend/app/storage/graph.py:2799`）  
- 影响：按文档拆解任务容易误判工作量/风险  
- 建议：后续以“代码真实能力”为基线，更新文档或在 dev_plan 标注“文档漂移点”

7) P2 FastAPI `on_event("startup")` deprecation（非功能性问题）  
- 证据：pytest warnings 指向 `project/backend/app/main.py:48`  
- 影响：未来 FastAPI 升级可能需要调整生命周期写法  
- 建议：重构 API 层时顺手迁到 lifespan（不阻塞当前重构）

## 可执行的重构拆解建议（面向 DEV/TEST，可增量验证）
目标：在不大爆炸的前提下，把“存储可替换（DIP）+ 时序状态能力补齐 + Topone 集成可契约验证”推进到可交付。

1) 先补“契约/行为”测试（红）再拆（绿）  
- 新增测试优先级：  
  - `logic_check` 在提供 `root_id/branch_id/scene_id` 时，必须从图谱构建 world_state（当前应红）  
  - 分支隔离：同一实体在不同 branch 的状态不应互相污染（当前应红）  
  - 时序回溯：同一实体在不同 scene_seq 的状态可查询（当前应红，待 Memgraph 实现）  
- 现有测试基础良好（`python -m pytest -q` 全绿），适合增量加测

2) 引入存储抽象（GraphRepository/GraphPort），把 `GraphStorage` 变成 Kùzu Adapter  
- 目标：业务层只依赖接口，不依赖 Kùzu（DIP）  
- 验证：接口单测 + 现有 API 测试继续全绿

3) 拆分 `GraphStorage`（SRP）  
- 建议拆分为：`structure_repo`（root/branch/commit）、`narrative_repo`（entity/state/relations）、`scene_repo`（scene origin/version/context/diff）、`ops_repo`（gc/migrations）  
- 验证：逐步迁移调用点；每次迁移跑 `pytest`

4) 新增 `WorldStateService`/`LogicCheckService`，明确“从图谱取状态”责任边界  
- API 层只做：参数校验 + 调用 service + 返回  
- Service 层做：world_state 构建/impact_level 应用/dirty 传播

5) 并行落地 Memgraph（按文档 dual-subgraph + temporal edge + snapshot）  
- 新增 `MemgraphStorage` 实现同一接口；先做最小闭环：  
  - 写入/读取 entity 状态（时序边）  
  - 按 scene_seq 查询 world_state  
  - 每 N 场景生成 snapshot（N 可配置但不要兜底）  
- 验证：新增 integration tests（可先 local docker-compose），再切换默认 storage

6) Topone 集成层保持“薄”：Client 只负责 HTTP；Gateway 只负责“结构化输出 + 校验（快速失败）”  
- 现状已接近；建议增加契约测试覆盖错误响应/超时语义（不引入兜底）

## 进度核实（对照 `orchestrator/memory/dev_plan.md`）
- M0-T1（status: DONE）核实结果：PASS  
  - 证据：dev_plan 存在且字段齐全（`orchestrator/memory/dev_plan.md:1`、`orchestrator/memory/dev_plan.md:15`）；project_history 有 Iteration 1 留痕（`orchestrator/memory/project_history.md:8`）
- M0-T2（status: DOING）核实结果：PASS（本报告已满足验收口径）  
  - 证据：本报告包含可复现命令与输出摘要（见“证据”），并逐条核实 dev_plan
- M1-T1（status: DOING）核实结果：PASS  
  - 证据：已覆盖三份文档要点并映射到代码（见“文档取证”章节，含 `doc/*:line` 与 `project/backend/*:line`）
- M1-T2（status: DOING）核实结果：PASS  
  - 证据：已给出模块清单与至少 1 条调用链（见“代码现状取证/调用链”章节）
- M1-T3（status: TODO）核实结果：PASS（本报告已给出可执行拆解）  
  - 证据：见“可执行的重构拆解建议”章节（含分步迁移与验证方式）

## 建议更新 dev_plan 的具体文本（可直接复制）
建议 MAIN 将以下块合入 `orchestrator/memory/dev_plan.md`（保持“几十条以内”）：

```md
### M0-T1: 建立 dev_plan 状态机
- status: VERIFIED
- acceptance:
- `orchestrator/memory/dev_plan.md` 存在并遵循固定字段
- 每轮在 `orchestrator/memory/project_history.md` 留痕（说明改了什么/为什么）
- evidence:
- Iteration 1 REVIEW: `orchestrator/memory/dev_plan.md` 存在（orchestrator/memory/dev_plan.md:1）；`orchestrator/memory/project_history.md` 含 `## Iteration 1:`（orchestrator/memory/project_history.md:8）

### M0-T2: 审阅代理输出可核实证据
- status: VERIFIED
- acceptance:
- `orchestrator/reports/report_review.md` 包含可复现的命令与关键输出摘要
- 进度核实：逐条对照 dev_plan 的任务给出 PASS/FAIL 与证据
- evidence:
- Iteration 1 REVIEW: `python -m pytest -q`（93 passed）；并提供 doc/code 的行号级证据与可复现 rg/wc 命令（见 report_review.md）

### M1-T1: 阅读关键文档并提炼重构目标/约束
- status: VERIFIED
- acceptance:
- 逐份阅读并提炼：术语/边界/流程/约束（含快速失败/禁止防御性编程）
- 明确与现有代码中 project 模块的映射点（文件/模块层面）
- evidence:
- Iteration 1 REVIEW: 设计文档 Phase1/存储目标（doc/长篇小说生成系统设计.md:7,9,11,68）↔ 代码入口与存储现状（project/backend/app/main.py:348,955；project/backend/app/storage/graph.py:12）
- Iteration 1 REVIEW: Topone 接口文档（doc/topone接口文档.md:12,19,88）↔ ToponeClient 实现（project/backend/app/services/topone_client.py:106,107；project/backend/app/config.py:29）

### M1-T2: 代码现状取证：定位 project 相关模块、入口与调用链
- status: VERIFIED
- acceptance:
- 给出 project 相关目录/包/模块清单（含入口点与主要依赖关系）
- 给出至少 1 条从入口到 project 核心逻辑的调用链证据
- 标注主要痛点并附定位证据
- evidence:
- Iteration 1 REVIEW: 调用链 Step4 落库（project/backend/app/main.py:348 → project/backend/app/logic/snowflake_manager.py:69,99 → project/backend/app/storage/graph.py:1124）
- Iteration 1 REVIEW: Topone 调用链（project/backend/app/main.py:955 → project/backend/app/services/topone_client.py:106,107）

### M1-T3: 输出可执行的重构拆解（面向 dev_plan 的任务颗粒）
- status: VERIFIED
- acceptance:
- 产出目标结构草图（目录/模块/职责边界）
- 产出迁移步骤（每步可独立验证）
- 定义可验证的验收标准（测试、接口兼容性、关键行为不回归）
- evidence:
- Iteration 1 REVIEW: report_review.md 给出“存储抽象→服务层→Memgraph 并行实现→迁移→删旧”的分步路线，并标注每步验证方式（pytest/契约测试/集成测试）
```

并建议补充/细化 M2/M3（仍控制总任务数）：

```md
## Milestone M2: Project 模块重构（实现）

### M2-T1: 存储层解耦（DIP）+ GraphStorage 拆分（SRP）
- status: TODO
- acceptance:
- 引入存储接口（GraphRepository/Port），业务层不直接依赖 Kùzu
- GraphStorage 拆分为按职责的子模块（结构/叙事/场景/运维），main.py 调用面收敛
- 现有 `python -m pytest -q` 全绿
- evidence:

### M2-T2: Memgraph 存储落地（Dual-subgraph + Temporal edge + Snapshot）
- status: TODO
- acceptance:
- 引入 Memgraph/GQLAlchemy 实现同一存储接口（不保留兜底路径，失败即失败）
- 支持：按 scene_seq 查询 world_state；时序边失效；快照生成与查询
- 新增集成测试（可 docker-compose）覆盖核心查询
- evidence:

### M2-T3: 逻辑检察官/状态流改造：从图谱构建 world_state（快速失败）
- status: TODO
- acceptance:
- `logic_check` 在提供 locator（root_id/branch_id/scene_id）时，world_state 必须来自图谱而非请求体
- impact_level 应用/dirty 传播逻辑归入 service 层，API 层仅做参数校验与编排
- 新增/更新测试先红后绿
- evidence:

## Milestone M3: 测试与验证

### M3-T1: 补齐关键单元/契约/集成测试（覆盖重构风险面）
- status: TODO
- acceptance:
- 新增测试覆盖：branch 隔离、时序回溯、logic_check 图谱取状态、Topone 错误语义契约
- CI 可复现运行（最少 pytest；如引入 Memgraph 则提供可选集成测试流程）
- evidence:
```

## 建议（给 MAIN 的下一步）
优先级：DEV  
原因：取证/拆解已完成且测试全绿，下一步应按上面的拆解先补“红测”并做存储解耦与 Memgraph 并行落地，降低大爆炸重构风险。

## 工具调用简报
【MCP调用简报】  
服务: serena  
触发: 读取工单要求的 3 份文档、定位 project/topone/kuzu 现状、给出调用链与可复现证据、最小化验证测试  
参数: read_file(max_answer_chars=-1) / list_dir / find_file / execute_shell_command（rg/wc/pytest）  
结果: 命中关键文件（`project/backend/app/main.py`、`project/backend/app/storage/graph.py`、`project/backend/app/services/topone_client.py`、`project/backend/app/llm/topone_gateway.py`）；pytest `93 passed`  
状态: 成功