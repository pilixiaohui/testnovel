已阅读开发行为规范
iteration: 4
self_test: enabled

## 任务理解

工单要求实现的功能：
1. 在 SceneNode 中新增 `title` 与 `sequence_index` 字段，并设置校验规则（非空/非负）。
2. Step4 返回的 SceneNode 必须包含新增字段。
3. 若 SceneNode 由 SceneOrigin 映射产生，需要补齐 title（可由现有字段派生）。

## 实现方案

### 设计思路
- 直接在 SceneNode 模型层强制约束字段必填与合法范围，保证契约一致性（KISS/快速失败）。
- 在本地场景生成与持久化映射中显式填充 `title`/`sequence_index`，避免隐式缺失（DRY）。
- 同步 Step4 LLM 提示词要求输出新增字段，保证线上链路契约闭环（YAGNI：仅做必要字段扩展）。

### 改动说明

| 文件 | 修改内容 | 实现逻辑 |
|-----|---------|---------|
| `project/backend/app/models.py:41` | SceneNode 新增 `title`/`sequence_index` 必填校验 | 通过 Pydantic Field 约束非空与非负，契约即校验 |
| `project/backend/app/services/llm_engine.py:403` | 本地 SceneNode 生成时补齐标题与序号 | 以循环索引生成确定性标题与序号，确保 Step4 响应完整 |
| `project/backend/app/storage/memgraph_storage.py:1706` | SceneOrigin 持久化使用 SceneNode 的 title/sequence_index | 持久化字段与 SceneNode 保持一致，避免信息丢失 |
| `project/backend/app/storage/memgraph_storage.py:1952` | SceneOrigin → scene dict 映射加入 title/sequence_index | 读回时补齐前端所需字段 |
| `project/backend/app/llm/prompts/__init__.py:31` | Step4 提示词加入 title/sequence_index | 约束 LLM 输出结构，保障模型解析成功 |

### 关键实现逻辑
- 数据流向：Step4 生成 → `SceneNode`（含 title/sequence_index）→ 持久化到 `SceneOrigin` → 读回场景列表时携带同名字段。
- 关键处理：`SceneNode` 使用 `Field(..., min_length=1)` 与 `Field(..., ge=0)` 强制校验，非法输入直接失败；本地生成与存储映射显式写入字段。
- 异常处理策略：不新增兜底逻辑，缺失/非法字段由模型校验或现有异常直接抛出，符合快速失败要求。
- 与模块交互：更新 Step4 LLM 提示词以匹配 `SceneNode` 模型，避免模型解析失败。

## 自测结果（仅 enabled 模式）

### 验收结果汇总

| 序号 | 命令 | 返回码 | 结果摘要 |
|-----|------|-------|---------|
| 1 | `MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit/test_scene_node_contract.py -v` | 0 | 4 passed |

- 全部验收命令已执行: 是
- 自测结果: PASS

### 测试详情
- `tests/unit/test_scene_node_contract.py` 全部 4 项用例通过。

## 总结与展望
- 已完成：SceneNode 新增字段校验、Step4 本地生成与存储映射补齐、Step4 提示词契约同步。
- 原则应用：KISS（模型层直接约束）；YAGNI（仅补必要字段）；DRY（同字段在生成与持久化统一来源）；SOLID/SRP（模型校验与生成/持久化职责明确分离）。
- 遇到的挑战：需要同时覆盖“生成/持久化/提示词”三处以保证契约闭环，已通过最小改动一致化解决。
- 下一步计划和建议：
1. 在集成环境验证真实 LLM Step4 输出是否严格包含 `title/sequence_index`。
2. 如需前端展示从 1 开始的序号，确认 UI 是否需要额外格式化。

结论：PASS
阻塞：无

【MCP调用简报】
服务: serena
触发: 代码检索、定位与编辑
参数: read_file/search_for_pattern/replace_regex（均含 max_answer_chars=-1）
结果: 完成 SceneNode 字段新增、生成与存储映射补齐、Step4 提示词更新
状态: 成功