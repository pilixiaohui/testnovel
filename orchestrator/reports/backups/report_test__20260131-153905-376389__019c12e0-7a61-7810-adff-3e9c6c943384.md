已阅读测试行为规范
iteration: 9

## 测试需求分析

工单要求测试的功能点：
1. 图信息提取/提交闭环（stateExtract/stateCommit + 变更预览 + World 刷新 + 失败重试）
2. 章节正文生成（POST /chapters/{id}/render + 渲染结果展示 + 失败重试）
3. Step6 完成后跳转 EditorView + root_id/branch_id 传递
4. 分支/提交/快照 UI（分支列表与切换、提交历史、快照加载/恢复）
5. 章节审核流程（Approve/Reject 点击后状态更新）

## 测试设计

### 设计思路
基于现有 E2E 结构，新增最小可执行用例，优先覆盖 P0 闭环与失败重试，再补 P1 跳转与 P2 版本/审核流程；统一使用 data-test 选择器与 API mock，确保后续实现后即可转绿。

### 创建的测试文件
- `project/frontend/tests/e2e/state-extract.spec.ts:1` - stateExtract/stateCommit 闭环 + 失败重试
- `project/frontend/tests/e2e/chapter-render.spec.ts:1` - 章节渲染展示 + 失败重试
- `project/frontend/tests/e2e/version-control.spec.ts:1` - 分支列表/切换、提交历史、快照加载/恢复

### 扩展的测试文件
- `project/frontend/tests/e2e/snowflake.spec.ts:163` - Step6 跳转 Editor + root_id/branch_id 断言
- `project/frontend/tests/e2e/core.e2e.spec.ts:336` - 章节审核按钮与状态更新

### 测试用例清单

| 用例名称 | 测试场景 | 对应功能点 | 测试逻辑说明 |
|---------|---------|-----------|-------------|
| StateExtract 提取预览并提交更新世界 | 正常流程 | 图信息提取/提交闭环 | 点击提取→展示变更→提交→World 刷新请求 |
| StateExtract 失败后可重试 | 异常重试 | 图信息提取/提交失败 | 首次 500 → 错误提示 → 重试成功 |
| ChapterRender 渲染结果与质量评分 | 正常流程 | 章节正文生成 | 点击渲染→展示 content + quality_scores |
| ChapterRender 失败后可重试 | 异常重试 | 章节正文生成失败 | 首次 500 → 错误提示 → 重试成功 |
| Snowflake Step6 完成后跳转 Editor | 正常流程 | Step6 跳转 | 走完 1-6 步 → 跳转 /editor 并携带 root_id/branch_id |
| VersionControl 分支列表与切换 | 正常流程 | 分支列表/切换 | 拉取分支列表 → 切换分支触发 switch API |
| VersionControl 提交历史与快照操作 | 正常流程 | 提交历史/快照 | 拉取 history → 加载 snapshot → 触发 restore |
| ChapterReview 审核更新状态 | 正常流程 | 章节审核 | 点击 Approve → review_status 更新 |

### 关键测试逻辑
- 状态提取：mock `/api/v1/state/extract` & `/api/v1/state/commit`，断言预览与提交后触发 `/roots/**/entities|anchors|subplots` 刷新。
- 失败重试：同一接口首次 500、第二次成功，断言错误提示与重试入口可用。
- 章节渲染：mock `/api/v1/chapters/{id}/render`，断言输出 content 与质量评分展示。
- Step6 跳转：完成 1-6 步并断言 URL 包含 `root_id`/`branch_id`。
- 版本控制：mock 分支列表/切换、提交历史、快照加载/恢复接口并断言 UI 变化。
- 章节审核：mock review 接口，点击 Approve 后断言状态标签更新。

## 测试执行

- 命令: `npm run test:e2e`
- 结果: 失败（8 failed / 7 passed）
- 红灯确认: 是（失败原因均为对应 UI/跳转未实现或 data-test 缺失）

### 执行详情
- ChapterRender/ChapterReview：`[data-test="chapter-review-item"]` 未出现，无法触发渲染与审核流程。
- Step6 跳转：完成 Step6 后未跳转到 `/editor`。
- StateExtract：`[data-test="state-extract"]` 未出现，提取/提交闭环入口缺失。
- VersionControl：`[data-test="version-control-root"]` 未出现，版本控制 UI 缺失。

## 验收标准

- 命令: `npm run test:e2e`
- 阈值: 测试可执行且因实现缺失产生红灯失败

结论：PASS
阻塞：无

【MCP调用简报】
服务: serena  
触发: 读取文档/现有E2E、创建与修改测试文件  
参数: list_dir/read_file/search_for_pattern/create_text_file/replace_regex  
结果: 新增3个E2E测试文件，扩展2个现有测试文件  
状态: 成功