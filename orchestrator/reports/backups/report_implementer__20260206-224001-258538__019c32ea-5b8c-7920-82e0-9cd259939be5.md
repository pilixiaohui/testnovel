已阅读实现者行为规范
iteration: 3

## Phase 1: 红灯阶段

### 测试设计思路
本轮先围绕 SYNTHESIZER 指出的两类核心问题做红灯：
1. **后端 500 根因**：TopOne 结构化输出在返回 Markdown fenced JSON、非法 JSON、或上游限流时未被正确转换，导致 Step2/3/4 抛 500。  
2. **前端链路稳定性**：前端开发代理目标错误导致 `/roots` 请求异常，进而引发按钮状态与流程异常；同时 Step 调用异常在视图层存在未捕获分支。  

测试覆盖按“正常 + 边界 + 异常映射”设计，确保不靠 mock 核心业务作弊。

### 创建的测试文件
- `project/backend/tests/unit/test_topone_gateway_structured.py` - 增加结构化输出解析边界（fenced JSON / invalid JSON）  
- `project/backend/tests/test_api_minimal.py` - 增加 Step2/3/4 的 422 映射与 Step2 上游 429 状态透传  
- `project/frontend/tests/snowflake_view_branches.spec.ts` - 增加 Step2 失败时前端错误展示分支（避免未处理异常）

### 测试用例清单
| 用例名称 | 测试场景 | 预期结果 |
|---------|---------|---------|
| `test_gateway_accepts_json_fenced_output` | LLM 返回 fenced JSON | 可正常解析，不抛 500 |
| `test_gateway_invalid_json_raises_value_error` | LLM 返回非法 JSON 文本 | 抛 `ValueError`，供上层转 4xx |
| `test_step2_returns_422_when_engine_output_invalid` | Step2 结构化失败 | 返回 422 |
| `test_step3_returns_422_when_engine_output_invalid` | Step3 结构化失败 | 返回 422 |
| `test_step4_returns_422_when_manager_output_invalid` | Step4 结构化失败 | 返回 422 |
| `test_step2_returns_upstream_status_when_engine_rate_limited` | 上游返回 429 | API 返回 429，不是 500 |
| `shows error when step2 request fails` | 前端 Step2 API 失败 | 页面展示错误信息，不吞错 |

### 红灯确认
- 命令: `SNOWFLAKE_ENGINE=local MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit/test_topone_gateway_structured.py project/backend/tests/test_api_minimal.py -q`
- 结果: 失败（预期）
- 失败原因:  
  - fenced JSON / invalid JSON 未正确转换（`JSONDecodeError`）  
  - Step2/3/4 对结构化失败未映射为 422  
  - Step2 上游 `HTTPStatusError(429)` 未透传，直接冒泡导致失败

---

## Phase 2: 绿灯阶段

### 实现方案
按最小改动闭环修复：
1. **后端解析层修复**：在网关增加 fenced JSON 解包与统一 JSON 解析错误语义（`ValueError`）。  
2. **后端接口层修复**：Step1~Step5 对 `ValueError` 映射 422；对 `httpx.HTTPError` 做上游状态映射（429/504/503），彻底消除 500 冒泡。  
3. **前端环境修复**：修正开发代理目标，恢复前后端本地联通。  
4. **前端交互修复**：`runStep` 增加统一异常捕获，避免未处理 Promise 分支。  

### 改动说明
| 文件 | 修改内容 | 实现逻辑 |
|-----|---------|---------|
| `project/backend/app/llm/topone_gateway.py:45` | 新增 `_strip_code_fence`、`_parse_json_payload` | 兼容 fenced JSON；非法 JSON 统一转 `ValueError` |
| `project/backend/app/llm/topone_gateway.py:85` | `TypeAdapter` 校验失败转 `ValueError` | schema 不匹配不再直接 500 |
| `project/backend/app/main.py:164` | 新增 `_raise_upstream_http_error` | 429/504/503 显式映射，避免 500 |
| `project/backend/app/main.py:283` | Step1~Step5 增加 `except httpx.HTTPError` | 上游异常统一转业务 HTTP 状态码 |
| `project/backend/app/main.py:282` | Step2/3/4/5 等增加 422 映射 | 结构化输出失败转 422 |
| `project/frontend/.env.development:2` | 修正 `VITE_API_PROXY_TARGET` | 恢复开发态代理到本地后端 |
| `project/frontend/src/views/SnowflakeView.vue:359` | `runStep` 外围新增 `try/catch` | API 失败时写入 `errorMessage`，避免未处理异常 |
| `project/backend/tests/unit/test_topone_gateway_structured.py:150` | 新增解析边界测试 | 锁定 fenced/invalid 行为 |
| `project/backend/tests/test_api_minimal.py:36` | 新增 429 透传与 422 映射测试 | 锁定接口层错误语义 |
| `project/frontend/tests/snowflake_view_branches.spec.ts:232` | 新增 Step2 失败展示测试 | 锁定前端失败分支 |

### 绿灯确认
- 命令: `SNOWFLAKE_ENGINE=local MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit/test_topone_gateway_structured.py project/backend/tests/test_api_minimal.py -q`
- 结果: `35 passed`
- 覆盖率: 后端本次目标用例全绿

补充绿灯：
- `npx vitest run tests/snowflake_view_branches.spec.ts` -> `6 passed`
- `npm run test:coverage` -> `259 passed`, `Branch 80.45%`

---

## 自测结果汇总

| 验收命令 | 返回码 | 结果 |
|---------|-------|------|
| `SNOWFLAKE_ENGINE=local MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit/test_topone_gateway_structured.py project/backend/tests/test_api_minimal.py -q` | 0 | 35 passed |
| `SNOWFLAKE_ENGINE=local MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit/test_config.py project/backend/tests/test_topone_client.py -q` | 0 | 21 passed |
| `npx vitest run tests/snowflake_view_branches.spec.ts` | 0 | 6 passed |
| `npm run test:coverage` | 0 | 259 passed，Branch 80.45% |
| Playwright MCP: 首页加载 + roots 列表请求 | 成功 | `/api/v1/roots` 返回 200，项目列表正常显示 |
| Playwright MCP: Snowflake 页面按钮可交互 | 成功 | Step 按钮可点击，`/api/v1/snowflake/step2` 返回 200（网络日志可见） |
| Playwright MCP: Editor 页面渲染入口 | 成功 | Scene Render 按钮与 Chapter Render 按钮可见 |
| 章节统计脚本（既有 root） | 0 | 10/10 章节有正文；无缺失；非标点空白字符均值约 3077 |
| 主题一致性脚本（既有 root） | 0 | 各章均命中主题关键词（如“何方/赛博”） |

自测结果: PASS

---

## 总结、反思与展望

### 本次迭代已完成的核心任务
- 修复了 Step2/3/4（及 Step5）因结构化输出/上游异常导致的 500 问题。  
- 修复了前端开发代理目标错误引发的 `/roots` 异常链路。  
- 修复了 Snowflake 页面 step 调用异常分支未统一捕获问题。  
- 补齐了需求证据：超时配置、章节字数统计、主题一致性取证。

### KISS / YAGNI / DRY / SOLID 应用
- **KISS**：仅增加一个上游错误映射函数 `_raise_upstream_http_error`，避免分散重复判断。  
- **YAGNI**：未引入复杂重试/降级机制，仅做必要状态码映射与解析修复。  
- **DRY**：JSON 解析统一走 `_parse_json_payload`，接口异常统一走 `_raise_upstream_http_error`。  
- **SOLID（SRP/OCP）**：  
  - 结构化解析职责留在网关层；  
  - HTTP 语义转换留在 API 层；  
  - 前端仅负责展示错误，不侵入业务层。  

### 遇到的挑战与处理
- **挑战 1**：前端报 500 但后端单独 curl 正常。  
  - 处理：定位到 `project/frontend/.env.development:2` 代理目标错误，修复后链路恢复。  
- **挑战 2**：Step2 在上游限流时抛 500。  
  - 处理：新增 `httpx` 异常映射，429 直接透传为 429，避免 500。  
- **挑战 3**：LLM 返回 fenced JSON 触发解析失败。  
  - 处理：网关加 fenced 解包 + 明确 `ValueError` 语义，接口层统一转 422。  

### 下一步计划和建议
1. 在验证器阶段重点复核：Step1~Step6 + Simulation + Chapter Render 全链路稳定性。  
2. 若后续要求更强健性，可在不违背快速失败前提下增加“429 可观测性指标”与失败告警统计（非自动重试）。

---

## 职责边界说明

### IMPLEMENTER 测试职责
| 测试类型 | 工具 | 目的 |
|---------|------|------|
| 单元测试 | Bash (`pytest`) | 验证后端错误映射与解析逻辑 |
| 前端单测 | Bash (`vitest`) | 验证 Step 错误展示分支 |
| 覆盖率 | Bash (`npm run test:coverage`) | 验证覆盖率门槛 |
| 前端功能自测 | Playwright MCP | 验证真实页面交互与网络请求 |

### Playwright MCP 自测 vs 验证器测试
| 维度 | IMPLEMENTER 自测 | 验证器测试 |
|------|-----------------|-----------|
| 工具 | Playwright MCP | Playwright MCP |
| 目的 | 开发调试与链路确认 | 独立验收与质量把关 |
| 网络验证 | 已执行关键接口检查 | 会更严格覆盖全部场景 |

### 真实环境验证（验证器职责）
已保证：
- ✅ 前端可启动并与后端连通  
- ✅ 后端 API 可响应且关键接口不再冒 500  
- ✅ 命令行测试通过且覆盖率达标  
- ✅ 浏览器页面关键入口（Step/Render）可交互

---

## 验证信息

### 测试命令
```yaml
commands:
  - cmd: "SNOWFLAKE_ENGINE=local MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit/test_topone_gateway_structured.py project/backend/tests/test_api_minimal.py -q"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "SNOWFLAKE_ENGINE=local MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit/test_config.py project/backend/tests/test_topone_client.py -q"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "npx vitest run tests/snowflake_view_branches.spec.ts"
    cwd: "/home/zxh/ainovel_v3/project/frontend"
    type: unit
  - cmd: "npm run test:coverage"
    cwd: "/home/zxh/ainovel_v3/project/frontend"
    type: unit
```

### 修改文件
```yaml
files:
  - path: "project/backend/app/llm/topone_gateway.py"
    type: implementation
  - path: "project/backend/app/main.py"
    type: implementation
  - path: "project/frontend/.env.development"
    type: implementation
  - path: "project/frontend/src/views/SnowflakeView.vue"
    type: implementation
  - path: "project/backend/tests/unit/test_topone_gateway_structured.py"
    type: test
  - path: "project/backend/tests/test_api_minimal.py"
    type: test
  - path: "project/frontend/tests/snowflake_view_branches.spec.ts"
    type: test
```

### API 签名
```yaml
signatures:
  - name: "_parse_json_payload"
    file: "project/backend/app/llm/topone_gateway.py"
    params: ["text"]
  - name: "_raise_upstream_http_error"
    file: "project/backend/app/main.py"
    params: ["exc"]
  - name: "generate_structure_endpoint"
    file: "project/backend/app/main.py"
    params: ["payload", "engine"]
  - name: "generate_characters_endpoint"
    file: "project/backend/app/main.py"
    params: ["root", "manager"]
  - name: "generate_scene_endpoint"
    file: "project/backend/app/main.py"
    params: ["payload", "manager"]
```

结论：PASS  
阻塞：无

【MCP调用简报】  
服务: serena  
触发: 后端/前端代码定位、符号级编辑、测试文件增量修改  
参数: `read_file/search_for_pattern/replace_regex(max_answer_chars=-1)`  
结果: 完成 7 个文件的实现与测试改动，定位到关键行（如 `project/backend/app/main.py:164`, `project/backend/app/llm/topone_gateway.py:45`, `project/frontend/src/views/SnowflakeView.vue:359`）  
状态: 成功  

【MCP调用简报】  
服务: playwright  
触发: 真实浏览器自测（页面渲染、按钮可交互、网络请求验证、控制台检查）  
参数: `browser_navigate/browser_click/browser_snapshot/browser_network_requests/browser_console_messages`  
结果: 验证 `/api/v1/roots` 200、`/api/v1/snowflake/step2` 200、Editor Render 按钮可见，刷新后 console error 为 0  
状态: 成功