已阅读审阅行为规范
iteration: 1
review_mode: single

## 任务理解

审阅的任务：评估技术架构可行性，确认现有系统能否支撑 10 章小说生成，覆盖后端核心服务、Snowflake 六步 API、Memgraph 存储层、前端 SnowflakeView 展示能力。
验收标准：列出关键技术依赖和接口，标注架构缺口或风险，给出 PASS/FAIL 结论。

## 验收执行

- 验收命令: `无（工单未提供）`
- 返回码: N/A
- 测试结果: N/A
- 覆盖率: N/A

## 代码深度审查

### 实现代码审查
- 审查文件: `project/backend/app/main.py`
- 审查文件: `project/backend/app/services/llm_engine.py`
- 审查文件: `project/backend/app/llm/topone_gateway.py`
- 审查文件: `project/backend/app/services/smart_renderer.py`
- 审查文件: `project/backend/app/storage/memgraph_storage.py`
- 审查文件: `project/backend/app/models.py`
- 审查文件: `project/frontend/src/views/SnowflakeView.vue`
- 审查内容:
  | 检查项 | 结果 | 说明 |
  |-------|------|------|
  | 函数参数/返回值类型 | 不符合 | SmartRenderer 依赖 `llm.generate_prose`，但默认注入的 LLMEngine/ToponeGateway 未实现该接口 |
  | API 契约一致性 | 不符合 | 前端使用 `scene.title`，后端 `SceneNode` 无 `title` 字段；锚点类型/约束在存储层被强限制 |
  | 错误处理完整性 | 不完整 | gemini/local 模式缺少 Step5/锚点方法，运行时会触发 AttributeError/接口不可用 |
  | 边界条件处理 | 未考虑 | “10章”总量未在 Step5b/存储层强约束或配置化 |

- 代码片段证据:
```python
# project/backend/app/main.py:123-132
def get_llm_engine() -> LLMEngine | LocalStoryEngine | ToponeGateway:  # pragma: no cover
    engine_mode = _require_snowflake_engine_mode()
    if engine_mode == "local":
        return LocalStoryEngine()
    if engine_mode == "llm":
        return LLMEngine()
    if engine_mode == "gemini":
        return get_topone_gateway()
```

```python
# project/backend/app/main.py:252-305
@app.post("/api/v1/snowflake/step5a")
async def generate_act_list_endpoint(...):
    acts = await engine.generate_act_list(payload.root, payload.characters)
...
@app.post("/api/v1/snowflake/step5b")
async def generate_chapter_list_endpoint(...):
    generated = await engine.generate_chapter_list(payload.root, act, payload.characters)
```

```python
# project/backend/app/main.py:328-365
@app.post("/api/v1/roots/{root_id}/anchors")
async def create_anchor_endpoint(...):
    anchors = await engine.generate_story_anchors(payload.root, payload.characters, acts)
```

```python
# project/backend/app/llm/topone_gateway.py:65-171
class ToponeGateway:
    ...
    async def generate_logline_options(...)
    async def generate_root_structure(...)
    async def generate_characters(...)
    async def generate_scene_list(...)
    async def logic_check(...)
    async def state_extract(...)
    async def render_scene(...)
```

```python
# project/backend/app/services/llm_engine.py:346-406
class LocalStoryEngine:
    async def generate_logline_options(...)
    async def generate_root_structure(...)
    async def generate_characters(...)
    async def validate_characters(...)
    async def generate_scene_list(...)
```

```python
# project/backend/app/services/smart_renderer.py:17-45
async def render(...):
    ...
    content = await self.llm.generate_prose(
        beats=beats,
        sensory=sensory_details,
        style=style_context,
        pov=pov,
    )
```

```python
# project/backend/app/storage/memgraph_storage.py:39-40
VALID_ANCHOR_TYPES = {"inciting_incident", "midpoint"}
VALID_ANCHOR_CONSTRAINTS = {"hard", "soft"}
```

```python
# project/backend/app/storage/memgraph_storage.py:1262-1276
def create_anchor(...):
    if type not in VALID_ANCHOR_TYPES:
        raise ValueError(f"invalid anchor type: {type}")
    if constraint not in VALID_ANCHOR_CONSTRAINTS:
        raise ValueError(f"invalid anchor constraint: {constraint}")
```

```python
# project/backend/app/models.py:41-52
class SceneNode(BaseModel):
    id: UUID = Field(default_factory=uuid4)
    branch_id: str = Field(..., min_length=1)
    parent_act_id: Optional[UUID] = None
    pov_character_id: Optional[UUID] = None
    expected_outcome: str
    conflict_type: str
    actual_outcome: str
```

```vue
<!-- project/frontend/src/views/SnowflakeView.vue:60-64 -->
<ul class="result-list">
  <li v-for="scene in store.scenes" :key="scene.id">{{ scene.title }}</li>
</ul>
```

- 实现审查结论: 存在问题

**关键技术依赖与接口（确认）**
- 依赖：FastAPI + Memgraph（`MemgraphStorage`）+ SNOWFLAKE_ENGINE 三态（local/llm/gemini）+ ToponeGateway
- Snowflake 六步端点：`/api/v1/snowflake/step1~step5b` 与 `/api/v1/roots/{root_id}/anchors` 已存在（见 `project/backend/app/main.py:216-365`）
- 渲染/逻辑检查：`/api/v1/scenes/{scene_id}/render` 与 `/api/v1/logic/check` 强依赖 gemini 模式（同文件后半段）

### 测试代码审查
- 测试文件: 存在（例如 `project/backend/tests/test_snowflake_workflow.py`, `project/backend/tests/integration/test_snowflake_step5.py`, `project/backend/tests/unit/test_smart_renderer.py`）
- 测试覆盖情况:
  | 功能点 | 是否有测试 | 测试是否正确 |
  |-------|-----------|-------------|
  | Snowflake Step5/章节生成 | 是 | 不适用（未执行） |
  | SmartRenderer | 是 | 不适用（未执行） |
- 测试质量结论: 未执行测试，无法确认是否符合需求

## 结论

结论：FAIL  
失败类型：实现问题  
阻塞：核心流程接口契约不一致（Step5/锚点在 gemini/local 模式不可用、SmartRenderer LLM 接口不一致、SceneNode/前端字段不匹配）

## 建议

1. 统一 Snowflake 引擎接口：为 `ToponeGateway`/`LocalStoryEngine`补齐 `generate_act_list`、`generate_chapter_list`、`generate_story_anchors`，或在 `get_llm_engine` 层强制限制模式并提供明确错误提示。  
2. 修复 SmartRenderer LLM 接口不一致：要么在 LLMEngine/ToponeGateway 增加 `generate_prose`，要么改 SmartRenderer 统一调用已存在的 `render_scene`。  
3. 扩展锚点类型/约束：存储层 `VALID_ANCHOR_TYPES/CONSTRAINTS` 需支持至少 `climax`、`resolution` 与 `flexible`，否则生成锚点会被拒绝。  
4. 修复前后端契约：`SceneNode` 增加 `title` 或前端改为展示 `expected_outcome`，避免 Step4 UI 空白。  
5. 明确“10章”约束实现策略：在 Step5b 或存储层加入总章数约束/分配策略（如固定 3 幕 3/3/4）。  
6. 执行现有测试并补充 10 章约束的集成用例，保证覆盖率达标后再复核。

【MCP调用简报】
服务: serena  
触发: 架构审阅定位与读取核心实现/配置  
参数: read_file(main.py, llm_engine.py, topone_gateway.py, smart_renderer.py, memgraph_storage.py, models.py, SnowflakeView.vue), list_dir(project/backend/tests), search_for_pattern(VALID_ANCHOR_TYPES)  
结果: 读取核心服务与前端视图文件，定位锚点约束与契约不一致点  
状态: 成功