已阅读审阅行为规范  
iteration: 1  
review_mode: milestone  

## Milestone Review: M2

### M2-T1: Step5b章节数量约束（总数=10）

#### 任务理解
Step5b 生成章节列表时，章节总数必须**严格等于 10**；否则应快速失败并返回 400。

#### 验收执行
- 验收命令: `cd project/backend && /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/unit/test_step5b_chapter_count.py -v`
- 返回码: 0
- 测试结果: 3 passed, 0 failed
- 覆盖率: 未采集（该验收命令未启用 --cov）
- 命令输出:
```text
============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-9.0.2, pluggy-1.6.0 -- /home/zxh/ainovel_v3/project/backend/.venv/bin/python
cachedir: .pytest_cache
rootdir: /home/zxh/ainovel_v3/project/backend
configfile: pyproject.toml
plugins: anyio-4.12.1, mock-3.15.1, cov-7.0.0, asyncio-1.3.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 3 items

tests/unit/test_step5b_chapter_count.py::test_step5b_returns_10_chapters_when_total_is_10 PASSED [ 33%]
tests/unit/test_step5b_chapter_count.py::test_step5b_returns_400_when_total_less_than_10 PASSED [ 66%]
tests/unit/test_step5b_chapter_count.py::test_step5b_returns_400_when_total_greater_than_10 PASSED [100%]

=============================== warnings summary ===============================
app/main.py:118
  /home/zxh/ainovel_v3/project/backend/app/main.py:118: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("startup")

.venv/lib/python3.11/site-packages/fastapi/applications.py:4576
  /home/zxh/ainovel_v3/project/backend/.venv/lib/python3.11/site-packages/fastapi/applications.py:4576: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    return self.router.on_event(event_type)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
======================== 3 passed, 2 warnings in 0.91s =========================
```

#### 代码深度审查

##### 实现代码审查
- 审查文件: `project/backend/app/main.py:285`
- 审查内容:
  | 检查项 | 结果 | 说明 |
  |-------|------|------|
  | 函数参数/返回值类型 | 符合 | `payload: Step5bPayload -> List[dict[str, Any]]`，依赖注入清晰 |
  | API 契约一致性 | 符合 | 读取acts→逐act调用 `generate_chapter_list`→创建chapter |
  | 错误处理完整性 | 基本完整 | act缺失/LLM返回空/总数!=10均返回4xx |
  | 边界条件处理 | 已考虑关键边界 | 总数<10、>10 → 400；acts缺失 → 404 |
- 代码片段证据:
```python
# project/backend/app/main.py:285
@app.post("/api/v1/snowflake/step5b")
async def generate_chapter_list_endpoint(...):
    ...
    total_count = 0
    for act in acts:
        ...
        generated = await engine.generate_chapter_list(...)
        ...
        total_count += len(generated)
    if total_count != 10:
        raise HTTPException(status_code=400, detail="chapter count must be exactly 10")
```
- 实现审查结论: 合理（章节总数强约束已落地在服务端，符合快速失败）

##### 测试代码审查
- 测试文件: 存在: `project/backend/tests/unit/test_step5b_chapter_count.py`
- 测试覆盖情况:
  | 功能点 | 是否有测试 | 测试是否正确 |
  |-------|-----------|-------------|
  | 总数=10返回200 | 是 | 是 |
  | 总数<10返回400 | 是 | 是 |
  | 总数>10返回400 | 是 | 是 |
- 测试质量结论: 符合需求（无明显“作弊”路径）

#### 任务结论
- 结论: PASS
- 建议状态: VERIFIED
- 改进建议: 更新/补齐其他旧测试对 Step5b 的期望（见“额外发现”）

---

### M2-T2: 章节渲染API（/chapters/{id}/render）

#### 任务理解
提供章节渲染端点，返回 `rendered_content`；并满足 1800-2200（按测试实现为 `len(content)`）范围；不满足约束应快速失败返回 400。

#### 验收执行
- 验收命令: `cd project/backend && /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/integration/test_chapter_render_api.py -v`
- 返回码: 0
- 测试结果: 3 passed, 0 failed
- 覆盖率: 未采集（该验收命令未启用 --cov）
- 命令输出:
```text
============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-9.0.2, pluggy-1.6.0 -- /home/zxh/ainovel_v3/project/backend/.venv/bin/python
cachedir: .pytest_cache
rootdir: /home/zxh/ainovel_v3/project/backend
configfile: pyproject.toml
plugins: anyio-4.12.1, mock-3.15.1, cov-7.0.0, asyncio-1.3.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 3 items

tests/integration/test_chapter_render_api.py::test_chapter_render_success_returns_content_and_word_count PASSED [ 33%]
tests/integration/test_chapter_render_api.py::test_chapter_render_missing_chapter_returns_404 PASSED [ 66%]
tests/integration/test_chapter_render_api.py::test_chapter_render_failure_returns_400 PASSED [100%]

=============================== warnings summary ===============================
app/main.py:118
  /home/zxh/ainovel_v3/project/backend/app/main.py:118: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("startup")

.venv/lib/python3.11/site-packages/fastapi/applications.py:4576
  /home/zxh/ainovel_v3/project/backend/.venv/lib/python3.11/site-packages/fastapi/applications.py:4576: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    return self.router.on_event(event_type)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
======================== 3 passed, 2 warnings in 0.90s =========================
```

#### 代码深度审查

##### 实现代码审查
- 审查文件: `project/backend/app/main.py:589`
- 审查内容:
  | 检查项 | 结果 | 说明 |
  |-------|------|------|
  | 函数参数/返回值类型 | 符合 | `-> dict[str, str]` |
  | API 契约一致性 | 部分符合 | 返回 `rendered_content`，但缺少对 1800-2200 的服务端校验 |
  | 错误处理完整性 | 不完整 | 仅对 gateway 抛错返回 400；**未对“字数不达标”快速失败** |
  | 边界条件处理 | 未考虑关键边界 | content 长度 <1800 或 >2200 仍会成功返回并持久化 |
- 代码片段证据:
```python
# project/backend/app/main.py:589
content = await gateway.render_scene(payload)
chapter.rendered_content = content
storage.update_chapter(chapter)
return {"rendered_content": content}  # 无长度校验/无400快速失败
```
- 实现审查结论: 存在问题（字数约束未在服务端实现，无法保证 2000±10% 的硬性验收）

##### 测试代码审查
- 测试文件: 存在: `project/backend/tests/integration/test_chapter_render_api.py`
- 测试覆盖情况:
  | 功能点 | 是否有测试 | 测试是否正确 |
  |-------|-----------|-------------|
  | 正常渲染返回200 | 是 | 是 |
  | 缺失chapter返回404 | 是 | 是 |
  | gateway异常返回400 | 是 | 是 |
  | 字数下限/上限（1800/2200）边界 | 否 | 不适用 |
  | 字数不达标时返回400（快速失败） | 否 | 不适用 |
- 代码片段证据:
```python
# project/backend/tests/integration/test_chapter_render_api.py:71
content = _make_content(1900)
...
assert 1800 <= len(payload["rendered_content"]) <= 2200  # 仅验证“返回值”，未验证“不达标时应400”
```
- 测试质量结论: 部分符合（缺少关键边界与失败路径测试，无法防回归）

#### 任务结论
- 结论: FAIL
- 失败类型: 实现问题
- 建议状态: 保持 DONE
- 改进建议:
  - 在 `project/backend/app/main.py:589` 对 `len(content)` 做硬校验（<1800 或 >2200 → 400），并补齐对应测试（<1800、=1800、=2200、>2200）
  - 避免捕获过宽的 `Exception` 将内部错误伪装成 400（可至少收敛到可预期异常类型）

---

### M2-T3: 章节渲染持久化

#### 任务理解
渲染结果写入 Memgraph；可通过 GET 章节接口读出；重复渲染可更新覆盖。

#### 验收执行
- 验收命令: `cd project/backend && /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/integration/test_chapter_persistence.py -v`
- 返回码: 0
- 测试结果: 4 passed, 0 failed
- 覆盖率: 未采集（该验收命令未启用 --cov）
- 命令输出:
```text
============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-9.0.2, pluggy-1.6.0 -- /home/zxh/ainovel_v3/project/backend/.venv/bin/python
cachedir: .pytest_cache
rootdir: /home/zxh/ainovel_v3/project/backend
configfile: pyproject.toml
plugins: anyio-4.12.1, mock-3.15.1, cov-7.0.0, asyncio-1.3.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 4 items

tests/integration/test_chapter_persistence.py::test_unrendered_chapter_has_empty_rendered_content PASSED [ 25%]
tests/integration/test_chapter_persistence.py::test_render_persists_rendered_content PASSED [ 50%]
tests/integration/test_chapter_persistence.py::test_render_updates_content_on_second_call PASSED [ 75%]
tests/integration/test_chapter_persistence.py::test_get_chapter_returns_rendered_content PASSED [100%]

=============================== warnings summary ===============================
app/main.py:118
  /home/zxh/ainovel_v3/project/backend/app/main.py:118: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("startup")

.venv/lib/python3.11/site-packages/fastapi/applications.py:4576
  /home/zxh/ainovel_v3/project/backend/.venv/lib/python3.11/site-packages/fastapi/applications.py:4576: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    return self.router.on_event(event_type)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
======================== 4 passed, 2 warnings in 0.97s =========================
```

#### 代码深度审查

##### 实现代码审查
- 审查文件: `project/backend/app/storage/memgraph_storage.py:707`
- 审查内容:
  | 检查项 | 结果 | 说明 |
  |-------|------|------|
  | 函数参数/返回值类型 | 符合 | `get_chapter -> Chapter|None`, `update_chapter -> Chapter` |
  | API 契约一致性 | 符合 | `rendered_content` 在 Chapter 属性中持久化 |
  | 错误处理完整性 | 基本完整 | create/update 路径对缺失 act 等抛 KeyError |
  | 边界条件处理 | 已覆盖主要路径 | 未渲染为 None/""，二次渲染可覆盖 |
- 代码片段证据:
```python
# project/backend/app/storage/memgraph_storage.py:707
def _chapter_props(self, chapter: Chapter) -> dict[str, object]:
    ...
    optional=("pov_character_id", "rendered_content")
```
- 实现审查结论: 合理（`rendered_content` 已纳入属性集并可更新）

##### 测试代码审查
- 测试文件: 存在: `project/backend/tests/integration/test_chapter_persistence.py`
- 测试覆盖情况:
  | 功能点 | 是否有测试 | 测试是否正确 |
  |-------|-----------|-------------|
  | 未渲染章节初始值 | 是 | 是 |
  | 渲染后写入Memgraph | 是 | 是 |
  | 二次渲染覆盖更新 | 是 | 是 |
  | GET章节返回rendered_content | 是 | 是 |
- 测试质量结论: 符合需求（持久化链路验证到位；但仍依赖渲染长度“碰巧正确”，见 M2-T2）

#### 任务结论
- 结论: PASS
- 建议状态: VERIFIED
- 改进建议: 与 M2-T2 同步补齐“渲染内容长度不达标”时不得写入的快速失败用例（避免脏数据落库）

---

## 汇总

| 任务 | 验收结果 | 代码审查 | 测试质量 | 失败类型 | 建议状态 |
|------|---------|---------|---------|---------|---------|
| M2-T1 | PASS | 合理 | 符合需求 | - | VERIFIED |
| M2-T2 | PASS（命令）/FAIL（审查） | 存在问题 | 部分符合 | 实现问题 | 保持 DONE |
| M2-T3 | PASS | 合理 | 符合需求 | - | VERIFIED |

结论：FAIL  
阻塞：M2-T2 未实现 1800-2200 字数约束的服务端校验与快速失败（`project/backend/app/main.py:589` 直接返回并持久化 content）；需补实现与补测试后方可 VERIFIED。

## 建议

- 派发 DEV：在 `project/backend/app/main.py:589` 增加 `rendered_content` 长度硬校验（<1800 或 >2200 → HTTP 400），并明确错误信息；必要时决定“不达标内容是否禁止落库”（建议禁止）。
- 派发 TEST：补 `project/backend/tests/integration/test_chapter_render_api.py` 的边界/失败用例（<1800、=1800、=2200、>2200），并确保失败时不会更新存储（可在持久化测试里加断言）。
- 额外发现（与本Milestone强相关的回归风险）：全量测试当前不绿（非工单验收命令，但影响 `must_pass_before_review`）
  - 示例1：`tests/integration/test_snowflake_step5.py::test_step5b_generates_chapters` 仍期望 step5b 支持返回 1 章（与“总数必须=10”的新约束冲突）  
    - 复现命令输出（节选，完整输出如下）:
```text
=========================== short test summary info ============================
FAILED tests/integration/test_snowflake_step5.py::test_step5b_generates_chapters
======================== 1 failed, 2 warnings in 0.91s =========================
```
  - 示例2：`tests/test_api_minimal.py::test_step4_generate_scene_endpoint` 的 DummyManager 构造 SceneNode 缺少必填字段 `title/sequence_index`（契约升级后未同步）  
    - 复现命令输出（节选，完整输出如下）:
```text
pydantic_core._pydantic_core.ValidationError: 2 validation errors for SceneNode
title Field required
sequence_index Field required
```

（如 MAIN 需要，我可以按失败用例列表进一步分拣：哪些是“测试需更新”、哪些是“实现不符/缺失”。）

【MCP调用简报】  
服务: serena  
触发: 定位Step5b/章节渲染/持久化实现与对应测试，提供代码证据与行号  
参数: read_file/search_for_pattern（relative_path=project/backend/...，max_answer_chars=-1）  
结果: 命中并审查关键文件：`project/backend/app/main.py`、`project/backend/app/storage/memgraph_storage.py`、3个验收测试文件等  
状态: 成功