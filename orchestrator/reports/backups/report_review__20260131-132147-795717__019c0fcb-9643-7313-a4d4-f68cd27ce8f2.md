已阅读审阅行为规范
iteration: 3
review_mode: single

## 任务理解
对照规格文档：
- `doc/frontend_implementation_spec.md`
- `doc/系统架构与技术规格.md`

对现有前端 E2E 测试进行全面性与合理性评估（范围：`project/frontend/tests/e2e/`），产出：
- 覆盖度矩阵（≥20 功能点，包含文档行号与用例映射）
- 测试质量评估（选择器/断言/等待/E2E真实性）
- 分级问题清单（Critical/High/Medium/Low）
- 可执行的优先级改进建议

## 验收执行
- 命令: `npm run test:e2e` | 返回码: 0 | 结果: 7 passed（约 7.1s）

## 代码深度审查

### 实现代码
- 文件: `project/frontend/src/views/SnowflakeView.vue`
- 检查结果:

| 检查项 | 结果 | 说明 |
|---|---|---|
| 规格一致性 | 存在问题 | 规格要求“完成 Step 6 -> 跳转到编辑器”（`doc/frontend_implementation_spec.md:754`），实现仅执行 `await store.fetchStep6()`（`project/frontend/src/views/SnowflakeView.vue:149`），无跳转逻辑 |
| 可测性 | 合理 | Snowflake 关键控件均有 `data-test`，E2E 选择器可较稳定绑定 |

- 结论: 存在问题

- 文件: `project/frontend/src/views/EditorView.vue`
- 检查结果:

| 检查项 | 结果 | 说明 |
|---|---|---|
| 审核能力暴露 | 存在问题 | 已出现章节审核按钮（`data-test="chapter-approve"`，`project/frontend/src/views/EditorView.vue:90`），但 E2E 完全未覆盖审核行为与 review_status 变化 |
| 与文档关键字段一致性 | 部分满足 | 文档强调 `review_status`（`doc/系统架构与技术规格.md:1879`）与审核端点（`doc/frontend_implementation_spec.md:1108`），但当前测试不验收 |

- 结论: 存在问题

### 测试代码
- 文件: 存在
  - `project/frontend/tests/e2e/core.e2e.spec.ts`
  - `project/frontend/tests/e2e/snowflake.spec.ts`
  - `project/frontend/tests/e2e/simulation.spec.ts`
  - `project/frontend/tests/e2e/playwright.e2e.ts`
  - `project/frontend/playwright.config.ts`

- 覆盖情况（结论级）：

| 功能点 | 有测试 | 正确 |
|---|---:|---:|
| 路由可访问（除 Home） | 是 | 部分 |
| Snowflake 1-6 happy path | 是 | 部分 |
| Simulation Start/Step/Scene happy path | 是 | 部分 |
| Editor Load/Save/Diff/Render happy path | 是 | 部分 |
| World Load/CRUD/Relations（烟测） | 是 | 部分 |
| Settings 真正保存与反馈 | 否 | - |
| Anchor 可达性检查/动态补路相关验收 | 否 | - |
| Chapter/Scene 审核（review_status） | 否 | - |
| 分支/提交/LLM/反馈等模块验收 | 否 | - |

- 结论: 不符合需求（覆盖不足 + 质量问题）

## 覆盖度矩阵（≥20 功能点）
覆盖状态说明：
- ✅ 已覆盖：有 E2E 且对关键结果有断言
- ⚠️ 部分覆盖：有用例但断言弱/只烟测可见性/缺边界错误/严重依赖 mock
- ❌ 未覆盖：无对应 E2E

| 功能点 | 文档行号 | 测试用例 | 覆盖状态 | 备注 |
|---|---:|---|:---:|---|
| HomeView 路由 `/` 可访问 | doc/frontend_implementation_spec.md:925 | - | ❌ | 无首页导航/项目列表相关 E2E |
| SnowflakeView 路由 `/snowflake` 可访问 | doc/frontend_implementation_spec.md:926 | `SnowflakeFlow 基本流程`、`SnowflakeFlow 核心流程` | ✅ | 覆盖路由进入与核心 UI 元素可见 |
| SimulationView 路由 `/simulation/:sceneId?` 可访问 | doc/frontend_implementation_spec.md:927 | `SimulationConsole 基本流程`、`SimulationConsole 核心流程` | ✅ | 覆盖路由进入与核心 UI 元素可见 |
| EditorView 路由 `/editor/:sceneId?` 可访问 | doc/frontend_implementation_spec.md:928 | `SceneEditor 核心流程` | ✅ | 覆盖路由进入与核心 UI 元素可见 |
| WorldView 路由 `/world` 可访问 | doc/frontend_implementation_spec.md:929 | `WorldManager 核心流程` | ✅ | 覆盖路由进入与核心 UI 元素可见 |
| SettingsView 路由 `/settings` 可访问 | doc/frontend_implementation_spec.md:930 | `Settings 保存流程` | ⚠️ | 只验可见性，不点击保存/不验证保存结果（`project/frontend/tests/e2e/core.e2e.spec.ts:329`） |
| Snowflake Step1 输入面板：textarea + 生成按钮 + loglineOptions | doc/frontend_implementation_spec.md:758 | `SnowflakeFlow 基本流程`、`SnowflakeFlow 核心流程` | ⚠️ | 未按规格验证 textarea/radio-group；且使用结构选择器 `section.step-panel`（`project/frontend/tests/e2e/core.e2e.spec.ts:205`） |
| Snowflake Step1：输入想法 -> 生成 10 个 logline | doc/frontend_implementation_spec.md:752 | 同上 | ⚠️ | 未断言数量=10（只断言包含某条文本） |
| Snowflake Step2：选择 logline -> 生成故事结构 | doc/frontend_implementation_spec.md:753 | 同上 | ⚠️ | 仅烟测 Root ready 文案；未校验结构字段（theme/ending/three_disasters 等） |
| Snowflake Step3：生成角色小传（API） | doc/frontend_implementation_spec.md:980 | `SnowflakeFlow 核心流程` | ⚠️ | 只断言角色名可见；不验证卡片字段（doc/frontend_implementation_spec.md:762） |
| Snowflake Step4：生成场景骨架（API） | doc/frontend_implementation_spec.md:981 | `SnowflakeFlow 核心流程` | ⚠️ | 只断言场景标题可见 |
| Snowflake Step5a：生成幕结构（API） | doc/frontend_implementation_spec.md:982 | `SnowflakeFlow 核心流程` | ⚠️ | 仅等待 step5a request |
| Snowflake Step5b：生成章结构（API） | doc/frontend_implementation_spec.md:983 | `SnowflakeFlow 核心流程` | ⚠️ | 未显式等待 step5b；仅通过文案间接覆盖 |
| Snowflake Step6：生成锚点（API） | doc/frontend_implementation_spec.md:990 | `SnowflakeFlow 核心流程` | ⚠️ | 只验 anchors 数量文案；不验锚点字段/顺序/约束 |
| Snowflake Step6 完成后跳转编辑器 | doc/frontend_implementation_spec.md:754 | - | ❌ | 实现缺失（`project/frontend/src/views/SnowflakeView.vue:149`） |
| Simulation 主页面三栏布局/组件：AgentStatePanel + ActionTimeline + ArbitrationResult + ConvergenceIndicator | doc/frontend_implementation_spec.md:770 | `SimulationConsole 基本流程`、`SimulationConsole 核心流程` | ⚠️ | 仅覆盖部分组件可见；未覆盖 ArbitrationResult/ConvergenceIndicator 关键数据展示 |
| AgentStatePanel：beliefs/desires/intentions 展示 | doc/frontend_implementation_spec.md:774 | `SimulationConsole 基本流程` | ⚠️ | 只断言 panel 可见 |
| ActionTimeline：info_gain/agent_actions/conflicts_resolved 展示 | doc/frontend_implementation_spec.md:778 | `SimulationConsole 基本流程` | ⚠️ | 只断言容器/文案 |
| ConvergenceIndicator：(1-distance)*100 + 停滞告警/建议 | doc/frontend_implementation_spec.md:782 | - | ❌ | 未覆盖 distance/告警/建议 |
| Simulation：获取日志（API） | doc/frontend_implementation_spec.md:1019 | `SimulationConsole 核心流程` | ⚠️ | 只断言条数，缺字段/结构断言 |
| Simulation：单回合推演（API） | doc/frontend_implementation_spec.md:1017 | `SimulationConsole 核心流程` | ⚠️ | 断言仅“Converged”可见；不验回合数据 |
| Simulation：场景推演（API） | doc/frontend_implementation_spec.md:1018 | `SimulationConsole 核心流程` | ⚠️ | 仅验证日志条数变化 |
| DM：裁决（API） | doc/frontend_implementation_spec.md:1008；doc/系统架构与技术规格.md:19 | - | ❌ | 规格核心能力未验收 |
| DM：收敛检查（API） | doc/frontend_implementation_spec.md:1009；doc/系统架构与技术规格.md:669 | - | ❌ | 未验收收敛检查流程 |
| Editor：三栏布局 + 场景树 + Tabs（大纲/正文/推演日志）+ SceneContextPanel | doc/frontend_implementation_spec.md:790 | - | ❌ | 未覆盖该规格页面结构与交互 |
| Scene：获取场景上下文（API） | doc/frontend_implementation_spec.md:1046 | `SceneEditor 核心流程` | ⚠️ | 覆盖 happy path；无异常 |
| Scene：完成场景（API） | doc/frontend_implementation_spec.md:1043 | `SceneEditor 核心流程` | ⚠️ | 覆盖保存 request；不校验 payload |
| Scene：版本 diff（API） | doc/frontend_implementation_spec.md:1047 | `SceneEditor 核心流程` | ⚠️ | 覆盖 diff 文本；不验 commit 参数 |
| Scene：渲染场景（API，quality_scores） | doc/frontend_implementation_spec.md:1045 | `SceneEditor 核心流程` | ⚠️ | 只断言 content；不验 quality_scores |
| Scene：标记为脏（API） | doc/frontend_implementation_spec.md:1048 | - | ❌ | 未覆盖 |
| 审核：reviewChapter 端点（API） | doc/frontend_implementation_spec.md:1108 | - | ❌ | 未覆盖 approve/reject |
| 内容审核：review_status 字段（pending/approved/rejected） | doc/系统架构与技术规格.md:1879 | - | ❌ | 未覆盖 review_status 变化与 UI 展示 |
| World：四 Tab（实体/关系图谱/锚点/支线）与实体三栏 | doc/frontend_implementation_spec.md:798 | - | ❌ | 当前 E2E 覆盖的是简化版（无 tabs） |
| World：锚点时间线组件 AnchorTimeline | doc/frontend_implementation_spec.md:802 | - | ❌ | 未覆盖锚点进度/时间线 |
| World：列出实体（API） | doc/frontend_implementation_spec.md:1063 | `WorldManager 核心流程` | ⚠️ | 只断言文字出现；不验筛选/空态 |
| World：创建实体（API） | doc/frontend_implementation_spec.md:1062 | `WorldManager 核心流程` | ⚠️ | 只等待 request；不验证 UI 列表更新 |
| World：创建/更新关系（API） | doc/frontend_implementation_spec.md:1064 | - | ❌ | 未覆盖 |
| Anchor：更新锚点（API） | doc/frontend_implementation_spec.md:992 | - | ❌ | 未覆盖 |
| Anchor：检查可达性（API） | doc/frontend_implementation_spec.md:993；doc/系统架构与技术规格.md:27 | - | ❌ | 规格关键点（锚点不可达/动态补路），E2E 缺失 |
| World：列出支线（API） | doc/frontend_implementation_spec.md:1071 | `WorldManager 核心流程` | ⚠️ | 仅烟测列表文本 |
| World：创建支线（API） | doc/frontend_implementation_spec.md:1070 | - | ❌ | 未覆盖 |
| World：解决支线（API） | doc/frontend_implementation_spec.md:1072 | - | ❌ | 未覆盖 |
| 查询：RootSnapshot（关系图谱数据来源）（API） | doc/frontend_implementation_spec.md:1078 | `WorldManager 核心流程` | ⚠️ | 断言弱（仅包含 `"source"` 字符串） |
| 分支：创建分支（API） | doc/frontend_implementation_spec.md:1027 | - | ❌ | 未覆盖 |
| 分支：切换分支（API） | doc/frontend_implementation_spec.md:1029 | - | ❌ | 未覆盖 |
| 提交：commitScene（API） | doc/frontend_implementation_spec.md:1085 | - | ❌ | 未覆盖 |
| LLM：logicCheck（API） | doc/frontend_implementation_spec.md:1093 | - | ❌ | 未覆盖 |
| 递归反馈：feedbackLoop（API） | doc/frontend_implementation_spec.md:1101 | - | ❌ | 未覆盖 |

## 质量评估
### 选择器稳定性
- 优点：大量 `data-test` 选择器。
- 问题：仍存在结构选择器耦合，例如 `section.step-panel`（`project/frontend/tests/e2e/core.e2e.spec.ts:205`、`project/frontend/tests/e2e/snowflake.spec.ts:90`）。

### 断言完整性
- 主要问题：多数断言停留在“可见/请求发生/文本包含”，缺对业务结果的强断言。
  - Step1 不断言 logline 数量=10（`doc/frontend_implementation_spec.md:752`）。
  - Settings 用例不点击保存、不验证保存反馈（`project/frontend/tests/e2e/core.e2e.spec.ts:329`；对应 UI 有 `settings-save-status`，`project/frontend/src/views/SettingsView.vue:6`）。

### 等待策略
- 多用 `waitForRequest`（请求发出即可），对“响应成功 + UI 更新完成”覆盖不足，存在潜在 flake 风险。

### E2E 真实性
- 大量 `page.route` mock（例如 `project/frontend/tests/e2e/core.e2e.spec.ts:96` 起），更像前端契约/烟测，难发现真实后端契约问题。

## 问题清单（按严重程度）
### Critical
1. 端口/超时硬编码且与配置不一致：
   - baseURL/端口硬编码 5177（`project/frontend/tests/e2e/core.e2e.spec.ts:7`；`project/frontend/tests/e2e/snowflake.spec.ts:7`；`project/frontend/tests/e2e/simulation.spec.ts:7`）
   - dev server 启动硬编码 `--port 5177`（`project/frontend/tests/e2e/core.e2e.spec.ts:42` 等）
   - waitForServer 默认 15000ms（`project/frontend/tests/e2e/core.e2e.spec.ts:14` 等）
   - Playwright config 另用 baseURL 5173（`project/frontend/playwright.config.ts:9`）

2. 规格关键链路缺失：
   - Step6 完成应跳转编辑器（`doc/frontend_implementation_spec.md:754`），实现缺失（`project/frontend/src/views/SnowflakeView.vue:149`），测试也缺失。
   - HomeView 导航入口未覆盖（`doc/frontend_implementation_spec.md:925`）。

### High
1. E2E 真实性偏弱：大量 `page.route` mock（`project/frontend/tests/e2e/core.e2e.spec.ts:96` 起），难以发现联调/契约问题。
2. 审核/锚点可达性/支线等核心能力未被验收：
   - `anchorApi.checkAnchor`（`doc/frontend_implementation_spec.md:993`）
   - `reviewApi.reviewChapter`（`doc/frontend_implementation_spec.md:1108`；`review_status` 语义：`doc/系统架构与技术规格.md:1879`）
   - `subplotApi.resolveSubplot`（`doc/frontend_implementation_spec.md:1072`）

### Medium
1. DRY 违反：多个 spec 文件重复 devServer 启停与 waitForServer/jsonResponse（维护成本高）。
2. Playwright 配置与实际运行方式割裂：配置 baseURL/timeout，但测试内部自启服务并覆盖 baseURL，导致 config 形同虚设（`project/frontend/playwright.config.ts:6`）。

### Low
1. 计划文件放在测试目录且包含 `throw`：`project/frontend/tests/e2e/playwright.e2e.ts:42`（未来若命中 testMatch 会直接炸套件）。
2. 缺少异常/边界用例（空输入、4xx/5xx、超时等）。

## 结论
结论：FAIL
失败类型：测试问题
阻塞：覆盖度不足 + 配置硬编码/不一致 + 断言/真实性不足（详见“覆盖度矩阵/问题清单”）

## 建议
### P0（先止血：让测试配置一致且可复现）
1. 统一端口/超时来源：移除 E2E 中 5177/15000 等硬编码，使用可配置的环境变量/Playwright config，并对齐执行环境注入值（端口/等待/timeout）。
2. 统一 dev server 生命周期：用 Playwright `webServer` 启动一次前端服务，避免每个 spec 文件都启动/关闭一次。

### P1（补齐覆盖：按规格把关键链路测到）
1. 补 HomeView 导航与“从 Home 进入雪花流程/编辑器/世界观/推演”的主入口链路（`doc/frontend_implementation_spec.md:925`）。
2. 补 Snowflake Step6 -> Editor 的跳转与验收（`doc/frontend_implementation_spec.md:754`；实现需补齐后再测）。
3. 补 Editor 审核（approve/reject）与 review_status 变化的 E2E（`doc/frontend_implementation_spec.md:1108`；`doc/系统架构与技术规格.md:1879`）。
4. 补 World 锚点可达性检查、支线创建/解决等（`doc/frontend_implementation_spec.md:993`、`doc/frontend_implementation_spec.md:1070`、`doc/frontend_implementation_spec.md:1071`、`doc/frontend_implementation_spec.md:1072`）。

### P2（提高质量：让用例能抓住回归）
1. 强化断言：
   - Snowflake Step1 校验 logline 数量=10（`doc/frontend_implementation_spec.md:752`）
   - 校验关键请求 payload（idea/logline/root_id/branch_id 等）
   - World/Simulation 校验关键字段展示（info_gain、convergence distance、relations 数据结构等）
2. 整理测试目录：将 `project/frontend/tests/e2e/playwright.e2e.ts` 移出 `tests/e2e/` 或改名，避免未来误匹配。

【工具调用简报】
服务: serena
触发: 读取文档/代码、抽取行号证据、生成并写入报告文件
参数: read_file/search_for_pattern/create_text_file（relative_path 限定在 doc/ 与 project/frontend/）
结果: 输出覆盖度矩阵≥20、问题分级、改进建议，并写入 `doc/e2e_test_evaluation_report.md`
状态: 成功

服务: bash(shell_command)
触发: 执行验收命令获取可复现证据
参数: workdir=/home/zxh/ainovel_v3/project/frontend；cmd=`npm run test:e2e`
结果: Exit 0；7 passed（约 7.1s）
状态: 成功