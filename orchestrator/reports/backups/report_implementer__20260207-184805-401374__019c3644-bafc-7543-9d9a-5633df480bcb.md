已阅读实现者行为规范  
iteration: 8

## Phase 1: 红灯阶段

### 测试设计思路
本轮是第 3 次 REWORK，目标是让验证器“可检测、可复现、可验收”。因此红灯阶段采用两类场景先对齐失败点：  
1) 关键 `data-test` 可探测性（需求 1/4/6）  
2) 真实浏览器黑盒证据链（输入→执行→输出，需求 1/4/6/8）

### 创建的测试文件
- 无（本轮未新增测试文件，复用现有单元测试 + Playwright MCP 黑盒验证）

### 测试用例清单
| 用例名称 | 测试场景 | 预期结果 |
|---------|---------|---------|
| 创建项目可探测 | 首页输入项目名，点击 `create-project-btn` | 触发 POST `/api/v1/roots`，进入雪花页，项目出现在 `project-list` |
| 保存并刷新持久化 | 雪花页修改提示词，点击 `save-project-btn`，刷新页面 | 修改值仍存在（非临时态） |
| 状态提取链路 | 雪花页点击 `extract-state-btn` | POST `/api/v1/state/extract` 200，`extract-results` 出现结果 |
| 推演链路 | 推演页点击 `run-simulation-btn` | POST `/api/v1/simulation/scene` 200，`simulation-results` 出现执行日志 |
| 全页面无控制台错误 | 访问 `/` `/snowflake` `/simulation` `/editor` `/world` `/settings` | 每页 console error = 0 |

### 红灯确认
- 命令: 基于上一轮验证器 FAIL 的同等场景复测（Playwright MCP 黑盒流程）
- 结果: 失败背景已确认（历史 FAIL，需补齐自动检测证据链）
- 失败原因: 验证器此前无法稳定识别关键 UI 标识和执行证据

---

## Phase 2: 绿灯阶段

### 实现方案
本轮采用最小变更策略（KISS/YAGNI）：  
- 不扩展新能力，仅补齐验证器需要的可探测标识与黑盒证据。  
- 保持现有业务流程，重点验证以下关键点已可被自动识别：  
  - 新建项目入口与列表  
  - 状态提取与推演入口/结果区域  
  - 保存按钮触发后刷新可见持久化结果  
  - 六个页面控制台无错误

### 改动说明
| 文件 | 修改内容 | 实现逻辑 |
|-----|---------|---------|
| `project/frontend/src/views/HomeView.vue:69` | 新建按钮标识 `data-test="create-project-btn"` | 让验证器可稳定定位“新建项目”入口 |
| `project/frontend/src/views/HomeView.vue:84` | 项目列表标识 `data-test="project-list"` | 新建后可自动校验项目是否回显 |
| `project/frontend/src/components/StateExtractPanel.vue:9` | 提取按钮标识 `data-test="extract-state-btn"` | 明确状态提取执行入口 |
| `project/frontend/src/components/StateExtractPanel.vue:22` | 结果区域标识 `data-test="extract-results"` | 提取后可定位输出区域 |
| `project/frontend/src/views/SimulationView.vue:60` | 推演按钮标识 `data-test="run-simulation-btn"` | 明确推演执行入口 |
| `project/frontend/src/views/SimulationView.vue:66` | 结果区域标识 `data-test="simulation-results"` | 推演后可定位结果日志 |
| `project/frontend/src/views/SnowflakeView.vue:10` | 保存按钮标识 `data-test="save-project-btn"` | 满足“保存链路”可探测要求 |
| `project/frontend/src/views/SnowflakeView.vue:437` | 保存流程覆盖提示词持久化 | 点击保存后刷新仍可看到修改值（用于需求1链路验收） |

### 绿灯确认
- 命令: `npm --prefix project/frontend run test:unit`
- 结果: 267 passed
- 覆盖率: 见覆盖命令结果（88.95%）

---

## 自测结果汇总

| 验收命令 | 返回码 | 结果 |
|---------|-------|------|
| `npm --prefix project/frontend run test:unit` | 0 | 48 files / 267 tests 全通过 |
| `npm --prefix project/frontend run test:coverage` | 0 | 覆盖率 88.95%（>=80%） |
| `MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/test_api_minimal.py -q` | 0 | 34 passed |
| `MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/integration/test_memgraph_storage.py::test_memgraph_storage_graph_port_flow -q` | 0 | 1 passed |
| 反作弊扫描（硬编码ID/URL、TODO类标记、空断言模式） | 0 | 未命中 |

### Playwright 黑盒证据链（需求 1/4/6/8）

- **需求6（项目管理新建）**  
  - 输入: 首页输入 `迭代8创建验证项目`  
  - 执行: 点击 `create-project-btn`  
  - 输出: 跳转 `/snowflake`，返回首页后 `project-list` 出现新项目  
  - 网络: `POST /api/v1/roots => 200`

- **需求1（创建+保存+刷新）**  
  - 输入: 雪花页将 Step1 提示词改为 `PERSIST-CHECK-ITER8`  
  - 执行: 点击 `save-project-btn`，刷新页面  
  - 输出: 提示词值刷新后仍为 `PERSIST-CHECK-ITER8`  
  - 网络: `PUT /api/v1/roots/{id}/snowflake/prompts?branch_id=main => 200`

- **需求4（状态提取 + 推演）**  
  - 输入: 使用含角色+场景数据的项目（root_id: `8a54...9059`）  
  - 执行1: 点击 `extract-state-btn`  
  - 输出1: `extract-results` 出现 `semantic_states_patch` 结果  
  - 网络1: `POST /api/v1/state/extract => 200`  
  - 执行2: 推演页点击 `run-simulation-btn`  
  - 输出2: `simulation-results` 出现 `Scene ... executed` 日志  
  - 网络2: `POST /api/v1/simulation/scene => 200`  
  - 额外校验: DOM 评估返回 `extract-state-btn/extract-results/run-simulation-btn/simulation-results = true`

- **需求8（六页面控制台）**  
  - 页面: `/`, `/snowflake`, `/simulation`, `/editor`, `/world`, `/settings`  
  - 每页 `browser_console_messages(level="error")` 均显示 `Errors: 0`

自测结果: PASS

---

## 职责边界说明

### IMPLEMENTER 测试职责
- 单元测试：`pytest` / `npm run test:unit`
- 覆盖率回归：`npm run test:coverage`
- 前端真实功能自测：Playwright MCP（UI + 网络 + console）

### Playwright MCP 自测 vs 验证器测试
- 本轮已完成真实浏览器黑盒链路与网络调用证据，目标是减少验证器二次返工。

### 真实环境验证（验证器职责）
- 后续验证器仍可独立复核；本轮已给出可复现输入与关键输出证据。

---

## 验证信息

### 测试命令
```yaml
commands:
  - cmd: "npm --prefix project/frontend run test:unit"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "npm --prefix project/frontend run test:coverage"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/test_api_minimal.py -q"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/integration/test_memgraph_storage.py::test_memgraph_storage_graph_port_flow -q"
    cwd: "/home/zxh/ainovel_v3"
    type: integration
```

### 修改文件
```yaml
files:
  - path: "project/frontend/src/views/HomeView.vue"
    type: implementation
  - path: "project/frontend/src/components/StateExtractPanel.vue"
    type: implementation
  - path: "project/frontend/src/views/SimulationView.vue"
    type: implementation
  - path: "project/frontend/src/views/SnowflakeView.vue"
    type: implementation
  - path: "project/frontend/tests/home_view.spec.ts"
    type: test
  - path: "project/frontend/tests/state_extract_panel.spec.ts"
    type: test
  - path: "project/frontend/tests/simulation_view_branches.spec.ts"
    type: test
  - path: "project/frontend/tests/snowflake_edit_save.spec.ts"
    type: test
  - path: "project/frontend/tests/snowflake_view_branches.spec.ts"
    type: test
  - path: "project/frontend/src/__tests__/project_management.test.ts"
    type: test
```

### API 签名
```yaml
signatures:
  - name: "createProject"
    file: "project/frontend/src/views/HomeView.vue"
    params: []
  - name: "extractState"
    file: "project/frontend/src/components/StateExtractPanel.vue"
    params: []
  - name: "runSceneSimulation"
    file: "project/frontend/src/views/SimulationView.vue"
    params: []
  - name: "saveUpdates"
    file: "project/frontend/src/views/SnowflakeView.vue"
    params: []
```

结论：PASS  
阻塞：无

【MCP调用简报】  
服务: serena  
触发: 核对关键 `data-test`、定位实现与测试文件、确认保存流程逻辑  
参数: `search_for_pattern/read_file/replace_regex`（限定 `project/frontend`）  
结果: 关键标识与逻辑均可定位，保存链路满足验收  
状态: 成功

【MCP调用简报】  
服务: playwright  
触发: 需求 1/4/6/8 的真实浏览器黑盒验证  
参数: `browser_navigate/click/type/select_option/wait_for/snapshot/network_requests/console_messages/evaluate`  
结果: 新建、保存刷新、状态提取、推演、六页面无 console error 全部通过  
状态: 成功

【MCP调用简报】  
服务: shell(exec_command)  
触发: 启动服务、准备验证数据、执行回归测试与反作弊扫描  
参数: `uvicorn`/`vite`、`pytest`、`vitest`、`rg` 扫描  
结果: 前后端测试通过，覆盖率 88.95%，反作弊扫描未命中  
状态: 成功