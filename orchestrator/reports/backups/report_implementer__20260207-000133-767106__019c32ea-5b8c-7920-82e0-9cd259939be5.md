已阅读实现者行为规范  
iteration: 5

## Phase 1: 红灯阶段

### 测试设计思路
针对 SYNTHESIZER 指出的 `step5a 500` 风险，我先补了“最容易导致 500 的真实边界场景”测试：LLM 返回数组元素不是对象（例如字符串）。  
这类输入在旧逻辑里会触发 `act.get(...)` / `chapter.get(...)` 的 `AttributeError`，直接变成 500。  
同时补充前端 422 错误展示路径测试，避免把非字符串 `detail` 直接传给 UI 组件导致前端异常（此前浏览器有 `setAttribute('0')` 报错）。

### 创建的测试文件
- `project/backend/tests/test_api_minimal.py` - 新增 Step5a/Step5b 非对象输出回归测试（红灯→绿灯）
- `project/frontend/tests/api_error_handling.spec.ts` - 新增 Axios 非字符串错误详情规范化测试

### 测试用例清单
| 用例名称 | 测试场景 | 预期结果 |
|---------|---------|---------|
| `test_step5a_returns_422_when_engine_returns_non_object_act` | Step5a 返回 `["malformed"]` | 返回 422，不再 500 |
| `test_step5b_returns_422_when_engine_returns_non_object_chapter` | Step5b 返回非对象章节项 | 返回 422，不再 500 |
| `normalizes non-string detail before showing error message` | 前端收到 422 的 `detail` 数组 | 转成字符串展示，不触发 UI 异常 |

### 红灯确认
- 命令: `/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/test_api_minimal.py -k "step5a_returns_422_when_engine_returns_non_object_act or step5b_returns_422_when_engine_returns_non_object_chapter" -q`
- 结果: 失败（预期）
- 失败原因: 旧逻辑对 `act/chapter` 直接 `.get()`，触发 `AttributeError` 导致 500

## Phase 2: 绿灯阶段

### 实现方案
- 后端：在 Step5a/Step5b 的循环中增加**显式结构校验**（必须是对象/映射），非法即 422，快速失败，避免 500。
- 前端：统一把 `AxiosError.response.data.detail` 做字符串化后再展示，避免把数组对象直接喂给 UI 消息组件。
- 保持最小改动，不引入兜底分支，不改业务主流程（KISS/YAGNI）。

### 改动说明
| 文件 | 修改内容 | 实现逻辑 |
|-----|---------|---------|
| `project/backend/app/main.py:13` | 引入 `Mapping` | 为 Step5 条目类型校验提供类型支持 |
| `project/backend/app/main.py:408` | Step5a 条目校验 | 非对象 act 直接 422（`step5a act item must be object`） |
| `project/backend/app/main.py:448` | Step5b act 校验 | 非对象 act 直接 422 |
| `project/backend/app/main.py:467` | Step5b chapter 校验 | 非对象 chapter 直接 422 |
| `project/backend/tests/test_api_minimal.py:43` | 新增 `MalformedStep5Engine` / `DummyStep5Storage` | 构造稳定复现 500 的最小测试桩 |
| `project/backend/tests/test_api_minimal.py:540` | 新增 Step5a 回归测试 | 锁定“非对象输出必须 422” |
| `project/backend/tests/test_api_minimal.py:572` | 新增 Step5b 回归测试 | 锁定“非对象输出必须 422” |
| `project/frontend/src/api/index.ts:14` | 错误 detail 类型改为 `unknown` | 接受后端 422 数组型 detail |
| `project/frontend/src/api/index.ts:17` | `detail` 非字符串时 `JSON.stringify` | 消除 UI 层 `InvalidCharacterError` 风险 |
| `project/frontend/tests/api_error_handling.spec.ts:36` | 新增前端回归测试 | 锁定非字符串 detail 的展示行为 |

### 绿灯确认
- 命令: `/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/test_api_minimal.py -k "step5a_returns_422_when_engine_returns_non_object_act or step5b_returns_422_when_engine_returns_non_object_chapter" -q`
- 结果: `2 passed`
- 覆盖率: 已纳入后续全量覆盖命令统计（前端 Branch `80.45%`）

## 自测结果汇总

| 验收命令 | 返回码 | 结果 |
|---------|-------|------|
| `/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/test_api_minimal.py -k "step5a_returns_422_when_engine_returns_non_object_act or step5b_returns_422_when_engine_returns_non_object_chapter" -q` | 0 | 2 passed（Step5 回归通过） |
| `/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit/test_topone_gateway_structured.py project/backend/tests/test_api_minimal.py project/backend/tests/integration/test_snowflake_step5.py -q` | 0 | 39 passed |
| `/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit/test_config.py project/backend/tests/test_topone_client.py -q` | 0 | 21 passed（超时配置相关） |
| `npm run test:unit -- tests/api_error_handling.spec.ts`（cwd: `project/frontend`） | 0 | 1 passed |
| `npm run test:coverage`（cwd: `project/frontend`） | 0 | 260 passed，Branch 80.45% |
| `grep -RIn ...` 反作弊扫描（限定代码目录，排除 `.venv/node_modules/dist`） | 0 | 三类模式均空结果 |
| Playwright MCP：`/snowflake` Step1/2/3、Simulation Step/Scene、`/editor` Chapter Render | N/A | 真实浏览器链路可执行；网络请求可见，Render 返回 200 |

自测结果: PASS

## 职责边界说明

### IMPLEMENTER 测试职责

你负责执行以下测试，确保代码逻辑正确：

| 测试类型 | 工具 | 目的 |
|---------|------|------|
| 单元测试 | Bash (`pytest`) | 验证函数逻辑 |
| 前端单元测试 | Bash (`npm run test:unit`) | 验证组件逻辑 |
| E2E 脚本测试 | Bash (`npx playwright test`) | 验证页面流程（Mock 后端） |
| **前端功能自测** | **Playwright MCP** | **验证真实浏览器中的 UI 和交互** |

### Playwright MCP 自测 vs 验证器测试

| 维度 | IMPLEMENTER 自测 | 验证器测试 |
|------|-----------------|-----------|
| 工具 | Playwright MCP | Playwright MCP |
| 目的 | 开发调试、快速反馈 | 独立验证、质量把关 |
| 时机 | 开发过程中随时使用 | 代码提交后 |
| 标准 | 功能基本可用 | 严格验收标准 |
| 网络验证 | 可选 | **必须**验证 API 请求 |

**关键区别**：
- 你的自测是为了**快速发现和修复问题**
- 验证器测试是为了**独立验证质量**，会检测 mock 数据等作弊行为
- 你应该在自测通过后再提交，减少验证器返工

### 真实环境验证（验证器职责）

真实浏览器验证由后续验证器（TEST_RUNNER、EDGE_CASE_TESTER、FINISH_REVIEW）执行。

验证器会执行更严格的检查：
- **网络请求验证**：确保 API 真正被调用，而非 mock 数据
- 前后端集成问题
- 真实数据格式问题
- 边界条件处理问题

你只需确保：
- ✅ 前端服务可正常启动  
- ✅ 后端 API 可正常响应  
- ✅ 代码无明显的运行时错误  
- ✅ 命令行测试全部通过  
- ✅ Playwright MCP 自测基本功能正常  

## 补充验收证据（需求缺口补齐）

- TopOne 超时配置（>=10分钟）：
  - 前端 `project/frontend/src/api/index.ts:8` → `timeout: 600000`（毫秒）
  - 后端 `project/backend/app/config.py:36` → `TOPONE_MIN_TIMEOUT_SECONDS = 600.0`
  - 后端 `project/backend/app/config.py:37` + `project/backend/app/services/topone_client.py:57` → 默认与校验均强制 `>=600s`
- 章节产出统计（根 `64f2f042-99af-4bb9-8d81-e6aa3ab1ecfb`，读取 `/api/v1/chapters/{id}` 的 `rendered_content`）：
  - `chapter_count=10`
  - `empty_rendered_content=0`
  - 非标点空白字符：`min=2647` / `max=3540` / `avg=3047.0`
  - 主题关键词命中：`何方=10章`，`赛博=6章`
- 浏览器网络证据（节选）：
  - `POST /api/v1/snowflake/step1 => 200`
  - `POST /api/v1/snowflake/step2 => 200`
  - `POST /api/v1/snowflake/step3 => 200`
  - `POST /api/v1/simulation/round => 200`
  - `POST /api/v1/chapters/{chapter_id}/render => 200`
- 说明：复跑 Step4 时在“持久化简化角色结构”场景会返回 422（非500）；本轮前端已把该 422 的数组 detail 正常字符串化展示，避免 UI 崩溃型控制台异常。

## 验证信息

### 测试命令
```yaml
commands:
  - cmd: "/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/test_api_minimal.py -k \"step5a_returns_422_when_engine_returns_non_object_act or step5b_returns_422_when_engine_returns_non_object_chapter\" -q"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit/test_topone_gateway_structured.py project/backend/tests/test_api_minimal.py project/backend/tests/integration/test_snowflake_step5.py -q"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit/test_config.py project/backend/tests/test_topone_client.py -q"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "npm run test:unit -- tests/api_error_handling.spec.ts"
    cwd: "/home/zxh/ainovel_v3/project/frontend"
    type: unit
  - cmd: "npm run test:coverage"
    cwd: "/home/zxh/ainovel_v3/project/frontend"
    type: unit
```

### 修改文件
```yaml
files:
  - path: "project/backend/app/main.py"
    type: implementation
  - path: "project/frontend/src/api/index.ts"
    type: implementation
  - path: "project/backend/tests/test_api_minimal.py"
    type: test
  - path: "project/frontend/tests/api_error_handling.spec.ts"
    type: test
```

### API 签名
```yaml
signatures:
  - name: "generate_act_list_endpoint"
    file: "project/backend/app/main.py"
    params: ["payload", "engine", "storage"]
  - name: "generate_chapter_list_endpoint"
    file: "project/backend/app/main.py"
    params: ["payload", "engine", "storage"]
```

结论：PASS  
阻塞：无

【MCP调用简报】  
服务: serena  
触发: 初始代码定位与结构审查（step5a/step5b、超时配置、测试文件）  
参数: activate_project/check_onboarding/read/search（后续服务超时后降级本地命令）  
结果: 完成关键定位；serena 后续调用超时，按降级策略改用本地 Bash/Python 工具  
状态: 成功（含降级）

【MCP调用简报】  
服务: playwright  
触发: 真实浏览器链路自测（Snowflake/Simulation/Editor）  
参数: browser_navigate/click/type/snapshot/network_requests/console_messages/wait_for  
结果: 采集到 Step1~3、Simulation、Chapter Render 的真实请求与响应；验证 Render 200 与页面可用  
状态: 成功