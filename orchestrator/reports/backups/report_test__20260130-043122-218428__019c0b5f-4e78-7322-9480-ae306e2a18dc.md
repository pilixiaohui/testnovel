已阅读测试行为规范
iteration: 5

## 测试需求分析

工单要求测试的功能点：
1. 后端 SceneRenderPayload 必填字段校验（voice_dna/conflict_type/outline_requirement/user_intent/expected_outcome）
2. 空 payload 调用应返回 422 校验错误
3. 完整 payload 调用应成功返回 rendered content
4. 或：新增 minimal render 端点接受 scene_id 自动填充上下文（本次测试选择“前端传完整字段”路径）

## 测试设计

### 设计思路
以 FastAPI TestClient 验证后端渲染端点的请求校验与成功路径，同时用静态代码检查确保前端 EditorView 具备完整渲染 payload 字段，从而锁定前后端契约一致性。

### 创建的测试文件
- `project/backend/tests/unit/test_render_contract.py` - 渲染接口契约与前端调用字段一致性测试

### 测试用例清单

| 用例名称 | 测试场景 | 对应功能点 | 测试逻辑说明 |
|---------|---------|-----------|-------------|
| test_render_scene_empty_payload_returns_422 | 空 payload | 功能点2 | POST render 接口空 body，断言 422 |
| test_render_scene_missing_required_field_returns_422 | 缺失必填字段 | 功能点1 | 参数化移除每个必填字段，断言 422 |
| test_render_scene_full_payload_returns_content | 正常流程 | 功能点3 | 传完整 payload，断言 200 与 content |
| test_frontend_render_scene_payload_contains_required_fields | 前端契约 | 功能点1/3 | 读取 EditorView，断言必填字段出现在文件中 |

### 关键测试逻辑
- 测试数据准备：构造完整 payload（含 5 个必填字段 + world_state）。
- 调用接口/函数：使用 TestClient 调用 `/api/v1/scenes/{scene_id}/render`，并设置 `branch_id` 查询参数；依赖注入 DummyGateway/DummyStorage。
- 断言条件：空/缺字段返回 422；完整 payload 返回 200 且 content 正确；前端文件包含 5 个字段名。
- 设计理由：后端校验与前端字段一致性同时覆盖，保证前端可满足后端契约。

## 测试执行

- 命令: `MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/unit/test_render_contract.py -v`
- 结果: 失败
- 红灯确认: 是（前端 EditorView 未包含必填字段）

### 执行详情
- 失败用例：`test_frontend_render_scene_payload_contains_required_fields`
- 失败原因：EditorView 中缺少 `voice_dna/conflict_type/outline_requirement/user_intent/expected_outcome` 字段名。

## 验收标准

- 命令: `MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/unit/test_render_contract.py -v`
- 阈值: 测试可运行，且当前因实现未完成出现红灯

结论：PASS
阻塞：无

【MCP调用简报】
服务: serena
触发: 读取被测代码与前端调用、编写测试、执行测试
参数: read_file/search_for_pattern/create_text_file/execute_shell_command（均使用 max_answer_chars: -1 或默认要求）
结果: 新增测试文件 1 个；测试执行 1 次，红灯 1 处
状态: 成功