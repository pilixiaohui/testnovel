已阅读开发行为规范
iteration: 13
self_test: enabled

## 任务理解

工单要求实现的功能：
1. 新增章节渲染端点 `POST /api/v1/chapters/{chapter_id}/render`。
2. 章节不存在返回 404，渲染失败返回 400。
3. 返回 `rendered_content`，并在 prompt 中明确 2000 字左右要求（不做强校验）。

## 实现方案

### 设计思路
- 复用现有 ToponeGateway 渲染逻辑，通过构造 SceneRenderPayload 生成章节正文（KISS）。
- 先取章、再渲染、再持久化，任一步失败立即返回错误（快速失败）。
- 不引入额外兜底或重试，保持端点简单（YAGNI）。

### 改动说明

| 文件 | 修改内容 | 实现逻辑 |
|-----|---------|---------|
| `project/backend/app/main.py:589` | 新增章节渲染端点 | 获取章节 → 组装渲染 payload → 调用 gateway.render_scene → 更新章节 rendered_content → 返回结果 |

### 关键实现逻辑
- 数据流向：`get_chapter` → 构造 `SceneRenderPayload` → `gateway.render_scene` → `update_chapter`。
- 关键算法/处理步骤：`outline_requirement` 拼接章节标题/焦点，并强调“约2000字”。
- 异常处理策略：章节不存在 404；渲染异常 400；存储更新异常按现有模式处理。
- 与其他模块交互方式：复用 ToponeGateway 的 `render_scene` 与 GraphStoragePort 的 `get_chapter/update_chapter`。

## 自测结果（仅 enabled 模式）

### 验收结果汇总

| 序号 | 命令 | 返回码 | 结果摘要 |
|-----|------|-------|---------|
| 1 | `MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/integration/test_chapter_render_api.py -v` | 0 | 3 passed, 2 warnings |

- 全部验收命令已执行: 是
- 自测结果: PASS
- 覆盖率: 未输出（未开启覆盖率参数）

### 测试详情
- `tests/integration/test_chapter_render_api.py` 全部通过。
- 警告：FastAPI `on_event` deprecation（不影响本次验收）。

## 测试问题反馈（如有）

无

## 总结与展望
- 已完成：新增章节渲染 API，支持返回正文并持久化更新。
- 原则应用：KISS（复用现有 render_scene），YAGNI（不加兜底/重试），DRY（统一 payload 构造），SOLID（端点职责清晰）。
- 遇到的挑战：无。
- 下一步建议：如需更精确的章节风格控制，可引入专用章节渲染 prompt（非本次验收要求）。

结论：PASS
阻塞：无

【MCP调用简报】
服务: serena
触发: 新增章节渲染端点并修复语法
参数: search_for_pattern/read_file/replace_regex（relative_path=project/backend/app/main.py）
结果: 新端点已插入并通过测试
状态: 成功