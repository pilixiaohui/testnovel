已阅读开发行为规范  
iteration: 13  
self_test: enabled

## 任务理解

工单要求实现的功能：
1. 修复 state_extract/state_commit 契约，按 StateProposal[] 展示并用 query 传 root_id/branch_id
2. renderChapter 使用 rendered_content 字段，移除占位章节并改为真实数据
3. Step6 跳转移除固定 sleep
4. 移除版本控制 DEV 伪造提交历史
5. 章节审核基于真实章节数据

## 实现方案

### 设计思路
- 以契约一致为先：前端按后端字段/参数组织数据，移除占位与 DEV 兜底（KISS/YAGNI）。
- 章节数据使用真实 API 拉取，拒绝伪造默认值（快速失败）。
- 复用现有 snowflakeApi / llmApi / branchApi，避免新增抽象（DRY/SOLID）。

### 改动说明

| 文件 | 修改内容 | 实现逻辑 |
|-----|---------|---------|
| `project/frontend/src/components/StateExtractPanel.vue:91` | state_extract 解析为 StateProposal[] | 不再解析 entity_changes/relation_changes，直接展示 proposals 列表 |
| `project/frontend/src/components/StateExtractPanel.vue:109` | state_commit 改为 query + body proposals | 使用 `llmApi.stateCommit(rootId, branchId, proposals)` |
| `project/frontend/src/api/llm.ts:10` | stateCommit API 参数调整 | root_id/branch_id 走 query，body 仅为 proposals |
| `project/frontend/src/views/EditorView.vue:346` | renderChapter 读取 rendered_content | 与后端字段一致 |
| `project/frontend/src/views/EditorView.vue:358` | 移除占位章节，改为 listActs/listChapters | 真实拉取章节并写入 store |
| `project/frontend/src/views/EditorView.vue:436` | 移除 DEV 提交历史兜底 | 仅展示真实返回 |
| `project/frontend/src/views/SnowflakeView.vue:161` | Step6 去除固定 sleep | 直接在 API 完成后跳转 |
| `project/frontend/src/api/chapter.ts:11` | ChapterRenderResponse 字段修正 | 使用 rendered_content |

### 关键实现逻辑
- state_extract：响应必须为 StateProposal[]，非数组直接报错并显示错误提示。
- state_commit：以 query 携带 root_id/branch_id，body 发送 proposals 列表后刷新实体/锚点/支线。
- 章节数据：通过 `/roots/{id}/acts` + `/acts/{id}/chapters` 拉取，空则展示“暂无章节”。
- Step6：anchors 生成完成后立即跳转 editor，去除固定 sleep。
- 版本控制：历史展示只依赖真实接口结果，不再注入 DEV 伪造数据。

## 自测结果（仅 enabled 模式）

### 验收结果汇总

| 序号 | 命令 | 返回码 | 结果摘要 |
|-----|------|-------|---------|
| 1 | `cd /home/zxh/ainovel_v3/project/frontend && npm run test:e2e` | 非零 | 8 passed, 7 failed |

- 全部验收命令已执行: 是  
- 自测结果: FAIL

### 测试详情
失败集中在测试仍使用旧契约/占位数据：state_extract 预览形态、renderChapter 字段、章节列表来源、Snowflake Step6 行为、提交历史依赖等。

## 测试问题反馈

问题类型：测试依赖问题

### 我的实现逻辑
- state_extract 按后端契约返回 `StateProposal[]`；state_commit 使用 query 传 root_id/branch_id + body proposals。
- renderChapter 使用 `rendered_content` 字段；章节列表来自真实 listActs/listChapters，不再注入占位章节。
- Step6 完成后立即跳转 editor（无固定 sleep）。
- 版本控制不再使用 DEV 伪造提交历史。

### 测试代码问题
- `project/frontend/tests/e2e/state-extract.spec.ts:63` - mock 仍为 `{entity_changes, relation_changes}`，应改为 `StateProposal[]` 并匹配 query/body 规范。
- `project/frontend/tests/e2e/chapter-render.spec.ts:63` - mock 仍为 `content` 字段，且未 mock listActs/listChapters，导致无章节可渲染。
- `project/frontend/tests/e2e/core.e2e.spec.ts:232` - 仍断言 Step6 后留在 Snowflake 页显示 Anchors，而新行为应跳转到 Editor。
- `project/frontend/tests/e2e/core.e2e.spec.ts:343` - 审核依赖占位章节，需改为 listActs/listChapters mock。
- `project/frontend/tests/e2e/version-control.spec.ts:89` - 移除 DEV 兜底后需确保接口 mock 完整且数据形态匹配真实返回。

### 问题分析
当前测试仍使用旧契约/占位数据，导致真实实现无法满足断言（章节缺失、字段不一致、Step6 行为变化、提交历史为空）。

### 需求依据
工单修复清单要求：
- state_extract/state_commit 契约修复
- renderChapter 使用 rendered_content
- 移除占位章节与 DEV 伪造数据
- Step6 移除固定 sleep 并跳转 editor

### 建议修改
- 按新契约更新 `state-extract.spec.ts` 与 `chapter-render.spec.ts` mock 数据形态；
- 为章节相关测试补充 listActs/listChapters mock；
- 更新 `core.e2e.spec.ts` Step6 断言为跳转行为；
- 确保 version-control mocks 与真实接口一致。

结论：BLOCKED  
阻塞：测试代码问题，建议派发 REVIEW 调查

【MCP调用简报】  
服务: serena  
触发: 定位/修改实现与获取行号  
参数: `read_file/search_for_pattern/replace_regex`（限定文件路径，max_answer_chars=-1）  
结果: 更新 StateExtractPanel、llm.ts、EditorView、SnowflakeView、chapter.ts  
状态: 成功