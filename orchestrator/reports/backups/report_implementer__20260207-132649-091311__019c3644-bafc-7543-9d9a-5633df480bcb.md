已阅读实现者行为规范
iteration: 1

## Phase 1: 红灯阶段

### 测试设计思路
本轮聚焦上轮遗留风险：`Step3` 在 root 快照缺少 `three_disasters` 时触发后端 `422`。  
测试目标分两类：
1. 前端前置校验（快速失败）：缺少前置数据时应在前端拦截，不发起无效请求。  
2. 设置接口回归：`/api/v1/settings/llm` 需可读可写且读写一致。

### 创建的测试文件
- `project/frontend/tests/snowflake_view_branches.spec.ts:257` - 覆盖“root 不完整时 Step3 阻断”的前端回归场景。
- `project/backend/tests/test_api_minimal.py:1178` - 覆盖 LLM 设置接口读写回归（round-trip）。

### 测试用例清单
| 用例名称 | 测试场景 | 预期结果 |
|---------|---------|---------|
| step3_requires_complete_root | root 缺少 `three_disasters`，点击 Run Step 3 | 前端报错并阻断请求 |
| llm_settings_round_trip | GET 初始配置 -> PUT 新配置 -> GET 回读 | 回读值与写入值一致 |

### 红灯确认
- 命令: `Playwright MCP: browser_click(data-test="snowflake-step3-submit")`（在 root 不完整上下文）
- 结果: 失败（预期）
- 失败原因: 前置条件不满足（`three_disasters` 缺失），触发快速失败提示，阻断无效流程

---

## Phase 2: 绿灯阶段

### 实现方案
采用最小改动、快速失败策略：
- 在 Snowflake 步骤执行前增加统一 root 校验（KISS + DRY）。
- 对 Step5 增加 root_id 前置约束，避免无意义后端调用（YAGNI：仅补当前必需约束）。
- 增加前后端回归测试，验证行为稳定（SOLID-SRP：校验逻辑与流程执行分离）。

### 改动说明
| 文件 | 修改内容 | 实现逻辑 |
|-----|---------|---------|
| `project/frontend/src/views/SnowflakeView.vue:284` | 新增 `requireRootForStep(step)` | 统一校验 root 与 `three_disasters` 长度，前置失败即中断 |
| `project/frontend/src/views/SnowflakeView.vue:440` | Step3/4/5 改用前置校验 | 避免将不完整 root 传给 step API，减少 422 |
| `project/frontend/src/views/SnowflakeView.vue:466` | Step5 增加 `root_id` 必填校验 | 未完成 Step4 时直接报错，不走后端 |
| `project/frontend/tests/snowflake_view_branches.spec.ts:257` | 新增 Step3 阻断断言 | 验证不调用 `fetchSnowflakeStep3` 且错误提示正确 |
| `project/backend/tests/test_api_minimal.py:1178` | 新增 settings round-trip 测试 | 验证 `/api/v1/settings/llm` GET/PUT 一致性 |

### 绿灯确认
- 命令: `npm --prefix project/frontend run test:unit`
- 结果: `266 passed`
- 覆盖率: `All files - Statements 88.79% / Branches 80.85% / Functions 89.79% / Lines 88.78%`

---

## 自测结果汇总

| 验收命令 | 返回码 | 结果 |
|---------|-------|------|
| `npm --prefix project/frontend run test:unit` | 0 | PASS（48 files, 266 tests） |
| `npm --prefix project/frontend run test:coverage` | 0 | PASS（覆盖率达标，>=80%） |
| `/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/test_api_minimal.py -q` | 0 | PASS（34 passed） |
| `/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/test_models.py -q` | 0 | PASS（7 passed） |
| `grep -rn "'scene-1'\|'root-1'\|'test-id'" project/frontend/src project/backend/app project/frontend/tests project/backend/tests` | 1 | PASS（空结果） |
| `grep -rn "localhost\|127.0.0.1" project/frontend/src project/backend/app project/frontend/tests project/backend/tests` | 1 | PASS（空结果） |
| `grep -rn "TODO\|FIXME\|XXX\|HACK" project/frontend/src project/backend/app project/frontend/tests project/backend/tests` | 1 | PASS（空结果） |
| Playwright MCP：创建项目、切页、Step3 前置校验、Settings 读取 | N/A | PASS（无 console error，网络请求符合预期） |

自测结果: PASS

---

## 遇到的挑战与处理
- 挑战：历史 root 快照字段不完整会在后续步骤触发 422，错误暴露在后端。  
- 处理：将失败前移到前端步骤入口（`project/frontend/src/views/SnowflakeView.vue:284`），直接提示用户先完成 Step2，避免无意义请求。

## 原则应用说明（KISS/YAGNI/DRY/SOLID）
- KISS：只在步骤入口增加轻量校验，不引入新依赖/复杂状态机。
- YAGNI：不扩展额外流程，仅修复当前 422 与配置读写回归需求。
- DRY：用 `requireRootForStep` 复用 Step3/4/5 的共同前置校验。
- SOLID（SRP）：把“流程前置校验”与“步骤执行”职责分开，测试也按职责拆分。

## 下一步建议
1. 补一条集成测试：覆盖“从旧 root 快照恢复后，Step2 -> Step3”完整闭环，确保用户路径清晰。  
2. 若需要彻底消除历史数据差异，可评估后端 root 快照模型中 `three_disasters` 的持久化契约统一（单独迭代处理）。

---

## 职责边界说明

### IMPLEMENTER 测试职责
| 测试类型 | 工具 | 目的 |
|---------|------|------|
| 单元测试 | Bash (`pytest`) | 验证后端函数/API逻辑 |
| 前端单元测试 | Bash (`npm run test:unit`) | 验证组件与状态逻辑 |
| 覆盖率测试 | Bash (`npm run test:coverage`) | 验证覆盖率门槛 |
| 前端功能自测 | Playwright MCP | 验证真实浏览器交互与网络行为 |

### Playwright MCP 自测 vs 验证器测试
| 维度 | IMPLEMENTER 自测 | 验证器测试 |
|------|-----------------|-----------|
| 工具 | Playwright MCP | Playwright MCP |
| 目的 | 开发调试、快速反馈 | 独立验收、质量把关 |
| 时机 | 开发中 | 提交后 |
| 网络验证 | 本轮已验证关键请求 | 验证器会做更严格验证 |

---

## 验证信息

### 测试命令
```yaml
commands:
  - cmd: "npm --prefix project/frontend run test:unit"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "npm --prefix project/frontend run test:coverage"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/test_api_minimal.py -q"
    cwd: "/home/zxh/ainovel_v3/project/backend"
    type: unit
  - cmd: "/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/test_models.py -q"
    cwd: "/home/zxh/ainovel_v3/project/backend"
    type: unit
```

### 修改文件
```yaml
files:
  - path: "project/frontend/src/views/SnowflakeView.vue"
    type: implementation
  - path: "project/frontend/tests/snowflake_view_branches.spec.ts"
    type: test
  - path: "project/backend/tests/test_api_minimal.py"
    type: test
```

### API 签名
```yaml
signatures:
  - name: "requireRootForStep"
    file: "project/frontend/src/views/SnowflakeView.vue"
    params: ["step"]
  - name: "test_llm_settings_round_trip"
    file: "project/backend/tests/test_api_minimal.py"
    params: []
  - name: "get_llm_settings_endpoint"
    file: "project/backend/app/main.py"
    params: []
  - name: "save_llm_settings_endpoint"
    file: "project/backend/app/main.py"
    params: ["payload"]
```

结论：PASS  
阻塞：无

【MCP调用简报】  
服务: serena  
触发: 代码定位、实现核查、测试执行与反作弊扫描  
参数: `relative_path` 限定 `project/frontend` 与 `project/backend`，`max_answer_chars=-1`  
结果: 完成缺陷闭环验证；前后端测试与覆盖率均通过  
状态: 成功

【MCP调用简报】  
服务: playwright  
触发: 真实浏览器自测（项目创建、页面切换、Step3 前置校验、Settings 网络验证）  
参数: `browser_navigate/click/type/snapshot/console_messages/network_requests/close`  
结果: 关键流程可用；Step3 在不完整 root 下前端快速失败且无后端 step3 请求；无控制台错误  
状态: 成功