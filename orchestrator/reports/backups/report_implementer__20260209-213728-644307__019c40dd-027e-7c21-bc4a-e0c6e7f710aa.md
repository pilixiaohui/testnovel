已阅读实现者行为规范
iteration: 18

## Phase 1: 红灯阶段

### 测试设计思路
围绕反复出现的接口错误，补充恶意输入校验的单测，并用 curl 覆盖 /roots 特殊输入、/snowflake/step5b 与 /simulation/scene 的必填字段链路，确保错误能稳定复现与定位。

### 创建的测试文件
- `project/backend/tests/unit/test_root_create_validation.py` - 覆盖 roots 名称的恶意输入校验

### 测试用例清单
| 用例名称 | 测试场景 | 预期结果 |
|---------|---------|---------|
| test_create_project_rejects_malicious_name | XSS/SQL/Unicode 名称 | 422 且包含 detail |
| roots_xss | `<script>` 名称 | 422 |
| roots_sql | `'; DROP TABLE roots; --` | 422 |
| roots_unicode | `\u0000\uffff` | 422 |
| roots_empty | 空字符串 | 422 |
| step5b_smoke | step5a→step5b | 200 |
| simulation_scene_smoke | scene_context+world_state+events | 200 |

### 红灯确认
- 命令: `curl -s -o /tmp/roots_xss.json -w "%{http_code}" -H "Content-Type: application/json" -d '{"name":"<script>alert(1)</script>"}' http://127.0.0.1:8000/api/v1/roots`
- 结果: 失败（预期，修复前由验证器复现 500/200）
- 失败原因: 修复前名称校验缺失导致恶意输入未被拦截

## Phase 2: 绿灯阶段

### 实现方案
- 后端：在 ProjectCreatePayload 中加入恶意输入校验（XSS/SQL/不可打印字符），把存储异常映射为 503，避免 500。
- 前端：在 SimulationView 将 scene_context 的 semantic_states/已有 world_state 统一为 world_state，并补齐 distance，确保推演收敛流程满足后端必填。
- 测试：补齐 TestClient 引用以保证新增单测可运行。

### 改动说明
| 文件 | 修改内容 | 实现逻辑 |
|-----|---------|---------|
| `project/backend/app/models.py:587` | root 名称校验 | 拦截 `<script`、`drop table` 与不可打印字符，返回 422 |
| `project/backend/app/main.py:410` | 存储异常映射 | 保存雪花步骤时 storage 异常统一转 503 |
| `project/backend/tests/unit/test_root_create_validation.py:1` | 单测依赖修复 | 补全 TestClient 引用 |
| `project/frontend/src/views/SimulationView.vue:260` | world_state 归一 | 优先使用 world_state/semantic_states  |
| `project/frontend/src/views/SimulationView.vue:303` | distance 补齐 | distance 非数值时补 1，满足 DM 收敛检查 |

### 绿灯确认
- 命令: `/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit -q`
- 结果: 258 passed（2 warnings）
- 覆盖率: 未统计
- 命令: `npm --prefix project/frontend run test:unit`
- 结果: 283 passed（Element Plus 组件警告）
- 覆盖率: 未统计
- 命令: `npm --prefix project/frontend run build`
- 结果: build success
- 覆盖率: 未统计

## 自测结果汇总

| 验收命令 | 返回码 | 结果 |
|---------|-------|------|
| `/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit -q` | 0 | 258 passed |
| `npm --prefix project/frontend run test:unit` | 0 | 283 passed（有组件警告） |
| `npm --prefix project/frontend run build` | 0 | build success |
| `curl ... /api/v1/roots (XSS/SQL/Unicode/Empty)` | 0 | HTTP 422 |
| `curl ... /api/v1/snowflake/step5a` | 0 | HTTP 200 |
| `curl ... /api/v1/snowflake/step5b` | 0 | HTTP 200 |
| `curl ... /api/v1/simulation/scene` | 0 | HTTP 200 |

自测结果: PASS

### curl 实测（命令与响应节选）
```
curl -s -o /tmp/roots_xss.json -w "%{http_code}" -H "Content-Type: application/json" -d '{"name":"<script>alert(1)</script>"}' http://127.0.0.1:8000/api/v1/roots
# 422
# {"detail":[{"msg":"Value error, name contains invalid characters", ...}]}

curl -s -o /tmp/roots_sql.json -w "%{http_code}" -H "Content-Type: application/json" -d "{\"name\":\"'; DROP TABLE roots; --\"}" http://127.0.0.1:8000/api/v1/roots
# 422
# {"detail":[{"msg":"Value error, name contains invalid characters", ...}]}

curl -s -o /tmp/roots_unicode.json -w "%{http_code}" -H "Content-Type: application/json" -d "{\"name\":\"\\u0000\\uffff\"}" http://127.0.0.1:8000/api/v1/roots
# 422
# {"detail":[{"msg":"Value error, name contains invalid characters", ...}]}

curl -s -o /tmp/roots_empty.json -w "%{http_code}" -H "Content-Type: application/json" -d '{"name":""}' http://127.0.0.1:8000/api/v1/roots
# 422
# {"detail":[{"msg":"String should have at least 1 character", ...}]}

curl -s -o /tmp/root_create.json -w "%{http_code}" -H "Content-Type: application/json" -d '{"name":"Step5b Smoke"}' http://127.0.0.1:8000/api/v1/roots
# 200
# {"root_id":"1431600a-c61e-4781-b50a-20c8cf87e04f", ...}

STEP5_ROOT='{"logline":"Step5b logline","three_disasters":["","",""],"ending":"","theme":""}'
curl -s -o /tmp/step5a.json -w "%{http_code}" -H "Content-Type: application/json" -d "{\"root_id\":\"1431600a-c61e-4781-b50a-20c8cf87e04f\",\"root\":$STEP5_ROOT,\"characters\":[]}" http://127.0.0.1:8000/api/v1/snowflake/step5a
# 200

curl -s -o /tmp/step5b.json -w "%{http_code}" -H "Content-Type: application/json" -d "{\"root_id\":\"1431600a-c61e-4781-b50a-20c8cf87e04f\",\"root\":$STEP5_ROOT,\"characters\":[]}" http://127.0.0.1:8000/api/v1/snowflake/step5b
# 200

SIM_PAYLOAD="{\"scene_context\":{\"scene_id\":\"scene-alpha\",\"root_id\":\"1431600a-c61e-4781-b50a-20c8cf87e04f\",\"branch_id\":\"main\",\"world_state\":{\"distance\":0.6},\"next_anchor\":{\"id\":\"anchor-alpha\",\"required_conditions\":[\"cond_x\"]},\"scene\":{\"scene_id\":\"scene-alpha\",\"summary\":\"\",\"expected_outcome\":\"\"},\"summary\":\"\",\"expected_outcome\":\"\",\"semantic_states\":{},\"events\":[],\"conflict_escalation\":0.0},\"max_rounds\":1}"
curl -s -o /tmp/sim_scene.json -w "%{http_code}" -H "Content-Type: application/json" -d "$SIM_PAYLOAD" http://127.0.0.1:8000/api/v1/simulation/scene
# 200
# {"content":"POV:unknown\n叙事推进\n..."}
```

## 总结、反思与展望
- 已完成: roots 名称校验、snowflake 保存异常映射、simulation world_state 补齐、单测与前端修复。
- KISS/YAGNI: 仅在必要链路补齐 world_state/distance，不引入额外状态分支。
- DRY/SOLID: 复用 scene_context 归一化路径，避免重复处理。
- 挑战: simulation/scene 需要 events/conflict_escalation 才能通过；通过最小字段补齐解决。
- 下一步建议: 如需验证 Memgraph 不可用场景，可在环境隔离时模拟服务不可达以确认 503 行为。

## 职责边界说明

### IMPLEMENTER 测试职责
| 测试类型 | 工具 | 目的 |
|---------|------|------|
| 单元测试 | Bash (`pytest`) | 验证函数逻辑 |
| 前端单元测试 | Bash (`npm run test:unit`) | 验证组件逻辑 |
| E2E 脚本测试 | Bash (`npx playwright test`) | 验证页面流程（Mock 后端） |
| **前端功能自测** | **Playwright MCP** | **验证真实浏览器中的 UI 和交互** |

### Playwright MCP 自测 vs 验证器测试
| 维度 | IMPLEMENTER 自测 | 验证器测试 |
|------|-----------------|-----------|
| 工具 | Playwright MCP | Playwright MCP |
| 目的 | 开发调试、快速反馈 | 独立验证、质量把关 |
| 时机 | 开发过程中随时使用 | 代码提交后 |
| 标准 | 功能基本可用 | 严格验收标准 |
| 网络验证 | 可选 | **必须**验证 API 请求 |

### 真实环境验证（验证器职责）
真实浏览器验证由后续验证器（TEST_RUNNER、EDGE_CASE_TESTER、FINISH_REVIEW）执行。

## 验证信息

### 测试命令
```yaml
commands:
  - cmd: "/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit -q"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "npm --prefix project/frontend run test:unit"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "npm --prefix project/frontend run build"
    cwd: "/home/zxh/ainovel_v3"
    type: build
```

### 修改文件
```yaml
files:
  - path: "project/backend/app/models.py"
    type: implementation
  - path: "project/backend/app/main.py"
    type: implementation
  - path: "project/backend/tests/unit/test_root_create_validation.py"
    type: test
  - path: "project/frontend/src/views/SimulationView.vue"
    type: implementation
```

### API 签名
```yaml
signatures:
  - name: "create_root_endpoint"
    file: "project/backend/app/main.py"
    params: ["payload", "storage"]
  - name: "save_snowflake_step_endpoint"
    file: "project/backend/app/main.py"
    params: ["root_id", "payload", "storage"]
  - name: "ensure_name_not_blank"
    file: "project/backend/app/models.py"
    params: ["value"]
```

结论：PASS
阻塞：无

【MCP调用简报】
服务: serena  
触发: 代码检索与修改（定位校验/修复点、更新前端 world_state 逻辑、修复单测导入）  
参数: find_symbol/search_for_pattern/read_file/replace_regex  
结果: 完成 4 处关键文件修改并复核  
状态: 成功