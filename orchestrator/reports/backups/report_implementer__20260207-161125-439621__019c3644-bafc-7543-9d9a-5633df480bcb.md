已阅读实现者行为规范
iteration: 4

## Phase 1: 红灯阶段

### 测试设计思路
本轮针对 REWORK 的 3 个失败点做最小闭环测试设计：  
1) 创建项目防重复提交（快速双击只允许一次创建请求）；  
2) 状态提取与推演必须有“输入→执行→输出”的黑盒证据；  
3) 清理空断言，保证测试可信度。  
测试覆盖正常路径（成功调用）、并发边界（双击）、以及断言质量（禁止空断言）。

### 创建的测试文件
- `project/frontend/tests/home_view.spec.ts:25` - 新增 deferred 工具与并发双击防重测试
- `project/frontend/tests/round_player.spec.ts:48` - 将弱断言替换为事件次数断言
- `project/frontend/tests/simulation_context.spec.ts:190` - 对 `runRound` payload 增加非空与结构断言
- `project/frontend/tests/snowflake_store_contract.spec.ts:67` - 替换空泛 truthy 断言为类型/长度断言

### 测试用例清单
| 用例名称 | 测试场景 | 预期结果 |
|---------|---------|---------|
| prevents duplicate project creation requests on rapid clicks | HomeView 创建按钮快速双击 | `saveProject` 只被调用 1 次 |
| test_runRound_payload_not_empty | SimulationView 点击 Step 后构造 payload | `scene_context` 存在且非空，agents 非空数组 |
| emits play when not playing / emits pause when playing | RoundPlayer 播放状态切换 | 仅触发对应事件，事件次数准确 |
| uses VITE_API_BASE_URL when set | API 客户端配置契约 | baseURL 与环境变量一致且非空 |

### 红灯确认
- 命令: `npm --prefix project/frontend run test:unit -- tests/home_view.spec.ts`
- 结果: 失败（预期）
- 失败原因: 修复前快速连续点击会导致重复创建请求，新增用例断言 `saveProject` 次数不满足预期

## Phase 2: 绿灯阶段

### 实现方案
采用最小实现（KISS/YAGNI）：在 HomeView 创建入口增加 `loading` 锁，避免并发重复提交，不引入新依赖；并同步补强测试断言质量（去空断言）。  
同时用 Playwright MCP 做真实链路验证：  
- 创建项目双击防重（网络层只 1 次 POST）  
- 状态提取执行成功并回显结果  
- 推演 round/scene 执行成功并回显日志

### 改动说明
| 文件 | 修改内容 | 实现逻辑 |
|-----|---------|---------|
| `project/frontend/src/views/HomeView.vue:160` | 增加 `createProjectPending` 并纳入 `isCreateDisabled` | 在 UI 与动作入口双重锁定，防止重复提交 |
| `project/frontend/src/views/HomeView.vue:186` | `createProject` 增加并发短路 + `try/finally` 释放锁 | 快速双击只允许首个请求通过 |
| `project/frontend/tests/home_view.spec.ts:99` | 新增 rapid clicks 用例 | 验证 `saveProject` 调用次数严格为 1 |
| `project/frontend/tests/round_player.spec.ts:48` | `toBeTruthy/toBeFalsy` 改为事件次数断言 | 消除空泛断言，提高测试可信度 |
| `project/frontend/tests/simulation_context.spec.ts:190` | 增加 fail-fast + key 数量断言 | 确认 `runRound` 实际传递有效上下文 |
| `project/frontend/tests/snowflake_store_contract.spec.ts:67` | truthy 改为 `typeof + length` | 明确约束值类型与内容有效性 |

### 原则应用（KISS / YAGNI / DRY / SOLID）
- KISS：仅用一个 `pending` flag 完成防重，不引入复杂队列/防抖库。  
- YAGNI：只修复当前验收失败点，不扩展额外功能。  
- DRY：复用既有 `runWithFeedback`，测试中用 `createDeferred` 统一异步控制。  
- SOLID（SRP）：创建防重逻辑聚焦在 HomeView 的创建动作，不污染 store 其他职责。  

### 遇到的挑战与处理
- 挑战：新建空项目在 Step2 触发上游 LLM 429，无法作为“状态提取成功链路”样本。  
- 处理：切换到已有结构化数据项目 `I4-dup-proof` 做黑盒验证，成功完成 `state/extract` 与 `simulation` 全链路验证。  

### 绿灯确认
- 命令: `npm --prefix project/frontend run test:unit`
- 结果: 48 passed / 267 passed
- 覆盖率: 89.1%（line，`npm --prefix project/frontend run test:coverage`）

## 自测结果汇总

| 验收命令 | 返回码 | 结果 |
|---------|-------|------|
| `npm --prefix project/frontend run test:unit` | 0 | 48 files / 267 tests 全通过 |
| `npm --prefix project/frontend run test:coverage` | 0 | 覆盖率通过（All files: Stmts 89.09 / Branch 81.76 / Funcs 90.11 / Lines 89.1） |
| `/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/test_api_minimal.py -q` | 0 | 34 passed |
| `grep -R -n "'scene-1'\|'root-1'\|'test-id'" project/frontend/src project/frontend/tests project/backend/app project/backend/tests` | 0 | 空输出 |
| `grep -R -n "localhost\|127.0.0.1" project/frontend/src project/frontend/tests project/backend/app project/backend/tests` | 0 | 空输出 |
| `grep -R -n "TODO\|FIXME\|XXX\|HACK" project/frontend/src project/frontend/tests project/backend/app project/backend/tests` | 0 | 空输出 |
| `grep -R -n "toBeTruthy\|assert True" project/frontend/tests project/frontend/src/__tests__` | 0 | 空输出 |
| Playwright MCP：Home 双击创建 | N/A | 网络仅 1 次 `POST /api/v1/roots`（200） |
| Playwright MCP：Snowflake 状态提取 | N/A | `POST /api/v1/state/extract`（200），页面显示结构化提取结果 |
| Playwright MCP：Simulation Step/Scene | N/A | `POST /api/v1/simulation/round`（200）+ `POST /api/v1/simulation/scene`（200），日志与回合面板更新 |
| Playwright MCP：控制台检查 | N/A | error 0 |

自测结果: PASS

## 职责边界说明

### IMPLEMENTER 测试职责

你负责执行以下测试，确保代码逻辑正确：

| 测试类型 | 工具 | 目的 |
|---------|------|------|
| 单元测试 | Bash (`pytest`) | 验证函数逻辑 |
| 前端单元测试 | Bash (`npm run test:unit`) | 验证组件逻辑 |
| E2E 脚本测试 | Bash (`npx playwright test`) | 验证页面流程（Mock 后端） |
| **前端功能自测** | **Playwright MCP** | **验证真实浏览器中的 UI 和交互** |

### Playwright MCP 自测 vs 验证器测试

| 维度 | IMPLEMENTER 自测 | 验证器测试 |
|------|-----------------|-----------|
| 工具 | Playwright MCP | Playwright MCP |
| 目的 | 开发调试、快速反馈 | 独立验证、质量把关 |
| 时机 | 开发过程中随时使用 | 代码提交后 |
| 标准 | 功能基本可用 | 严格验收标准 |
| 网络验证 | 可选 | **必须**验证 API 请求 |

**关键区别**：
- 我的自测用于快速发现并修复问题；
- 验证器用于独立质量把关；
- 本轮已先完成命令行 + 浏览器黑盒自测，降低后续返工风险。

### 真实环境验证（验证器职责）

真实浏览器验证由后续验证器（TEST_RUNNER、EDGE_CASE_TESTER、FINISH_REVIEW）执行。  
本轮已确保：
- ✅ 前端服务可正常启动  
- ✅ 后端 API 可正常响应  
- ✅ 代码无明显运行时错误  
- ✅ 命令行测试通过  
- ✅ Playwright MCP 关键链路通过（创建防重 / 状态提取 / 推演）

## 验证信息

### 测试命令
```yaml
commands:
  - cmd: "npm --prefix project/frontend run test:unit"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "npm --prefix project/frontend run test:coverage"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/test_api_minimal.py -q"
    cwd: "/home/zxh/ainovel_v3/project/backend"
    type: unit
  - cmd: "grep -R -n \"'scene-1'\\|'root-1'\\|'test-id'\" project/frontend/src project/frontend/tests project/backend/app project/backend/tests"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "grep -R -n \"localhost\\|127.0.0.1\" project/frontend/src project/frontend/tests project/backend/app project/backend/tests"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "grep -R -n \"TODO\\|FIXME\\|XXX\\|HACK\" project/frontend/src project/frontend/tests project/backend/app project/backend/tests"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
```

### 修改文件
```yaml
files:
  - path: "project/frontend/src/views/HomeView.vue"
    type: implementation
  - path: "project/frontend/tests/home_view.spec.ts"
    type: test
  - path: "project/frontend/tests/round_player.spec.ts"
    type: test
  - path: "project/frontend/tests/simulation_context.spec.ts"
    type: test
  - path: "project/frontend/tests/snowflake_store_contract.spec.ts"
    type: test
```

### API 签名
```yaml
signatures:
  - name: "createProject"
    file: "project/frontend/src/views/HomeView.vue"
    params: []
  - name: "runWithFeedback"
    file: "project/frontend/src/views/HomeView.vue"
    params: ["action", "fallback"]
  - name: "createDeferred"
    file: "project/frontend/tests/home_view.spec.ts"
    params: []
```

## MCP调用简报
【MCP调用简报】  
服务: serena  
触发: 定位 HomeView 防重逻辑与断言修复点、复核行号与反作弊扫描范围  
参数: `read_file/search_for_pattern(relative_path=project/frontend..., max_answer_chars=-1)`  
结果: 确认防重复提交逻辑与 4 个测试文件断言强化已落地  
状态: 成功

【MCP调用简报】  
服务: playwright  
触发: 真实浏览器黑盒验证（创建防重、状态提取、推演）  
参数: `browser_navigate/click/type/select_option/network_requests/console_messages/snapshot`  
结果: `POST /api/v1/roots` 单次触发；`state/extract` 200 且有结果；`simulation/round` 与 `simulation/scene` 均 200；console error 0  
状态: 成功

结论：PASS
阻塞：无