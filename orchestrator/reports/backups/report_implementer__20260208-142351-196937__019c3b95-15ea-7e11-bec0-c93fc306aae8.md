已阅读实现者行为规范
iteration: 2

## Phase 1: 红灯阶段

### 测试设计思路
- 先覆盖**本轮新增修复点**：导航上下文透传、项目上下文切换后提示词重新加载。
- 用最小闭环验证核心行为：URL 是否带 `root_id/branch_id`、`editor/simulation` 是否携带 `scene_id`、切换项目后提示词是否刷新。
- 边界条件覆盖：无上下文时退化为纯路径；非项目路由不注入查询参数。

### 创建的测试文件
- `project/frontend/src/__tests__/navigation_context.test.ts:4` - 导航目标构造规则（含 scene path + query 规则）
- `project/frontend/tests/snowflake_prompt_customization.spec.ts:259` - 项目上下文切换后提示词重载验证

### 测试用例清单
| 用例名称 | 测试场景 | 预期结果 |
|---------|---------|---------|
| navigation missing context | `root_id/branch_id` 为空 | 返回纯 `path`，不注入 query |
| navigation project route | 进入 snowflake/world/editor/simulation | 注入 `root_id/branch_id` |
| navigation scene route | editor/simulation 且有 `scene_id` | 路径变为 `/{route}/{scene_id}` |
| navigation non-project route | settings/home | 不注入项目 query |
| snowflake prompt reload on context switch | 不卸载页面切换项目上下文 | 重新请求新项目 prompts，并更新输入框内容 |
| snowflake prompt persistence behavior | 提示词保存后再运行步骤 | API 请求使用最新提示词 |

### 红灯确认
- 命令: `npx vitest run src/__tests__/navigation_context.test.ts tests/snowflake_prompt_customization.spec.ts`
- 结果: 失败（预期）
- 失败原因: （承接本轮先前执行记录）实现当时未完成：导航未统一携带上下文、Snowflake 页面仅初始化加载一次 prompts，项目切换后未重拉取。

## Phase 2: 绿灯阶段

### 实现方案
- 将路由跳转规则集中到一个函数，避免 Header/Sidebar 重复拼装（DRY + SRP）。
- 在 Snowflake 页面监听项目上下文变化，切换项目时重载进度与提示词；无 root 时立即清空本地状态，避免 stale 数据污染（快速失败）。
- 不改后端接口，不加新依赖，仅做前端最小修复（KISS/YAGNI）。

### 改动说明
| 文件 | 修改内容 | 实现逻辑 |
|-----|---------|---------|
| `project/frontend/src/utils/navigation.ts:31` | 新增 `buildNavigationTarget(index, context)` | 统一生成导航目标；项目路由自动附带 `root_id/branch_id`；editor/simulation 在有 scene 时走路径参数 |
| `project/frontend/src/components/common/AppHeader.vue:31` | `handleSelect` 改为调用 `buildNavigationTarget` | 顶部导航点击时保留项目上下文与 scene 上下文 |
| `project/frontend/src/components/common/AppSidebar.vue:26` | `handleSelect` 改为调用 `buildNavigationTarget` | 侧边导航与顶部导航行为一致，消除分叉逻辑 |
| `project/frontend/src/views/SnowflakeView.vue:462` | 新增 `loadSnowflakeContext(rootId, branchId)` | 上下文变化时串行加载 `loadProgress` + `fetchSnowflakePrompts`，并处理空 root 场景的状态清理 |
| `project/frontend/src/views/SnowflakeView.vue:501` | 新增对 `projectStore.root_id/branch_id` 的 `watch` | 替代一次性 mounted 加载，实现“切项目即刷新” |
| `project/frontend/src/__tests__/navigation_context.test.ts:4` | 新增导航上下文测试 | 锁定导航 query/path 规则，防回归 |
| `project/frontend/tests/snowflake_prompt_customization.spec.ts:259` | 新增上下文切换重载测试 | 锁定 Snowflake prompts 动态刷新行为 |

### 绿灯确认
- 命令: `npx vitest run src/__tests__/navigation_context.test.ts tests/snowflake_prompt_customization.spec.ts`
- 结果: 13 passed
- 覆盖率: 已在全量覆盖率中体现（见下）

## 自测结果汇总

| 验收命令 | 返回码 | 结果 |
|---------|-------|------|
| `npx vitest run src/__tests__/navigation_context.test.ts tests/snowflake_prompt_customization.spec.ts`（cwd=`/home/zxh/ainovel_v3/project/frontend`） | 0 | 2 files / 13 tests passed |
| `npm --prefix project/frontend run test:unit`（cwd=`/home/zxh/ainovel_v3`） | 0 | 49 files / 275 tests passed |
| `npm --prefix project/frontend run test:coverage`（cwd=`/home/zxh/ainovel_v3`） | 0 | Stmts 89.06%、Branch 81.66%、Funcs 89.84%、Lines 89.20% |
| Playwright MCP：首页→雪花→编辑器→推演→设置→世界观→雪花导航回归 | 0 | URL 上下文保持正确；页面无白屏/崩溃 |
| Playwright MCP：控制台错误检查 | 0 | error 级别 0 条 |
| Playwright MCP：网络请求检查 | 0 | 关键接口均 200（含 prompts、settings、simulation、create root） |
| 反作弊扫描（本轮改动文件） | 0 | 未命中硬编码 ID/URL、未命中未完成标记 |

自测结果: PASS

## 本次迭代原则应用与收益
- **KISS**: 只做导航上下文与页面监听的最小改动，避免重构路由体系。
- **YAGNI**: 不引入全局事件总线/新依赖，不扩展后端接口。
- **DRY**: Header/Sidebar 共用 `buildNavigationTarget`，去除重复拼接逻辑。
- **SOLID（SRP/OCP）**: 导航目标构造职责下沉到工具层；调用方只负责触发跳转，后续扩展新路由只需改一处。
- **快速失败**: Snowflake 在缺失 `branch_id` 时直接报错，不做隐式兜底。

## 遇到的挑战与处理
- 挑战：测试输出中存在大量 UI 组件解析 warning，容易淹没关键失败信息。  
  处理：以“测试退出码 + 断言结果 + Playwright 控制台 error=0”为主判据，保证问题定位聚焦功能性缺陷。
- 挑战：标签切换问题根因分散在多个入口（顶部/侧边栏）。  
  处理：提炼统一导航构造函数，一次修复多入口一致性问题。

## 下一步计划和建议
1. 在 HomeView 的“创建项目后跳转”路径补齐 query（当前功能可用，但可进一步统一 URL 语义）。
2. 增加一条 e2e 脚本，固定校验“跨页面切换上下文不丢失”。
3. 对 Snowflake Step3/5/6 准备一份含完整字段的稳定样本数据，增强展示回归测试可读性。

## 职责边界说明

### IMPLEMENTER 测试职责

| 测试类型 | 工具 | 目的 |
|---------|------|------|
| 单元测试 | Bash (`pytest`) | 验证函数逻辑 |
| 前端单元测试 | Bash (`npm run test:unit`) | 验证组件逻辑 |
| E2E 脚本测试 | Bash (`npx playwright test`) | 验证页面流程（Mock 后端） |
| **前端功能自测** | **Playwright MCP** | **验证真实浏览器中的 UI 和交互** |

### Playwright MCP 自测 vs 验证器测试

| 维度 | IMPLEMENTER 自测 | 验证器测试 |
|------|-----------------|-----------|
| 工具 | Playwright MCP | Playwright MCP |
| 目的 | 开发调试、快速反馈 | 独立验证、质量把关 |
| 时机 | 开发过程中随时使用 | 代码提交后 |
| 标准 | 功能基本可用 | 严格验收标准 |
| 网络验证 | 可选 | **必须**验证 API 请求 |

**关键区别**：
- 你的自测是为了**快速发现和修复问题**
- 验证器测试是为了**独立验证质量**，会检测 mock 数据等作弊行为
- 你应该在自测通过后再提交，减少验证器返工

### 真实环境验证（验证器职责）

真实浏览器验证由后续验证器（TEST_RUNNER、EDGE_CASE_TESTER、FINISH_REVIEW）执行。

验证器会执行更严格的检查：
- **网络请求验证**：确保 API 真正被调用，而非 mock 数据
- 前后端集成问题
- 真实数据格式问题
- 边界条件处理问题

你只需确保：
- ✅ 前端服务可正常启动
- ✅ 后端 API 可正常响应
- ✅ 代码无明显的运行时错误
- ✅ 命令行测试全部通过
- ✅ Playwright MCP 自测基本功能正常

## 验证信息

### 测试命令
```yaml
commands:
  - cmd: "npx vitest run src/__tests__/navigation_context.test.ts tests/snowflake_prompt_customization.spec.ts"
    cwd: "/home/zxh/ainovel_v3/project/frontend"
    type: unit
  - cmd: "npm --prefix project/frontend run test:unit"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "npm --prefix project/frontend run test:coverage"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
```

### 修改文件
```yaml
files:
  - path: "project/frontend/src/utils/navigation.ts"
    type: implementation
  - path: "project/frontend/src/components/common/AppHeader.vue"
    type: implementation
  - path: "project/frontend/src/components/common/AppSidebar.vue"
    type: implementation
  - path: "project/frontend/src/views/SnowflakeView.vue"
    type: implementation
  - path: "project/frontend/src/__tests__/navigation_context.test.ts"
    type: test
  - path: "project/frontend/tests/snowflake_prompt_customization.spec.ts"
    type: test
```

### API 签名
```yaml
signatures:
  - name: "buildNavigationTarget"
    file: "project/frontend/src/utils/navigation.ts"
    params: ["index", "context"]
  - name: "handleSelect"
    file: "project/frontend/src/components/common/AppHeader.vue"
    params: ["index"]
  - name: "handleSelect"
    file: "project/frontend/src/components/common/AppSidebar.vue"
    params: ["index"]
  - name: "loadSnowflakeContext"
    file: "project/frontend/src/views/SnowflakeView.vue"
    params: ["rootId", "branchId"]
```

结论：PASS  
阻塞：无

【MCP调用简报】
服务: serena  
触发: 核查本轮相关实现与测试文件、定位关键函数行号、读取代码上下文  
参数: `activate_project=/home/zxh/ainovel_v3`，`read_file/get_symbols_overview/search_for_pattern(max_answer_chars=-1)`，聚焦 `project/frontend`  
结果: 命中并确认 6 个核心文件改动点；定位关键行号（navigation/header/sidebar/snowflake/tests）  
状态: 成功

【MCP调用简报】
服务: playwright  
触发: 前端真实浏览器自测（标签切换、提示词显示、设置配置、项目创建、推演触发、控制台与网络校验）  
参数: `browser_navigate/click/type/console_messages(network)/network_requests/close`，目标端口 `5185`  
结果: URL 上下文保持正确；控制台 error=0；关键请求 200（含 `GET .../snowflake/prompts`、`GET .../settings/llm`、`POST .../simulation/scene`、`POST .../roots`）  
状态: 成功