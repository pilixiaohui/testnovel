已阅读实现者行为规范
iteration: 2

## Phase 1: 红灯阶段

### 测试设计思路
先用测试锁定本轮高优先缺陷：  
1) 雪花步骤内容必须展示完整字段（不仅是名称）；  
2) 项目加载必须携带 `branch_id`，确保前后端接口契约一致。  
这两类问题直接对应 P0/P1 验收项，且能最小成本覆盖核心回归风险（KISS/YAGNI）。

### 创建的测试文件
- `project/frontend/tests/snowflake_full_content_display.spec.ts:116` - 扩展 Snowflake 完整字段展示断言（角色/场景/幕章/锚点 + 原始 JSON）
- `project/frontend/tests/project_store.spec.ts:64` - 增加 `loadProject` 调用 `fetchProject(rootId, branchId)` 的契约断言

### 测试用例清单
| 用例名称 | 测试场景 | 预期结果 |
|---------|---------|---------|
| snowflake_full_fields_render | Step3/4/5/6 展示结构化字段与 JSON 原文 | 所有关键字段可见且断言通过 |
| project_load_with_branch | `loadProject` 调用后端详情接口 | 必须携带 `branch_id` |
| prompt_round_trip_visibility | Snowflake 提示词加载 | 页面显示后端返回的实际提示词 |
| home_create_and_route | 首页新建项目 | 创建成功并跳转雪花流程 |
| tab_switch_stability | 首页/雪花/推演/编辑器/世界观/设置切换 | 无崩溃、无控制台错误 |
| settings_real_config | 设置页读取 LLM 配置 | 显示数据库真实配置 |

### 红灯确认
- 命令: `npm --prefix project/frontend run test:unit -- tests/snowflake_full_content_display.spec.ts tests/project_store.spec.ts`
- 结果: 失败（预期）
- 失败原因: 详情字段渲染断言不满足；项目加载参数契约不满足（实现未完成）

## Phase 2: 绿灯阶段

### 实现方案
按“最小必要改动”修复：  
- 视图层补齐结构化展示与 JSON 原文展示；  
- API 与 Store 参数严格对齐后端；  
- 恢复链路补全 root 关键字段，避免后续步骤缺失。  
保持快速失败：缺少关键上下文时直接报错，不做兜底吞错。

### 改动说明
| 文件 | 修改内容 | 实现逻辑 |
|-----|---------|---------|
| `project/frontend/src/views/SnowflakeView.vue:104` | 新增 root/character/scene/act/chapter/anchor 详情展示区 | 结构化字段 + 原始 JSON 同时展示，满足“完整信息可视化” |
| `project/frontend/src/views/SnowflakeView.vue:291` | 新增 `readAnchorText`、`readAnchorConditions` | 抽取锚点字段读取逻辑，减少模板重复（DRY） |
| `project/frontend/src/views/SnowflakeView.vue:338` | `requireRootForStep` 前置校验 | Step3/4/5 无 root 时快速失败，避免脏流程 |
| `project/frontend/src/views/SnowflakeView.vue:465` | 挂载时加载 `fetchSnowflakePrompts` | 提示词编辑器显示后端实际值，不再空白/伪默认 |
| `project/frontend/src/api/project.ts:5` | `fetchProject` 增加 `branch_id` 查询参数 | 与后端 `/roots/{id}?branch_id=...` 契约对齐 |
| `project/frontend/src/stores/project.ts:204` | `loadProject` 传递当前分支到 `fetchProject` | 保证项目上下文一致性，修复“项目保存/读取链路”前置问题 |
| `project/frontend/src/stores/snowflake.ts:198` | `restoreFromBackend` 构造规范化 `restoredRoot`（含 `three_disasters`） | 恢复流程字段完整，避免后续步骤缺字段 |
| `project/frontend/src/api/snowflake.ts:147` | `updateSnowflakeLogline` 改为 `/roots/{id}/snowflake/steps` step1 写回 | 对齐现有后端端点，修复日志线更新链路 |
| `project/frontend/tests/snowflake_full_content_display.spec.ts:126` | 增加详情字段断言 | 锁定 UI 展示回归 |
| `project/frontend/tests/project_store.spec.ts:74` | 增加 `branch_id` 调用断言 | 锁定 API 参数回归 |

### 绿灯确认
- 命令: `npm --prefix project/frontend run test:coverage`
- 结果: `266 passed`
- 覆盖率: `Statements 89% / Branches 81.45% / Functions 89.88% / Lines 89%`

## 自测结果汇总

| 验收命令 | 返回码 | 结果 |
|---------|-------|------|
| `npm --prefix project/frontend run test:unit` | 0 | 48 files, 266 passed |
| `npm --prefix project/frontend run test:coverage` | 0 | 覆盖率达标（全局 89%） |
| `/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/test_api_minimal.py -q` | 0 | 34 passed |
| `/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/test_models.py -q` | 0 | 7 passed |
| `grep -Rns "<hardcoded-id-pattern>" project/frontend/src project/frontend/tests project/backend/app project/backend/tests` | 0 | 输出为空 |
| `grep -Rns "<hardcoded-url-pattern>" project/frontend/src project/frontend/tests project/backend/app project/backend/tests` | 0 | 输出为空 |
| `grep -Rns "<todo-marker-pattern>" project/frontend/src project/frontend/tests project/backend/app project/backend/tests` | 0 | 输出为空 |
| Playwright MCP（创建项目→跳转雪花→保存→切换标签→读取设置→删除项目→控制台/网络核验） | PASS | 关键链路通过，控制台 error=0，关键 API 命中 |

自测结果: PASS

## 职责边界说明

### IMPLEMENTER 测试职责

| 测试类型 | 工具 | 目的 |
|---------|------|------|
| 单元测试 | Bash (`pytest`) | 验证函数逻辑 |
| 前端单元测试 | Bash (`npm run test:unit`) | 验证组件与 Store 逻辑 |
| E2E 脚本测试 | Bash (`npx playwright test`) | 页面流程验证（脚本层） |
| 前端功能自测 | Playwright MCP | 真实浏览器交互 + API 命中验证 |

### Playwright MCP 自测 vs 验证器测试

| 维度 | IMPLEMENTER 自测 | 验证器测试 |
|------|-----------------|-----------|
| 工具 | Playwright MCP | Playwright MCP |
| 目的 | 开发期快速反馈 | 独立质量把关 |
| 时机 | 开发过程中 | 提交后 |
| 标准 | 功能可用+无明显错误 | 严格验收 |
| 网络验证 | 已执行关键链路核验 | 必须全量核验 |

### 真实环境验证（验证器职责）
已完成实现者侧必要自测：前端可启动、后端可响应、命令行测试通过、真实浏览器关键链路可用。后续由 TEST_RUNNER / EDGE_CASE_TESTER / FINISH_REVIEW 执行更严格验证。

## 总结、反思与展望

- 本次迭代完成的核心任务：
  - 修复项目读取分支参数契约，打通项目上下文一致性；
  - 修复 Snowflake 恢复数据结构，补齐关键字段；
  - 实现雪花步骤完整信息展示（结构化 + JSON 原文）；
  - 修复提示词加载显示实际后端值；
  - 完成真实浏览器链路验证（创建/保存/切换/设置/删除）。
- 原则应用：
  - KISS：直接在现有视图补齐字段显示，不引入新层级；
  - YAGNI：仅修复本轮验收所需链路，不做额外重构；
  - DRY：抽取锚点字段读取函数，减少重复模板表达；
  - SOLID：API 参数对齐放在 API/Store 边界，视图专注渲染。
- 遇到的挑战：
  - 项目存在历史类型检查噪声（`npm run build` 仍有既有 TS 问题），与本轮验收目标无直接耦合；本轮通过“测试+真实浏览器”优先保证功能正确性。
- 下一步建议：
  1. 单独开工单清理历史 TS 类型问题（不与功能修复混合）。
  2. 增加“带真实场景数据”的状态提取/推演集成用例，强化 P2 回归覆盖。

## 验证信息

### 测试命令
```yaml
commands:
  - cmd: "npm --prefix project/frontend run test:unit"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "npm --prefix project/frontend run test:coverage"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/test_api_minimal.py -q"
    cwd: "/home/zxh/ainovel_v3/project/backend"
    type: unit
  - cmd: "/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/test_models.py -q"
    cwd: "/home/zxh/ainovel_v3/project/backend"
    type: unit
  - cmd: "Playwright MCP: create/save/switch/settings/delete with console+network verification"
    cwd: "/home/zxh/ainovel_v3/project/frontend"
    type: e2e_manual
```

### 修改文件
```yaml
files:
  - path: "project/frontend/src/views/SnowflakeView.vue"
    type: implementation
  - path: "project/frontend/src/stores/snowflake.ts"
    type: implementation
  - path: "project/frontend/src/stores/project.ts"
    type: implementation
  - path: "project/frontend/src/api/project.ts"
    type: implementation
  - path: "project/frontend/src/api/snowflake.ts"
    type: implementation
  - path: "project/frontend/tests/snowflake_full_content_display.spec.ts"
    type: test
  - path: "project/frontend/tests/project_store.spec.ts"
    type: test
```

### API 签名
```yaml
signatures:
  - name: "fetchProject"
    file: "project/frontend/src/api/project.ts"
    params: ["rootId", "branchId"]
  - name: "useProjectStore/actions/loadProject"
    file: "project/frontend/src/stores/project.ts"
    params: ["rootId"]
  - name: "useSnowflakeStore/actions/restoreFromBackend"
    file: "project/frontend/src/stores/snowflake.ts"
    params: ["rootId", "branchId"]
  - name: "updateSnowflakeLogline"
    file: "project/frontend/src/api/snowflake.ts"
    params: ["rootId", "loglines"]
  - name: "readAnchorConditions"
    file: "project/frontend/src/views/SnowflakeView.vue"
    params: ["anchor"]
```

结论：PASS  
阻塞：无

【MCP调用简报】  
服务: serena  
触发: 代码定位、实现核对、测试证据整理  
参数: `relative_path` 精确到 `project/frontend` 与 `project/backend`，`max_answer_chars=-1`  
结果: 完成关键改动点与行号核验，形成可追溯变更清单  
状态: 成功

【MCP调用简报】  
服务: playwright  
触发: 真实浏览器自测（创建/保存/切页/设置读取/删除）  
参数: `browser_navigate/click/type/snapshot/network_requests/console_messages`  
结果: 关键交互链路通过，关键 API 命中，控制台 error 为 0  
状态: 成功