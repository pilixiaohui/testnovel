已阅读审阅行为规范
iteration: 16
review_mode: milestone

## Milestone Review: M2

### M2-T1: Step5b章节数量约束（总数=10）

#### 任务理解
Step5b 生成章节总数必须严格等于 10，异常快速失败返回 400。

#### 验收执行
- 验收命令: `cd project/backend && MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/unit/test_step5b_chapter_count.py -v`
- 返回码: 0
- 测试结果: 3 passed
- 覆盖率: 未提供（命令未输出覆盖率）

#### 代码深度审查

##### 实现代码审查
- 审查文件: `project/backend/app/main.py:285`
- 审查文件: `project/backend/app/storage/memgraph_storage.py:1172`
- 审查内容:
  | 检查项 | 结果 | 说明 |
  |-------|------|------|
  | 函数参数/返回值类型 | 符合 | Step5b 入参/返回结构清晰 |
  | API 契约一致性 | 符合 | total_count==10 时才落库 |
  | 错误处理完整性 | 完整 | total_count!=10 直接 400 |
  | 边界条件处理 | 已考虑 | <10 与 >10 都会失败 |
- 代码片段证据:
```python
# project/backend/app/main.py:285
total_count = 0
for act in acts:
    generated = await engine.generate_chapter_list(...)
    total_count += len(generated)
    planned.append((act_id, generated))
if total_count != 10:
    raise HTTPException(status_code=400, detail="chapter count must be exactly 10")
```
- 实现审查结论: 合理

##### 测试代码审查
- 测试文件: `project/backend/tests/unit/test_step5b_chapter_count.py`
- 测试覆盖情况:
  | 功能点 | 是否有测试 | 测试是否正确 |
  |-------|-----------|-------------|
  | 章节总数=10 | 是 | 是 |
  | 章节总数<10 | 是 | 是 |
  | 章节总数>10 | 是 | 是 |
- 测试质量结论: 符合需求

#### 任务结论
- 结论: PASS
- 建议状态: VERIFIED
- 改进建议: 无

---

### M2-T2: 章节渲染API（/chapters/{id}/render）

#### 任务理解
新增章节渲染接口，返回 rendered_content，字数应在 1800-2200 范围。

#### 验收执行
- 验收命令: `cd project/backend && MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/integration/test_chapter_render_api.py -v`
- 返回码: 0
- 测试结果: 3 passed
- 覆盖率: 未提供（命令未输出覆盖率）

#### 代码深度审查

##### 实现代码审查
- 审查文件: `project/backend/app/main.py:589`
- 审查文件: `project/backend/app/models.py:410`
- 审查内容:
  | 检查项 | 结果 | 说明 |
  |-------|------|------|
  | 函数参数/返回值类型 | 符合 | 使用 SceneRenderPayload 组织渲染输入 |
  | API 契约一致性 | 部分符合 | 返回 rendered_content，但未校验字数范围 |
  | 错误处理完整性 | 完整 | LLM 异常返回 400 |
  | 边界条件处理 | 未考虑 | 未对内容长度做约束/快速失败 |
- 代码片段证据:
```python
# project/backend/app/main.py:589
outline_requirement = (
    f"章节标题: {chapter.title}\n"
    f"章节焦点: {chapter.focus}\n"
    "请写约2000字的章节正文。"
)
payload = SceneRenderPayload(...)
content = await gateway.render_scene(payload)
chapter.rendered_content = content
storage.update_chapter(chapter)
return {"rendered_content": content}
```
- 实现审查结论: 存在问题（缺少 1800-2200 字数校验与快速失败）

##### 测试代码审查
- 测试文件: `project/backend/tests/integration/test_chapter_render_api.py`
- 测试覆盖情况:
  | 功能点 | 是否有测试 | 测试是否正确 |
  |-------|-----------|-------------|
  | 渲染成功返回内容 | 是 | 是 |
  | 缺失章节返回404 | 是 | 是 |
  | 渲染失败返回400 | 是 | 是 |
  | 字数越界快速失败 | 否 | 不适用 |
- 测试质量结论: 部分符合（缺少字数越界场景）

#### 任务结论
- 结论: FAIL
- 失败类型: 实现问题
- 建议状态: 保持 DONE
- 改进建议: 在渲染后对 content 长度进行硬性校验（1800-2200），不满足则返回 400 并不落库；补充越界测试用例。

---

### M2-T3: 章节渲染持久化

#### 任务理解
渲染结果写入 Memgraph，并支持 GET 获取 rendered_content。

#### 验收执行
- 验收命令: `cd project/backend && MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/integration/test_chapter_persistence.py -v`
- 返回码: 0
- 测试结果: 4 passed
- 覆盖率: 未提供（命令未输出覆盖率）

#### 代码深度审查

##### 实现代码审查
- 审查文件: `project/backend/app/main.py:625`
- 审查文件: `project/backend/app/storage/memgraph_storage.py:707`
- 审查内容:
  | 检查项 | 结果 | 说明 |
  |-------|------|------|
  | 函数参数/返回值类型 | 符合 | GET 端点返回完整章节字段 |
  | API 契约一致性 | 符合 | rendered_content/ review_status 持久化 |
  | 错误处理完整性 | 完整 | 找不到章节返回404 |
  | 边界条件处理 | 已考虑 | review_status Enum 转字符串 |
- 代码片段证据:
```python
# project/backend/app/storage/memgraph_storage.py:707
def _chapter_props(self, chapter: Chapter) -> dict[str, object]:
    props = self._props_from(
        chapter,
        required=("id", "act_id", "sequence", "title", "focus", "review_status"),
        optional=("pov_character_id", "rendered_content"),
    )
```
```python
# project/backend/app/main.py:625
@app.get("/api/v1/chapters/{chapter_id}")
async def get_chapter_endpoint(...):
    chapter = storage.get_chapter(chapter_id)
    ...
    return {
        "rendered_content": chapter.rendered_content,
        "review_status": review_status,
    }
```
- 实现审查结论: 合理

##### 测试代码审查
- 测试文件: `project/backend/tests/integration/test_chapter_persistence.py`
- 测试覆盖情况:
  | 功能点 | 是否有测试 | 测试是否正确 |
  |-------|-----------|-------------|
  | 初始 rendered_content 为空 | 是 | 是 |
  | 渲染后持久化 | 是 | 是 |
  | 二次渲染更新内容 | 是 | 是 |
  | GET 返回 rendered_content | 是 | 是 |
- 测试质量结论: 符合需求

#### 任务结论
- 结论: PASS
- 建议状态: VERIFIED
- 改进建议: 无（但依赖 M2-T2 的字数校验补齐）

---

## 汇总

| 任务 | 验收结果 | 代码审查 | 测试质量 | 失败类型 | 建议状态 |
|------|---------|---------|---------|---------|---------|
| M2-T1 | PASS | 合理 | 符合需求 | - | VERIFIED |
| M2-T2 | FAIL | 存在问题 | 部分符合 | 实现问题 | 保持 DONE |
| M2-T3 | PASS | 合理 | 符合需求 | - | VERIFIED |

结论：FAIL  
失败类型：实现问题  
阻塞：章节渲染未校验字数范围，无法保证 1800-2200 的硬性约束

## 建议

- M2-T2 增加渲染字数校验与快速失败（不合规即 400），并补充“长度越界”测试用例。
- 保留当前“约2000字”提示，但不能替代硬性校验，避免违反全局字数验收标准。
- Pytest 输出包含 FastAPI `on_event` 弃用警告，建议迁移到 lifespan 事件以清理技术债。
- 覆盖率未输出，建议在后续验收命令中补充覆盖率采集（满足 min_coverage=80 的全局要求）。

【MCP调用简报】
服务: serena  
触发: 执行M2验收命令与代码/测试审查取证  
参数: execute_shell_command（pytest/rg/nl/find，`max_answer_chars: -1`）  
结果: 3条验收命令全部PASS；定位 Step5b、章节渲染与持久化实现  
状态: 成功