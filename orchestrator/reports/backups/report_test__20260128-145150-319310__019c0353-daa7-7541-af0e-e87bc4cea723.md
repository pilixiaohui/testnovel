已阅读测试行为规范
iteration: 2

## 测试需求分析

工单要求测试的功能点：
1. API baseURL：当 VITE_API_BASE_URL 设置时 client.baseURL 等于该值；未设置时为 /api/v1。
2. Snowflake store：state 包含 Step1-6 关键字段（logline/root/characters/scenes/acts/chapters/anchors）；关键 actions 调用对应 API 并更新状态。
3. 失败场景：未完成 API 调用时 state 不应进入下一步（保持前一步状态）。

## 测试设计

### 设计思路
- 使用 Pinia 单元测试 + API mock，直接验证 store state 字段、action 调用与状态更新。
- baseURL 通过动态导入 apiClient 校验环境变量分支。
- 使用 deferred promise 验证异步未完成时 state 不提前更新。

### 创建的测试文件
- `project/frontend/tests/snowflake_store_contract.spec.ts:1` - 覆盖 baseURL 契约 + Snowflake store Step1-6 契约。

### 测试用例清单

| 用例名称 | 测试场景 | 对应功能点 | 测试逻辑说明 |
|---------|---------|-----------|-------------|
| uses VITE_API_BASE_URL when set | 正常流程 | 功能点1 | env 有值时，apiClient.baseURL 应等于 env |
| falls back to /api/v1 when VITE_API_BASE_URL is missing | 正常流程 | 功能点1 | env 为空时，baseURL 应为 /api/v1 |
| state exposes step1-6 fields | 正常流程 | 功能点2 | 检查 state 包含 logline/root/characters/scenes/acts/chapters/anchors |
| actions call snowflake APIs and update state | 正常流程 | 功能点2 | mock API，验证 action 调用参数与 state 更新 |
| does not advance state before async API resolves | 异步失败前置 | 功能点3 | Promise 未 resolve 前 state 不更新 |

### 关键测试逻辑
- 通过 `vi.mock` 替换 `@/api/snowflake` 与 `@/api/anchor`，控制返回值并断言 action 调用。
- 初始化 Pinia store，验证 state 字段存在与数组初始化。
- 使用 `createDeferred` 控制 step3 的返回时机，验证未完成时 `characters` 保持空数组，完成后更新。

## 测试执行

- 命令: `cd /home/zxh/ainovel_v3/project/frontend && MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 npm run test:unit`
- 结果: 失败
- 红灯确认: 否（包含非实现导致的测试套件错误）

### 执行详情
- 新增用例失败（实现缺失导致）：
  - baseURL 未使用 env：`project/frontend/tests/snowflake_store_contract.spec.ts:62` 期望 `http://localhost:8000` 实际 `/api/v1`。
  - Snowflake store 缺少 logline 等字段：`project/frontend/tests/snowflake_store_contract.spec.ts:82`。
  - Snowflake store 缺少 fetchStep1/fetchStep3 等 action：`project/frontend/tests/snowflake_store_contract.spec.ts:147`、`project/frontend/tests/snowflake_store_contract.spec.ts:198`。
- 现有测试套件错误（非实现红灯）：
  - `tests/fe_core_views_contract.spec.ts`、`tests/fe_core_views_minimal.spec.ts`：`TypeError: Unknown file extension ".css"`（element-plus CSS 导入）。
  - `project/frontend/src/__tests__/fe_api_types_store_alignment.test.ts:17` 与 `project/frontend/src/__tests__/fe_api_types_store_alignment.test.ts:25`：store state keys 与测试预期不一致。
- 阻塞类型：环境问题（vitest 无法处理 element-plus CSS 导入）。

## 验收标准

- 命令: `cd /home/zxh/ainovel_v3/project/frontend && npm run test:unit`
- 阈值: 测试可运行、覆盖需求场景、当前为红灯

结论：FAIL  
阻塞：现有测试套件因 element-plus CSS 导入报错导致 suite 失败；Snowflake store 与 api baseURL 实现缺失导致断言失败

## 澄清请求

### 问题
Snowflake store 的 action 命名与 Step5/6 对应数据（acts/chapters/anchors）是否有明确约定？

### 当前理解
假设 action 为 `fetchStep1~fetchStep6`/`fetchAnchors`，并分别更新 `logline/root/characters/scenes/acts/chapters/anchors`。

### 备选理解
action 命名与步骤映射可能不同（例如 `runStepX` 或 Step5/6 对应 anchors/chapters 的顺序不同）。

### 影响
若命名或步骤映射不同，需要调整测试用例与断言。

【MCP调用简报】
服务: serena  
触发: 代码检索、定位被测文件、创建测试文件、执行测试  
参数: list_dir/read_file/search_for_pattern（project/frontend 相关路径）、create_text_file（`project/frontend/tests/snowflake_store_contract.spec.ts`）、execute_shell_command（npm run test:unit）  
结果: 新增测试文件 1 个；测试执行失败并输出断言与套件错误  
状态: 成功