已阅读审阅行为规范  
iteration: 1  
review_mode: single

## 任务理解

审阅的任务：对现有前后端代码进行全面审阅，对比需求文档并生成差距分析报告（后端对照 `requirements/系统架构与技术规格.md:138`；前端对照 `doc/frontend_implementation_spec.md:44`）。  
验收标准：  
1. 报告包含后端差距分析小节，列出 API 端点覆盖率（已实现/54）。  
2. 报告包含前端差距分析小节，列出组件覆盖率（已实现/32）。  
3. 报告包含优先级建议小节，按 Milestone 划分实现顺序。

## 验收执行

- 验收命令: `无（工单未提供）`
- 返回码: N/A
- 测试结果: N/A
- 覆盖率: N/A

## 证据分析

### 执行输出
- 未提供验收命令；本次通过脚本统计与文件核对形成差距清单（后端端点 58 / 文档表列 52；前端 API 函数 31 / 规格 57；类型 21 / 规格 24 等）。

### 代码审查

#### 后端差距分析（对照 `requirements/系统架构与技术规格.md:520`、实现见 `project/backend/app/main.py:1`）
- 已实现的 API 端点列表（58 / 文档表列 52；文档标题写 54，但表格仅列 52，尚缺 2 个规格定义）：
```
POST /api/v1/snowflake/step2
POST /api/v1/snowflake/step1
POST /api/v1/snowflake/step3
POST /api/v1/snowflake/step4
POST /api/v1/snowflake/step5a
POST /api/v1/snowflake/step5b
POST /api/v1/roots/{root_id}/anchors
GET /api/v1/roots/{root_id}/anchors
GET /api/v1/roots/{root_id}/subplots
POST /api/v1/roots/{root_id}/subplots
POST /api/v1/subplots/{subplot_id}/activate
POST /api/v1/subplots/{subplot_id}/resolve
PUT /api/v1/anchors/{id}
POST /api/v1/anchors/{id}/check
GET /api/v1/roots/{root_id}/acts
GET /api/v1/acts/{act_id}/chapters
POST /api/v1/entities/{id}/agent/init
GET /api/v1/entities/{id}/agent/state
PUT /api/v1/entities/{id}/agent/desires
POST /api/v1/entities/{id}/agent/decide
POST /api/v1/dm/arbitrate
POST /api/v1/dm/converge
POST /api/v1/dm/intervene
POST /api/v1/dm/replan
POST /api/v1/simulation/round
POST /api/v1/simulation/scene
POST /api/v1/feedback/loop
POST /api/v1/simulation/feedback
GET /api/v1/simulation/logs/{scene_id}
POST /api/v1/render/scene
POST /api/v1/roots/{root_id}/branches
GET /api/v1/roots/{root_id}/branches
POST /api/v1/roots/{root_id}/branches/{branch_id}/switch
POST /api/v1/roots/{root_id}/branches/{branch_id}/merge
POST /api/v1/roots/{root_id}/branches/{branch_id}/revert
POST /api/v1/roots/{root_id}/branches/fork_from_commit
POST /api/v1/roots/{root_id}/branches/fork_from_scene
POST /api/v1/roots/{root_id}/branches/{branch_id}/reset
GET /api/v1/roots/{root_id}/branches/{branch_id}/history
POST /api/v1/roots/{root_id}/branches/{branch_id}/commit
POST /api/v1/roots/{root_id}/scene_origins
POST /api/v1/commits/gc
GET /api/v1/roots/{root_id}
POST /api/v1/roots/{root_id}/entities
GET /api/v1/roots/{root_id}/entities
POST /api/v1/roots/{root_id}/relations
GET /api/v1/scenes/{scene_id}/context
GET /api/v1/scenes/{scene_id}/diff
POST /api/v1/roots/{root_id}/scenes/{scene_id}/delete
POST /api/v1/scenes/{scene_id}/render
POST /api/v1/scenes/{scene_id}/complete
POST /api/v1/scenes/{scene_id}/complete/orchestrated
POST /api/v1/scenes/{scene_id}/dirty
GET /api/v1/roots/{root_id}/dirty_scenes
POST /api/v1/llm/topone/generate
POST /api/v1/logic/check
POST /api/v1/state/extract
POST /api/v1/state/commit
```
- 缺失的 API 端点列表：无（按表格列举 52 个全部实现）；额外实现 6 个：  
  - GET/POST `/api/v1/roots/{root_id}/subplots`、POST `/api/v1/subplots/{subplot_id}/activate`、POST `/api/v1/subplots/{subplot_id}/resolve`、POST `/api/v1/feedback/loop`、POST `/api/v1/simulation/feedback`（实现见 `project/backend/app/main.py:1`）。  
- 已实现的节点类型列表（规格列举 14/实现 14；规格标题写 16 但未列齐）：  
  - Root, Branch, BranchHead, Commit, Act, Chapter, SceneOrigin, SceneVersion, Entity, WorldSnapshot, StoryAnchor, Subplot, CharacterAgentState, SimulationLog（规格见 `requirements/系统架构与技术规格.md:173`；实现见 `project/backend/app/storage/schema.py:1`）。  
- 已实现的数据模型列表（规格列举 40/实现覆盖 40）：  
  - Desire, Intention, AgentAction, ActionResult, DMArbitration, ConvergenceCheck, SimulationRoundResult, ReplanRequest, ReplanResult, IdeaPayload, LoglinePayload, ScenePayload, Step4Result, BranchView, BranchPayload, ForkFromCommitPayload, ForkFromScenePayload, ResetBranchPayload, EntityView, EntityRelationView, CreateEntityPayload, UpsertRelationPayload, SceneView, SceneContextView, SceneCompletePayload, SceneCompletionOrchestratePayload, SceneCompletionResult, SceneRenderResult, CreateSceneOriginPayload, CreateSceneOriginResult, DeleteSceneOriginPayload, SceneReorderPayload, SceneReorderResult, CommitScenePayload, CommitResult, GcPayload, GcResult, RootGraphView, StructureTreeView, StructureTreeActView（规格见 `requirements/系统架构与技术规格.md:423`；实现见 `project/backend/app/models.py:1`）。  
- 缺失的数据模型列表：无（但实现额外 47 个模型超出规格，需后续确认是否需要纳入文档）。  
- 已实现的服务模块列表（规格 9/实现 9）：  
  - world_state_service.py, entity_resolver.py, impact_analyzer.py, dependency_matrix.py, llm_engine.py, character_agent.py, world_master.py, simulation_engine.py, smart_renderer.py（规格见 `requirements/系统架构与技术规格.md:138`；实现示例 `project/backend/app/services/character_agent.py:1`）。  
- 缺失的服务模块列表：无；额外模块：feedback_detector.py、subplot_manager.py、topone_client.py。  
- 核心算法实现状态：  
  - BDI / DM / 推演 / 智能渲染核心文件均有实质逻辑实现（`project/backend/app/services/character_agent.py:1`、`project/backend/app/services/world_master.py:1`、`project/backend/app/services/simulation_engine.py:1`、`project/backend/app/services/smart_renderer.py:1`）。

#### 前端差距分析（规格见 `doc/frontend_implementation_spec.md:44`）
- 目录结构符合度：  
  - 实际 `src/components` 为扁平结构（示例 `project/frontend/src/components/ActionTimeline.vue:1`），未按 spec 的 common/snowflake/simulation/editor/world 子目录拆分。  
  - `src/styles` 为空；仅有 `project/frontend/src/style.css:1`，缺少变量/重置/全局样式文件。  
  - `src/utils` 为空；spec 要求 format.ts/validation.ts。  
  - `src/composables` 仅有 useSnowflake/useSimulation（示例 `project/frontend/src/composables/useSnowflake.ts:1`），缺 usePolling/useNotification。  
  - `src/types` 缺导出入口（spec 要求 index.ts）；现有类型文件见 `project/frontend/src/types/snowflake.ts:1`。  
  - `src/stores` 缺导出入口（spec 要求 index.ts）；现有 store 文件见 `project/frontend/src/stores/snowflake.ts:1`。  
- 已实现的 API 函数列表（31 / 规格 57；命名体系与规范完全不一致）：  
  - fetchActs, fetchAgents, fetchChapters, fetchSimulations, runRound, runScene, createFeedback, apiClient, fetchEntities, createEntity, updateEntity, deleteEntity, fetchRelations, fetchScenes, fetchSceneContext, renderScene, updateScene, diffScene, fetchDmOverview, fetchAnchors, fetchBranches, fetchSubplots, fetchLlmStatus, fetchCommits, fetchSnowflakeStep1, fetchSnowflakeStep2, fetchSnowflakeRoot, fetchSnowflakeStep3, fetchSnowflakeStep4, fetchSnowflakeStep5, fetchSnowflakeStep6（实现示例 `project/frontend/src/api/snowflake.ts:1`）。  
- 缺失的 API 函数列表（57 / 57；规格表列函数名均未出现）：  
  - snowflakeApi.generateLoglines, snowflakeApi.generateStructure, snowflakeApi.generateCharacters, snowflakeApi.generateScenes, snowflakeApi.generateActs, snowflakeApi.generateChapters, anchorApi.generateAnchors, anchorApi.listAnchors, anchorApi.updateAnchor, anchorApi.checkAnchor, agentApi.initAgent, agentApi.getAgentState, agentApi.updateDesires, agentApi.decide, dmApi.arbitrate, dmApi.checkConvergence, dmApi.intervene, dmApi.replan, simulationApi.runRound, simulationApi.runScene, simulationApi.getLogs, simulationApi.renderScene, simulationApi.feedbackLoop, branchApi.createBranch, branchApi.listBranches, branchApi.switchBranch, branchApi.mergeBranch, branchApi.revertBranch, branchApi.forkFromCommit, branchApi.forkFromScene, branchApi.resetBranch, branchApi.getBranchHistory, sceneApi.createScene, sceneApi.deleteScene, sceneApi.completeScene, sceneApi.completeOrchestrated, sceneApi.renderScene, sceneApi.getContext, sceneApi.diffScene, sceneApi.markDirty, snowflakeApi.listActs, snowflakeApi.listChapters, entityApi.createEntity, entityApi.listEntities, entityApi.upsertRelation, subplotApi.createSubplot, subplotApi.listSubplots, subplotApi.resolveSubplot, branchApi.getRootSnapshot, sceneApi.listDirtyScenes, commitApi.commitScene, commitApi.gcCommits, llmApi.toponeGenerate, llmApi.logicCheck, llmApi.stateExtract, llmApi.stateCommit, feedbackApi.feedbackLoop（规格见 `doc/frontend_implementation_spec.md:947`）。  
- 已实现的类型定义列表（21 / 规格 24；仅 4 项名称一致）：  
  - AgentAction, ActionResult, DMArbitration, SimulationConfig, SimulationState, EntityBase, EntityPosition, WorldEntity, Scene, ApiResponse, SnowflakeStructure, SnowflakeCharacter, SnowflakeSceneNode, SnowflakeStep4Result, SnowflakeStep4Payload, SnowflakeStep5Payload, SnowflakeSteps, SnowflakeRoot, SnowflakeAct, SnowflakeChapter, SnowflakeAnchor（实现示例 `project/frontend/src/types/snowflake.ts:1`）。  
- 缺失的类型定义列表（20 / 24）：  
  - CharacterSheet, SceneNode, Act, Chapter, Step4Result, Desire, Intention, CharacterAgentState, ConvergenceCheck, SimulationRoundResult, ReplanResult, ReplanRequest, FeedbackReport, EntityView, EntityRelationView, StoryAnchor, Subplot, SceneView, SceneContextView, WorldSnapshot（规格见 `doc/frontend_implementation_spec.md:150`）。  
- 已实现的 Store 列表（5 / 5）：project, snowflake, simulation, editor, world（实现示例 `project/frontend/src/stores/snowflake.ts:1`）；缺少统一导出入口（spec 要求）。  
- 已实现的组件列表（7 / 规格表列 31；规格标题写 32 但表格仅列 31）：  
  - AppSidebar, EmptyState, CharacterCard, SceneCard, ActionTimeline, EntityList, AnchorTimeline（实现示例 `project/frontend/src/components/ActionTimeline.vue:1`）。  
- 缺失的组件列表（24 / 31）：  
  - AppHeader, LoadingOverlay, StepIndicator, Step1Panel, Step2Panel, Step3Panel, Step4Panel, Step5Panel, Step6Panel, LoglineSelector, ActCard, ChapterCard, AgentStatePanel, ArbitrationResult, ConvergenceIndicator, RoundPlayer, SceneEditor, ContentRenderer, VersionDiff, MarkdownPreview, SimulationLogs, SceneContextPanel, RelationGraph, SubplotPanel（规格见 `doc/frontend_implementation_spec.md:909`）。  
- 额外组件（26）：BeatCard, BranchList, CommitList, EntityBadge, ErrorBanner, FeedbackForm, FilterBar, HelloWorld, LlmStatus, LoadingIndicator, MetricsPanel, ModalDialog, PageHeader, ProgressBar, ProjectHeader, SceneTimeline, SceneToolbar, SearchBox, SectionTitle, SimulationControls, SimulationStatus, SnowflakeStepCard, StatusBadge, SubplotList, WorldCard, WorldToolbar。  
- 视图与路由：  
  - 路由 6 条与规格一致（`project/frontend/src/router/index.ts:1` 对照 `doc/frontend_implementation_spec.md:896`）。  
  - 视图命名与规范不一致：缺 SnowflakeView/SimulationView/EditorView/WorldView；现有 SnowflakeFlow/SimulationConsole/SceneEditor/WorldManager（实现示例 `project/frontend/src/views/SnowflakeFlow.vue:1`）。  

#### 优先级建议（Milestone）
- M1（契约对齐）：统一前端 API 函数命名与模块组织（按附录 C），补齐 types 定义与 stores/types 导出入口，补齐 composables/util/styles 的规范文件；必要时先更新现有代码以匹配后端接口（规范见 `doc/frontend_implementation_spec.md:150`）。  
- M2（组件与视图补齐）：按附录 B 补齐缺失组件，并将 components 目录按 common/snowflake/simulation/editor/world 分层；视图文件命名与路由组件对齐。  
- M3（文档一致性与后端同步）：规格中计数不一致项（后端端点 54 vs 列 52、节点 16 vs 列 14、模型 50 vs 列 40；前端组件 32 vs 列 31、API 58 vs 列 57）需统一修订或补充缺失清单；后端新增 subplot/feedback 端点是否纳入规格需确认。

## 结论

结论：FAIL  
失败类型：实现问题  
阻塞：前端目录/组件/API函数/类型与规范大量不匹配，无法满足当前规格交付

## 建议

- 优先修订规格中的数量不一致清单，明确缺失 2 个后端端点与前端 1 个 API 函数/1 个组件的具体项，再推进实现。  
- 按 M1/M2 阶段性推进前端对齐：先补齐类型与 API 层（利于后续组件开发），再补齐组件与视图。  
- 后端方面建议将已实现的 subplot/feedback 相关端点纳入规格或回收实现，以避免文档与实现分叉。

【MCP调用简报】  
服务: serena  
触发: 读取需求文档与代码、统计差距  
参数: read_file/execute_shell_command（max_answer_chars: -1）  
结果: 端点/模型/组件/API/类型/路由清单已提取  
状态: 成功