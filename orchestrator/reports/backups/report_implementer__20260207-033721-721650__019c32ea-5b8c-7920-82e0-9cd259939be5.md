已阅读实现者行为规范
iteration: 9

## Phase 1: 红灯阶段

### 测试设计思路
本轮红灯聚焦两类高风险点：  
1) `scene_id` 边界输入（格式非法、项目内不存在）是否会触发未处理异常与 console error 泄漏；  
2) 需求证据链是否可独立复现（Step1~Step6 请求链、Simulation Scene、章节渲染与超时配置）。

### 创建的测试文件
- `project/frontend/tests/simulation_view_m3_t1.spec.ts` - 在既有文件中补充边界用例，覆盖 malformed/unknown scene_id 的前置拦截与错误展示路径。

### 测试用例清单
| 用例名称 | 测试场景 | 预期结果 |
|---------|---------|---------|
| M3-T1 blocks malformed scene id before network request | `scene_id` 为 XSS 样式非法值 | 不发起 context/scene 推演请求，展示受控错误 |
| M3-T1 blocks unknown scene id before context request when scene list is loaded | `scene_id` 格式合法但不在当前项目场景列表 | 不发起 context 请求，展示受控错误 |
| Simulation valid scene flow | 合法 scene 执行 Step+Scene | `round`/`scene` 请求均 200，console 无 error |

### 红灯确认
- 命令: `Playwright MCP 场景4（SYNTHESIZER Iteration 8 失败复现基线）`
- 结果: 失败（预期）
- 失败原因: 修复前无效 `scene_id` 会触发未处理 AxiosError，出现 console error 泄漏（EDGE_CASE_TESTER 历史失败点）

---

## Phase 2: 绿灯阶段

### 实现方案
按 KISS/YAGNI 最小改动策略，仅在 `SimulationView` 的 scene 请求路径补前置校验与受控失败，不做大规模重构：  
- 先验校验 `scene_id` 格式；  
- 场景列表加载后校验 `scene_id` 是否属于当前项目；  
- `loadSceneContext` 在网络请求前快速失败；  
- `onMounted` 改为先加载 scene 列表，再加载 context/agents，避免竞态穿透；  
- 保持 `try/catch -> errorMessage` 的显式错误展示，不静默吞错。

### 改动说明
| 文件 | 修改内容 | 实现逻辑 |
|-----|---------|---------|
| `project/frontend/src/views/SimulationView.vue:234` | 新增 `SCENE_ID_PATTERN` + `assertValidSceneId` | 对非法 `scene_id` 在请求前快速失败 |
| `project/frontend/src/views/SimulationView.vue:242` | 新增 `assertSceneInProject` | 场景列表已就绪时阻断“不属于当前项目”的 scene_id |
| `project/frontend/src/views/SimulationView.vue:417` | `loadSceneContext` 前置双校验 | 防止 404 异常进入未受控路径 |
| `project/frontend/src/views/SimulationView.vue:458` | `onMounted` 串行化初始化 | 先 `loadSceneOptions`，后 `loadSceneContext/loadAgents`，消除竞态 |
| `project/frontend/tests/simulation_view_m3_t1.spec.ts:474` | 新增 malformed scene_id 用例 | 断言不发请求且展示 `scene_id format is invalid` |
| `project/frontend/tests/simulation_view_m3_t1.spec.ts:490` | 新增 unknown scene_id 用例 | 断言不发 context 请求且展示 `scene_id not found...` |

### 绿灯确认
- 命令: `npm --prefix project/frontend run test -- tests/simulation_view_m3_t1.spec.ts tests/simulation_view_branches.spec.ts`
- 结果: `21 passed`
- 命令: `MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit/test_topone_gateway_structured.py project/backend/tests/integration/test_simulation_api.py -v`
- 结果: `7 passed`
- 命令: `npm --prefix project/frontend run test:coverage`
- 结果: `45 files passed, 263 tests passed`
- 覆盖率: `All files 88.52%`（>=80%）

---

## 需求证据链（本轮补齐）

1) **Step1~Step6 全流程请求日志（URL+status）**  
- 证据文件：`snowflake_step_chain.log:7`（step1）到 `snowflake_step_chain.log:52`（step6）  
- 顺序证据：`step1 -> step2 -> step3 -> step4 -> step5a -> step5b -> step6`（严格有序，无跳步）  
- 全部状态码：200（见 `snowflake_step_chain.log:10`, `:17`, `:24`, `:31`, `:38`, `:45`, `:52`）

2) **Simulation Step/Scene 正常**  
- `simulation_valid_network.log:6` `POST /simulation/round => 200`  
- `simulation_valid_network.log:8` `POST /simulation/scene => 200`  
- `simulation_valid_console.log:1` Errors: 0

3) **无效 scene_id 受控失败（不泄漏 console error）**  
- unknown scene_id：  
  - 页面提示：`simulation_invalid_snapshot.md:38` / `simulation_invalid_snapshot.md:43`  
  - 网络仅 root 请求：`simulation_invalid_network.log:1`  
  - console 无 error：`simulation_invalid_console.log:1`
- malformed/XSS scene_id：  
  - 页面提示：`simulation_xss_snapshot.md:38` / `simulation_xss_snapshot.md:43`  
  - 网络仅 root 请求：`simulation_xss_network.log:1`  
  - console 无 error：`simulation_xss_console.log:1`

4) **10章 + 渲染完成 + 主题一致性**（既有赛博朋克项目数据）  
- 章节规模：`chapter_stats.json:8` (`chapters: 10`)  
- 渲染完成：`chapter_stats.json:10` (`rendered_chapters: 10`)  
- 每章渲染状态：`chapter_stats.json:23`~`chapter_stats.json:68` 全为 200  
- 字数统计：`chapter_stats.json:11`（min 2647 / max 3540 / avg 3046.7）  
- 关键词命中：`chapter_stats.json:16`（何方=239，赛博=15）

5) **TopOne 超时 >= 10 分钟**  
- 前端：`project/frontend/src/api/index.ts:8` `timeout: 600000`  
- 后端：`project/backend/app/config.py:36`~`project/backend/app/config.py:42` 强制 `TOPONE_TIMEOUT_SECONDS >= 600`

---

## 自测结果汇总

| 验收命令 | 返回码 | 结果 |
|---------|-------|------|
| `npm --prefix project/frontend run test -- tests/simulation_view_m3_t1.spec.ts tests/simulation_view_branches.spec.ts` | 0 | 21 passed |
| `MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit/test_topone_gateway_structured.py project/backend/tests/integration/test_simulation_api.py -v` | 0 | 7 passed |
| `npm --prefix project/frontend run test:coverage` | 0 | 263 passed, 覆盖率 88.52% |
| Playwright MCP：valid/invalid/xss 三场景网络+console采样 | 0 | 全部无 console error，关键 API 状态符合预期 |
| Anti-cheat 关键 grep（排除第三方/缓存目录） | 0 | 未命中硬编码ID、localhost/127、TODO/FIXME 等 |

自测结果: PASS

---

## 职责边界说明

### IMPLEMENTER 测试职责
| 测试类型 | 工具 | 目的 |
|---------|------|------|
| 单元/集成测试 | Bash (`pytest`) | 验证后端逻辑与接口映射 |
| 前端单元测试 | Bash (`vitest`) | 验证视图与状态逻辑 |
| 覆盖率测试 | Bash (`vitest --coverage`) | 验证回归质量门槛 |
| 前端功能自测 | Playwright MCP | 验证真实浏览器交互、网络与console |

### Playwright MCP 自测 vs 验证器测试
- 本轮自测已覆盖：场景有效链路、无效 scene_id 边界、console/network 双证据。
- 验证器仍会做独立复核；本次提交目标是先把可复现证据链补齐，减少返工。

### 真实环境验证（验证器职责）
- 真实验收仍由 TEST_RUNNER / EDGE_CASE_TESTER / FINISH_REVIEW 执行。  
- 当前已提供可独立复现的证据文件与命令，便于验证器直接复查。

---

## 验证信息

### 测试命令
```yaml
commands:
  - cmd: "npm --prefix project/frontend run test -- tests/simulation_view_m3_t1.spec.ts tests/simulation_view_branches.spec.ts"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit/test_topone_gateway_structured.py project/backend/tests/integration/test_simulation_api.py -v"
    cwd: "/home/zxh/ainovel_v3"
    type: integration
  - cmd: "npm --prefix project/frontend run test:coverage"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
```

### 修改文件
```yaml
files:
  - path: "project/frontend/src/views/SimulationView.vue"
    type: implementation
  - path: "project/frontend/tests/simulation_view_m3_t1.spec.ts"
    type: test
```

### API 签名
```yaml
signatures:
  - name: "assertValidSceneId"
    file: "project/frontend/src/views/SimulationView.vue"
    params: ["value"]
  - name: "assertSceneInProject"
    file: "project/frontend/src/views/SimulationView.vue"
    params: ["value"]
  - name: "loadSceneContext"
    file: "project/frontend/src/views/SimulationView.vue"
    params: []
```

结论：PASS  
阻塞：无

【MCP调用简报】  
服务: serena  
触发: 代码定位与证据定位（SimulationView 关键函数、测试新增点、超时配置行号）  
参数: `read_file/search_for_pattern/find_file`（限定在 `project/frontend`/`project/backend`）  
结果: 命中关键实现与测试位置，确认边界修复路径与配置证据  
状态: 成功

【MCP调用简报】  
服务: playwright  
触发: 真实浏览器自测与证据补齐（valid/invalid/xss scene_id）  
参数: `browser_navigate/browser_click/browser_wait_for/browser_network_requests/browser_console_messages/browser_snapshot`  
结果: valid 场景 `round/scene` 均 200；invalid/xss 仅 root 请求且 console error=0；页面有受控错误提示  
状态: 成功

【MCP调用简报】  
服务: shell  
触发: 命令行回归测试、覆盖率、Step1~Step6 请求链日志生成与反作弊 grep 自检  
参数: `pytest/vitest/coverage/python requests 脚本/grep`  
结果: 前后端回归通过、覆盖率 88.52%、Step1~Step6 URL+状态链补齐、反作弊关键模式未命中  
状态: 成功