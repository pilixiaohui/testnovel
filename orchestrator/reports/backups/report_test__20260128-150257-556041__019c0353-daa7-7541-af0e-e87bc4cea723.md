已阅读测试行为规范
iteration: 3

## 测试需求分析

工单要求测试的功能点：
1. 解决 `Unknown file extension ".css"`（element-plus CSS 导入）导致的 test suite 失败。
2. `snowflake_store_contract.spec.ts` 与 Step1-6 映射一致，actions/字段断言清晰。
3. 测试运行失败应由实现缺失导致，而非套件/环境错误。

## 测试设计

### 设计思路
- 通过 element-plus 样式模块 mock 解除 CSS 导入错误，确保 suite 可运行。
- Snowflake 合同测试对齐 Step1-6 映射：Step1 logline → Step2 root → Step3 characters → Step4 scenes → Step5 acts/chapters → Step6 anchors。
- 继续使用 deferred promise 验证“未完成 API 调用时 state 不前进”。

### 创建的测试文件
- `project/frontend/tests/element_plus_style_mock.ts` - element-plus 样式模块 mock，消除 CSS 导入错误。
- `project/frontend/tests/fe_core_views_contract.spec.ts` - 引入样式 mock（更新）。
- `project/frontend/tests/fe_core_views_minimal.spec.ts` - 引入样式 mock（更新）。
- `project/frontend/tests/snowflake_store_contract.spec.ts` - 校准 Step1-6 映射（更新）。

### 测试用例清单

| 用例名称 | 测试场景 | 对应功能点 | 测试逻辑说明 |
|---------|---------|-----------|-------------|
| uses VITE_API_BASE_URL when set | 正常流程 | 功能点2 | env 有值时 baseURL 等于 env |
| falls back to /api/v1 when VITE_API_BASE_URL is missing | 正常流程 | 功能点2 | env 为空时 baseURL 为 /api/v1 |
| state exposes step1-6 fields | 正常流程 | 功能点2 | state 必须包含 logline/root/characters/scenes/acts/chapters/anchors |
| actions call snowflake APIs and update state per step mapping | 正常流程 | 功能点2 | Step1-6 action 调用对应 API 并更新 state |
| does not advance state before async API resolves | 异步保护 | 功能点3 | promise 未 resolve 前 state 不更新 |

### 关键测试逻辑
- 通过 `element_plus_style_mock.ts` 对 `element-plus/es/components/*/style/css` 进行 mock，避免 CSS 扩展名导致的 suite 错误。
- Snowflake actions 使用 `vi.mock` 控制 API 返回值，断言调用参数 + state 更新。
- 使用 deferred promise 验证 `fetchStep3` 未完成前 `characters` 仍为空数组。
- baseURL 使用 `import.meta.env` + `vi.stubEnv` 覆盖验证分支逻辑。

## 测试执行

- 命令: `cd /home/zxh/ainovel_v3/project/frontend && MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 npm run test:unit`
- 结果: 失败
- 红灯确认: 是（失败均为实现缺失/契约不一致导致断言失败）

### 执行详情
- suite 错误已清零：`tests/fe_core_views_contract.spec.ts`、`tests/fe_core_views_minimal.spec.ts` 均通过，CSS 导入问题已消除。
- 失败来源（实现缺失/契约不一致）：
  - `tests/snowflake_store_contract.spec.ts`: baseURL 未读取 env；Snowflake store 缺少 Step1-6 字段与 actions。
  - `src/__tests__/fe_api_types_store_alignment.test.ts`: store state 与类型约束不一致（断言失败）。

## 验收标准

- 命令: `cd /home/zxh/ainovel_v3/project/frontend && npm run test:unit`
- 阈值: 测试可运行、套件错误清零、红灯来自实现缺失

结论：PASS  
阻塞：无

【MCP调用简报】
服务: serena  
触发: 读取测试/视图文件、修复测试、执行单测  
参数: read_file, create_text_file, execute_shell_command  
结果: 新增样式 mock 文件；更新 3 个测试文件；`npm run test:unit` 执行完成并验证红灯  
状态: 成功