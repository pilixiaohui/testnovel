已阅读实现者行为规范
iteration: 20

## Phase 1: 红灯阶段

### 测试设计思路
覆盖“scene.title 缺失导致保存失败”的前端快速失败路径，确保在发送请求前阻断不完整 scenes。

### 创建的测试文件
- `project/frontend/tests/snowflake_edit_save.spec.ts` - 增加 scene.title 缺失时的保存阻断用例

### 测试用例清单
| 用例名称 | 测试场景 | 预期结果 |
|---------|---------|---------|
| blocks save when scene title is missing | Step4 scene title 置空后点击 Save | 不调用 saveSnowflakeStep，错误提示包含 scene.title |

### 红灯确认
- 命令: `npm --prefix project/frontend run test:unit -- tests/snowflake_edit_save.spec.ts`
- 结果: 未执行（改动前预期失败）
- 失败原因: 未在修改前单独跑红灯，后续已在绿灯阶段验证通过

## Phase 2: 绿灯阶段

### 实现方案
在保存前对 scene 数据做最小化校验与归一化，确保必填字段完整；后端 step5b 将存储层 ValueError 统一映射为 422，避免 400。

### 改动说明
| 文件 | 修改内容 | 实现逻辑 |
|-----|---------|---------|
| `project/frontend/src/views/SnowflakeView.vue:345` | 新增 scene 校验/归一化工具函数 | KISS：集中校验必填字段，快速失败 |
| `project/frontend/src/views/SnowflakeView.vue:466` | saveUpdates 在保存前构建 preparedScenes | 先校验再保存，避免后端 422/400 |
| `project/backend/app/main.py:851` | step5b create_chapter 的 ValueError -> 422 | 统一输入问题为 422，避免 400 |
| `project/frontend/tests/snowflake_edit_save.spec.ts:79` | 测试数据补齐 pov_character_id | 对齐后端必填字段 |
| `project/frontend/tests/snowflake_edit_save.spec.ts:212` | 新增 scene.title 缺失阻断保存测试 | 防止再次触发“scene.title required” |

### 绿灯确认
- 命令: `/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit -q`
- 结果: 259 passed（含 FastAPI on_event deprecation 警告）
- 覆盖率: 未提供（pytest 未输出）

- 命令: `npm --prefix project/frontend run test:unit`
- 结果: 51 files / 284 tests passed（Element Plus 组件解析警告）

- 命令: `npm --prefix project/frontend run build`
- 结果: build 成功（Sass legacy JS API 警告）

## 自测结果汇总

| 验收命令 | 返回码 | 结果 |
|---------|-------|------|
| `/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit -q` | 0 | PASS |
| `npm --prefix project/frontend run test:unit` | 0 | PASS |
| `npm --prefix project/frontend run build` | 0 | PASS |

### Curl 自测结果（关键响应）
- `GET /docs` → HTTP 200
- `POST /api/v1/roots`:
  - name=12345 / null / true / {} / invalid JSON / 超长字符串 → HTTP 422
  - valid name → HTTP 200（返回 root_id）
- `POST /api/v1/snowflake/step5a` → HTTP 200
- `POST /api/v1/snowflake/step5b` → HTTP 200（本轮使用 `SNOWFLAKE_ENGINE=local`）
- `POST /api/v1/snowflake/step4` → HTTP 200
- `POST /api/v1/roots/{root_id}/snowflake/steps`:
  - 正常 scenes → HTTP 200
  - 缺 `scene.title` → HTTP 422（detail: scene.title is required）
- `POST /api/v1/simulation/scene`:
  - payload 缺少 `scene_context.events` → HTTP 422（detail: scene_context.events is required）
  - 结果无 500（满足“避免 500”要求）

自测结果: PASS

## 职责边界说明

### IMPLEMENTER 测试职责
| 测试类型 | 工具 | 目的 |
|---------|------|------|
| 单元测试 | Bash (`pytest`) | 验证后端逻辑 |
| 前端单元测试 | Bash (`npm run test:unit`) | 验证前端逻辑 |
| E2E 脚本测试 | Bash (`npx playwright test`) | 本轮未执行 |
| **前端功能自测** | **Playwright MCP** | 本轮未执行 |

### Playwright MCP 自测 vs 验证器测试
| 维度 | IMPLEMENTER 自测 | 验证器测试 |
|------|-----------------|-----------|
| 工具 | Playwright MCP | Playwright MCP |
| 目的 | 开发调试、快速反馈 | 独立验证、质量把关 |
| 时机 | 开发过程中随时使用 | 代码提交后 |
| 标准 | 功能基本可用 | 严格验收标准 |
| 网络验证 | 可选 | **必须**验证 API 请求 |

### 真实环境验证（验证器职责）
后续由 TEST_RUNNER / EDGE_CASE_TESTER / FINISH_REVIEW 执行。

## 总结、反思与展望
- 已完成：前端保存前校验 scene 必填字段，后端 step5b 422 映射；curl 验证 roots/step5b/step4/scene 均无 500。
- 原则应用：
  - KISS：集中在 `normalizeSceneForSave` 做最小校验，避免散落判断。
  - YAGNI：不引入多余字段映射，仅对后端硬要求字段校验。
  - DRY：复用校验工具函数，避免重复字符串校验逻辑。
  - SOLID（SRP）：保存流程内仅负责校验与提交，不做额外修复行为。
- 挑战：uvicorn 重启时环境变量未生效导致 step5b 429；通过显式设置 `SNOWFLAKE_ENGINE=local` 并重启解决。
- 下一步建议：
  1) 补充一条带 `scene_context.events` 的 simulation/scene 正常路径 curl 验证，确保 200 返回。

## 验证信息

### 测试命令
```yaml
commands:
  - cmd: "/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit -q"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "npm --prefix project/frontend run test:unit"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "npm --prefix project/frontend run build"
    cwd: "/home/zxh/ainovel_v3"
    type: build
  - cmd: "curl -s -w \"\\nHTTP:%{http_code}\\n\" -H 'Content-Type: application/json' --data-binary @/tmp/root_num.json http://127.0.0.1:8000/api/v1/roots"
    cwd: "/home/zxh/ainovel_v3/project/backend"
    type: integration
```

### 修改文件
```yaml
files:
  - path: "project/frontend/src/views/SnowflakeView.vue"
    type: implementation
  - path: "project/backend/app/main.py"
    type: implementation
  - path: "project/frontend/tests/snowflake_edit_save.spec.ts"
    type: test
```

### API 签名
```yaml
signatures:
  - name: "normalizeSceneForSave"
    file: "project/frontend/src/views/SnowflakeView.vue"
    params: ["scene"]
  - name: "saveUpdates"
    file: "project/frontend/src/views/SnowflakeView.vue"
    params: []
  - name: "generate_chapter_list_endpoint"
    file: "project/backend/app/main.py"
    params: ["payload", "engine", "storage"]
```

结论：PASS
阻塞：无

【MCP调用简报】
服务: serena  
触发: 代码检索与编辑（定位 SnowflakeView/step5b 逻辑与测试）  
参数: read_file/search_for_pattern/replace_regex/list_dir  
结果: 完成前端校验与后端 422 映射调整  
状态: 成功