已阅读实现者行为规范
iteration: 1

## Phase 1: 红灯阶段

### 测试设计思路
围绕本轮核心缺陷做最小必要测试补强：  
1) 保存链路（scene complete + commit）参数完整性；2) 场景编辑空摘要边界；3) state extract 在上下文缺失 `entity_ids` 时的回退行为；4) 项目列表刷新后 stale root 的上下文一致性。  
目标是先用失败用例锁定回归点，再做最小实现让用例转绿。

### 创建的测试文件
- `project/frontend/src/__tests__/project_store_save.test.ts` - 覆盖 `saveProjectData` 参数校验与 commit payload
- `project/frontend/tests/project_store.spec.ts` - 覆盖 stale root 上下文清理
- `project/frontend/tests/state_extract_panel.spec.ts` - 覆盖 `entity_ids` 回退到 `fetchEntities`
- `project/frontend/tests/scene_editor_edit_save.spec.ts` - 覆盖空摘要禁止保存

### 测试用例清单
| 用例名称 | 测试场景 | 预期结果 |
|---------|---------|---------|
| saveProjectData rejects missing content | 提交空 content | 抛出 `content is required` |
| clears stale project context | 当前 root 不在最新项目列表 | 清空 root/scene，branch 回到 main |
| loads fallback entity ids from entities API | context 无 entity_ids | 调用 entities API 并继续 state extract |
| blocks save when summary is empty | Summary 为空点击 Save | 不调用 update 接口并显示错误 |
| loads scene content and saves update | Load 后编辑并保存 | complete + commit 正常成功 |
| loadProject persists root_id | 加载项目后刷新上下文 | `localStorage` 与 store 一致 |

### 红灯确认
- 命令: `npx vitest run src/__tests__/project_store_save.test.ts tests/scene_editor_edit_save.spec.ts tests/state_extract_panel.spec.ts tests/project_store.spec.ts`
- 结果: 失败（预期）
- 失败原因: 在红灯阶段，新增用例暴露了保存链路 content 缺失校验、空摘要提交、entity_ids 回退与 stale root 清理等实现缺口

## Phase 2: 绿灯阶段

### 实现方案
采用“最小改动闭环”：
- 保存路径只做必要字段对齐（KISS/YAGNI），不扩展后端接口。
- 将校验下沉到 store/view 明确边界（SRP），失败即报错（快速失败）。
- 去除空提交/脏上下文带来的重复问题（DRY）。
- 保持现有 API 约束，前端适配不侵入其它模块（OCP）。

### 改动说明
| 文件 | 修改内容 | 实现逻辑 |
|-----|---------|---------|
| `project/frontend/src/stores/project.ts` | `listProjects` 增加 stale root 清理；`saveProjectData` 改为必须传 `content` | 避免过期上下文；commit 必须携带真实场景内容 |
| `project/frontend/src/stores/editor.ts` | 默认 `outcome` 与 `reset` 均改为 `success` | 避免空 outcome 导致后端 422 |
| `project/frontend/src/views/EditorView.vue` | `loadScene` 增加 summary/outcome 字段回退；`saveScene` 增加 summary 必填；commit 传完整 content | 打通 scene complete + commit 链路，确保字段齐全 |
| `project/frontend/src/components/StateExtractPanel.vue` | `resolveEntityIds` 增加多级来源；无 id 时回退 `fetchEntities` | 先补齐实体，再调用 state extract，仍缺失则快速失败 |
| `project/frontend/src/__tests__/project_store_save.test.ts` | 适配新签名并新增 content 缺失断言 | 锁定 store 保存契约 |
| `project/frontend/tests/project_store.spec.ts` | 新增 stale root 清理测试 | 锁定上下文一致性 |
| `project/frontend/tests/state_extract_panel.spec.ts` | 新增 entities API 回退测试 | 锁定 state extract 回退行为 |
| `project/frontend/tests/scene_editor_edit_save.spec.ts` | 空摘要保存改为阻断并断言错误提示 | 锁定编辑器边界条件 |

### 绿灯确认
- 命令: `npm --prefix project/frontend run test:unit`
- 结果: 48 passed（270 tests）
- 覆盖率: 89.01%（`npm --prefix project/frontend run test:coverage`）

## 自测结果汇总

| 验收命令 | 返回码 | 结果 |
|---------|-------|------|
| `curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8000/docs && curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:5185` | 0 | 后端/前端服务可访问（200/200） |
| `npm --prefix project/frontend run test:unit` | 0 | 48 files / 270 tests 全通过 |
| `npx vitest run src/__tests__/project_store_save.test.ts tests/scene_editor_edit_save.spec.ts tests/state_extract_panel.spec.ts tests/project_store.spec.ts`（cwd=`/home/zxh/ainovel_v3/project/frontend`） | 0 | 4 files / 25 tests 全通过 |
| `npm --prefix project/frontend run test:coverage` | 0 | 覆盖率达标（All files 89.01%，Branch 81.61%） |
| Playwright MCP：Editor Load/Save 网络链路验证 | 0 | `POST /scenes/{id}/complete` 200，`POST /roots/{root}/branches/main/commit` 200 |
| Playwright MCP：stale root 场景验证 | 0 | 首页显示“暂无项目”，编辑器显示 `Project context required`，无 console error |
| 反作弊扫描（8个改动文件）：ID/URL/TODO 关键字 grep | 0 | 均为空结果 |

自测结果: PASS

## 原则应用与收益
- **KISS**：仅修复保存链路、实体回退、上下文清理三条主路径，避免泛化重构。  
- **YAGNI**：未引入新依赖、未扩展后端接口，完全在现有契约内修复。  
- **SOLID**：把参数完整性放在 store/view 边界做显式校验，组件职责更清晰。  
- **DRY**：统一使用 `saveProjectData(rootId, content)` 与 `resolveEntityIds` 回退链，减少散落重复判断。  

## 遇到的挑战与处理
- 历史脏场景 ID 会触发 `scene version not found`（404），影响单次加载；已通过选择有效 scene 并复测确认保存主链路正常。  
- state extract 在后端实体为空时仍会失败；前端已完成 API 回退与明确报错，符合快速失败原则（不做吞错兜底）。  

## 下一步计划和建议
1. 补一条“有效 scene 列表过滤不可加载 scene”的前端用例，减少历史数据噪声。  
2. 若业务要求 state extract 在无实体时也可运行，需要后端明确新契约（当前保持快速失败）。  

## 职责边界说明

### IMPLEMENTER 测试职责

你负责执行以下测试，确保代码逻辑正确：

| 测试类型 | 工具 | 目的 |
|---------|------|------|
| 单元测试 | Bash (`pytest`) | 验证函数逻辑 |
| 前端单元测试 | Bash (`npm run test:unit`) | 验证组件逻辑 |
| E2E 脚本测试 | Bash (`npx playwright test`) | 验证页面流程（Mock 后端） |
| **前端功能自测** | **Playwright MCP** | **验证真实浏览器中的 UI 和交互** |

### Playwright MCP 自测 vs 验证器测试

| 维度 | IMPLEMENTER 自测 | 验证器测试 |
|------|-----------------|-----------|
| 工具 | Playwright MCP | Playwright MCP |
| 目的 | 开发调试、快速反馈 | 独立验证、质量把关 |
| 时机 | 开发过程中随时使用 | 代码提交后 |
| 标准 | 功能基本可用 | 严格验收标准 |
| 网络验证 | 可选 | **必须**验证 API 请求 |

**关键区别**：
- 你的自测是为了**快速发现和修复问题**
- 验证器测试是为了**独立验证质量**，会检测 mock 数据等作弊行为
- 你应该在自测通过后再提交，减少验证器返工

### 真实环境验证（验证器职责）

真实浏览器验证由后续验证器（TEST_RUNNER、EDGE_CASE_TESTER、FINISH_REVIEW）执行。

验证器会执行更严格的检查：
- **网络请求验证**：确保 API 真正被调用，而非 mock 数据
- 前后端集成问题
- 真实数据格式问题
- 边界条件处理问题

你只需确保：
- ✅ 前端服务可正常启动
- ✅ 后端 API 可正常响应
- ✅ 代码无明显的运行时错误
- ✅ 命令行测试全部通过
- ✅ Playwright MCP 自测基本功能正常

## 验证信息

### 测试命令
```yaml
commands:
  - cmd: "npm --prefix project/frontend run test:unit"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "npx vitest run src/__tests__/project_store_save.test.ts tests/scene_editor_edit_save.spec.ts tests/state_extract_panel.spec.ts tests/project_store.spec.ts"
    cwd: "/home/zxh/ainovel_v3/project/frontend"
    type: unit
  - cmd: "npm --prefix project/frontend run test:coverage"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "curl -s -o /dev/null -w \"%{http_code}\" http://127.0.0.1:8000/docs && echo && curl -s -o /dev/null -w \"%{http_code}\" http://127.0.0.1:5185"
    cwd: "/home/zxh/ainovel_v3"
    type: integration
```

### 修改文件
```yaml
files:
  - path: "project/frontend/src/stores/project.ts"
    type: implementation
  - path: "project/frontend/src/stores/editor.ts"
    type: implementation
  - path: "project/frontend/src/views/EditorView.vue"
    type: implementation
  - path: "project/frontend/src/components/StateExtractPanel.vue"
    type: implementation
  - path: "project/frontend/src/__tests__/project_store_save.test.ts"
    type: test
  - path: "project/frontend/tests/project_store.spec.ts"
    type: test
  - path: "project/frontend/tests/state_extract_panel.spec.ts"
    type: test
  - path: "project/frontend/tests/scene_editor_edit_save.spec.ts"
    type: test
```

### API 签名
```yaml
signatures:
  - name: "saveProjectData"
    file: "project/frontend/src/stores/project.ts"
    params: ["rootId", "content"]
  - name: "loadScene"
    file: "project/frontend/src/views/EditorView.vue"
    params: []
  - name: "saveScene"
    file: "project/frontend/src/views/EditorView.vue"
    params: []
  - name: "resolveEntityIds"
    file: "project/frontend/src/components/StateExtractPanel.vue"
    params: ["context"]
  - name: "extractState"
    file: "project/frontend/src/components/StateExtractPanel.vue"
    params: []
```

结论：PASS  
阻塞：无

【MCP调用简报】  
服务: serena  
触发: 复核前端关键实现与测试文件、确认任务完成度  
参数: `read_file`(8个关键文件), `check_onboarding_performed`, `think_about_*`  
结果: 命中目标实现与测试逻辑，信息充分  
状态: 成功  

【MCP调用简报】  
服务: playwright  
触发: 真实浏览器自测（保存链路、标签切换、state extract、stale root）  
参数: `browser_navigate/click/select_option/run_code/snapshot/network_requests/console_messages`  
结果: 保存链路接口 200；stale root 显示上下文缺失保护；关键流程无页面崩溃  
状态: 成功