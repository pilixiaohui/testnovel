已阅读审阅行为规范  
iteration: 14  
review_mode: single  

## 任务理解
目标：复核 DEV Iteration 13 的“按后端契约修复”是否正确，并对照失败用例判断 **问题归属（测试问题 vs 实现问题）**。  
验收标准：给出明确归属 + 列出需修复的具体文件/点位 + 下一步建议（派发 TEST 或 DEV）。

## 验收执行
- 命令: `cd /home/zxh/ainovel_v3/project/frontend && npm run test:e2e` | 返回码: 1 | 结果: **8 passed / 7 failed**
  - 失败用例：`tests/e2e/chapter-render.spec.ts:72`、`tests/e2e/chapter-render.spec.ts:89`、`tests/e2e/core.e2e.spec.ts:195`、`tests/e2e/core.e2e.spec.ts:336`、`tests/e2e/state-extract.spec.ts:107`、`tests/e2e/state-extract.spec.ts:137`、`tests/e2e/version-control.spec.ts:87`

## 代码深度审查

### 实现代码
- 文件: `project/backend/app/main.py`
- 检查结果: | 检查项 | 结果 | 说明 |
  |---|---|---|
  | state_extract 契约 | 通过 | 返回 `List[StateProposal]`（`project/backend/app/main.py:1637`） |
  | state_commit 契约 | 通过 | `root_id/branch_id` 为 query（`project/backend/app/main.py:1756`）+ body `List[StateProposal]`（`project/backend/app/main.py:1758`） |
  | renderChapter 契约 | 通过 | 仅返回 `{"rendered_content": ...}`（`project/backend/app/main.py:601`、`project/backend/app/main.py:653`） |

- 文件: `project/frontend/src/api/llm.ts`
- 检查结果: | 检查项 | 结果 | 说明 |
  |---|---|---|
  | state_commit 参数位置 | 通过 | 按 query 传 `root_id/branch_id` + body proposals（`project/frontend/src/api/llm.ts:12`） |

- 文件: `project/frontend/src/components/StateExtractPanel.vue`
- 检查结果: | 检查项 | 结果 | 说明 |
  |---|---|---|
  | state_extract 返回校验 | 通过 | 要求 `Array.isArray(result)` 否则抛错（`project/frontend/src/components/StateExtractPanel.vue:91`） |
  | commit 调用形态 | 通过 | 调用 `llmApi.stateCommit(rootId, branchId, proposals[])`（`project/frontend/src/components/StateExtractPanel.vue:109`） |
  | 风险点 | 有 | `buildExtractPayload` 允许 `props.context` 覆盖 root/branch（`project/frontend/src/components/StateExtractPanel.vue:79`），但与本轮失败无直接因果 |

- 文件: `project/frontend/src/views/EditorView.vue`
- 检查结果: | 检查项 | 结果 | 说明 |
  |---|---|---|
  | 章节来源 | 通过 | `loadChapters()` 真实调用 listActs/listChapters（`project/frontend/src/views/EditorView.vue:361`、`project/frontend/src/views/EditorView.vue:366`；mounted `project/frontend/src/views/EditorView.vue:474`）→ 不再“占位章节” |
  | renderChapter 字段 | 通过 | 读取 `rendered_content`（`project/frontend/src/views/EditorView.vue:349`） |
  | 版本历史加载 | 通过 | 点击加载后调 history API（`project/frontend/src/views/EditorView.vue:436`） |
  | 仍存硬编码/兜底风险 | 有 | `worldRootId/worldBranchId` 缺参默认 `'world-1'/'main'`（`project/frontend/src/views/EditorView.vue:202`、`project/frontend/src/views/EditorView.vue:203`）；`sceneId/branchId` 写死（`project/frontend/src/views/EditorView.vue:264`、`project/frontend/src/views/EditorView.vue:265`） |

- 文件: `project/frontend/src/views/SnowflakeView.vue`
- 检查结果: | 检查项 | 结果 | 说明 |
  |---|---|---|
  | Step6 行为 | 通过 | Step6 完成后立即跳转 Editor（`project/frontend/src/views/SnowflakeView.vue:161`），未见固定 sleep |

**实现侧结论**：与后端契约的关键点（state_extract/state_commit/rendered_content/Step6 跳转/移除占位章节/移除 DEV 伪造历史）已对齐；本轮 7 个失败用例均可由测试侧过期 mock/断言解释。

### 测试代码
- 文件: `project/frontend/tests/e2e/state-extract.spec.ts`
- 覆盖情况: | 功能点 | 有测试 | 正确 |
  |---|---:|---:|
  | 提取预览 | 有 | 否 |
  | 失败重试 | 有 | 否 |
- 证据：测试把 extract mock 成对象 `{ entity_changes, relation_changes }`（`project/frontend/tests/e2e/state-extract.spec.ts:64`/`:109`），但实现要求 `StateProposal[]`（`project/frontend/src/components/StateExtractPanel.vue:91`）→ 预览元素不存在导致失败（`project/frontend/tests/e2e/state-extract.spec.ts:107`/`:137`）。  
- 归属：测试问题（mock 契约过期）。

- 文件: `project/frontend/tests/e2e/chapter-render.spec.ts`
- 覆盖情况: | 功能点 | 有测试 | 正确 |
  |---|---:|---:|
  | 渲染结果展示 | 有 | 否 |
  | 失败重试 | 有 | 否 |
- 证据：
  - 测试只 mock render 接口（`project/frontend/tests/e2e/chapter-render.spec.ts:74`），但当前 Editor 章节列表来自 listActs/listChapters（`project/frontend/src/views/EditorView.vue:361`/`:366`；mounted `project/frontend/src/views/EditorView.vue:474`）→ `chapter-review-item` 不会出现（失败点 `project/frontend/tests/e2e/chapter-render.spec.ts:78`）。  
  - 测试 mock 字段仍用 `content`（`project/frontend/tests/e2e/chapter-render.spec.ts:65`），实现读取 `rendered_content`（`project/frontend/src/views/EditorView.vue:349`）。  
- 归属：测试问题（mock 不完整 + 字段过期）。

- 文件: `project/frontend/tests/e2e/core.e2e.spec.ts`
- 覆盖情况: | 功能点 | 有测试 | 正确 |
  |---|---:|---:|
  | Snowflake Step6 | 有 | 否 |
  | ChapterReview | 有 | 否 |
- 证据：
  - Step6：测试断言 `Anchors: 1` 仍在 Snowflake 页可见（`project/frontend/tests/e2e/core.e2e.spec.ts:232`），但实现 Step6 会跳转 Editor（`project/frontend/src/views/SnowflakeView.vue:161`）→ 断言过期。  
  - ChapterReview：仅 mock review 接口（`project/frontend/tests/e2e/core.e2e.spec.ts:337`），未 mock acts/chapters，导致无 `chapter-review-item`（`project/frontend/tests/e2e/core.e2e.spec.ts:343`/`:344`）。  
- 归属：测试问题（断言与实现变更冲突 + mock 缺失）。

- 文件: `project/frontend/tests/e2e/version-control.spec.ts`
- 覆盖情况: | 功能点 | 有测试 | 正确 |
  |---|---:|---:|
  | 分支切换 | 有 | 是 |
  | 历史/快照 | 有 | 否 |
- 证据：同一用例中存在过宽路由 `**/api/v1/roots/**`（`project/frontend/tests/e2e/version-control.spec.ts:97`），可能覆盖 `**/api/v1/roots/**/branches/**/history`（`project/frontend/tests/e2e/version-control.spec.ts:89`），导致历史响应被错误形状数据替换、`commit-history-list` 为空（失败点 `project/frontend/tests/e2e/version-control.spec.ts:112`）。  
- 归属：测试问题（mock 路由覆盖/匹配设计缺陷）。

- 全局不合规（测试基础设施）
  - 多个 spec 硬编码端口/超时：`baseURL=http://127.0.0.1:5177`（如 `project/frontend/tests/e2e/state-extract.spec.ts:7`、`project/frontend/tests/e2e/core.e2e.spec.ts:7`、`project/frontend/tests/e2e/chapter-render.spec.ts:7`、`project/frontend/tests/e2e/version-control.spec.ts:7`），且 `timeoutMs=15000`（如 `project/frontend/tests/e2e/chapter-render.spec.ts:14`）→ 与执行环境（端口 5185、e2e 超时 600s、禁止硬编码端口/超时）冲突。
  - 潜在炸弹：`project/frontend/tests/e2e/playwright.e2e.ts:42` 顶层 `throw new Error(...)`（当前不参与匹配，但一旦纳入会直接炸）。

## 结论
结论：FAIL  
失败类型：测试问题  
阻塞：`npm run test:e2e` 当前 7 failed（mock/断言未随实现与后端契约更新）

## 建议
- 建议派发：TEST（优先修测试；实现侧关键契约点已对齐后端）
- 需修复的测试点（按失败用例归因）：
  1. `project/frontend/tests/e2e/state-extract.spec.ts:64`：把 mock 改为 `StateProposal[]`（对齐 `project/backend/app/main.py:1637` 与 `project/frontend/src/components/StateExtractPanel.vue:91`），并更新断言内容（不应依赖 `entity_changes`）。
  2. `project/frontend/tests/e2e/chapter-render.spec.ts:74`：补齐 `GET /roots/{root}/acts` 与 `GET /acts/{act}/chapters` 的 mock；render mock 字段改为 `rendered_content`（对齐 `project/backend/app/main.py:653`、`project/frontend/src/views/EditorView.vue:349`）。
  3. `project/frontend/tests/e2e/core.e2e.spec.ts:232`：Step6 断言改为“跳转到 /editor（含 query root_id/branch_id）”，或移除该段并由 `snowflake.spec.ts` 负责 Step6 跳转验证。
  4. `project/frontend/tests/e2e/core.e2e.spec.ts:337`：ChapterReview 用例补齐 acts/chapters mock（否则无 chapter item 可审）。
  5. `project/frontend/tests/e2e/version-control.spec.ts:97`：收紧 snapshot 路由或在 handler 内对 `/branches/` 请求 `route.fallback()`，避免覆盖 history mock（`project/frontend/tests/e2e/version-control.spec.ts:89`）。
  6. 统一 E2E 基础设施：移除各 spec 自启 dev server + 5177/15000 硬编码，改为 Playwright 配置级 `webServer`，并使用执行环境端口 5185、e2e 超时 600s。

【MCP调用简报】  
服务: serena  
触发: 取证（对照后端契约/前端实现/失败测试用例定位问题归属）  
参数: `read_file`/`search_for_pattern`（限定 `project/frontend`、`project/backend`，max_answer_chars=-1）  
结果: 命中关键证据：后端契约点位（`project/backend/app/main.py:1637`/`:1753`/`:601`），实现读取点位（`project/frontend/src/components/StateExtractPanel.vue:91`、`project/frontend/src/views/EditorView.vue:361`/`:349`、`project/frontend/src/views/SnowflakeView.vue:161`），测试过期 mock/断言点位（`project/frontend/tests/e2e/*.spec.ts`）  
状态: 成功  

【MCP调用简报】  
服务: bash(shell_command)  
触发: 验收命令执行  
参数: `cd /home/zxh/ainovel_v3/project/frontend && npm run test:e2e`（timeout 600s）  
结果: Exit 1；8 passed / 7 failed（失败用例如上）  
状态: 成功