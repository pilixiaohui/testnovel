已阅读开发行为规范  
iteration: 7  
self_test: enabled  

## 改动说明

### 改了哪里
- `project/backend/app/services/simulation_engine.py:63` - run_scene 增加收敛检查/动态补路/锚点达成与 convergence_score 更新，补充事件记录并推进 next_anchor。
- `project/backend/app/services/simulation_engine.py:96` - 收敛流程要求 world_state/anchor 关键字段，缺失直接抛错以快速失败。

### 为什么这样改
对齐 M1-T4 的推演主流程，串联 SimulationEngine 与 WorldMaster 的收敛/补路/锚点能力，同时保留快速失败约束，避免隐式兜底。

## 自测结果

- 验收命令: `MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest -q tests/integration/test_simulation_flow.py`
- 返回码: 0
- 测试通过数: 3 passed
- coverage: 62%
- 自测结果: PASS

输出:
```
...                                                                      [100%]
=============================== warnings summary ===============================
app/main.py:70
  /home/zxh/ainovel_v3/project/backend/app/main.py:70: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("startup")

.venv/lib/python3.11/site-packages/fastapi/applications.py:4576
  /home/zxh/ainovel_v3/project/backend/.venv/lib/python3.11/site-packages/fastapi/applications.py:4576: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    return self.router.on_event(event_type)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
3 passed, 2 warnings in 0.90s
```

coverage 输出:
```
Name                                        Stmts   Miss  Cover
---------------------------------------------------------------
app/__init__.py                                 0      0   100%
app/constants.py                                1      0   100%
app/logic/snowflake_manager.py                 51     40    22%
app/main.py                                   261      8    97%
app/models.py                                 139      3    98%
app/services/character_agent.py                85     66    22%
app/services/feedback_detector.py              21     15    29%
app/services/llm_engine.py                     39     20    49%
app/services/simulation_engine.py             150    136     9%
app/services/smart_renderer.py                 80     66    18%
app/services/subplot_manager.py                14      9    36%
app/services/topone_client.py                  51     37    27%
app/services/world_master.py                   11      1    91%
app/storage/__init__.py                         0      0   100%
app/storage/ports.py                            4      0   100%
app/storage/schema.py                         164      0   100%
tests/__init__.py                               0      0   100%
tests/integration/__init__.py                   0      0   100%
tests/integration/conftest.py                  54     44    19%
tests/integration/test_simulation_flow.py      53      0   100%
---------------------------------------------------------------
TOTAL                                        1178    445    62%
```

结论：PASS  
阻塞：无  

【MCP调用简报】  
服务: serena  
触发: 读取工单/源码并修改 SimulationEngine 以补齐收敛、补路、锚点流程  
参数: read_file/search_for_pattern/replace_regex（`project/backend/app/services/simulation_engine.py` 等）  
结果: 更新 run_scene 主流程并完成验收测试  
状态: 成功