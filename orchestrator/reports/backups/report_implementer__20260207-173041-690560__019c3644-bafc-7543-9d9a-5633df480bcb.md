已阅读实现者行为规范  
iteration: 6

## Phase 1: 红灯阶段

### 测试设计思路
围绕本轮 4 个必修需求设计“先失败后修复”的验证链：  
1) 角色/锚点字段契约严格化后，先让单测暴露不一致；  
2) 再补实现与测试数据，最后通过真实浏览器黑盒验证（输入→执行→输出）。

### 创建的测试文件
- 无新增文件；在 `project/frontend/tests/snowflake_edit_save.spec.ts:103` 补充测试前置数据（锚点完整字段）。

### 测试用例清单
| 用例名称 | 测试场景 | 预期结果 |
|---------|---------|---------|
| snowflake_edit_save | 锚点字段契约严格后执行保存流程 | 先红灯（fixture 缺字段），修复后绿灯 |
| prompts_real_value | 雪花页加载提示词 | prompts API 200 且文本框非空 |
| settings_real_value | 设置页加载 LLM 配置 | settings API 200 且表单显示真实值 |
| tab_switch_stability | 首页→雪花→推演→编辑器→世界观→设置→首页 | 每次切换后 console error=0 |
| snowflake_full_fields | Step3-6 展示完整字段 + 原始 JSON | 不再仅名字列表，字段齐全 |

### 红灯确认
- 命令: `npm --prefix project/frontend run test:unit`
- 结果: 失败（预期）
- 失败原因: `readAnchorConditions` 快速失败校验后，旧测试 fixture 缺少 `required_conditions`，触发 `required_conditions must be an array`（2 failed）。

---

## Phase 2: 绿灯阶段

### 实现方案
最小改动闭环（KISS/YAGNI）：
1) 后端响应模型补齐角色字段，确保 API 不再丢字段；  
2) 前端锚点条件读取支持字符串 JSON → 数组解析（非法即快速失败）；  
3) 测试 fixture 对齐新字段契约；  
4) 用 Playwright 逐项补齐黑盒证据链。

### 改动说明
| 文件 | 修改内容 | 实现逻辑 |
|-----|---------|---------|
| `project/backend/app/models.py:540` | 扩展 `CharacterView` 增加 `ambition/conflict/epiphany/voice_dna` | 修复 root snapshot 到前端时字段被 response model 裁剪的问题，满足 Step3 完整展示 |
| `project/frontend/src/views/SnowflakeView.vue:296` | `readAnchorConditions` 支持解析字符串 JSON，并对非法类型抛错 | 满足 Step6 `required_conditions` 结构化展示，遵循快速失败 |
| `project/frontend/tests/snowflake_edit_save.spec.ts:103` | 补全 anchor fixture 字段（含 `required_conditions`） | 让测试数据与新契约一致，消除红灯 |

### 绿灯确认
- 命令: `npm --prefix project/frontend run test:unit`
- 结果: 267 passed
- 覆盖率: 89.04%（`npm --prefix project/frontend run test:coverage`）

---

## 需求证据链（输入→执行→输出）

### 需求2：提示词编辑器显示实际提示词
- 输入：访问 `snowflake?root_id=2cd0a816-7d71-46bd-89a9-110a5cccec1b&branch_id=main`
- 执行：页面 `onMounted` 加载进度并请求 prompts
- 输出：
  - 网络：`GET /api/v1/roots/2cd0.../snowflake/prompts?branch_id=main => 200`
  - 页面：Step1~Step6 prompt 输入框均为非空（可见实际提示词内容）

### 需求3：标签页/视图切换稳定
- 输入：按顺序切换 `首页→雪花→推演→编辑器→世界观→设置→首页`
- 执行：逐页点击顶部菜单
- 输出：每次切换后 `browser_console_messages(level="error")` 均为 `Errors: 0`

### 需求5：设置页显示数据库真实 LLM 配置
- 输入：进入 `/settings`
- 执行：`onMounted(loadSettings)`
- 输出：
  - 网络：`GET /api/v1/settings/llm => 200`
  - 页面：`settings-llm-model` 显示 `gemini-3-pro-preview-11-2025`，温度/超时/max_tokens 均有值

### 需求7：雪花 Step3-6 显示完整信息
- 输入：进入带数据的雪花页（同 root）
- 执行：页面加载 root snapshot + acts + chapters + anchors
- 输出：
  - Step3：显示 `name/ambition/conflict/epiphany/voice_dna`（如 “Protect the city”）
  - Step4：显示 `title/expected_outcome/conflict_type/actual_outcome`
  - Step5：显示 `title/purpose/tone/focus/pov_character_id`
  - Step6：显示 `anchor_type/description/constraint_type/required_conditions`
  - 各步骤均显示原始 JSON block

---

## 自测结果汇总

| 验收命令 | 返回码 | 结果 |
|---------|-------|------|
| `npm --prefix project/frontend run test:unit`（红灯） | 1 | 2 failed（预期） |
| `npm --prefix project/frontend run test:unit`（绿灯） | 0 | 48 files / 267 passed |
| `npm --prefix project/frontend run test:coverage` | 0 | Lines 89.04% |
| `MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/test_api_minimal.py -q` | 0 | 34 passed |
| `MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/integration/test_memgraph_storage.py::test_memgraph_storage_graph_port_flow -q` | 0 | 1 passed |
| `grep -RIn \"'scene-1'\\|'root-1'\\|'test-id'\\|'mock-id'\" project/frontend/src project/frontend/tests project/backend/app project/backend/tests` | 0 | 空输出（通过） |
| `grep -RIn \"localhost\\|127.0.0.1\" project/frontend/src project/frontend/tests project/backend/app project/backend/tests` | 0 | 空输出（通过） |
| `grep -RIn \"TODO\\|FIXME\\|XXX\\|HACK\" project/frontend/src project/frontend/tests project/backend/app project/backend/tests` | 0 | 空输出（通过） |
| `grep -RIn \"toBeTruthy\\|assert True\" project/frontend/tests project/backend/tests` | 0 | 空输出（通过） |

自测结果: PASS

---

## 原则应用与收益（KISS/YAGNI/DRY/SOLID）
- KISS：仅修 3 处关键点（响应模型、条件解析、测试 fixture），不引入新依赖。  
- YAGNI：未新增抽象层/中间服务，仅补当前验收所需字段与解析逻辑。  
- DRY：复用既有 Step3-6 展示结构，不复制 UI 组件。  
- SOLID（SRP/OCP）：`CharacterView` 专注契约表达；`readAnchorConditions` 单一职责处理字段归一化。  
- 快速失败：`required_conditions` 非数组/不可解析时直接抛错，避免静默吞错。

---

## 遇到的挑战与处理
- 挑战：跑完后端集成测试后，图数据被清空，Playwright 出现 `root not found`。  
- 处理：按执行环境重建最小真实数据集（root/characters/scenes/acts/chapters/anchors），再重新执行 4 项黑盒验证链。

---

## 下一步建议
1. 给 Step3-6 关键字段补 `data-test` 聚合容器（便于验证器一次性定位完整卡片）。  
2. 在后端新增“测试种子接口”或脚本入口，避免集成测试后人工补数据。  
3. 将 `required_conditions` 存储类型统一为数组（减少前后端类型分歧）。

---

## 职责边界说明

### IMPLEMENTER 测试职责

| 测试类型 | 工具 | 目的 |
|---------|------|------|
| 单元测试 | Bash (`pytest`) | 验证函数逻辑 |
| 前端单元测试 | Bash (`npm run test:unit`) | 验证组件逻辑 |
| E2E 脚本测试 | Bash (`npx playwright test`) | 验证页面流程（Mock 后端） |
| **前端功能自测** | **Playwright MCP** | **验证真实浏览器中的 UI 和交互** |

### Playwright MCP 自测 vs 验证器测试

| 维度 | IMPLEMENTER 自测 | 验证器测试 |
|------|-----------------|-----------|
| 工具 | Playwright MCP | Playwright MCP |
| 目的 | 开发调试、快速反馈 | 独立验证、质量把关 |
| 时机 | 开发过程中随时使用 | 代码提交后 |
| 标准 | 功能基本可用 | 严格验收标准 |
| 网络验证 | 可选 | **必须**验证 API 请求 |

### 真实环境验证（验证器职责）
已满足提交前要求：前端可启动、后端可响应、命令行测试通过、Playwright 黑盒链路完成。

---

## 验证信息

### 测试命令
```yaml
commands:
  - cmd: "npm --prefix project/frontend run test:unit"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "npm --prefix project/frontend run test:coverage"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/test_api_minimal.py -q"
    cwd: "/home/zxh/ainovel_v3/project/backend"
    type: unit
  - cmd: "MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/integration/test_memgraph_storage.py::test_memgraph_storage_graph_port_flow -q"
    cwd: "/home/zxh/ainovel_v3/project/backend"
    type: integration
  - cmd: "grep -RIn \"'scene-1'\\|'root-1'\\|'test-id'\\|'mock-id'\" project/frontend/src project/frontend/tests project/backend/app project/backend/tests || true"
    cwd: "/home/zxh/ainovel_v3"
    type: lint
  - cmd: "grep -RIn \"localhost\\|127.0.0.1\" project/frontend/src project/frontend/tests project/backend/app project/backend/tests || true"
    cwd: "/home/zxh/ainovel_v3"
    type: lint
  - cmd: "grep -RIn \"TODO\\|FIXME\\|XXX\\|HACK\" project/frontend/src project/frontend/tests project/backend/app project/backend/tests || true"
    cwd: "/home/zxh/ainovel_v3"
    type: lint
```

### 修改文件
```yaml
files:
  - path: "project/backend/app/models.py"
    type: implementation
  - path: "project/frontend/src/views/SnowflakeView.vue"
    type: implementation
  - path: "project/frontend/tests/snowflake_edit_save.spec.ts"
    type: test
```

### API 签名
```yaml
signatures:
  - name: "CharacterView"
    file: "project/backend/app/models.py"
    params: ["entity_id", "name", "ambition", "conflict", "epiphany", "voice_dna"]
  - name: "readAnchorConditions"
    file: "project/frontend/src/views/SnowflakeView.vue"
    params: ["anchor"]
  - name: "seedSnowflakeStore"
    file: "project/frontend/tests/snowflake_edit_save.spec.ts"
    params: []
```

结论：PASS  
阻塞：无

【MCP调用简报】  
服务: serena  
触发: 定位并修改前后端关键实现与测试文件  
参数: `read_file/search_for_pattern/replace_regex`（限定 `project/frontend`、`project/backend`）  
结果: 完成 3 处最小必要修改并复核行级定位  
状态: 成功

【MCP调用简报】  
服务: playwright  
触发: 4 项需求黑盒证据补齐（prompts/settings/字段展示/路由切换稳定）  
参数: `browser_navigate/click/snapshot/console_messages/network_requests`  
结果: 关键 API 均 200，Step3-6 字段完整可见，路由切换全程 0 console error  
状态: 成功

【MCP调用简报】  
服务: exec_command  
触发: 单测/覆盖率/后端测试/反作弊扫描/服务重启与种子数据  
参数: `npm test:unit`, `npm test:coverage`, `pytest`, `grep`, `curl`  
结果: 前端 267 passed，覆盖率 89.04%，后端 34+1 passed，扫描全通过  
状态: 成功