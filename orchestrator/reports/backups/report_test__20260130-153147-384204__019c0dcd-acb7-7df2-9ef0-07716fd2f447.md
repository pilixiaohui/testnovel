已阅读测试行为规范
iteration: 3

## 测试需求分析

工单要求测试的功能点：
1. rendered_content 字数不足（<1800）时返回 400，并包含详细提示
2. rendered_content 字数超限（>2200）时返回 400，并包含详细提示
3. 计数口径排除标点/空白（可选）

## 测试设计

### 设计思路
选择最小可行的三类场景覆盖边界：不足/超限/标点空白口径验证。使用现有 `_make_content` 生成确定性长度内容，避免引入额外依赖，确保测试可复现与高可读性（KISS/YAGNI）。

### 创建的测试文件
- `project/backend/tests/integration/test_chapter_render_api.py` - 补充渲染接口字数校验场景测试

### 测试用例清单

| 用例名称 | 测试场景 | 对应功能点 | 测试逻辑说明 |
|---------|---------|-----------|-------------|
| test_chapter_render_too_short_returns_400 | 字数不足 | 功能点1 | 传入1799字符内容，断言400与detail包含“字数不足/1799/1800-2200/不含标点空白” |
| test_chapter_render_too_long_returns_400 | 字数超限 | 功能点2 | 传入2201字符内容，断言400与detail包含“字数超限/2201/1800-2200/不含标点空白” |
| test_chapter_render_ignores_punctuation_and_whitespace_when_counting | 口径验证 | 功能点3 | 1800字母 + 500标点空白，总长度>2200，断言仍返回200 |

### 关键测试逻辑
- 测试数据：用 `_make_content(n)` 生成纯字母；用 `" ,.!?" * 100` 生成仅标点/空白附加量。
- 调用接口：`POST /api/v1/chapters/{chapter_id}/render`。
- 断言条件：不足/超限返回400并包含明确提示；口径验证在总长度>2200情况下仍返回200。
- 设计理由：若实现错误用 `len()` 计数，第三个用例会失败，从而验证“排除标点空白”的统计口径。

## 测试执行

- 命令: `/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/integration/test_chapter_render_api.py -v`
- 结果: 通过
- 红灯确认: 否（实现已满足字数校验，新增测试均通过）

### 执行详情
共6个用例全部通过；出现2条 FastAPI on_event deprecation 警告，不影响本次验证结论。

## 验收标准

- 命令: `/home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/integration/test_chapter_render_api.py -v`
- 阈值: 0 failed

结论：PASS
阻塞：无

【MCP调用简报】
服务: serena  
触发: 读取测试与实现、补充测试、执行验证  
参数: read_file/search_for_pattern/replace_regex/execute_shell_command（均 max_answer_chars: -1）  
结果: 命中渲染字数逻辑并新增3个测试，pytest 6 passed  
状态: 成功