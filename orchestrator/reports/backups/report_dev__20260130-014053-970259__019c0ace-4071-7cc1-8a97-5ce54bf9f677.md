已阅读开发行为规范
iteration: 4
self_test: enabled

## 任务理解

工单要求实现的功能：
1. 为 ToponeGateway 补齐 Step5a 幕结构生成方法 `generate_act_list`
2. 为 ToponeGateway 补齐 Step5b 章节结构生成方法 `generate_chapter_list`（支持 prompt_constraint 章节数量约束）
3. 为 ToponeGateway 补齐锚点生成方法 `generate_story_anchors`

## 实现方案

### 设计思路
复用现有 `_generate_structured_output` 统一 TopOne 调用与结构化解析，最小化改动面。Step5b 通过在 system_prompt 中追加 `prompt_constraint` 文本实现“提示词约束章节数量”的策略，不在服务端做数量兜底，保持快速失败。

### 改动说明

| 文件 | 修改内容 | 实现逻辑 |
|-----|---------|---------|
| `project/backend/app/llm/topone_gateway.py:129` | 新增 `generate_act_list` / `generate_chapter_list` / `generate_story_anchors` | 复用结构化输出通道；Step5b 若 act 含 `prompt_constraint` 则拼接到 system prompt 以约束章节数 |

### 关键实现逻辑
- 数据流向：`root/act/characters` → 拼装 `user_text` → `ToponeClient.generate_content` → JSON 解析 → `TypeAdapter` 校验 → `list[dict]` 返回
- 关键步骤：Step5a/5b/anchors 使用 ARCHITECT 角色；Step5b 若 `act["prompt_constraint"]` 非空则追加至 system prompt
- 异常处理策略：不做兜底，JSON 解析/结构化校验失败即抛错（快速失败）
- 与其他模块交互：使用 `app.llm.prompts` 常量，结果供 `app.main` Step5a/Step5b/anchors 端点写入存储

## 自测结果（仅 enabled 模式）

### 验收结果汇总

| 序号 | 命令 | 返回码 | 结果摘要 |
|-----|------|-------|---------|
| 1 | `MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit/test_snowflake_engine_contract.py::test_topone_gateway_has_generate_act_list -v` | 0 | 1 passed |
| 2 | `MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit/test_snowflake_engine_contract.py::test_topone_gateway_has_generate_chapter_list -v` | 0 | 1 passed |
| 3 | `MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit/test_snowflake_engine_contract.py::test_topone_gateway_has_generate_story_anchors -v` | 0 | 1 passed |
| 4 | `MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit/test_snowflake_engine_contract.py -v` | 1 | 4 passed, 1 failed（LocalStoryEngine.generate_act_list is missing） |

- 全部验收命令已执行: 是
- 自测结果: FAIL
- 覆盖率: 未输出（验收命令未启用 coverage）

### 测试详情
失败用例为 `test_local_story_engine_has_step5_methods`，原因是 `LocalStoryEngine` 尚未实现 Step5 方法，属于当前任务范围之外的缺口。

## 总结与展望
- 已完成：ToponeGateway Step5a/5b/anchors 方法补齐，遵循 KISS/DRY（复用结构化输出通道）与 YAGNI（未引入额外配置/容错）。
- 原则落地：SRP 保持 ToponeGateway 仅负责 LLM 调用与结构化输出；prompt_constraint 通过提示词实现，避免服务端硬编码。
- 遇到挑战：全量契约测试仍失败，因 LocalStoryEngine 未实现 Step5 方法。
- 下一步建议：补齐 `LocalStoryEngine`（及如需 `LLMEngine`）的 Step5 方法以使全量契约测试通过。

结论：FAIL
阻塞：LocalStoryEngine 缺少 Step5 方法导致 `test_local_story_engine_has_step5_methods` 失败

【MCP调用简报】
服务: serena  
触发: 代码定位/修改与自测执行  
参数: 读取 `project/backend/app/llm/topone_gateway.py` 等；修改 `project/backend/app/llm/topone_gateway.py`；执行 4 条 pytest 命令  
结果: 新增 3 个 Step5 方法；3 条单测通过，整文件测试 1 失败  
状态: 成功（自测失败）