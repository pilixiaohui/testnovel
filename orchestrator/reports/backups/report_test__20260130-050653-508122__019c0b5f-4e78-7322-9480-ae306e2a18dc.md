已阅读测试行为规范
iteration: 10

## 测试需求分析

工单要求测试的功能点：
1. Step5b生成的章节总数必须等于10
2. 章节数量不足10时返回400错误
3. 章节数量超过10时返回400错误
4. 正常情况下返回10个章节结构

## 测试设计

### 设计思路
用FastAPI TestClient直连Step5b端点，依赖注入DummyEngine/DummyStorage控制章节生成数量，覆盖总数=10、<10、>10三种场景，确保总数约束与快速失败行为被显式验证。

### 创建的测试文件
- `project/backend/tests/unit/test_step5b_chapter_count.py` - Step5b章节数量约束测试

### 测试用例清单

| 用例名称 | 测试场景 | 对应功能点 | 测试逻辑说明 |
|---------|---------|-----------|-------------|
| test_step5b_returns_10_chapters_when_total_is_10 | 正常流程 | 功能点1/4 | 两幕各5章，总数10，期望200且返回10条 |
| test_step5b_returns_400_when_total_less_than_10 | 异常处理 | 功能点2 | 返回9章，期望400 |
| test_step5b_returns_400_when_total_greater_than_10 | 异常处理 | 功能点3 | 返回11章，期望400 |

### 关键测试逻辑
- 测试数据如何准备：构造Step5b payload（root/characters），DummyEngine按act_id返回指定数量章节。
- 调用什么接口/函数：`POST /api/v1/snowflake/step5b`。
- 断言什么条件：总数=10时200且长度10；总数≠10时状态码400。
- 为什么这样设计能验证需求：用可控章节数量覆盖所有边界，直接验证“总数必须等于10”的契约。

## 测试执行

- 命令: `MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/unit/test_step5b_chapter_count.py -v`
- 结果: 失败
- 红灯确认: 是（实现未加总数约束，导致状态码为200）

### 执行详情
- 失败用例：
  - `test_step5b_returns_400_when_total_less_than_10`：期望400，实际200
  - `test_step5b_returns_400_when_total_greater_than_10`：期望400，实际200
- 通过用例：
  - `test_step5b_returns_10_chapters_when_total_is_10`

## 验收标准

- 命令: `MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/unit/test_step5b_chapter_count.py -v`
- 阈值: 测试文件存在、可运行，且对章节数≠10产生红灯

结论：PASS
阻塞：无

【MCP调用简报】
服务: serena
触发: 读取端点实现并编写/执行单元测试
参数: search_for_pattern, read_file, create_text_file, execute_shell_command（max_answer_chars: -1）
结果: 新增测试文件1个；执行1次，红灯2处
状态: 成功