已阅读开发行为规范
iteration: 4
self_test: enabled

## 任务理解

工单要求实现的功能：
1. 让 `src/api/index.ts` 按环境变量读取 baseURL，缺失时回退 `/api/v1`。
2. 对齐 Snowflake Step1-6 的类型与 store 映射（logline → root → characters → scenes → acts/chapters → anchors）。
3. 为 Step1-6 提供明确 action，调用对应 API 并更新状态。
4. 修复前端类型/状态不一致导致的单测失败（不改测试）。
5. 保持快速失败，避免防御性兜底。

## 实现方案

### 设计思路
围绕测试契约对 Snowflake store 做最小改动：保留 `steps` 作为唯一数据源（DRY），通过别名属性与 getters 暴露 Step1-6 字段（KISS），只实现当前需要的状态与 action（YAGNI），并让每个 action 只负责单一步骤的状态推进（SRP/SOLID）。

### 改动说明

| 文件 | 修改内容 | 实现逻辑 |
|-----|---------|---------|
| `project/frontend/src/api/index.ts:1` | baseURL 改为读取 `VITE_API_BASE_URL` 并回退 `/api/v1` | 对齐环境变量优先级，满足 baseURL 契约 |
| `project/frontend/src/types/snowflake.ts:1` | 统一 Step1-6 类型与 `SnowflakeSteps` 结构 | 明确 logline/root/characters/scenes/acts/chapters/anchors 形态 |
| `project/frontend/src/api/snowflake.ts:1` | 维持 step1-6 API 签名并补齐类型 | 保障 store actions 与测试 mock 一致 |
| `project/frontend/src/stores/snowflake.ts:1` | 重构 store：steps 为单一真源、别名字段、getter、actions | 满足“keys 对齐 + 顶层字段暴露 + 步骤动作”三方契约 |
| `project/frontend/src/composables/useSnowflake.ts:1` | 组合式 API 对齐新 store 字段 | 直取 step 字段，无额外状态 |
| `project/frontend/src/stores/simulation.ts:1` | store state 回归 `SimulationState` | 使 state keys 与类型一致 |
| `project/frontend/src/composables/useSimulation.ts:1` | 组合式 API 对齐简化后的 store | 删除无用字段引用 |

### 关键实现逻辑
- 数据流向：`steps` 作为 Snowflake 单一状态源；顶层别名属性与 getters 指向 `steps.*`，保证 `$state` 与 `store` 读取一致。  
- 关键处理步骤：  
  - Step1-4 依次写入 logline/root/characters/scenes（Step4 仅落 scenes 数组）。  
  - Step5 同步调用 step5a/step5b，分别更新 acts/chapters。  
  - Step6 调用 anchors API，更新 anchors。  
- 异常处理策略：不做兜底与提前写入，等待异步返回后更新（快速失败）。  
- 与其他模块交互：store actions 仅调用 `api/snowflake` 与 `api/anchor`，组合式 API 只负责读取。

## 自测结果（仅 enabled 模式）

- 验收命令: `MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 npm --prefix /home/zxh/ainovel_v3/project/frontend run test:unit`
- 返回码: 0
- 测试通过数: 16 passed, 0 failed
- coverage: N/A（未运行覆盖率命令）
- 自测结果: PASS

### 测试详情
- `tests/snowflake_store_contract.spec.ts`、`src/__tests__/fe_api_types_store_alignment.test.ts` 等全部通过。
- 覆盖率未生成（本次未执行 `test:coverage`）。

## 测试问题反馈（如有）

无

## 总结与展望
- 已完成核心任务：baseURL 环境读取、Snowflake Step1-6 类型/状态/动作对齐、store 契约修复，单测转绿。
- 原则应用：  
  - KISS：状态只维护一个 steps 真源。  
  - YAGNI：移除 simulation 额外字段与无用 action。  
  - DRY：别名字段统一映射 steps，避免重复存储。  
  - SOLID：每个 action 仅处理单一步骤的 API 与状态更新。  
- 挑战与解决：store 顶层字段与 `$state` keys 的测试冲突，通过“steps 真源 + 非枚举别名 + getters”同时满足两类契约。  
- 下一步建议（可选）：  
  1) 运行 `npm --prefix /home/zxh/ainovel_v3/project/frontend run test:coverage` 获取覆盖率。  
  2) 如需发布验证，运行前端构建 `npm --prefix /home/zxh/ainovel_v3/project/frontend run build`。

结论：PASS
阻塞：无

【MCP调用简报】
服务: serena  
触发: 代码检索/修改与自测执行  
参数: 读取/替换 `project/frontend/src/**`，执行 `npm --prefix /home/zxh/ainovel_v3/project/frontend run test:unit`  
结果: 16 tests passed, 0 failed  
状态: 成功