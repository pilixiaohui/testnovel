已阅读开发行为规范  
iteration: 2

## 改了哪里
- `project/backend/app/storage/ports.py:8` 新增最小存储抽象 `GraphStoragePort`（Protocol），只包含当前调用方实际使用的方法集合
- `project/backend/app/main.py:29` API 层依赖注入与辅助函数参数类型由 `GraphStorage` 调整为 `GraphStoragePort`
- `project/backend/app/main.py:288` `get_graph_storage()` 返回 `GraphStoragePort`，并在函数内局部 import `GraphStorage` 进行组装，避免 API 模块顶层强依赖具体实现
- `project/backend/app/logic/snowflake_manager.py:8` 业务编排层注入类型改为 `GraphStoragePort`（不再依赖具体 Kùzu 类）
- `project/backend/app/storage/graph.py:20` `GraphStorage` 收敛为 facade（仅保留连接创建/close + mixin 组合），实现拆分到以下职责模块：
- `project/backend/app/storage/graph_schema.py:3` schema/建表与列管理
- `project/backend/app/storage/graph_migrations.py:8` migrations/backfill 相关逻辑
- `project/backend/app/storage/graph_snowflake.py:13` `save_snowflake`（初始化持久化写入）
- `project/backend/app/storage/graph_branches.py:8` branch/commit/fork/merge/revert 等分支与提交链路
- `project/backend/app/storage/graph_entities.py:9` entity 与 semantic_states 读写
- `project/backend/app/storage/graph_scenes.py:10` scene/version/commit、脏标记、上下文与 diff
- `project/backend/app/storage/graph_utils.py:8` + `project/backend/app/storage/graph_constants.py:6` 通用常量/工具方法（含 branch 名校验、SQL 字面量拼装等）

## 为什么这样改（对应验收标准）
- DIP：高层模块（API/业务）依赖抽象 `GraphStoragePort`，具体 Kùzu 实现在组装点注入（`project/backend/app/main.py:288` + `project/backend/app/storage/graph.py:20`）
- SRP：将原单文件大类按职责拆分为 schema/migrations/branches/entities/scenes/snowflake/utils，`project/backend/app/storage/graph.py:20` 明显收敛为 facade，后续替换存储实现的成本更可控
- 行为保持不变：拆分采用“搬家+组合”，方法签名与实现逻辑不改；未引入任何吞异常/默认值续跑等防御性编程，失败仍快速暴露

## 挑战与解决
- 主要挑战：`GraphStorage` 超大类拆分容易引入细微行为差异
- 解决：以现有测试为表征安全网，拆分后全量回归（见下），确保行为一致

## 如何自测
- 在 `project/backend` 运行：`python -m pytest -q`
- 关键输出摘要：`93 passed`（全绿）；覆盖证据主要来自 `project/backend/tests/test_storage.py:9`、`project/backend/tests/test_api.py:17` 对存储与 API 的大量表征测试

## 风险与建议
- 当前拆分为 mixin 聚合（`project/backend/app/storage/graph.py:20`），对外稳定但内部仍共享 `self.conn`/SQL 字符串；下一步若要引入新后端（Memgraph/时序/快照），建议逐步把“执行器/连接”抽为显式依赖并减少跨模块隐式耦合

## 工具调用简报
【MCP调用简报】  
服务: serena  
触发: 定位 GraphStorage 调用方、实施 DIP+SRP 拆分、回归验证  
参数: 代码检索限定 `project/backend/app/**`；测试命令 `python -m pytest -q`  
结果: 完成接口引入与 GraphStorage 拆分；测试 `93 passed`  
状态: 成功