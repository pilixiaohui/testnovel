已阅读实现者行为规范
iteration: 12

## Phase 1: 红灯阶段

### 测试设计思路
针对 EDGE_CASE_TESTER 报告的边界输入问题，优先补了 3 个直接复现用例，覆盖：
1) LLM 配置中的恶意/超长 `model`  
2) 雪花 step1 的恶意/超长 `idea`  
3) roots 创建时空白项目名  
目标是先稳定复现“当前未拦截输入会通过”的问题，形成红灯基线。

### 创建的测试文件
- `project/backend/tests/test_api_minimal.py:1212` - 新增边界输入校验用例（在现有文件追加）

### 测试用例清单
| 用例名称 | 测试场景 | 预期结果 |
|---------|---------|---------|
| `test_llm_settings_rejects_malicious_model_values` | `PUT /api/v1/settings/llm` 传入 XSS/SQL 样式/超长 model | 返回 422，且有结构化 `detail` |
| `test_step1_rejects_malicious_or_overlong_idea` | `POST /api/v1/snowflake/step1` 传入 XSS/SQL 样式/超长 idea | 返回 422，且有结构化 `detail` |
| `test_create_project_rejects_blank_name` | `POST /api/v1/roots` 传入空白 name | 返回 422，且有结构化 `detail` |

### 红灯确认
- 命令: `MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/test_api_minimal.py -k "llm_settings_rejects_malicious_model_values or step1_rejects_malicious_or_overlong_idea or create_project_rejects_blank_name" -v`
- 结果: 失败（预期），`3 failed`
- 失败原因: 现有实现未对上述输入进行足够校验，接口返回 200 而非 4xx

## Phase 2: 绿灯阶段

### 实现方案
采用最小改动（KISS/YAGNI）：
- 在模型层用 Pydantic 约束/validator 做输入拦截（优先内置机制，避免散落在路由里手写大量逻辑）
- 在 roots 关键路由补齐 `KeyError/ValueError -> 404/400` 映射，避免异常冒泡成 500
- 不改请求/响应结构，不改正常业务流程

### 改动说明
| 文件 | 修改内容 | 实现逻辑 |
|-----|---------|---------|
| `project/backend/app/models.py:34` | 强化 `LlmConfigView.model` 约束（长度+pattern），`system_instruction` 增加上限 | 非法 model（如 `<script>`、SQL 样式字符串）在模型层直接 422 |
| `project/backend/app/models.py:469` | `IdeaPayload.idea` 增加 `max_length` 与恶意内容校验 | step1 对 XSS/SQL 样式/超长输入直接返回 422，避免进入下游逻辑 |
| `project/backend/app/models.py:590` | `ProjectCreatePayload.name` 增加去空白校验 | 空白项目名直接 422，避免后续脏数据/潜在异常 |
| `project/backend/app/main.py:1325` | `create_root_endpoint` 增加异常映射 | `KeyError/ValueError` 收敛为 404/400，避免 500 |
| `project/backend/app/main.py:1354` | `delete_root_endpoint` 增加异常映射 | 同上 |
| `project/backend/app/main.py:1368` | `list_roots_endpoint` 增加异常映射 | 同上 |
| `project/backend/app/main.py:1426` | `list_root_entities_endpoint` 增加异常映射 | 同上 |
| `project/backend/tests/test_api_minimal.py:1212` | 新增 3 个边界输入测试 | 覆盖本轮需求并固定回归 |

### 绿灯确认
- 命令: `MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/test_api_minimal.py -k "llm_settings_rejects_malicious_model_values or step1_rejects_malicious_or_overlong_idea or create_project_rejects_blank_name" -v`
- 结果: `3 passed`
- 覆盖率: 本轮未单独执行 coverage 统计（执行了目标与回归测试）

## 自测结果汇总

| 验收命令 | 返回码 | 结果 |
|---------|-------|------|
| 红灯：`...pytest ... -k "llm_settings_rejects... or step1_rejects... or create_project_rejects..." -v` | 1 | 预期失败（3 failed） |
| 绿灯：同上命令 | 0 | 通过（3 passed） |
| 回归：`MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/test_api_minimal.py -v` | 0 | 通过（37 passed） |
| 全量后端：`MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 MEMGRAPH_BOLT_URI=bolt://localhost:7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests -q` | 1 | 失败（6 failed, 453 passed） |
| 防偷懒扫描（仅本次改动文件）`grep -nE "'scene-1'|'root-1'|'test-id'" ...` / `grep -nE "localhost|127\\.0\\.0\\.1" ...` / `grep -nE "TODO|FIXME|XXX|HACK" ...` | 0 | 均无命中 |

自测结果: FAIL

## 总结、反思与展望

### 本次完成成果
- 已将本轮目标边界输入从“可通过/潜在异常路径”收敛为明确 422/400（重点覆盖 settings/step1/roots-create）。
- 给 roots 核心接口补齐异常映射，降低 500 暴露面。
- 新增测试完成红灯→绿灯闭环，并通过文件级回归。

### 原则落地
- **KISS**：优先 Pydantic 字段约束和 validator，避免复杂全局拦截器。
- **YAGNI**：只改本轮相关模型与路由，不做大范围重构。
- **DRY**：复用 FastAPI/Pydantic 统一校验机制，减少重复手写校验。
- **SOLID（SRP/OCP）**：输入合法性放在模型层，路由层只做错误映射，职责清晰、便于扩展。

### 遇到的挑战与处理
- 全量后端测试存在与本轮改动无关的既有失败（章节渲染长度校验、step5b 章节数校验、memgraph 结构边界案例），导致无法给出全量 green。
- 已明确记录失败清单与命令，避免误判为本次改动引入。

### 下一步建议
1. 优先修复 `project/backend/tests/integration/test_chapter_render_api.py` 对应的字数边界逻辑（当前 1799/2201 未返回 400）。  
2. 修复 `project/backend/tests/unit/test_step5b_chapter_count.py` 的章节总数校验（9/11 应返回 400）。  
3. 修复 `project/backend/tests/integration/test_structure_edges.py` / `test_dual_subgraph.py` 中 `save_snowflake` 对角色字段假设导致的 `AttributeError`。  

## 职责边界说明

### IMPLEMENTER 测试职责
| 测试类型 | 工具 | 目的 |
|---------|------|------|
| 单元测试 | Bash (`pytest`) | 验证函数逻辑 |
| 前端单元测试 | Bash (`npm run test:unit`) | 验证组件逻辑 |
| E2E 脚本测试 | Bash (`npx playwright test`) | 验证页面流程（Mock 后端） |
| **前端功能自测** | **Playwright MCP** | **验证真实浏览器中的 UI 和交互** |

### Playwright MCP 自测 vs 验证器测试
| 维度 | IMPLEMENTER 自测 | 验证器测试 |
|------|-----------------|-----------|
| 工具 | Playwright MCP | Playwright MCP |
| 目的 | 开发调试、快速反馈 | 独立验证、质量把关 |
| 时机 | 开发过程中随时使用 | 代码提交后 |
| 标准 | 功能基本可用 | 严格验收标准 |
| 网络验证 | 可选 | **必须**验证 API 请求 |

### 真实环境验证（验证器职责）
本轮为后端边界输入修复，已完成命令行与 TestClient 自测；真实浏览器验证由后续验证器执行。

## 验证信息

### 测试命令
```yaml
commands:
  - cmd: "MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/test_api_minimal.py -k \"llm_settings_rejects_malicious_model_values or step1_rejects_malicious_or_overlong_idea or create_project_rejects_blank_name\" -v"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/test_api_minimal.py -v"
    cwd: "/home/zxh/ainovel_v3"
    type: unit
  - cmd: "MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 MEMGRAPH_BOLT_URI=bolt://localhost:7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests -q"
    cwd: "/home/zxh/ainovel_v3"
    type: integration
```

### 修改文件
```yaml
files:
  - path: "project/backend/app/models.py"
    type: implementation
  - path: "project/backend/app/main.py"
    type: implementation
  - path: "project/backend/tests/test_api_minimal.py"
    type: test
```

### API 签名
```yaml
signatures:
  - name: "ensure_idea_not_blank"
    file: "project/backend/app/models.py"
    params: ["cls", "value"]
  - name: "ensure_name_not_blank"
    file: "project/backend/app/models.py"
    params: ["cls", "value"]
  - name: "create_root_endpoint"
    file: "project/backend/app/main.py"
    params: ["payload", "storage"]
  - name: "delete_root_endpoint"
    file: "project/backend/app/main.py"
    params: ["root_id", "storage"]
  - name: "list_roots_endpoint"
    file: "project/backend/app/main.py"
    params: ["limit", "offset", "storage"]
  - name: "list_root_entities_endpoint"
    file: "project/backend/app/main.py"
    params: ["root_id", "branch_id", "storage"]
```

结论：FAIL  
阻塞：全量后端测试未全部通过（`test_chapter_render_api` 2项、`test_step5b_chapter_count` 2项、`test_structure_edges*` 2项），需后续迭代修复这些既有失败后才能给出全量 PASS。

【MCP调用简报】
服务: serena  
触发: 代码定位、增量编辑、符号/正则检索（按要求优先本地代码工具）  
参数: `read_file/search_for_pattern/replace_regex`（均限定到 `project/backend` 且 `max_answer_chars=-1`）  
结果: 定位并修改 `models.py`/`main.py`，新增 `test_api_minimal.py` 边界测试并完成红绿闭环  
状态: 成功

服务: (bash via exec_command)  
触发: 执行 pytest 与 grep 自测验证  
参数: 使用指定 Python 绝对路径 `/home/zxh/ainovel_v3/project/backend/.venv/bin/python`，并设置环境变量  
结果: 目标测试通过、文件级回归通过；全量后端测试存在 6 项既有失败  
状态: 成功（含失败用例证据收集）