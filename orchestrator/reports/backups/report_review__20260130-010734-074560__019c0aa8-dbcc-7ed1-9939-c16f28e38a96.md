已阅读审阅行为规范
iteration: 1
review_mode: single

## 任务理解

审阅的任务：识别 10 章小说生成任务的潜在阻塞点和技术风险（LLM 稳定性、性能瓶颈、数据一致性、端到端测试覆盖）。
验收标准：列出高/中/低风险项，给出风险缓解建议，给出 PASS/FAIL 结论。

## 验收执行

- 验收命令: `无（工单未提供）`
- 返回码: N/A
- 测试结果: N/A
- 覆盖率: N/A

## 代码深度审查

### 实现代码审查
- 审查文件: `project/backend/app/services/topone_client.py`
- 审查文件: `project/backend/app/llm/topone_gateway.py`
- 审查文件: `project/backend/app/storage/temporal_edge.py`
- 审查文件: `project/backend/app/storage/snapshot.py`
- 审查文件: `project/scripts/ten_chapter_novel_e2e.py`
- 审查内容:
  | 检查项 | 结果 | 说明 |
  |-------|------|------|
  | 函数参数/返回值类型 | 符合 | 类型定义基本一致 |
  | API 契约一致性 | 部分符合 | E2E 脚本强制 10 章，但服务端未见同等强约束 |
  | 错误处理完整性 | 不完整 | LLM 调用无重试/降级路径，JSON 解析失败直接抛错 |
  | 边界条件处理 | 未考虑 | Memgraph 时序关系更新/快照创建非事务包裹，易出现部分写入 |

- 代码片段证据:
```python
# project/backend/app/services/topone_client.py:81
async def generate_content(...):
    ...
    response = await client.post(...)
    response.raise_for_status()
    data = response.json()
    return self._strip_thoughts(data)
```

```python
# project/backend/app/llm/topone_gateway.py:54
response = await client.generate_content(...)
text = _extract_text(response).strip()
parsed = json.loads(text)
return TypeAdapter(output_type).validate_python(parsed)
```

```python
# project/backend/app/storage/temporal_edge.py:21
self._db.execute("... SET r.end_scene_seq = $scene_seq;", {...})
self._db.execute("... CREATE (from)-[:TemporalRelation ...]->(to);", {...})
```

```python
# project/backend/app/storage/snapshot.py:59
self._db.execute("CREATE (s:WorldSnapshot) SET ...;", {...})
self._db.execute("MATCH (sv:SceneVersion {id: $scene_version_id}), (s:WorldSnapshot {id: $snapshot_id}) MERGE ...;", {...})
```

```python
# project/scripts/ten_chapter_novel_e2e.py:63
chapters = _post("/snowflake/step5b", {...})
if len(chapters) != 10:
    raise RuntimeError(f"expected 10 chapters, got {len(chapters)}")
```

- 实现审查结论: 存在问题

### 测试代码审查
- 测试文件: 存在：`project/backend/tests/perf/test_m5_performance.py`
- 测试覆盖情况:
  | 功能点 | 是否有测试 | 测试是否正确 |
  |-------|-----------|-------------|
  | 性能指标 P95/InfoGain | 是 | 部分（使用 Mock，不覆盖真实 LLM/Memgraph） |
  | 端到端 10 章流程 | 否 | 不适用（仅脚本，无自动化测试） |
- 测试质量结论: 部分符合（性能测试为模拟，风险验证不足）

## 风险清单

### 高风险
1. **LLM 调用稳定性风险**：`topone_gateway` 对输出做 `json.loads` 强解析，且 `topone_client` 直接 `raise_for_status()`，无重试/限流处理，易因 LLM 返回非 JSON 或短暂网络失败导致全流程失败。  
   证据：`project/backend/app/llm/topone_gateway.py:54`，`project/backend/app/services/topone_client.py:81`  
   缓解建议：在编排层引入明确的失败上报与可控重试策略；输出解析失败时记录原始响应并快速失败（避免静默失败）。

2. **10 章强约束不一致风险**：E2E 脚本硬性要求 10 章，但服务端未见同等强约束，LLM 生成数量波动会导致流程失败。  
   证据：`project/scripts/ten_chapter_novel_e2e.py:63`  
   缓解建议：在 Step5b 服务端增加总章数约束/分配策略（例如固定 3 幕 3/3/4），或调整 E2E 预期与需求一致。

### 中风险
1. **数据一致性风险（时序关系/快照非事务）**：`TemporalEdgeManager.upsert_relation` 与 `SnapshotManager.create_snapshot_if_needed` 多次写入无事务包裹，可能出现部分写入导致状态不一致。  
   证据：`project/backend/app/storage/temporal_edge.py:21`，`project/backend/app/storage/snapshot.py:59`  
   缓解建议：用 Memgraph 事务包裹多语句写入或合并为单条 Cypher，确保原子性。

2. **性能测试失真风险**：`tests/perf` 使用 Mock/本地引擎，未覆盖真实 LLM 与 Memgraph I/O，性能指标可能失真。  
   证据：`project/backend/tests/perf/test_m5_performance.py:66`  
   缓解建议：增加依赖真实存储的基准测试用例或引入固定样本回放，至少覆盖存储层 I/O。

### 低风险
1. **E2E 脚本依赖外部服务**：脚本默认调用本地 API，需要服务与环境变量配置到位，易在 CI/本地出现误用失败。  
   证据：`project/scripts/ten_chapter_novel_e2e.py:23`  
   缓解建议：补充运行前置说明或脚本内显式校验服务可达性并快速失败。

## 结论

结论：FAIL  
失败类型：实现问题  
阻塞：高风险未缓解（LLM 稳定性、10章约束一致性、数据一致性）

## 建议

1. 在服务端补齐 10 章总量约束或明确分配策略，避免 E2E 与后端输出不一致。  
2. LLM 输出解析失败必须“快速失败+可追溯日志”，并在编排层加入可控重试机制（不做兜底继续）。  
3. Memgraph 时序关系写入与快照创建使用事务保证原子性。  
4. 将现有 perf 测试扩展为至少包含真实存储 I/O 的基准用例。  
5. 将 `project/scripts/ten_chapter_novel_e2e.py` 纳入自动化流程或提供明确运行前置条件检查。

【MCP调用简报】
服务: serena  
触发: 风险审阅所需文件定位与读取  
参数: read_file(topone_client.py, topone_gateway.py, temporal_edge.py, snapshot.py, test_m5_performance.py, ten_chapter_novel_e2e.py), list_dir(tests/perf), search_for_pattern(ten_chapter_novel_e2e.py)  
结果: 读取 LLM 调用、性能测试、数据一致性与 E2E 脚本证据  
状态: 成功