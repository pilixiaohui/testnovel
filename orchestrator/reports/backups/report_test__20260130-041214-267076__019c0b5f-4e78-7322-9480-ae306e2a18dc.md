已阅读测试行为规范
iteration: 3

## 测试需求分析

工单要求测试的功能点：
1. 后端 Step4 返回的 SceneNode 必须包含 title 字段（字符串，非空）
2. 后端 Step4 返回的 SceneNode 必须包含 sequence_index 字段（整数，>=0）
3. 前端类型定义与后端响应结构一致

## 测试设计

### 设计思路
通过后端模型契约测试锁定 Step4 返回结构：直接校验 `SceneNode` 的字段存在性与校验规则（非空/非负），同时读取前端 `snowflake.ts` 的 `SceneNode` 接口确认字段一致。这样覆盖了后端响应模型与前端解析契约。

### 创建的测试文件
- `project/backend/tests/unit/test_scene_node_contract.py` - 校验 SceneNode 字段与前端类型一致性

### 测试用例清单

| 用例名称 | 测试场景 | 对应功能点 | 测试逻辑说明 |
|---------|---------|-----------|-------------|
| test_scene_node_includes_title_and_sequence_index_fields | 正常契约 | 功能点1/2 | 断言 SceneNode 字段列表包含 title/sequence_index |
| test_scene_node_rejects_empty_title | 异常处理 | 功能点1 | title 为空应触发校验失败 |
| test_scene_node_rejects_negative_sequence_index | 异常处理 | 功能点2 | sequence_index 为负应触发校验失败 |
| test_frontend_scene_node_has_title_and_sequence_index_fields | 类型一致性 | 功能点3 | 解析前端接口块，断言包含 title/sequence_index |

### 关键测试逻辑
- 测试数据准备：构造最小可用 SceneNode payload，补齐必须字段并注入 title/sequence_index。
- 调用接口/函数：直接实例化 `app.models.SceneNode` 触发 Pydantic 校验；读取 `project/frontend/src/types/snowflake.ts`。
- 断言条件：字段存在、空字符串与负数触发 ValidationError、前端接口包含字段名。
- 设计理由：模型校验失败即可证明契约未实现；前端接口校验保证结构一致性要求被覆盖。

## 测试执行

- 命令: `MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/unit/test_scene_node_contract.py -v`
- 结果: 失败
- 红灯确认: 是（后端 SceneNode 未包含 title/sequence_index，导致断言与校验未触发）

### 执行详情
- 失败用例：
  - `test_scene_node_includes_title_and_sequence_index_fields`：`SceneNode.model_fields` 中缺少 `title`、`sequence_index`。
  - `test_scene_node_rejects_empty_title` / `test_scene_node_rejects_negative_sequence_index`：字段缺失导致传入参数被忽略，未触发校验异常。
- 通过用例：
  - `test_frontend_scene_node_has_title_and_sequence_index_fields`：前端接口已包含字段。

## 验收标准

- 命令: `MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/unit/test_scene_node_contract.py -v`
- 阈值: 测试可执行且出现实现缺失导致的断言/校验失败，无语法或导入错误

结论：PASS
阻塞：无

【MCP调用简报】
服务: 无
触发: 本次任务仅使用本地 shell 命令完成测试编写与执行
参数: N/A
结果: N/A
状态: 成功