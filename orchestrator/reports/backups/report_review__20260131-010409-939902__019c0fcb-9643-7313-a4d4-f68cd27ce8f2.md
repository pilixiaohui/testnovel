已阅读审阅行为规范
iteration: 1
review_mode: single

## 任务理解
目标：对照 `doc/系统架构与技术规格.md` 与 `doc/frontend_implementation_spec.md`，评估 `project/frontend/tests/e2e/` 下现有 E2E 用例的**覆盖度与合理性**，并检查测试实现质量（选择器、断言、等待、隔离、可重复性），输出“功能点 vs 用例”覆盖矩阵，给出 PASS/FAIL 结论与改进建议。

## 验收执行
- 命令: `npm run test:e2e` | 返回码: 0 | 结果: 7 passed

命令输出（完整）：
```text
> frontend@0.0.0 test:e2e
> npx playwright test


Running 7 tests using 1 worker

  ✓  1 tests/e2e/core.e2e.spec.ts:195:1 › SnowflakeFlow 核心流程 (3.2s)
  ✓  2 tests/e2e/core.e2e.spec.ts:235:1 › SimulationConsole 核心流程 (696ms)
  ✓  3 tests/e2e/core.e2e.spec.ts:258:1 › SceneEditor 核心流程 (834ms)
  ✓  4 tests/e2e/core.e2e.spec.ts:293:1 › WorldManager 核心流程 (796ms)
  ✓  5 tests/e2e/core.e2e.spec.ts:329:1 › Settings 保存流程 (413ms)
  ✓  6 tests/e2e/simulation.spec.ts:93:1 › SimulationConsole 基本流程 (691ms)
  ✓  7 tests/e2e/snowflake.spec.ts:76:1 › SnowflakeFlow 基本流程 (797ms)

  7 passed (9.8s)
```

## 代码深度审查

### 实现代码
- 文件: `project/frontend/src/views/SnowflakeView.vue`
- 检查结果:
  | 检查项 | 结果 | 说明 |
  |---|---|---|
  | 文档一致性 | 存在问题 | 文档期望 el-steps + currentStep 切换与“完成 Step6 跳转编辑器”（`doc/frontend_implementation_spec.md:750-754`），实现中 Step6 仅 `await store.fetchStep6()`，无跳转（`project/frontend/src/views/SnowflakeView.vue:148-149`） |
  | 可测性/选择器 | 合理 | 关键控件均有 `data-test`，E2E 选择器总体稳定 |
  | 关键流程暴露 | 基本满足 | Step1-6 都可触发，但缺少“流程编排式向导/分步显示”的实现，使文档用例无法真实验收 |
- 结论: 存在问题（实现与规格文档偏差较大，导致“按文档衡量的 E2E 覆盖”先天不足）

- 文件: `project/frontend/src/views/EditorView.vue`
- 检查结果:
  | 检查项 | 结果 | 说明 |
  |---|---|---|
  | 关键用户流 | 存在问题 | 已实现“章节审核”操作按钮（如 `data-test="chapter-approve"`，`project/frontend/src/views/EditorView.vue:90`），但 E2E 未覆盖（`project/frontend/tests/e2e/core.e2e.spec.ts` 中无 `chapter-approve`） |
  | API 契约暴露 | 部分满足 | 编辑器 E2E 覆盖了 context/render/diff/complete 的主链路，但不覆盖 review API 行为 |
- 结论: 存在问题（新增/隐藏的关键能力未纳入 E2E）

### 测试代码
- 文件: `project/frontend/tests/e2e/core.e2e.spec.ts`
- 文件: `project/frontend/tests/e2e/snowflake.spec.ts`
- 文件: `project/frontend/tests/e2e/simulation.spec.ts`
- 文件: `project/frontend/tests/e2e/playwright.e2e.ts`
- 文件: `project/frontend/playwright.config.ts`

- 检查结果（质量与风险）:
  | 检查项 | 结果 | 证据/说明 |
  |---|---|---|
  | 选择器稳定性 | 较好 | 绝大多数使用 `data-test`；但仍夹杂结构选择器（如 `section.step-panel`）对 UI 重构较敏感 |
  | 断言完整性 | 存在不足 | 多数断言仅“可见/包含文本/请求发生”，缺少对请求 payload、业务状态变化的强断言；Settings 用例只验证按钮可见（`project/frontend/tests/e2e/core.e2e.spec.ts:329-333`） |
  | 等待策略 | 基本可用但偏弱 | 多处用 `waitForRequest`（只保证发起请求，不保证响应+UI落地），虽然后续 `expect` 会等待，但易埋下偶发性 |
  | E2E 真实性 | 偏弱 | 大量 `page.route` mock（如 `project/frontend/tests/e2e/core.e2e.spec.ts:96` 起），更接近“前端契约/组件集成烟测”，无法发现后端契约/联调问题 |
  | 端口/超时硬编码 | 存在问题 | 用例硬编码 5177/15000ms（`project/frontend/tests/e2e/core.e2e.spec.ts:7,14,42`；同样重复在 `snowflake.spec.ts:7`、`simulation.spec.ts:7`）；与执行环境注入端口 5185、等待 6 秒、e2e 超时 600 秒不一致；配置也不一致（`project/frontend/playwright.config.ts:5,9`） |
  | DRY/维护性 | 存在问题 | 三个 spec 文件重复 devServer 启停与 waitForServer/jsonResponse；且每文件都 `npm run dev` 一次（慢且容易端口占用） |
  | 隐患文件 | 有风险 | `project/frontend/tests/e2e/playwright.e2e.ts` 含 `throw new Error(...)`（`project/frontend/tests/e2e/playwright.e2e.ts:42`），目前不匹配 Playwright 默认 testMatch 未执行，但未来改 testMatch/命名可能直接炸套件 |
- 结论: 存在问题（覆盖不足 + 质量/一致性问题；按文档要求难称“全面合理”）

#### 覆盖度矩阵（功能点 vs 测试用例映射）
（“文档”主要参考 `doc/frontend_implementation_spec.md` 的路由表与分阶段说明；其中明确测试点如 Step6 跳转见 `doc/frontend_implementation_spec.md:752-754`，Home 路由见 `doc/frontend_implementation_spec.md:925`）

| 功能点（按文档模块/流程） | 文档期望要点 | 现有 E2E 用例 | 覆盖结论 |
|---|---|---|---|
| HomeView `/` 项目列表/创建入口 | 首页入口+导航（`doc/frontend_implementation_spec.md:925`） | 无 | 缺失 |
| Snowflake Step1：输入想法→生成 loglines | 文档示例要求“生成 10 个 logline”（`doc/frontend_implementation_spec.md:752`） | `SnowflakeFlow 基本流程` / `SnowflakeFlow 核心流程` | 部分：只断言 1 条结果，不校验数量/边界/错误 |
| Snowflake Step2：选择 logline→生成结构 | 结构生成+状态更新 | `SnowflakeFlow 基本流程` / `SnowflakeFlow 核心流程` | 覆盖（happy path） |
| Snowflake Step3：生成角色小传 | 角色列表可见 | `SnowflakeFlow 核心流程` | 覆盖（happy path） |
| Snowflake Step4：生成场景骨架 | 场景可见 | `SnowflakeFlow 核心流程` | 覆盖（happy path） |
| Snowflake Step5：生成 Acts/Chapters | Acts/Chapters 数量 | `SnowflakeFlow 核心流程` | 部分：只等待 step5a 请求，未显式等待 step5b；无异常/边界 |
| Snowflake Step6：生成 Anchors | Anchors 数量 | `SnowflakeFlow 核心流程` | 覆盖（happy path） |
| Snowflake Step6 完成→跳转 Editor | 文档明确要求（`doc/frontend_implementation_spec.md:754`） | 无（且实现也未跳转） | 缺失（规格未被验收） |
| Simulation：Start 加载日志 | 进入推演控制台、加载 logs | `SimulationConsole 基本流程` / `SimulationConsole 核心流程` | 覆盖（happy path） |
| Simulation：Run Round（单回合） | 运行回合、展示收敛/日志 | `SimulationConsole 核心流程` | 覆盖但偏弱：不校验仲裁/信息增量等关键字段展示 |
| Simulation：Run Scene（场景推演） | 场景推演、日志累计 | `SimulationConsole 核心流程` | 覆盖但偏弱 |
| Simulation：Stop/Reset | 停止/重置（文档有控件） | 无（仅检查按钮存在） | 缺失（行为未验收） |
| Editor：Load Scene（context + render） | 拉取上下文并渲染 | `SceneEditor 核心流程` | 覆盖（happy path） |
| Editor：编辑→Dirty→Save | 脏状态、保存落库 | `SceneEditor 核心流程` | 覆盖（happy path） |
| Editor：Diff | 版本差异展示 | `SceneEditor 核心流程` | 覆盖（happy path） |
| Editor：Render | 重新渲染展示 | `SceneEditor 核心流程` | 覆盖（happy path） |
| Editor：章节审核（Approve/Reject） | 系统/前端具备 review 概念与 API（实现中已出现按钮） | 无 | 缺失（关键流程未覆盖） |
| World：加载 Entities/Anchors/Subplots | 4 个标签页/列表（文档期望 tabs：`doc/frontend_implementation_spec.md:796-798`） | `WorldManager 核心流程` | 部分：实现本身无 tabs；测试仅验收列表可见 |
| World：实体 Create/Update/Delete | 实体 CRUD | `WorldManager 核心流程` | 部分：只验证请求发生，不验证 UI/状态变化 |
| World：关系图谱展示 | 关系可视化 | `WorldManager 核心流程` | 覆盖（happy path，弱断言） |
| World：锚点更新/可达性检查 | anchor update/check | 无 | 缺失 |
| World：支线创建/解决 | subplot create/resolve | 无 | 缺失 |
| Settings：更新配置→保存→成功提示 | 文档/计划文件也给出“success indicator appears”（`project/frontend/tests/e2e/playwright.e2e.ts` 场景描述） | `Settings 保存流程` | 部分：仅验证按钮可见，不点击、不验证状态变化 |

## 结论
结论：FAIL  
失败类型：测试问题  
阻塞：E2E 覆盖未达到文档要求（缺 Home/导航、Settings 保存行为、Editor 章节审核、World 锚点/支线等关键流程；缺边界/错误场景）；且 E2E 测试存在端口/超时硬编码与配置不一致问题（`project/frontend/tests/e2e/core.e2e.spec.ts:7,14,42`；`project/frontend/playwright.config.ts:5,9`），整体难称“全面合理”。

## 建议
1. 明确测试分层：将当前大量 mock 的用例定位为“前端契约/烟测”，另补一组“真 E2E（连后端）”覆盖雪花→推演→渲染→审核的关键链路，否则“端对端”名不副实。  
2. 统一端口/超时配置：用 Playwright `webServer` 启一次 dev server，使用执行环境注入端口/等待/超时，去掉每文件自启与 5177/15000 等硬编码。  
3. 补齐关键缺口用例：HomeView 导航、Settings 点击保存并断言状态、Editor 章节审核 approve/reject、World 锚点 check/更新、Subplot resolve 等；至少覆盖 1 条错误/异常链路（例如 API 500/超时的可见失败）。  
4. 强化断言：对关键请求校验 payload（idea/logline/branch_id 等），对关键 UI 状态校验（计数、状态标签、dirty 标识、review_status 变化），减少“只要发请求就算过”的弱验收。  
5. 处理 `playwright.e2e.ts`：若只是计划文件，建议移出 `tests/e2e/` 或改名避免未来 testMatch 命中导致整套直接失败（`project/frontend/tests/e2e/playwright.e2e.ts:42`）。

【MCP调用简报】  
服务: serena  
触发: 读取规格文档/前端实现与 E2E 测试源码、抽取证据行号与覆盖点  
参数: read_file(list_dir/search_for_pattern)，relative_path 限定到 doc/ 与 project/frontend/  
结果: 命中 E2E 测试 4 文件 + Playwright 配置 1 文件 + 主要视图实现 5 文件 + 规格文档 2 份  
状态: 成功  

【MCP调用简报】  
服务: bash(shell_command)  
触发: 执行验收命令以验证 E2E 测试可运行  
参数: workdir=/home/zxh/ainovel_v3/project/frontend；cmd=`npm run test:e2e`  
结果: 7 passed (9.8s)  
状态: 成功