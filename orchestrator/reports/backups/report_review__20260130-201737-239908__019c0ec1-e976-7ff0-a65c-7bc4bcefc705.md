已阅读审阅行为规范  
iteration: 21  
review_mode: single  

## 任务理解

审阅的任务：调查用户反馈的前端问题和测试有效性问题（Vite 代理报错、Playwright/Vitest 测试是否有效、测试数据是否持久化到 Memgraph、数据流是否完整）。  
验收标准（来自工单）：  
1. 明确 Vite 代理错误的根因  
2. 确认测试数据是否持久化到 Memgraph  
3. 判断 Playwright 测试是否为有效 E2E（真实后端 vs mock）  
4. 给出修复建议  

## 验收执行

- 验收命令（复现 Vite 代理错误）: `cd project/frontend && npm run dev (5177) + curl /api/v1/snowflake/step1`
- 返回码: 0
- 测试结果: 不适用（复现命令）
- 覆盖率: 不适用
- 完整输出证据:
```text
        <!DOCTYPE html>
        <html lang="en">
          <head>
            <meta charset=UTF-8 />
            <title>Error</title>
            <script type="module">
              const error = {"message":"Cannot read properties of null (reading 'split')","stack":"    at required (file:///home/zxh/ainovel_v3/project/frontend/node_modules/vite/dist/node/chunks/dep-NjL7WTE1.js:59660:23)\n    at common.setupOutgoing (file:///home/zxh/ainovel_v3/project/frontend/node_modules/vite/dist/node/chunks/dep-NjL7WTE1.js:59787:8)\n    at Array.stream (file:///home/zxh/ainovel_v3/project/frontend/node_modules/vite/dist/node/chunks/dep-NjL7WTE1.js:60903:16)\n    at ProxyServer.<anonymous> (file:///home/zxh/ainovel_v3/project/frontend/node_modules/vite/dist/node/chunks/dep-NjL7WTE1.js:61215:22)\n    at viteProxyMiddleware (file:///home/zxh/ainovel_v3/project/frontend/node_modules/vite/dist/node/chunks/dep-NjL7WTE1.js:61534:15)\n    at call (file:///home/zxh/ainovel_v3/project/frontend/node_modules/vite/dist/node/chunks/dep-NjL7WTE1.js:41283:7)\n    at next (file:///home/zxh/ainovel_v3/project/frontend/node_modules/vite/dist/node/chunks/dep-NjL7WTE1.js:41227:5)\n    at viteCachedTransformMiddleware (file:///home/zxh/ainovel_v3/project/frontend/node_modules/vite/dist/node/chunks/dep-NjL7WTE1.js:61667:5)\n    at call (file:///home/zxh/ainovel_v3/project/frontend/node_modules/vite/dist/node/chunks/dep-NjL7WTE1.js:41283:7)\n    at next (file:///home/zxh/ainovel_v3/project/frontend/node_modules/vite/dist/node/chunks/dep-NjL7WTE1.js:41227:5)","frame":""}
              try {
                const { ErrorOverlay } = await import("/@vite/client")
                document.body.appendChild(new ErrorOverlay(error))
              } catch {
                const h = (tag, text) => {
                  const el = document.createElement(tag)
                  el.textContent = text
                  return el
                }
                document.body.appendChild(h('h1', 'Internal Server Error'))
                document.body.appendChild(h('h2', error.message))
                document.body.appendChild(h('pre', error.stack))
                document.body.appendChild(h('p', '(Error overlay failed to load)'))
              }
            </script>
          </head>
          <body>
          </body>
        </html>
      
> frontend@0.0.0 dev
> vite --host 127.0.0.1 --port 5177 --strictPort


  VITE v5.4.0  ready in 384 ms

  ➜  Local:   http://127.0.0.1:5177/
8:04:31 PM [vite] Internal server error: Cannot read properties of null (reading 'split')
      at required (file:///home/zxh/ainovel_v3/project/frontend/node_modules/vite/dist/node/chunks/dep-NjL7WTE1.js:59660:23)
      at common.setupOutgoing (file:///home/zxh/ainovel_v3/project/frontend/node_modules/vite/dist/node/chunks/dep-NjL7WTE1.js:59787:8)
      at Array.stream (file:///home/zxh/ainovel_v3/project/frontend/node_modules/vite/dist/node/chunks/dep-NjL7WTE1.js:60903:16)
      at ProxyServer.<anonymous> (file:///home/zxh/ainovel_v3/project/frontend/node_modules/vite/dist/node/chunks/dep-NjL7WTE1.js:61215:22)
      at viteProxyMiddleware (file:///home/zxh/ainovel_v3/project/frontend/node_modules/vite/dist/node/chunks/dep-NjL7WTE1.js:61534:15)
      at call (file:///home/zxh/ainovel_v3/project/frontend/node_modules/vite/dist/node/chunks/dep-NjL7WTE1.js:41283:7)
      at next (file:///home/zxh/ainovel_v3/project/frontend/node_modules/vite/dist/node/chunks/dep-NjL7WTE1.js:41227:5)
      at viteCachedTransformMiddleware (file:///home/zxh/ainovel_v3/project/frontend/node_modules/vite/dist/node/chunks/dep-NjL7WTE1.js:61667:5)
      at call (file:///home/zxh/ainovel_v3/project/frontend/node_modules/vite/dist/node/chunks/dep-NjL7WTE1.js:41283:7)
      at next (file:///home/zxh/ainovel_v3/project/frontend/node_modules/vite/dist/node/chunks/dep-NjL7WTE1.js:41227:5)
DEPRECATION WARNING [legacy-js-api]: The legacy JS API is deprecated and will be removed in Dart Sass 2.0.0.

More info: https://sass-lang.com/d/legacy-js-api
```

- 补充验证（将 proxy target 临时改为合法 URL 后，代理链路可用且后端可达）: `VITE_API_BASE_URL=http://127.0.0.1:8000 npm run dev (5178) + curl /api/v1/snowflake/step1`
- 返回码: 0
- 测试结果: 不适用（验证命令）
- 覆盖率: 不适用
- 完整输出证据:
```text
["宇航员在太阳系边缘发现神秘的第十颗行星“X”，惊觉其文明演化竟是地球历史的完全倒放。","一名精英特工被植入代号“X”的纳米芯片，必须在24小时内解开自己被抹去的记忆，否则芯片将引爆。","在全女性构成的未来社会，基因学家秘密抚养了世界上最后一个携带Y染色体的男人，而代号“X”的组织正试图猎杀他。","一群少年在森林深处发现地图上标记为“X”的禁区，意外唤醒了冷战时期遗留的时间静止实验场。","为了挽回初恋，落魄发明家制造了一台只能穿越回与前任（Ex）分手那一刻的时光机，却引发了蝴蝶效应。","数学天才发现了一个能预测股市崩盘的终极变量“X”，因此遭到全球金融寡头和暗杀组织的疯狂追杀。","两位长相一模一样的陌生人在十字路口（Cross）相撞，醒来后发现互换了身份，必须替对方解决人生危机。","一种代号“X”的未知病毒让感染者能听到他人的心声，原本平静的小镇因此陷入彻底的信任危机与混乱。","过气明星参加了一档名为“X生存”的死亡真人秀，发现唯一的获胜条件是杀死自己曾经最好的朋友。","警探在追查连环杀人案时发现，所有受害者身上都刻着罗马数字“X”，而第十个目标正是他失踪多年的女儿。"]
> frontend@0.0.0 dev
> vite --host 127.0.0.1 --port 5178 --strictPort


  VITE v5.4.0  ready in 396 ms

  ➜  Local:   http://127.0.0.1:5178/
DEPRECATION WARNING [legacy-js-api]: The legacy JS API is deprecated and will be removed in Dart Sass 2.0.0.

More info: https://sass-lang.com/d/legacy-js-api
```

- 后端数据持久化相关 E2E 测试（确认“写入 Memgraph + API 可查询”行为正确）:
  - 命令: `cd project/backend && /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/integration/test_ten_chapter_e2e.py -v`
  - 返回码: 0
  - 测试结果: `1 passed`
  - 输出证据（节选但为完整命令输出）:
```text
tests/integration/test_ten_chapter_e2e.py::test_ten_chapter_e2e_flow PASSED [100%]
======================== 1 passed, 2 warnings in 1.14s =========================
```
  - 命令: `cd project/backend && /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest tests/integration/test_review_e2e.py -v`
  - 返回码: 0
  - 测试结果: `1 passed`
  - 输出证据（节选但为完整命令输出）:
```text
tests/integration/test_review_e2e.py::test_review_e2e_flow PASSED        [100%]
======================== 1 passed, 2 warnings in 0.98s =========================
```

- 前端“章节审核 UI”测试（说明：这是 mock API 的单测，并不验证真实后端/数据库）:
  - 命令: `cd project/frontend && npm run test -- --run tests/fe_chapter_review.spec.ts`
  - 返回码: 0
  - 测试结果: `1 file passed, 3 tests passed`
  - 输出证据（节选但为完整命令输出）:
```text
✓ tests/fe_chapter_review.spec.ts (3 tests)
Test Files  1 passed (1)
Tests       3 passed (3)
```

## 代码深度审查

### 实现代码审查

- 审查文件: `project/frontend/vite.config.ts`
- 审查内容:
  | 检查项 | 结果 | 说明 |
  |-------|------|------|
  | 函数参数/返回值类型 | 符合 | 配置函数签名正常 |
  | API 契约一致性 | 不符合 | 将 `VITE_API_BASE_URL` 直接作为 Vite proxy 的 `target` 使用，但该值在开发环境为路径(`/api/v1`)而非 origin URL，导致 proxy 内部崩溃 |
  | 错误处理完整性 | 不完整 | 仅校验 `VITE_API_BASE_URL` 非空，但未保证其为合法 proxy target（URL） |
  | 边界条件处理 | 未考虑 | `target` 为相对路径时触发 `Cannot read properties of null (reading 'split')` |
- 代码片段证据:
```ts
// project/frontend/vite.config.ts:10
const env = loadEnv(mode, process.cwd(), '')
// project/frontend/vite.config.ts:11
const apiBaseUrl = env.VITE_API_BASE_URL
// project/frontend/vite.config.ts:33-35
'/api': {
  target: apiBaseUrl,
  changeOrigin: true,
},
```
- 实现审查结论: 存在问题（核心根因）

- 审查文件: `project/frontend/.env.development`
- 代码片段证据:
```text
# project/frontend/.env.development:1
VITE_API_BASE_URL=/api/v1
```
- 说明: 该值作为 axios `baseURL`（路径前缀）是合理的，但作为 Vite proxy `target`（要求是 URL）会触发崩溃。

- 审查文件: `project/frontend/src/api/index.ts`
- 代码片段证据:
```ts
// project/frontend/src/api/index.ts:4
const baseURL = import.meta.env.VITE_API_BASE_URL || '/api/v1'
```
- 说明: 前端 API 代码把 `VITE_API_BASE_URL` 当作“路径前缀”（默认 `/api/v1`）来用；与 `vite.config.ts` 把它当作“后端 origin”形成冲突，属于同一配置被两个职责复用导致的设计问题。

### 测试代码审查

- 测试文件: 存在
  - `project/frontend/tests/fe_chapter_review.spec.ts`（Vitest 单测）
  - `project/frontend/tests/e2e/core.e2e.spec.ts` 等（Playwright）
- 测试覆盖情况:
  | 功能点 | 是否有测试 | 测试是否正确 |
  |-------|-----------|-------------|
  | “审核按钮点击会调用 review API 并更新 UI” | 是 | 部分正确（API 被 mock，不验证真实网络/持久化） |
  | “Vite 代理能转发 /api/v1 到真实后端” | 否 | 不适用（Playwright 通过 `page.route` 直接拦截并 fulfill，绕过 proxy） |
  | “测试运行后数据能在 Memgraph 中保留供前端查看” | 否（且不应要求） | 不适用（后端集成测试 fixture 会清库） |
- 代码片段证据（Playwright 全部走 mock，不是有效的真实 E2E）:
```ts
// project/frontend/tests/e2e/core.e2e.spec.ts:96-112
await page.route('**/api/v1/snowflake/step1', (route) => route.fulfill(jsonResponse(loglines)))
await page.route('**/api/v1/snowflake/step2', (route) => route.fulfill(jsonResponse(root)))
...
await page.route('**/api/v1/snowflake/step5b', (route) => route.fulfill(jsonResponse([{ id: 'ch-1' }])))
```
- 代码片段证据（Vitest 章节审核测试 mock 掉了 `reviewChapter`，不触达后端/数据库）:
```ts
// project/frontend/tests/fe_chapter_review.spec.ts:10-12
vi.mock('@/api/chapter', () => ({
  reviewChapter: vi.fn(),
}))
```
- 测试质量结论: 部分符合（更偏“UI contract/组件行为测试”，不等价于真实 E2E）

### 测试数据持久化核查（后端）

- 核心结论：后端集成测试确实连接真实 Memgraph，但 **fixture 会在用例前后清空数据库**，因此“测试跑完前端看不到测试生成的数据”是预期行为，不是持久化缺失。
- 证据:
```py
# project/backend/tests/integration/conftest.py:74-79
storage.db.execute("MATCH (n) DETACH DELETE n;")
try:
    yield storage
finally:
    storage.db.execute("MATCH (n) DETACH DELETE n;")
```

## 结论

结论：FAIL  
失败类型：实现问题  
阻塞：前端 `vite` dev server 访问 `/api/v1/*` 时因 proxy `target` 配置为相对路径而触发内部崩溃（`Cannot read properties of null (reading 'split')`），导致实际前端使用不可用；同时 Playwright/Vitest 测试大量使用 mock，未覆盖真实 proxy/后端联通与持久化，因此未能提前发现此问题。  

## 建议

1. （派发 DEV）修复 Vite 代理配置职责混用：
   - 保留 `VITE_API_BASE_URL=/api/v1` 作为前端 axios 的 base path；
   - 新增并强制要求 `VITE_API_PROXY_TARGET=http://127.0.0.1:8000`（或可配置），在 `project/frontend/vite.config.ts` 中使用它作为 `server.proxy['/api'].target`；
   - 符合“快速失败”：若 `mode === 'development'` 且未配置 `VITE_API_PROXY_TARGET`，直接 throw。
2. （派发 TEST）补一条“真实联通”用例（避免全 mock）：
   - Playwright 增加一个 smoke 测试：不做 `page.route` 拦截，直接在 `/snowflake` 点击 Step1，断言返回 10 条 loglines；该用例能直接覆盖 “Vite proxy + 后端 API”。
3. （给 USER/MAIN 说明）“测试结果不在前端显示/不在数据库保留”的原因：
   - 后端集成测试在用例前后清库（避免污染），因此不会保留数据供 UI 查看；
   - 前端测试（Vitest/Playwright）大多 mock API，本身不会写入数据库。
4. （次要）Sass deprecation warning 为警告非致命，但建议后续统一升级/替换依赖链以消除噪声（不阻塞本问题）。

【MCP调用简报】  
服务: serena  
触发: 调查前端 Vite 代理错误、核查测试是否真实联通与数据是否写入 Memgraph  
参数: 读取 `project/frontend/vite.config.ts`/`.env.development`/测试文件；执行 `npm run dev`+curl 复现；执行 pytest/vitest 验证  
结果: 复现并定位根因为 proxy target 使用相对路径；确认前端/Playwright/Vitest 多为 mock；确认后端集成测试会清库  
状态: 成功