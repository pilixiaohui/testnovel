已阅读开发行为规范
iteration: 11
self_test: enabled

## 任务理解

工单要求实现的功能：
1. Step5b 端点统计所有幕生成章节总数，非 10 时返回 400。
2. 错误信息固定为 `chapter count must be exactly 10`。
3. 可选更新提示词（本次未做，非验收项）。

## 实现方案

### 设计思路
- 先生成并累计各幕章节数，统一校验后再持久化，避免错误数据入库（快速失败）。
- 保持原有字段校验与异常处理逻辑，最小改动满足测试（KISS/YAGNI）。

### 改动说明

| 文件 | 修改内容 | 实现逻辑 |
|-----|---------|---------|
| `project/backend/app/main.py:296` | Step5b 增加总数统计与校验 | 先收集各幕生成结果并统计总数，若 !=10 直接 400，成功后再创建章节 |

### 关键实现逻辑
- 数据流向：`generate_chapter_list` → 收集每幕生成列表 → 总数校验 → `create_chapter` 持久化。
- 关键处理步骤：统计 `total_count`，若不等于 10 直接抛出 HTTPException 400。
- 异常处理策略：沿用已有字段缺失/存储异常处理，不新增兜底逻辑。
- 与其他模块交互方式：不改变接口签名，仅调整 Step5b 端点内部流程。

## 自测结果（仅 enabled 模式）

### 验收结果汇总

| 序号 | 命令 | 返回码 | 结果摘要 |
|-----|------|-------|---------|
| 1 | `MEMGRAPH_HOST=localhost MEMGRAPH_PORT=7687 /home/zxh/ainovel_v3/project/backend/.venv/bin/python -m pytest project/backend/tests/unit/test_step5b_chapter_count.py -v` | 0 | 3 passed, 2 warnings |

- 全部验收命令已执行: 是
- 自测结果: PASS
- 覆盖率: 未输出（未开启覆盖率参数）

### 测试详情
- `tests/unit/test_step5b_chapter_count.py` 全部通过。
- 警告：FastAPI `on_event` deprecation（不影响本次验收）。

## 测试问题反馈（如有）

无

## 总结与展望
- 已完成：Step5b 添加章节总数严格校验，确保 !=10 时快速失败。
- 原则应用：KISS（集中校验逻辑）、YAGNI（不扩展提示词/重试）、DRY（复用现有字段校验逻辑）、SOLID（端点职责清晰）。
- 遇到的挑战：需要在不改变现有持久化逻辑的前提下避免错误写入，已通过“先统计后创建”解决。
- 下一步建议：如需提高 LLM 命中率，可在 `project/backend/app/llm/prompts/step5b.py` 中明确 10 章约束（非本次验收要求）。

结论：PASS
阻塞：无

【MCP调用简报】
服务: serena
触发: 定位并修改 Step5b 端点逻辑
参数: search_for_pattern/read_file/replace_regex（relative_path=project/backend/app/main.py）
结果: 增加总数统计与 400 校验
状态: 成功