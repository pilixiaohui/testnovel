已阅读审阅行为规范  
iteration: 5  
review_mode: single

## 任务理解

审阅的任务：审阅 **M3-T1 章节审核 API** 的需求与接口设计，确认实现方向  
验收标准（工单）：  
- `POST /api/v1/chapters/{id}/review` 接受 `{"status":"approved"|"rejected"}`
- `review_status` 写入 Memgraph 并可被查询验证
- 错误处理：章节不存在 404；无效 status 400

## 验收执行

- 验收命令: 不适用（本工单为需求/接口设计审阅，未提供验收测试命令）
- 返回码: 不适用
- 测试结果: 不适用
- 覆盖率: 不适用

## 代码深度审查

### 实现代码审查
- 审查文件: `project/backend/app/main.py`
- 审查文件: `project/backend/app/models.py`
- 审查文件: `project/backend/app/storage/schema.py`
- 审查文件: `project/backend/app/storage/memgraph_storage.py`
- 审查内容:
  | 检查项 | 结果 | 说明 |
  |-------|------|------|
  | 接口当前是否已存在 | 不存在 | `main.py` 当前只有 `/chapters/{chapter_id}/render` 与 `/chapters/{chapter_id}`，未定义 `/review` 端点 |
  | Chapter 模型是否具备 review_status | 符合 | `app.models.ReviewStatus(pending/approved/rejected)`；`Chapter.review_status` 默认 pending |
  | 存储层是否具备持久化路径 | 符合 | `storage.schema.Chapter.review_status` 为字符串；`MemgraphStorage.update_chapter()` 会写入 `_chapter_props`，其中 `review_status` 为必填字段 |
  | Enum/字符串兼容性 | 符合 | `_chapter_props` 对带 `.value` 的 enum 自动转字符串，兼容 `app.models.ReviewStatus` 与 `storage.schema.Chapter(str)` |
  | 错误处理实现可行性 | 符合 | `main.py` 现有风格：业务校验/不存在 → `HTTPException(400/404)`；存储层异常映射到 400/404 |

- 代码片段证据:
```python
# project/backend/app/models.py:144
class ReviewStatus(str, Enum):
    pending = "pending"
    approved = "approved"
    rejected = "rejected"

class Chapter(BaseModel):
    ...
    review_status: ReviewStatus = ReviewStatus.pending
```

```python
# project/backend/app/storage/schema.py:98
class Chapter(Node):
    ...
    review_status: str = "pending"
```

```python
# project/backend/app/storage/memgraph_storage.py:707
def _chapter_props(self, chapter: Chapter) -> dict[str, object]:
    props = self._props_from(
        chapter,
        required=("id", "act_id", "sequence", "title", "focus", "review_status"),
        optional=("pov_character_id", "rendered_content"),
    )
    review_status = props.get("review_status")
    if hasattr(review_status, "value"):
        props["review_status"] = review_status.value
    return props
```

- 实现审查结论: 现有模型与存储层已具备 `review_status` 的读写能力；只需在 `project/backend/app/main.py` 增加 review 端点并做 status 校验即可。

### 测试代码审查
- 测试文件: 不存在（未发现 `project/backend/tests/integration/test_chapter_review_api.py`）
- 测试覆盖情况（建议给 TEST 的用例清单）:
  | 功能点 | 是否有测试 | 测试是否正确 |
  |-------|-----------|-------------|
  | approved 更新 + 持久化 | 否 | 不适用 |
  | rejected 更新 + 持久化 | 否 | 不适用 |
  | 无效 status → 400 | 否 | 不适用 |
  | chapter 不存在 → 404 | 否 | 不适用 |
  | 幂等性（重复 approve/reject） | 否 | 不适用 |
- 测试质量结论: 缺少测试（符合当前阶段：待实现后补齐）

## 结论

结论：PASS  
阻塞：无

## 建议

1. 接口设计（建议最终落地形态，遵循 KISS/YAGNI）  
- 路径：`POST /api/v1/chapters/{chapter_id}/review`（路径参数命名建议与现有 `/chapters/{chapter_id}` 保持一致）  
- 请求体：`{"status": "approved" | "rejected"}`（按需求用 `status` 字段；写入时映射到 `chapter.review_status`）  
- 响应体：建议最简 `{"id": chapter_id, "review_status": "<approved|rejected>"}`；若前端需要全量数据可复用 `GET /chapters/{chapter_id}` 的返回结构  
- 错误：  
  - chapter 不存在：404 `detail="chapter not found"`  
  - status 非 approved/rejected：**400**（注意：若用 `Literal[...]` 走 Pydantic 校验会变成 422，不符合工单“无效status返回400”的要求；建议用 `status: str` + 手动校验）

2. 代码变更点（给 DEV 可直接照此拆分工单）  
- `project/backend/app/models.py`：新增 `ChapterReviewPayload(status: str)`（或复用现有结构但需要显式导出/导入）  
- `project/backend/app/main.py`：在 chapter 相关路由附近新增 endpoint：  
  - `chapter = storage.get_chapter(chapter_id)` → None 则 404  
  - 校验 `payload.status in {"approved","rejected"}` → 否则 400  
  - `chapter.review_status = payload.status` → `storage.update_chapter(chapter)` 持久化  
  - 返回确认响应

3. 测试建议（给 TEST 工单：`tests/integration/test_chapter_review_api.py`）  
- 使用 `memgraph_storage` fixture（`tests/integration/conftest.py` 已提供清库保障）  
- 复用 `test_chapter_persistence.py` 的“seed root/act/chapter”思路：`create_act` → `create_chapter`  
- 用例最少应覆盖：approve 成功、reject 成功、invalid status 400、missing chapter 404、持久化验证（再次 `get_chapter` 或 `GET /chapters/{id}`）

【MCP调用简报】  
服务: serena  
触发: 审阅 M3-T1 接口设计需要核实现有端点/模型/存储持久化能力  
参数: execute_shell_command(rg/nl 定位关键实现)、read_file(ports/schema/memgraph_storage)、find_file(检查测试文件存在性)  
结果: 确认 `review_status` 全链路字段已存在且可持久化；确认尚无 `/chapters/{id}/review` 端点与对应集成测试  
状态: 成功