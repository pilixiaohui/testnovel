已阅读开发行为规范  
iteration: 7

## 完成情况
实现了 Memgraph 存储的最小闭环（时序状态写入/读取 + `world_state(scene_seq)` 查询 + snapshot 生成/读取），并补齐可复现的本地运行方式与集成测试入口。

## 改了哪里
- `project/backend/app/storage/memgraph_world_state.py:27`
  - 新增 `MemgraphWorldStateStorage`：`add_entity_state`/`list_entity_states`/`get_world_state`/`create_snapshot`/`get_snapshot`（包含 start/end scene 区间的时序关系 `HAS_STATE`）。
  - 初始化时执行 `RETURN 1` 做连接校验，连接失败直接报错（无兜底/无回退）。
- `project/backend/tests/test_memgraph_storage_integration.py:13`
  - 新增 Memgraph 集成测试：覆盖“写入/读取 entity 状态（含 start/end）→ 按 scene_seq 查询 world_state → snapshot 生成与读取”。
  - Memgraph 不可用时默认 `skip`；设置 `REQUIRE_MEMGRAPH=1` 则强制失败（用于 CI/本地严格验证）。
- `project/backend/docker-compose.memgraph.yml:1`
  - 新增本地 Memgraph 启动方式（bolt 端口 `7687`）。
- `project/backend/README.md:9`
  - 补充 Memgraph 启动/停止命令与集成测试命令（含 `REQUIRE_MEMGRAPH=1` 严格模式）。
- `project/backend/pyproject.toml:10`
  - 增加 Memgraph 访问所需客户端依赖：`neo4j>=5.0.0`。

## 为什么这样改（对照验收标准）
- 最小闭环能力：用 `(:Entity)-[HAS_STATE{start_scene_seq,end_scene_seq}]->(:State)` 表达“时序区间”，`get_world_state(scene_seq)` 用区间过滤直接得到该时刻的世界状态；snapshot 以 `(:Snapshot{scene_seq,world_state_json})` 落盘，满足“查询 + 快照”最小闭环。
- 快速失败/无回退：`MemgraphWorldStateStorage.__init__` 直接验证连接；`get_world_state` 检测同一 entity 多条覆盖同一 scene_seq 的状态时直接报错，避免“继续跑”的兜底行为。
- KISS/YAGNI：本轮不改动现有 Kùzu `GraphStorage` 默认行为，也不引入“自动切库/自动回退”的开关；只实现测试所需的最小读写与查询。
- 可复现验证：提供 `docker-compose` + README 命令，保证本地一键拉起 Memgraph 后可复跑集成测试。

## 如何自测
我在当前环境实际运行：
- `cd project/backend && .venv/bin/python -m pytest -q`
  - 结果：`95 passed, 1 skipped`（跳过项为 Memgraph 未启动导致的集成测试 skip）
- `cd project/backend && .venv/bin/python -m pytest -q -rs -k memgraph`
  - 结果摘要：集成测试被 skip，原因是 `localhost:7687` 连接拒绝（本环境无法启动 docker）

你在本地（可用 docker 的环境）验证 Memgraph 集成闭环：
```bash
docker compose -f project/backend/docker-compose.memgraph.yml up -d
cd project/backend
REQUIRE_MEMGRAPH=1 python -m pytest -q -k memgraph
docker compose -f project/backend/docker-compose.memgraph.yml down
```

## 风险与遗留
- 本执行环境无法运行 docker（`docker version` 报 snap-confine/capability 权限问题），因此未能实测 Memgraph 容器下的“绿”。建议按 README 在本地 docker 环境执行 `REQUIRE_MEMGRAPH=1 ... -k memgraph` 做最终验收。
- `clear_all()` 会清空 Memgraph 全库（用于测试夹具）；请使用专用测试容器/空库运行集成测试，避免误清理共享数据。
- 我注意到仓库当前 git worktree 存在大量与本任务无关的变更/未跟踪内容（不在 `project/backend/**` 范围内）；本次未触碰、也未尝试整理。

## 工具调用简报
- shell_command: `rg -n "world_state" ...` / `rg -n "start_scene_seq|end_scene_seq" ...`（定位现状与缺失点）
- shell_command: `docker version`（失败：snap-confine 权限/capability 不足，导致无法在本环境启动 Memgraph）
- shell_command: `cd project/backend && .venv/bin/python -m pytest -q`（95 passed, 1 skipped）
- shell_command: `cd project/backend && .venv/bin/python -m pytest -q -rs -k memgraph`（skip：Memgraph 未启动导致连接拒绝）