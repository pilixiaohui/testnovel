已阅读开发行为规范  
iteration: 2  
self_test: enabled  

## 任务理解

工单要求实现的功能：
1. 按规格附录 C 重构 `project/frontend/src/api/` 为 13 个模块并统一命名。
2. 在每个模块内导出规范命名的 `*Api` 对象并映射到正确后端端点。
3. 保持向后兼容（旧函数可保留为别名）。

## 实现方案

### 设计思路
以 SRP 拆分 API 模块，每个文件只负责单一业务域；以 KISS 保持请求函数直连端点、payload 明确；通过内部 request 函数复用减少重复（DRY）；仅实现规格所需 API（YAGNI），旧导出函数保留为薄封装以降低回归风险。

### 改动说明

| 文件 | 修改内容 | 实现逻辑 |
|-----|---------|---------|
| `project/frontend/src/api/index.ts:1` | 调整 Axios 实例 timeout 与响应拦截 | 按规格统一 baseURL/timeout，响应仅透传 data，错误提示后直接 reject |
| `project/frontend/src/api/snowflake.ts:1` | 新增 `snowflakeApi` + 兼容旧导出 | 内部 request 复用，端点改为规范路径 |
| `project/frontend/src/api/anchor.ts:1` | 新增 `anchorApi` + 兼容旧导出 | 生成/列表/更新/检查均映射到附录 C 端点 |
| `project/frontend/src/api/agent.ts:1` | 新增 `agentApi` + 兼容旧导出 | 初始化/状态/欲望更新/决策统一 snake_case 载荷 |
| `project/frontend/src/api/dm.ts:1` | 新增 `dmApi` + 兼容旧导出 | 裁决/收敛/干预/补路映射规范端点 |
| `project/frontend/src/api/simulation.ts:1` | 新增 `simulationApi`（含反馈）+ 兼容旧导出 | runRound/runScene/getLogs/render/feedbackLoop 按规格封装 |
| `project/frontend/src/api/scene.ts:1` | 新增 `sceneApi` + 兼容旧导出 | 场景相关端点统一到 `/scenes` 与 `/roots` 路径 |
| `project/frontend/src/api/entity.ts:1` | 新增 `entityApi` + 兼容旧导出 | 实体/关系 API 使用根/分支参数化 |
| `project/frontend/src/api/subplot.ts:1` | 新增 `subplotApi` + 兼容旧导出 | 支线增/列/解决映射规范端点 |
| `project/frontend/src/api/branch.ts:1` | 新增 `branchApi` + 兼容旧导出 | 分支全流程 + 根快照映射规范端点 |
| `project/frontend/src/api/commit.ts:1` | 新增 `commitApi` + 兼容旧导出 | 提交与 GC 按规格封装 |
| `project/frontend/src/api/llm.ts:1` | 新增 `llmApi` + 兼容旧导出 | LLM/逻辑/状态 API 规范化 |
| `project/frontend/src/api/feedback.ts:1` | 新增 `feedbackApi` + 兼容旧导出 | 递归反馈统一封装 |
| `project/frontend/src/api/acts.ts:1` | 删除 | 并入 `snowflakeApi.listActs` |
| `project/frontend/src/api/chapters.ts:1` | 删除 | 并入 `snowflakeApi.listChapters` |

### 关键实现逻辑
- 数据流向：组件/Store 仍可调用旧导出函数，内部直接命中新路径或与 `*Api` 复用；新代码使用 `*Api` 规范命名。
- 关键处理步骤：每个模块定义 request 函数 → 组装 `*Api` → 旧导出函数薄封装复用。
- 异常处理策略：Axios 响应拦截仅提示 `detail` 并 `reject`，不做兜底。
- 与其他模块交互：统一由 `apiClient` 提供 baseURL/timeout/拦截器；旧调用方保持兼容。

## 自测结果（仅 enabled 模式）

### 验收结果汇总

| 序号 | 命令 | 返回码 | 结果摘要 |
|-----|------|-------|---------|
| 1 | `ls -la project/frontend/src/api/` | 0 | 共 13 个 .ts 文件 |
| 2 | `grep -c 'export const snowflakeApi' project/frontend/src/api/snowflake.ts` | 0 | 1 |
| 3 | `grep -c 'export const anchorApi' project/frontend/src/api/anchor.ts` | 0 | 1 |
| 4 | `grep -c 'export const agentApi' project/frontend/src/api/agent.ts` | 0 | 1 |
| 5 | `grep -c 'export const dmApi' project/frontend/src/api/dm.ts` | 0 | 1 |
| 6 | `grep -c 'export const simulationApi' project/frontend/src/api/simulation.ts` | 0 | 1 |
| 7 | `grep -c 'export const sceneApi' project/frontend/src/api/scene.ts` | 0 | 1 |
| 8 | `grep -c 'export const entityApi' project/frontend/src/api/entity.ts` | 0 | 1 |
| 9 | `grep -c 'export const subplotApi' project/frontend/src/api/subplot.ts` | 0 | 1 |
| 10 | `grep -c 'export const branchApi' project/frontend/src/api/branch.ts` | 0 | 1 |
| 11 | `grep -c 'export const commitApi' project/frontend/src/api/commit.ts` | 0 | 1 |
| 12 | `grep -c 'export const llmApi' project/frontend/src/api/llm.ts` | 0 | 1 |
| 13 | `grep -c 'export const feedbackApi' project/frontend/src/api/feedback.ts` | 0 | 1 |
| 14 | `cd project/frontend && npm run build` | 1 | `vue-tsc` 报错（Pinia 类型/Store 类型/插件类型冲突等） |

- 全部验收命令已执行: 是  
- 自测结果: FAIL  

### 测试详情
`npm run build` 在 `vue-tsc -b` 阶段失败，主要错误包括 Pinia typings 无法解析、多个 store 属性类型缺失、以及 Vite/Vitest 插件类型冲突。上述问题与本次 API 层改动无直接关联，需单独修复。

## 总结与展望
- 已完成：API 目录按规格收敛为 13 个模块、补齐全部 `*Api` 规范导出、旧函数保持兼容；端点路径统一为附录 C 形式。  
- 原则应用：  
  - KISS：请求函数直连端点、payload 直出，避免额外封装。  
  - DRY：通过内部 request 函数复用，旧导出仅薄封装。  
  - SRP：每个 API 文件只负责单一领域。  
  - YAGNI：不引入额外逻辑，仅实现规范中必需 API。  
- 挑战：`npm run build` 失败（Pinia 类型解析与 store 类型定义问题）。  
- 下一步建议：  
  1) 修复 Pinia 类型解析（可能需要调整 tsconfig 或依赖版本）。  
  2) 补齐 store 类型定义与 state 字段声明，消除 TS2339/TS7006。  
  3) 将业务代码逐步迁移到 `*Api` 新命名，清理旧导出。

结论：FAIL  
阻塞：构建失败（`vue-tsc` 类型错误：Pinia typings 与 store 类型问题）

【MCP调用简报】
服务: serena  
触发: 读取规格与现有 API 文件、重写 API 模块并删除冗余文件  
参数: read_file / list_dir / create_text_file / search_for_pattern  
结果: 完成 12 个 API 模块重写，删除 2 个旧文件  
状态: 成功