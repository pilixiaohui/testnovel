已阅读测试行为规范
iteration: 15

## 测试需求分析

工单要求测试的功能点：
1. state-extract mock 契约改为 `StateProposal[]`
2. chapter-render mock 补齐 acts/chapters + `rendered_content`
3. Snowflake Step6 跳转断言改为 `/editor` + query
4. ChapterReview 增补 acts/chapters mock
5. version-control snapshot 路由收敛，避免覆盖 history
6. E2E 基础设施统一（移除自启 dev server，改 Playwright webServer）

## 测试设计

### 设计思路
- KISS/YAGNI：只修复契约与路由问题，避免额外扩展。
- DRY：在章节渲染用例中抽出 `mockChapterListApis`，减少重复 mock。
- 对齐实现：以 EditorView/SnowflakeView 当前行为为准调整断言与 mock。

### 创建的测试文件
- 无（本次为修复既有测试文件）

### 修改的测试文件
- `project/frontend/tests/e2e/state-extract.spec.ts:1` - stateExtract mock 改为 `StateProposal[]`，commit 路由匹配 query
- `project/frontend/tests/e2e/chapter-render.spec.ts:1` - 补 acts/chapters mock，render 返回 `rendered_content`
- `project/frontend/tests/e2e/core.e2e.spec.ts:140` - Step6 跳转断言，ChapterReview 补 acts/chapters mock
- `project/frontend/tests/e2e/version-control.spec.ts:1` - snapshot 路由收敛，避免覆盖 history
- `project/frontend/tests/e2e/snowflake.spec.ts:1` / `project/frontend/tests/e2e/simulation.spec.ts:1` - 移除自启 dev server 逻辑
- `project/frontend/playwright.config.ts:1` - 配置 webServer + 5185 端口 + 600s 超时

### 测试用例清单

| 用例名称 | 测试场景 | 对应功能点 | 测试逻辑说明 |
|---------|---------|-----------|-------------|
| StateExtract 提取预览并提交更新世界 | 正常流程 | stateExtract/stateCommit 契约 | mock `StateProposal[]`，断言预览与提交后刷新 |
| StateExtract 失败后可重试 | 异常重试 | stateExtract/stateCommit | 首次 500，重试成功 |
| ChapterRender 渲染结果与质量评分 | 正常流程 | 章节 render | mock acts/chapters + `rendered_content` |
| ChapterRender 失败后可重试 | 异常重试 | 章节 render | 首次 500，重试成功 |
| Snowflake Step6 完成后跳转 Editor | 正常流程 | Step6 跳转 | 断言跳转 `/editor` 且携带 query |
| ChapterReview 审核更新状态 | 正常流程 | 章节审核 | mock acts/chapters + review |
| VersionControl 分支列表与切换 | 正常流程 | 分支列表/切换 | 分支列表 + switch |
| VersionControl 提交历史与快照操作 | 正常流程 | 提交历史/快照 | history + snapshot + reset |

### 关键测试逻辑
- stateExtract 返回 `StateProposal[]`（含 `entity_id/semantic_states_patch`），避免依赖旧字段。
- chapter-render 增加 `GET /roots/{id}/acts` 与 `GET /acts/{id}/chapters` mock，保证章节列表渲染。
- Step6 断言改为页面跳转与 query 校验，符合 SnowflakeView 现实现。
- snapshot 路由用 `**/api/v1/roots/*` 收敛，避免拦截 history。

## 测试执行

- 命令: `npm run test:e2e`
- 结果: 通过（15 passed）
- 红灯确认: 否（本轮目标为对齐实现并转绿）

### 执行详情
- `npx playwright test` 全部通过：15 passed，0 failed。
- WebServer 正常启动，端口 5185。

## 总结与展望
- 已完成：修复 E2E mock 契约与路由匹配问题，统一 Playwright webServer 启动方式。
- 原则应用：KISS/YAGNI 仅修补必要断点；DRY 抽出章节列表 mock；SOLID 保持用例职责清晰。
- 遇到挑战：后端字段差异（`rendered_content`/`StateProposal[]`）导致原测试失配；通过对齐契约解决。
- 下一步建议：保持 DEV 实现与后端契约一致后，继续回归验证所有 E2E 场景。

## 验收标准

- 命令: `cd /home/zxh/ainovel_v3/project/frontend && npm run test:e2e`
- 阈值: 15 passed, 0 failed

结论：PASS
阻塞：无

【MCP调用简报】
服务: serena  
触发: 修复测试/配置文件以对齐实现与契约  
参数: read_file/search_for_pattern/replace_regex  
结果: 更新 6 个 E2E spec + playwright.config.ts  
状态: 成功