# Current Task (Iteration 13)
assigned_agent: DEV
self_test: enabled

## 任务目标
修复 REVIEW Iteration 12 指出的实现问题，确保前后端契约一致、移除测试驱动痕迹

## 修复清单

### 1. M2-T1: state_extract/state_commit 契约修复
- 问题：前端按 `ExtractPreview{entity_changes,relation_changes}` 解析，后端返回 `List[StateProposal]`
- 修复：`StateExtractPanel.vue:90` 按 `StateProposal[]` 展示预览
- 问题：前端 state_commit 以 body 发送对象，后端要求 query `root_id/branch_id` + body `List[StateProposal]`
- 修复：`llm.ts:10` 改为 query 传 root_id/branch_id + body 传 proposals 列表
- 同步更新：`state-extract.spec.ts` mock 数据形状

### 2. M2-T2: renderChapter 契约修复
- 问题：后端返回 `rendered_content`，前端读取 `content/quality_scores`
- 修复：`EditorView.vue:348` 使用 `rendered_content` 字段
- 问题：`ensureChapters` 无条件塞入假章节
- 修复：移除占位章节逻辑，改为从后端 listChapters 加载
- 同步更新：`chapter-render.spec.ts` mock 数据形状

### 3. M2-T3: Step6 跳转稳健性修复
- 问题：固定 sleep 150ms（`SnowflakeView.vue:161`）
- 修复：移除固定 sleep，改为基于真实状态（API 完成/路由守卫）驱动跳转

### 4. M2-T4: 版本控制 DEV 兜底移除
- 问题：`EditorView.vue:439` DEV 环境下伪造 commit 列表
- 修复：删除 DEV 伪造逻辑，让空数据/错误显式暴露
- 同步更新：`version-control.spec.ts` 完整 mock 所需接口数据

### 5. M2-T5: 章节审核链路修复
- 问题：审核依赖占位章节
- 修复：与 M2-T2 一并修复，确保章节来源为真实数据

## 验收标准
1. `cd /home/zxh/ainovel_v3/project/frontend && npm run test:e2e` → 15 passed
2. 无 DEV 环境伪造数据逻辑
3. 无固定 sleep 等待策略
4. 前后端契约一致（state_extract/state_commit/renderChapter）

## 关键文件
- `project/frontend/src/components/StateExtractPanel.vue`
- `project/frontend/src/api/llm.ts`
- `project/frontend/src/api/chapter.ts`
- `project/frontend/src/views/EditorView.vue`
- `project/frontend/src/views/SnowflakeView.vue`
- `project/frontend/tests/e2e/state-extract.spec.ts`
- `project/frontend/tests/e2e/chapter-render.spec.ts`
- `project/frontend/tests/e2e/version-control.spec.ts`

## 执行环境
- 工作目录: /home/zxh/ainovel_v3
- 代码目录: /home/zxh/ainovel_v3/project/backend
- 前端目录: /home/zxh/ainovel_v3/project/frontend
- Python: /home/zxh/ainovel_v3/project/backend/.venv/bin/python
- 环境变量:
  - MEMGRAPH_HOST=localhost
  - MEMGRAPH_PORT=7687
- 测试执行配置:
  - 前端开发端口: 5185
  - 服务启动等待: 6秒
  - unit测试超时: 120秒
  - integration测试超时: 300秒
  - e2e测试超时: 600秒

