# Current Task (Iteration 5)
assigned_agent: DEV

## 目标
- 让 Iteration 4 TEST 新增的红测转绿：当 `/api/v1/logic/check` 请求提供 locator（root_id/branch_id/scene_id）时，必须从图存储构建并覆盖 payload 的 `world_state`，而不是信任请求体 `world_state`。

## 输入证据
- 红测文件：`project/backend/tests/test_logic_check_world_state.py`
- 失败用例：`test_logic_check_with_locator_builds_world_state_from_storage`
- 现状定位：`project/backend/app/main.py:973`（TEST 报告）处 `logic_check_endpoint` 当前直接透传请求体 world_state

## 实现要求（最小可行 + 快速失败）
1) 更新存储抽象（DIP）
- 在 `project/backend/app/storage/ports.py` 的 `GraphStoragePort` 增加方法：
  - `build_logic_check_world_state(root_id, branch_id, scene_id) -> dict`

2) 更新具体存储实现（GraphStorage）
- 在 `project/backend/app/storage/*` 中实现 `GraphStorage.build_logic_check_world_state(...)`（放在合适的职责模块里，例如 entities/scenes 侧），确保 GraphStorage 满足 Port。
- 禁止兜底：当 locator 存在但无法从图谱构建 world_state 时，必须显式失败（抛出异常/返回错误），不得回退使用请求体 world_state。

3) 修改 API 端点逻辑（logic_check）
- 在 `project/backend/app/main.py` 的 `logic_check_endpoint`：
  - 当 `root_id/branch_id/scene_id` 三者齐全时：调用 `storage.build_logic_check_world_state(...)`，并在调用 `gateway.logic_check(...)` 前用其返回值覆盖 payload 的 `world_state`。
  - 当 locator 不齐全时：保持现有行为（不引入破坏性变更）。

## 验收标准
- 在 `project/backend` 运行：`./.venv/bin/python -m pytest -q tests/test_logic_check_world_state.py` 全绿
- 在 `project/backend` 运行：`python -m pytest -q` 全绿（不得回归破坏）
- 未引入任何吞异常/默认值续跑等防御性编程；locator 存在时不得回退信任请求体 world_state

## TDD 要求
- 测试已为红（Iteration 4 TEST）；本轮按红-绿-重构推进：先让最小改动转绿，再做必要的小重构（保持 KISS）。
