# Current Task (Iteration 2)
assigned_agent: DEV

## 背景（已取证）
- 后端基线测试已通过：在 `project/backend` 执行 `python -m pytest -q` => 93 passed
- `GraphStorage` 为单文件大类（`project/backend/app/storage/graph.py`），职责混杂；后续要迁移 Memgraph/时序/快照会被放大成本

## 本轮目标（只做第一步，避免大爆炸）
- 完成 M2-T1：存储层解耦（DIP）+ `GraphStorage` 拆分（SRP），保持行为不变、测试全绿。

## 范围
- 仅改动后端：`project/backend/app/**`
- 聚焦 `storage` 与其调用方（API 依赖注入/业务编排层）

## 非目标（本轮不要做）
- 不引入/落地 Memgraph
- 不改变任何对外 API 行为与数据契约（除非为修复测试或明确 bug）
- 不添加兜底/容错逻辑（禁止吞异常/默认值续跑）

## 任务步骤（建议执行顺序）
1) 建立重构安全网（TDD 的“先红后绿”前提）
- 先跑现有测试确认基线：`python -m pytest -q`
- 若你将改动的关键路径缺少覆盖：先补最小“表征测试/契约测试”（characterization tests），确保重构前能锁定行为。

2) 引入存储抽象（DIP）
- 新增一个最小存储接口（Protocol/ABC 均可），只暴露“调用方实际需要的方法集合”（避免胖接口）
- 调整调用方依赖为接口类型，而不是直接依赖具体 Kùzu 实现

3) 拆分 `GraphStorage`（SRP）
- 将 `graph.py` 中不同职责的实现移动到更小的模块/类（例如：结构/提交链路/场景/语义状态/运维迁移等，具体命名你定）
- 保持对外入口（类名/方法名/语义）稳定；`graph.py` 收敛为 facade/delegator

4) 回归验证
- 必须全量通过：在 `project/backend` 执行 `python -m pytest -q`

## 验收标准
- 通过测试：`project/backend` 下 `python -m pytest -q` 全绿
- 已引入“最小存储接口”（DIP），业务/API 层不再强依赖具体 Kùzu 类
- `GraphStorage` 已按职责拆分为多个小模块，`storage/graph.py` 明显收敛为 facade（而非继续堆叠实现）
- 过程中不引入任何“兜底/吞异常/默认值继续跑”的防御性编程；失败应快速暴露
- 新增/变更代码均为 UTF-8（无 BOM）

## TDD 要求
- 如需新增测试：先写/补齐测试（红）→ 实现/重构（绿）→ 清理与重构（refactor）。
- 若你认为现有测试已足够覆盖本轮拆分：请在报告中明确说明“为何不需要新增测试”，并给出你依赖的现有测试文件/用例证据。
