# Current Task (Iteration 18)
assigned_agent: IMPLEMENTER
self_test: enabled

## 任务目标
SYNTHESIZER Iteration 17 返回 BLOCKED。这是第18轮迭代，以下问题已反复出现多轮未根治，本轮必须彻底解决。

## 反复出现的顽固问题（必须根治）

### 1. /api/v1/roots 对特殊输入仍返回 500（已出现6轮以上）
- 之前多轮都声称修复了此问题，但验证器每次都报告 500
- 要求：用 curl 实际测试以下输入并确认不返回 500：
  a) XSS: `<script>alert(1)</script>`
  b) SQL: `'; DROP TABLE roots; --`
  c) Unicode: `\u0000\uffff`
  d) 空字符串: `""`
- 如果后端启动时 Memgraph 不可用，GET /api/v1/roots 应返回 503 而非 500
- 如果 POST /api/v1/roots 输入校验失败，应返回 422 而非 500
- 必须用实际 curl 命令验证修复效果

### 2. /api/v1/snowflake/step5b 返回 400（已出现3轮以上）
- 之前修复了 step2/step4 的问题，但 step5b 仍然失败
- 要求：调研 step5b 端点的完整请求体模型，确认所有必填字段
- 检查前端调用 step5b 时发送的 payload 是否包含所有必填字段
- 用 curl 测试 step5b 端点确认修复

### 3. /api/v1/simulation/scene 返回 422 "world_state is required"（已出现2轮以上）
- 之前在 dm.ts 中补齐了 world_state，但 simulation/scene 端点仍报 422
- 要求：调研 simulation/scene 端点的请求模型，确认 world_state 字段的期望格式
- 检查前端 SimulationView 调用时是否正确传递 world_state
- 用 curl 测试确认修复

### 4. 保存后数据未持久化
- 现象：保存操作返回成功但刷新后数据丢失
- 要求：调研保存端点的实际存储逻辑，确认数据是否真正写入 Memgraph
- 如果 Memgraph 不可用，保存应返回 503 而非假装成功

## 工作方法（强制）
本轮必须采用以下方法，不允许跳过：
1. 对每个问题端点，先用 curl 发送实际请求确认当前行为
2. 阅读端点的完整代码路径（路由→处理函数→Pydantic模型→存储层）
3. 找到 500/400/422 的确切代码位置
4. 修复后再用 curl 验证修复效果
5. 在报告中附上 curl 命令和响应

## 验收标准
- /api/v1/roots GET/POST 对任何输入不返回 500（返回 422/503）
- /api/v1/snowflake/step5b 不返回 400（前端发送正确 payload）
- /api/v1/simulation/scene 不返回 422（world_state 正确传递）
- 保存操作在 Memgraph 不可用时返回 503
- 后端单元测试全部通过
- 前端单元测试全部通过
- 前端 build 成功
- curl 自测结果附在报告中

## 约束条件
- 必须用 curl 实际验证，不能只靠单元测试
- 不要削弱校验逻辑
- 快速失败原则

## 执行环境
- 工作目录: /home/zxh/ainovel_v3
- 代码目录: /home/zxh/ainovel_v3/project/backend
- 前端目录: /home/zxh/ainovel_v3/project/frontend
- Python: /home/zxh/ainovel_v3/project/backend/.venv/bin/python
- 环境变量:
  - MEMGRAPH_HOST=localhost
  - MEMGRAPH_PORT=7687
- 测试执行配置:
  - 前端开发端口: 5185
  - 服务启动等待: 6秒
  - unit测试超时: 120秒
  - integration测试超时: 300秒
  - e2e测试超时: 600秒

