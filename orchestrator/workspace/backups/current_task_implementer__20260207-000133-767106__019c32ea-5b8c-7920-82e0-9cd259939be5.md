# Current Task (Iteration 5)
assigned_agent: IMPLEMENTER
self_test: enabled

## 任务目标
修复 SYNTHESIZER 第2次 REWORK 发现的问题：step5a 500 错误、验证完整性、空断言清理

## 问题清单（来自 SYNTHESIZER Iteration 4 报告）

### P0 - step5a 500 错误（阻断主链路）
1. [TEST_RUNNER] `POST /api/v1/snowflake/step5a` 返回 500，阻断 Snowflake Step5 及后续流程
2. 根因分析：可能与 Iteration 3 修复的 fenced JSON / ValueError 映射类似，step5a 的结构化输出解析或上游异常未被正确处理
3. 需确保 step5a 和 step5b 都有与 step2/3/4 一致的错误映射（ValueError→422, HTTPError→上游状态码）

### P1 - 验证完整性
4. [基础设施] Playwright transport closed 导致验证场景 6/7/8 未执行
5. 确保后端服务稳定运行，不会在长时间操作中断开连接
6. 自测时需完整走通所有场景，提供 executed/total 一致性证据

### P2 - 空断言清理（降低反作弊风险）
7. [ANTI_CHEAT] 397 处可疑空断言（expect() 无有效业务断言）
8. 对高频空断言文件做分级清理：优先清理核心业务测试中的空断言，补充有效断言
9. 注意：不需要清理全部 397 处，聚焦于核心路径测试文件中的空断言

### P3 - 需求证据补齐
10. [REQUIREMENT] 需提供完整的需求验收证据：
    - Snowflake Step1~Step6 全流程完成的网络请求日志
    - Simulation 推演完成记录
    - Chapter Render 成功记录（10章内容）
    - TopOne 超时配置 ≥10 分钟的代码证据

## 需求边界
- 输入：当前代码库 + 已有的赛博朋克小说数据
- 输出：step5a 修复 + 空断言清理 + 完整验证证据
- 行为：
  1. 定位并修复 step5a 500 根因（参考 Iteration 3 对 step2/3/4 的修复模式）
  2. 清理核心测试文件中的空断言（补充有效业务断言）
  3. 通过浏览器完整重新验证全流程
  4. 提供详细的验证证据（网络请求日志、章节内容统计等）

## 验收标准（抽象描述）
- step5a API 正常响应（非 500）
- Snowflake Step1~Step6 全链路通过浏览器验证
- 核心测试文件中的空断言已清理（数量显著减少）
- 单元测试和覆盖率仍然达标
- 提供完整的需求验收证据包

## 约束条件
- step5a 修复应与 Iteration 3 的 step2/3/4 修复保持一致模式（ValueError→422, HTTPError→上游状态码）
- 空断言清理聚焦核心路径，不要大规模重写所有测试
- Playwright 自测需确保所有场景执行完成，不能有遗漏
- 如果 Playwright transport closed 是因为后端超时，需调整相关超时配置

## 执行环境
- 工作目录: /home/zxh/ainovel_v3
- 代码目录: /home/zxh/ainovel_v3/project/backend
- 前端目录: /home/zxh/ainovel_v3/project/frontend
- Python: /home/zxh/ainovel_v3/project/backend/.venv/bin/python
- 环境变量:
  - MEMGRAPH_HOST=localhost
  - MEMGRAPH_PORT=7687
- 测试执行配置:
  - 前端开发端口: 5185
  - 服务启动等待: 6秒
  - unit测试超时: 120秒
  - integration测试超时: 300秒
  - e2e测试超时: 600秒

