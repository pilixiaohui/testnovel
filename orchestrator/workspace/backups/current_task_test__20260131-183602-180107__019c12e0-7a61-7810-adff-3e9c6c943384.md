# Current Task (Iteration 15)
assigned_agent: TEST
work_mode: design

## 任务目标
修复E2E测试代码，使其与DEV Iteration 13修复后的实现及后端契约对齐。

## 需修复的测试点（来自REVIEW调查）

### 1. state-extract.spec.ts mock契约修复
- 文件: `project/frontend/tests/e2e/state-extract.spec.ts:64`
- 问题: mock返回`{entity_changes, relation_changes}`对象，但实现要求`StateProposal[]`
- 修复: 改为`StateProposal[]`格式（对齐`project/backend/app/main.py:1637`）
- 断言: 更新断言内容，不应依赖`entity_changes`

### 2. chapter-render.spec.ts mock补全+字段修复
- 文件: `project/frontend/tests/e2e/chapter-render.spec.ts:74`
- 问题: 只mock render接口，未mock acts/chapters；render字段用`content`而非`rendered_content`
- 修复:
  - 补齐`GET /roots/{root}/acts`和`GET /acts/{act}/chapters`的mock
  - render mock字段改为`rendered_content`（对齐`project/backend/app/main.py:653`）

### 3. core.e2e.spec.ts Step6断言修复
- 文件: `project/frontend/tests/e2e/core.e2e.spec.ts:232`
- 问题: 断言`Anchors: 1`仍在Snowflake页可见，但实现Step6会跳转Editor
- 修复: 改为断言跳转到`/editor`（含query root_id/branch_id），或移除该段由snowflake.spec.ts负责

### 4. core.e2e.spec.ts ChapterReview mock补全
- 文件: `project/frontend/tests/e2e/core.e2e.spec.ts:337`
- 问题: 仅mock review接口，未mock acts/chapters，导致无chapter item可审
- 修复: 补齐acts/chapters mock

### 5. version-control.spec.ts mock路由修复
- 文件: `project/frontend/tests/e2e/version-control.spec.ts:97`
- 问题: 过宽路由`**/api/v1/roots/**`覆盖了history mock
- 修复: 收紧snapshot路由或在handler内对`/branches/`请求`route.fallback()`

### 6. E2E基础设施统一
- 问题: 多个spec硬编码端口5177/超时15000ms
- 修复: 移除各spec自启dev server，改为Playwright配置级webServer，使用执行环境端口5185、e2e超时600s

## 验收标准
1. `cd /home/zxh/ainovel_v3/project/frontend && npm run test:e2e` → 15 passed, 0 failed

## 参考文件
- 后端契约: `project/backend/app/main.py:1637`(state_extract), `:1756`(state_commit), `:601/:653`(renderChapter)
- 前端实现: `project/frontend/src/components/StateExtractPanel.vue:91`, `project/frontend/src/views/EditorView.vue:349/:361/:366`
- 测试文件: `project/frontend/tests/e2e/*.spec.ts`

## 执行环境
- 工作目录: /home/zxh/ainovel_v3
- 代码目录: /home/zxh/ainovel_v3/project/backend
- 前端目录: /home/zxh/ainovel_v3/project/frontend
- Python: /home/zxh/ainovel_v3/project/backend/.venv/bin/python
- 环境变量:
  - MEMGRAPH_HOST=localhost
  - MEMGRAPH_PORT=7687
- 测试执行配置:
  - 前端开发端口: 5185
  - 服务启动等待: 6秒
  - unit测试超时: 120秒
  - integration测试超时: 300秒
  - e2e测试超时: 600秒

