# Current Task (Iteration 14)
assigned_agent: IMPLEMENTER
self_test: enabled

## 任务目标
SYNTHESIZER Iteration 13 返回 REWORK，核心问题是前后端数据契约不匹配导致的各种 400/422/500 错误。这是第14轮迭代，同类问题已反复出现多轮，本轮必须从根本上解决。

## 根因分析
之前多轮修复都是表面补丁，没有系统性地对齐前后端数据契约。每次修一个点，验证器又发现其他点不匹配。本轮要求：
1. 先完整调研后端每个相关端点的 Pydantic 模型定义（必填字段、类型、校验规则）
2. 再检查前端调用这些端点时发送的实际 payload
3. 找出所有不匹配的地方，一次性全部修复

## 必须修复的具体错误

### 1. 保存接口 400 "logline is required"
- 根因：前端保存时 payload 中缺少 logline 字段，或字段名不匹配
- 要求：调研后端保存端点的 Pydantic 模型，确认所有必填字段，确保前端发送完整数据

### 2. Step2 返回 422
- 根因：step2 请求体与后端期望的模型不匹配
- 要求：调研 step2 端点的请求模型，修复前端发送的 payload 格式

### 3. Step5b 返回 400
- 根因：step5b 依赖的前置数据（acts等）不完整
- 要求：确认 step5b 端点需要哪些前置数据，确保前端在调用前已准备好

### 4. Anchors 返回 400
- 根因：anchors 生成需要 acts 数据但前端未提供
- 要求：确认 anchors 端点的依赖关系，确保调用链路完整

### 5. 推演 422 "world_state required"
- 根因：推演端点需要 world_state 字段但前端未传递
- 要求：调研推演端点的请求模型，确保 world_state 字段正确传递

### 6. 多处 API 500（特殊字符输入）
- 涉及端点：/roots、/snowflake/step1、/entities、/simulation/context、/settings/llm
- 根因：这些端点缺少输入校验，异常输入导致未捕获异常
- 要求：在每个端点添加输入校验，确保异常输入返回 400/422 而非 500

## 工作方法（强制）
1. 先用代码搜索工具调研后端 main.py 中所有相关端点的路由定义和 Pydantic 模型
2. 再调研前端 api/ 目录中对应的 API 调用函数和发送的 payload
3. 列出所有不匹配的字段（字段名、类型、必填/可选）
4. 一次性修复所有不匹配
5. 对每个返回 500 的端点添加 try-except 捕获 ValidationError/KeyError/TypeError 返回 400/422

## 验收标准
- 后端单元测试全部通过
- 前端单元测试全部通过
- 前端 build 成功
- 保存接口不再返回 400
- step2 不再返回 422
- step5b 不再返回 400
- anchors 不再返回 400
- 推演不再返回 422
- 特殊字符输入不触发 500

## 约束条件
- 必须先调研再修复，不要猜测
- 不要削弱校验逻辑来通过测试
- 保持 snake_case 字段命名
- 快速失败原则

## 执行环境
- 工作目录: /home/zxh/ainovel_v3
- 代码目录: /home/zxh/ainovel_v3/project/backend
- 前端目录: /home/zxh/ainovel_v3/project/frontend
- Python: /home/zxh/ainovel_v3/project/backend/.venv/bin/python
- 环境变量:
  - MEMGRAPH_HOST=localhost
  - MEMGRAPH_PORT=7687
- 测试执行配置:
  - 前端开发端口: 5185
  - 服务启动等待: 6秒
  - unit测试超时: 120秒
  - integration测试超时: 300秒
  - e2e测试超时: 600秒

