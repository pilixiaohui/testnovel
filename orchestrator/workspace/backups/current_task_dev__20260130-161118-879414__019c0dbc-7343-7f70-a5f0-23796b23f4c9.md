# Current Task (Iteration 7)
assigned_agent: DEV
self_test: enabled

## 任务目标
实现章节审核API端点（M3-T1）

## 实现要求

### 接口定义
- 路径：`POST /api/v1/chapters/{chapter_id}/review`
- 请求体：`{"status": "approved" | "rejected"}`
- 成功响应：`{"id": chapter_id, "review_status": "<approved|rejected>"}`
- 错误响应：
  - 章节不存在：404 `{"detail": "chapter not found"}`
  - 无效status：**400**（注意：需手动校验，不能用Pydantic Literal导致422）

### 实现步骤（参考Iteration 5 REVIEW建议）

1. **新增请求模型**（`project/backend/app/models.py`）：
```python
class ChapterReviewPayload(BaseModel):
    status: str  # 手动校验，避免Pydantic 422
```

2. **新增端点**（`project/backend/app/main.py`，在chapter相关路由附近）：
```python
@app.post("/api/v1/chapters/{chapter_id}/review")
async def review_chapter(chapter_id: str, payload: ChapterReviewPayload):
    # 1. 获取章节
    chapter = storage.get_chapter(chapter_id)
    if chapter is None:
        raise HTTPException(status_code=404, detail="chapter not found")
    
    # 2. 校验status（手动校验返回400）
    if payload.status not in {"approved", "rejected"}:
        raise HTTPException(status_code=400, detail="invalid status")
    
    # 3. 更新review_status
    chapter.review_status = ReviewStatus(payload.status)
    storage.update_chapter(chapter)
    
    # 4. 返回确认
    return {"id": chapter_id, "review_status": payload.status}
```

### 关键注意事项
- **400 vs 422**：必须用手动校验`payload.status not in {...}`返回400，不能用`Literal["approved","rejected"]`（会变成422）
- **ReviewStatus枚举**：`from app.models import ReviewStatus`，赋值时用`ReviewStatus(payload.status)`
- **存储层**：`storage.update_chapter(chapter)`已支持review_status持久化（Iteration 5 REVIEW已确认）

## 验收标准
1. `cd project/backend && python -m pytest tests/integration/test_chapter_review_api.py -v` → 5 passed
2. 无新增lint错误

## 执行环境
- 工作目录：/home/zxh/ainovel_v3
- Python：/home/zxh/ainovel_v3/project/backend/.venv/bin/python
- Memgraph：localhost:7687
