# Dev Plan (Snapshot)

> 本文件由 MAIN 维护（可覆盖编辑）。它是「当前计划与进度」的快照；事实证据以 `orchestrator/reports/report_review.md` 与 `orchestrator/memory/project_history.md` 为准。

## 约束（强制）
- 任务总数必须保持在「几十条」以内（少而硬）
- 每个任务块必须包含：`status / acceptance / evidence`
- status 只允许：TODO / DOING / BLOCKED / DONE / VERIFIED
- 可选字段：`verification_status: <PENDING_DEV_VALIDATION|DEV_VALIDATED|TEST_PASSED|VERIFIED|REVIEW_REJECTED>` 用于验证闭环跟踪
- 只有 REVIEW 的证据才能把 DONE -> VERIFIED（evidence 必须引用 Iteration 与验证方式）

---

## Milestone M0: 引导与黑板契约

### M0-T1: 建立 dev_plan 状态机
- status: DONE
- acceptance:
- `orchestrator/memory/dev_plan.md` 存在并遵循固定字段
- 每轮更新在 `orchestrator/memory/project_history.md` 留痕（说明改了什么/为什么）
- evidence: Iteration 2 更新 dev_plan；Iteration 1 记录 task goal 于 project_history

### M0-T2: 审阅代理输出可核实证据
- status: DONE
- acceptance:
- `orchestrator/reports/report_review.md` 包含可复现的命令与关键输出摘要
  - 进度核实：逐条对照 dev_plan 的任务给出 PASS/FAIL 与证据
- evidence: Iteration 1 REVIEW 报告包含需求对照表与可复现命令建议

## Milestone M1: 前端对齐与落地

### M1-T1: 前端栈与配置对齐
- status: TODO
- acceptance:
- `python - <<'PY'
import json
p=json.load(open('project/frontend/package.json'))
assert p['devDependencies'].get('vite','').startswith('5.')
assert p['dependencies'].get('pinia','').startswith('2.')
print('ok')
PY`
- `rg '^VITE_API_BASE_URL=/api/v1$' project/frontend/.env.development`
- `rg '^VITE_API_BASE_URL=/api/v1$' project/frontend/.env.production`
- `rg 'baseURL.*?/api/v1' project/frontend/src/api/index.ts`
- `rg 'return response\\.data' project/frontend/src/api/index.ts`
- evidence:

### M1-T2: 前端 API/类型契约补齐
- status: TODO
- acceptance:
- `python - <<'PY'
import os
base='project/frontend/src/api'
files=['anchor.ts','branch.ts','dm.ts','simulation.ts','agent.ts','scene.ts','acts.ts','chapters.ts']
assert all(os.path.exists(os.path.join(base,f)) for f in files)
print('ok')
PY`
- `python - <<'PY'
import os
base='project/frontend/src/types'
files=['snowflake.ts','simulation.ts','entity.ts','scene.ts','api.ts']
assert all(os.path.exists(os.path.join(base,f)) for f in files)
print('ok')
PY`
- `rg 'interface .*Snowflake' project/frontend/src/types/snowflake.ts`
- evidence:

### M1-T3: 前端核心页面与组件实现
- status: TODO
- acceptance:
- `python - <<'PY'
import pathlib
base=pathlib.Path('project/frontend/src/views')
files=['SnowflakeFlow.vue','SimulationConsole.vue','SceneEditor.vue','WorldManager.vue','Settings.vue']
for f in files:
    p=base/f
    assert p.exists()
    assert sum(1 for _ in p.open()) >= 80
print('ok')
PY`
- `rg '<el-' project/frontend/src/views/SnowflakeFlow.vue`
- `rg '<el-' project/frontend/src/views/SimulationConsole.vue`
- `rg '<el-' project/frontend/src/views/SceneEditor.vue`
- `rg '<el-' project/frontend/src/views/WorldManager.vue`
- evidence:

### M1-T4: Pinia Store + Composables
- status: TODO
- acceptance:
- `python - <<'PY'
import pathlib
base=pathlib.Path('project/frontend/src/stores')
files=['snowflake.ts','simulation.ts','editor.ts','world.ts']
for f in files:
    p=base/f
    assert p.exists()
    assert sum(1 for _ in p.open()) >= 40
print('ok')
PY`
- `rg 'defineStore' project/frontend/src/stores -g '*.ts'`
- evidence:

## Milestone M2: 前端测试与 Playwright

### M2-T1: 测试与覆盖率
- status: TODO
- acceptance:
- `cd project/frontend && npm run test:unit`
- `cd project/frontend && npm run test:integration`
- `cd project/frontend && npm run test:coverage`（Lines/Coverage >= 80%）
- `cd project/frontend && npx playwright test`
- evidence:

## Milestone M3: 后端 LLM SDK 合规

### M3-T1: 移除 google-generativeai 依赖与调用
- status: TODO
- acceptance:
- `rg 'google-generativeai|GenerativeAI' project/backend`（期望返回码=1）
- `python - <<'PY'
import tomllib, pathlib
data=tomllib.loads(pathlib.Path('project/backend/pyproject.toml').read_text())
deps=data['project']['dependencies']
assert not any('google-generativeai' in d for d in deps)
print('ok')
PY`
- `rg 'ToponeGateway' project/backend/app/services/llm_engine.py`
- evidence:
