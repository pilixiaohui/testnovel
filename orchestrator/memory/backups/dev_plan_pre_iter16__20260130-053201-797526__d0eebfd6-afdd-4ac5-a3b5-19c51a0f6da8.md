# Dev Plan (Snapshot)

> 本文件由 MAIN 维护。事实证据以 `orchestrator/reports/report_review.md` 与 `orchestrator/memory/project_history.md` 为准。

## 约束（强制）
- 任务总数保持在几十条以内
- 每个任务块必须包含：`status / acceptance / evidence`
- status 只允许：TODO / DOING / BLOCKED / DONE / VERIFIED
- 只有 REVIEW 的证据才能把 DONE -> VERIFIED

## 用户确认范围
- 选项：with_review（核心链路 + 章节审核功能）
- 核心链路：雪花Step1-6 + 10章生成 + 渲染 + 字数验收
- 章节审核：approved/rejected状态管理

## 验收标准（全局）
- 章节数量：=10
- 字数：2000±10%（1800-2200字/章）
- 结构约束：3-5幕，总章数=10
- 关键锚点：inciting/midpoint/climax/resolution均achieved=true
- 审核状态：10章均为approved
- 快速失败：任一关键步骤错误即终止

---

## Milestone M1: 契约对齐与基础修复 ✅

### M1-T1: SceneNode前后端契约对齐
- status: VERIFIED
- acceptance:
  - `cd project/backend && python -m pytest tests/unit/test_scene_node_contract.py -v` → 全部PASS
  - 后端Step4返回包含title/sequence_index字段
  - 前端类型与后端响应结构一致
- evidence: Iteration 9 REVIEW PASS，验收命令4 passed

### M1-T2: 渲染接口契约修复
- status: VERIFIED
- acceptance:
  - `cd project/backend && python -m pytest tests/unit/test_render_contract.py -v` → 全部PASS
  - 前端EditorView传递完整SceneRenderPayload必填字段
  - 或后端提供minimal render接口with合理默认值
- evidence: Iteration 9 REVIEW PASS，验收命令8 passed

### M1-T3: Chapter模型扩展（rendered_content + review_status）
- status: VERIFIED
- acceptance:
  - `cd project/backend && python -m pytest tests/unit/test_chapter_model.py -v` → 全部PASS
  - Chapter模型包含rendered_content(str)和review_status(enum:pending/approved/rejected)
  - Memgraph存储层支持这两个字段的持久化
- evidence: Iteration 9 REVIEW PASS，验收命令7 passed

---

## Milestone M2: 10章生成链路

### M2-T1: Step5b章节数量约束（总数=10）
- status: DONE
- acceptance:
  - `cd project/backend && python -m pytest tests/unit/test_step5b_chapter_count.py -v` → 全部PASS
  - Step5b生成的章节总数严格等于10
  - 不满足时快速失败返回400
- evidence: Iteration 11 DEV自测PASS，3个测试全部通过

### M2-T2: 章节渲染API（/chapters/{id}/render）
- status: DONE
- acceptance:
  - `cd project/backend && python -m pytest tests/integration/test_chapter_render_api.py -v` → 全部PASS
  - POST /api/v1/chapters/{chapter_id}/render 返回rendered_content
  - 字数在1800-2200范围内
- evidence: Iteration 13 DEV自测PASS，3个测试全部通过

### M2-T3: 章节渲染持久化
- status: DOING
- acceptance:
  - `cd project/backend && python -m pytest tests/integration/test_chapter_persistence.py -v` → 全部PASS
  - rendered_content写入Memgraph
  - 可通过GET /api/v1/chapters/{id}获取
- evidence:

---

## Milestone M3: 章节审核功能

### M3-T1: 章节审核API
- status: TODO
- acceptance:
  - `cd project/backend && python -m pytest tests/integration/test_chapter_review_api.py -v` → 全部PASS
  - POST /api/v1/chapters/{id}/review 接受{status: approved|rejected}
  - review_status持久化到Memgraph
- evidence:

### M3-T2: 前端审核UI集成
- status: TODO
- acceptance:
  - `cd project/frontend && npm run test -- --run tests/fe_chapter_review.spec.ts` → 全部PASS
  - EditorView显示审核按钮
  - 点击后调用审核API并更新状态
- evidence:

---

## Milestone M4: E2E验收

### M4-T1: 10章生成E2E测试
- status: TODO
- acceptance:
  - `cd project/backend && python -m pytest tests/integration/test_ten_chapter_e2e.py -v` → 全部PASS
  - 从Step1输入到10章全部rendered_content生成
  - 每章字数1800-2200
- evidence:

### M4-T2: 审核流程E2E测试
- status: TODO
- acceptance:
  - `cd project/backend && python -m pytest tests/integration/test_review_e2e.py -v` → 全部PASS
  - 10章全部审核为approved
  - 最终状态可查询验证
- evidence:

### M4-T3: 完整流程验收脚本
- status: TODO
- acceptance:
  - `cd project && python scripts/ten_chapter_novel_e2e.py --story "名为何方的时空旅人穿越到赛博朋克世界的日常生活故事"` → 成功完成
  - 输出10章完整小说文本
  - 每章字数统计在1800-2200
  - 所有章节review_status=approved
- evidence:
