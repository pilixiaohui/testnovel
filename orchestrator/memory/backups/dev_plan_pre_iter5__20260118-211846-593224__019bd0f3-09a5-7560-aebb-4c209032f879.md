# Dev Plan (Snapshot)

> 本文件由 MAIN 维护（可覆盖编辑）。它是当前计划与进度的快照；事实证据以 `orchestrator/reports/report_review.md` 与 `orchestrator/memory/project_history.md` 为准。

## 约束（强制）
- 任务总数必须保持在几十条以内（少而硬）
- 每个任务块必须包含：`status / acceptance / evidence`
- status 只允许：TODO / DOING / BLOCKED / DONE / VERIFIED
- 只有 **REVIEW 的证据** 才能把 DONE -> VERIFIED（evidence 必须引用 Iteration 与验证方式）

---

## Milestone M0: 引导与黑板契约

### M0-T1: 建立 dev_plan 状态机
- status: VERIFIED
- acceptance:
- `orchestrator/memory/dev_plan.md` 存在并遵循固定字段
- 每轮在 `orchestrator/memory/project_history.md` 留痕（说明改了什么/为什么）
- evidence:
- Iteration 1 REVIEW: `orchestrator/memory/dev_plan.md` 存在（orchestrator/memory/dev_plan.md:1）；`orchestrator/memory/project_history.md` 含 `## Iteration 1:` 留痕（orchestrator/memory/project_history.md:8）

### M0-T2: 审阅代理输出可核实证据
- status: VERIFIED
- acceptance:
- `orchestrator/reports/report_review.md` 包含可复现的命令与关键输出摘要
- 进度核实：逐条对照 dev_plan 的任务给出 PASS/FAIL 与证据
- evidence:
- Iteration 1 REVIEW: `wc/rg/pytest` 证据齐全；在 `project/backend` 执行 `python -m pytest -q` => 93 passed（见 orchestrator/reports/report_review.md）

---

## Milestone M1: 需求与现状取证（Project 重构）

### M1-T1: 阅读关键文档并提炼重构目标/约束
- status: VERIFIED
- acceptance:
- 逐份阅读并提炼（至少涵盖）：project 相关术语、边界、关键流程/数据流、约束（含快速失败/禁止防御性编程的影响）
- 明确与现有代码中 project 模块的映射点（文件/模块层面）
- evidence:
- Iteration 1 REVIEW: 设计目标/约束与现状映射（doc/长篇小说生成系统设计.md:7,9,11,68 ↔ project/backend/app/main.py:348,955；project/backend/app/storage/graph.py:12）
- Iteration 1 REVIEW: Topone 接口文档与实现对齐（doc/topone接口文档.md:12,19,88 ↔ project/backend/app/services/topone_client.py:106,107；project/backend/app/config.py:29）

### M1-T2: 代码现状取证：定位 project 相关模块、入口与调用链
- status: VERIFIED
- acceptance:
- 给出 project 相关目录/包/模块清单（含入口点与主要依赖关系）
- 给出至少 1 条从入口到 project 核心逻辑的调用链证据（文件+符号/行号或可复现搜索命令）
- 标注主要痛点（重复/耦合/SRP 违背等）并附定位证据
- evidence:
- Iteration 1 REVIEW: 调用链（Snowflake Step4 落库）`project/backend/app/main.py:348` → `project/backend/app/logic/snowflake_manager.py:69,99` → `project/backend/app/storage/graph.py:1124`
- Iteration 1 REVIEW: 调用链（Topone 透传）`project/backend/app/main.py:955` → `project/backend/app/services/topone_client.py:106,107`

### M1-T3: 输出可执行的重构拆解（面向 dev_plan 的任务颗粒）
- status: VERIFIED
- acceptance:
- 产出目标结构草图（目录/模块/职责边界）
- 产出迁移步骤（每步可独立验证，避免大爆炸式改动）
- 定义可验证的验收标准（测试、接口兼容性、关键行为不回归）
- evidence:
- Iteration 1 REVIEW: report_review.md 提供分步路线（先补测→存储抽象→拆分 GraphStorage→world_state 服务→Memgraph 并行实现→迁移），并标注每步验证方式（pytest/契约/集成）

---

## Milestone M2: Project 模块重构（实现）

### M2-T1: 存储层解耦（DIP）+ GraphStorage 拆分（SRP）
- status: VERIFIED
- acceptance:
- 引入最小存储接口（Port/Protocol/ABC），调用方依赖抽象而非 Kùzu 具体实现
- `GraphStorage` 按职责拆分为更小模块/类；`project/backend/app/storage/graph.py` 收敛为 facade/delegator
- 不引入兜底/吞异常等防御性编程；失败快速暴露
- 在 `project/backend` 执行 `python -m pytest -q` 全绿
- evidence:
- Iteration 2 DEV: 引入 `GraphStoragePort` 并完成 GraphStorage 职责拆分（见 orchestrator/reports/report_dev.md）
- Iteration 3 REVIEW: 在 `project/backend` 运行 `python -m pytest -q` => 93 passed, 3 warnings；调用方使用 `GraphStoragePort`（project/backend/app/main.py:288,305；project/backend/app/logic/snowflake_manager.py:35）；`project/backend/app/storage/graph.py` 收敛为 40 行 facade 且拆分出 graph_schema/graph_migrations/graph_branches/graph_entities/graph_scenes/graph_snowflake/graph_utils 等模块；未发现新增吞异常/兜底模式（见 orchestrator/reports/report_review.md）

### M2-T2: 逻辑检察官/状态流改造：从图谱构建 world_state（快速失败）
- status: TODO
- acceptance:
- `logic_check` 在提供 locator（如 root_id/branch_id/scene_id）时，world_state 必须来自图谱而非请求体
- API 层仅做参数校验/编排；构建 world_state 与影响传播在 service 层
- 新增/更新测试先红后绿；并保持全量 pytest 通过
- evidence:

### M2-T3: Memgraph 存储落地（Dual-subgraph + Temporal edge + Snapshot）
- status: TODO
- acceptance:
- 新增 Memgraph 实现同一存储接口（无 fallback），完成最小闭环：写入/读取 entity 状态（时序边）、按 scene_seq 查询 world_state、快照生成与查询
- 提供可复现的本地集成验证方式（例如 docker-compose + 测试命令）
- evidence:

---

## Milestone M3: 测试与验证

### M3-T1: 补齐关键单元/契约/集成测试（覆盖重构风险面）
- status: TODO
- acceptance:
- 覆盖：branch 隔离、时序回溯、logic_check 图谱取状态、Topone 错误语义契约
- 测试可复现运行（至少 pytest；如包含 Memgraph 集成测试则提供命令）
- evidence:

### M3-T2: REVIEW 复核并推进全部任务到 VERIFIED
- status: TODO
- acceptance:
- REVIEW 对照每条任务 acceptance 给出 PASS/FAIL 与证据
- 所有任务最终状态为 VERIFIED
- evidence:
