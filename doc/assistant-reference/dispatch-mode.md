## 任务分发模式（Dispatch Mode）

当你收到标题以 `[分发]` 开头的任务时，你正在执行任务分发模式。

### 触发条件

系统检测到用户回复了一个 needs_input/blocked 任务，自动创建了此分发任务。
你需要分析用户的回复内容，判断意图，并执行相应操作。

### 分发流程

1. **读取任务描述中的"用户回复内容"和"原始任务内容"**
2. **读取 decisions/facts/ 了解已有决策**，避免冲突
3. **意图分类**（见下方四种情况）
4. **执行对应操作**
5. **通过飞书反馈结果**
6. **git commit + push**

### 情况 A：简单回答

用户只是回答了 agent 的问题，没有新需求。

操作：
1. 读取原始任务文件
2. 在末尾追加 `## 用户决策\n\n{用户回复}`
3. 将任务从原始目录移到 `tasks/available/`
4. 通过飞书告知用户："已将您的回复转达给 agent，任务已恢复。"

### 情况 B：新需求

用户的回复包含额外的功能请求或工作要求。

操作：
1. 先按情况 A 处理原始任务（移回 available）
2. 为新需求创建额外的 task 和/或 feature 文件
3. 通过飞书告知用户创建了哪些新任务

### 情况 C：方向变更

用户否定了当前实现方向，要求换方案。

操作：
1. 将原始任务移到 `tasks/available/`，追加用户的新方向
2. 在 `decisions/facts/` 记录决策变更（创建 FACT 文件）
3. 如果需要，创建新 task 替代原始任务
4. 通过飞书告知用户方向已调整

### 情况 D：需要进一步澄清

用户的回复仍然不够明确，无法做出判断。

操作：
1. 创建新的 `decisions/threads/` 对话线程
2. 通过飞书发送追问（带 feishu_message_id）
3. **不要移动原始任务**，保持在原目录

### 创建新任务时的 role 分配规则

| 用户意图 | 分配 role | 示例 |
|---------|----------|------|
| 实现新功能 | implementer | "顺便把注册也做了" |
| 写测试/验证 | implementer | "帮我测一下这个接口" |
| 写文档 | docs | "更新一下 API 文档" |
| 修改已有任务方向 | 保持原 role | "用 JWT 而不是 Session" |
| 系统操作 | assistant | "重置一下状态" |

### 注意事项

- 分发任务完成后，将自身标记为 done（移到 `tasks/done/`）
- 所有文件操作后必须 `git add -A && git commit -m "[assistant] dispatch: {原始任务ID}" && git push`
- 如果无法判断用户意图，优先选择情况 D（追问），不要猜测
