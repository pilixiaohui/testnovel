# AI小说生成系统测试方案

> 适用范围：`project/backend` 与 `project/scripts`（与 `project/README.md` 对齐）

## 1. 目标与范围
- 覆盖：API 合约（Topone Gemini 接口）、雪花流程、协商闭环、HITL、修复/分支、性能/压力
- 覆盖对象：后端服务逻辑、图数据库写入与状态管理、脚本级检查
- 输出：可执行的测试清单与优先级（P0/P1/P2）

## 2. 非目标
- 不覆盖前端 UI/交互细节（当前仓库未包含前端实现）
- 不进行模型微调效果评测或文学质量主观评审
- 不替代线上监控与运维告警体系

## 3. 约束与原则（必须遵循）
- 快速失败：任何前置条件缺失（配置、数据库、API Key）直接失败，不尝试兜底
- 禁止防御性编程：测试断言必须验证显式错误/异常，不允许静默降级或默认值掩盖问题
- JSON 字段采用 `snake_case`（与全局约束一致）

## 4. 环境与依赖
- Python 3.11+
- 依赖安装：`project/backend`（按 pyproject 管理）
- 环境变量：复制 `project/backend/.env.example` 并补齐 GEMINI/TOPONE API Key
- 数据库：Kuzu 本地库文件 `project/backend/data/snowflake.db`（必要时准备专用测试库）
- 测试目录：`project/backend/tests`
- 脚本目录：`project/scripts`

## 5. 测试类型与策略
- 单元测试（`project/backend/tests`）：模型、存储、雪花流程节点、协商结果解析
- API 合约测试：Topone Gemini 接口请求结构/必填项/错误响应处理
- 集成测试：Kuzu 读写、雪花流程全链路、协商闭环与强制执行
- 端到端脚本：`cyberpunk_integration_test.py` 等作为回归入口
- 性能/压力：长篇生成、批量场景生成、图谱一致性扫描
- 回归策略：P0 必跑，P1 定期或合入前，P2 按需

## 6. 用例矩阵（P0/P1/P2）
| 优先级 | 覆盖维度 | 用例/场景 | 关键断言（快速失败/禁止兜底） | 建议落地 |
| --- | --- | --- | --- | --- |
| P0 | API 合约 | 缺少 `key` 或 `Content-Type` | 直接返回错误/抛异常，拒绝发送请求 | `project/backend/tests` |
| P0 | API 合约 | `contents.parts.text` 缺失/空 | 校验失败即退出，不做默认填充 | `project/backend/tests` |
| P0 | 雪花流程 | Logline→三灾→人物小传→场景列表 | 必填字段缺失即失败，结构入库成功 | `project/backend/tests` |
| P0 | 协商闭环 | 标准协商路径（无强制） | 逻辑警告能被捕获并阻断生成 | `project/backend/tests` |
| P0 | 协商闭环 | Force Execute | `logic_exception=true`；后续逻辑检查跳过 | `project/backend/tests` |
| P0 | HITL | 状态提取后未确认 | 未确认的状态不写入 Kuzu | `project/backend/tests` |
| P0 | 修复/分支 | 偏差为 Local | 仅 N+1~N+3 被修复，其他不变 | `project/backend/tests` |
| P0 | 修复/分支 | 偏差为 Cascading | 受影响节点标记为 Dirty | `project/backend/tests` |
| P0 | 性能/压力 | 关键路径响应 | 超过基线阈值直接失败并报告 | `project/scripts/performance_stress_test.py` |
| P1 | API 合约 | 正常 200 响应 | 响应结构满足约定；非预期字段不被吞 | `project/backend/tests` |
| P1 | 图谱一致性 | 实体关系/状态写入 | 边与节点一致，失败立即报错 | `project/backend/tests` |
| P1 | 协商闭环 | 用户意图改变大纲 | 触发影响分析并进入修复流程 | `project/backend/tests` |
| P1 | HITL | 人工确认流程 | 仅确认项写入且可追踪 | `project/backend/tests` |
| P1 | 分支管理 | 创建 Dev 分支 | master/dev 分离；merge/revert 可回溯 | `project/backend/tests` |
| P1 | 性能/压力 | 20 万字生成压力 | 失败即中止并报告瓶颈 | `project/scripts/performance_stress_test.py` |
| P2 | 数据质量 | 示例小说一致性 | 人工抽检无严重逻辑断裂 | 手动 |
| P2 | 脚本回归 | 既有检查脚本 | 通过即视为回归通过 | `project/scripts` |


> 性能/压力脚本说明：
> - `project/scripts/performance_stress_test.py` 默认执行两段测试：P0 短文本、P1 200000 words 压测。
> - 通过 `--p0-threshold-seconds` / `--p1-threshold-seconds` 指定基线阈值，超时即失败。
> - 需要 `SNOWFLAKE_ENGINE=gemini` 且提供有效 `TOPONE_API_KEY`。

## 7. 数据准备
- 最小可复现实例：固定 Logline + 3 个角色小传 + 5 个场景
- Kuzu 测试库：从 `snowflake.db` 复制为独立测试库，避免污染主库
- LLM 输出：优先使用固定响应/Mock 保证确定性；真实接口仅用于合约/集成验证
- HITL 数据：准备一组“正确/错误”的状态提取样例用于确认面板

## 8. 验收与退出标准
- P0 全通过；P1 允许在明确风险登记后通过
- 覆盖：API 合约、雪花流程、协商闭环、HITL、修复/分支、性能/压力
- 测试结果可追溯（日志与失败原因明确）

## 9. 风险与应对
- 外部 API 不稳定：通过 Mock + 合约测试解耦；真实接口失败直接暴露
- LLM 非确定性：固定输入与快照输出；不做容错兜底
- 数据库污染：使用独立测试库；失败即回滚并报告

## 10. 与 README 的对齐（目录/脚本/执行）
- 单元/集成测试目录：`project/backend/tests`
- 脚本测试目录：`project/scripts`
- 现有脚本：
  - `python project/scripts/graph_health_check.py --db project/backend/data/snowflake.db`
  - `python project/scripts/cyberpunk_integration_test.py`
  - `python project/scripts/m5_ontology_check.py`
  - `python project/scripts/m6_negotiation_check.py`
- `python project/scripts/performance_stress_test.py --p0-threshold-seconds <P0秒> --p1-threshold-seconds <P1秒>`
