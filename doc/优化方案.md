# Orchestrator 系统全面优化方案

## 一、执行摘要

### 1.1 项目目标

本方案旨在全面优化 Orchestrator 多代理协作系统，解决当前**工作流设计缺陷**、**用户体验痛点**和**质量保障缺失**三大核心问题。

**核心目标**：
1. **修复 TDD 流程（最高优先级）**：让 TEST 代理真正发挥作用，建立自动化测试保障
2. **文档管理效率提升 80%**：通过集成文档上传功能，减少手动文件操作
3. **进度透明度提升 100%**：实时可视化展示任务完成进度，替代纯日志展示
4. **用户操作便捷性提升 60%**：支持文档引用和一键加入验收配置
5. **信息可读性提升 70%**：优化迭代摘要展示，增强信息层次结构
6. **代码质量保障提升 90%**：从 10% 测试覆盖率提升到 80%

### 1.2 核心问题分析

#### 问题分类

**A类问题（致命）- 工作流设计缺陷**：

| 维度 | 当前状态 | 目标状态 | 影响 |
|------|---------|---------|------|
| TEST 代理调用 | ❌ 几乎不被调用（~0%） | ✅ 80% 任务有测试 | 致命 |
| TDD 流程 | ❌ 完全断裂（先写代码） | ✅ 测试先行（红-绿-重构） | 致命 |
| 自动化测试 | ❌ 无自动化测试 | ✅ 80% 测试覆盖率 | 致命 |
| 代码质量保障 | ❌ 依赖人工审阅 | ✅ 自动化测试 + 人工审阅 | 高 |
| 回归测试 | ❌ 无回归保障 | ✅ 100% 自动化回归 | 高 |

**B类问题（重要）- 用户体验痛点**：

| 维度 | 当前状态 | 目标状态 | 影响 |
|------|---------|---------|------|
| 文档管理 | ❌ 需手动上传到服务器目录 | ✅ Web UI 直接上传管理 | 高 |
| 文档引用 | ❌ 手动输入绝对路径 | ✅ 下拉选择自动插入 | 中 |
| 验收配置 | ❌ 手动编辑 JSON 文件 | ✅ 一键添加到验收配置 | 高 |
| 进度展示 | ❌ 仅显示文本日志 | ✅ 可视化进度条和统计 | 高 |
| 任务状态 | ⚠️ 需手动查看 dev_plan.md | ✅ 实时解析并展示 | 高 |
| 迭代摘要 | ⚠️ 纯文本展示，层次不清 | ✅ 卡片式布局，时间线展示 | 中 |

#### A类问题详细分析：TEST 代理形同虚设

**问题严重性**: ⭐⭐⭐⭐⭐ (5/5 - 致命)

**根本原因**：

1. **MAIN 代理决策规则缺陷**
   - TEST 优先级极低，触发条件模糊
   - "按问题归属"、"明确需要测试"等判断标准不清晰
   - 缺少"DEV 后必须 TEST"、"代码变更必须测试"的强制规则

2. **工作流设计缺陷**
   - 实际流程：MAIN → DEV → REVIEW（TEST 被跳过）
   - DEV 自测不可靠（自己测自己的代码）
   - REVIEW 被迫承担测试职责（不擅长写测试）

3. **职责定义不清**
   - TEST、DEV、REVIEW 都能运行测试
   - MAIN 认为 DEV 或 REVIEW 就够了
   - 缺少独立的测试保障

4. **TDD 流程断裂**
   - 应该：先写测试 → 实现功能 → 测试通过
   - 实际：先写代码 → 手动验证 → 完成

**影响范围**：
- ❌ TDD 流程无法执行（红-绿-重构循环断裂）
- ❌ 代码质量无法通过自动化测试保障
- ❌ DEV 代理自测不可靠（自己测自己的代码）
- ❌ REVIEW 代理缺乏客观测试证据
- ❌ 回归风险高（修改代码后无测试验证）
- ❌ Bug 在生产环境才被发现（应在开发阶段发现）

**功能缺失清单**：

**A类（工作流）**：
- ❌ TEST 代理强制触发机制
- ❌ TDD 循环模式（TEST → DEV → TEST → REVIEW）
- ❌ 测试覆盖率门禁
- ❌ 测试先行的 dev_plan 结构
- ❌ 测试与实现分离的任务管理

**B类（用户体验）**：
- ❌ 文档上传入口
- ❌ 文档列表管理界面
- ❌ 文档引用选择器
- ❌ 进度计算模块
- ❌ 进度可视化组件
- ❌ 里程碑进度展示
- ❌ 总结代理进度分析能力

### 1.3 预期收益

**A类问题解决后的收益（质量保障）**：

| 指标 | 当前 | 目标 | 提升 |
|------|------|------|------|
| TEST 代理调用率 | ~0% | 80% | +80% |
| 测试覆盖率 | ~10% | 80% | +70% |
| 自动化测试 | 0 个 | 200+ 个 | 从无到有 |
| 回归测试自动化 | 0% | 100% | +100% |
| Bug 发现阶段 | 生产环境 | 开发阶段 | 提前发现 |
| 代码质量 | 中 | 高 | 显著提升 |
| 重构信心 | 低（怕破坏） | 高（有测试保障） | 质的飞跃 |

**B类问题解决后的收益（用户体验）**：

| 指标 | 当前 | 目标 | 提升 |
|------|------|------|------|
| 文档管理功能完整性 | 0% | 100% | +100% |
| 进度可视化功能完整性 | 20% | 100% | +80% |
| 文档上传操作时间 | 5分钟 | 30秒 | -90% |
| 进度查看效率 | 需打开文件 | 实时展示 | +100% |
| 信息获取速度 | 滚动日志查找 | 一目了然 | +80% |
| 手动文件操作 | 每次迭代 5 分钟 | 0 分钟 | -100% |
| 配置错误率 | 中（手动编辑） | 低（UI 操作） | -70% |

**综合收益**：
- 开发效率提升：每次迭代节省 5-10 分钟
- 质量保障提升：从"依赖人工"到"自动化 + 人工"
- 用户体验提升：从"命令行操作"到"可视化界面"
- 系统可靠性提升：从"无回归保障"到"全面测试覆盖"

### 1.4 技术栈决策

| 组件 | 当前技术 | 目标技术 | 选择理由 |
|------|---------|---------|---------|
| 前端框架 | Vue 3 | Vue 3 | ✅ 保持一致，无需迁移 |
| 后端框架 | Python HTTP Server | Python HTTP Server | ✅ 轻量级，满足需求 |
| 状态管理 | Vue Refs | Vue Refs | ✅ 简单场景无需 Vuex |
| 文件上传 | - | FormData + Base64 | ✅ 标准 Web API |
| 进度计算 | - | 正则解析 + 统计 | ✅ dev_plan.md 格式固定 |
| 数据可视化 | - | CSS + Vue 动画 | ✅ 无需引入图表库 |
| 工作流引擎 | 硬编码决策规则 | 规则引擎 + 配置化 | ✅ 支持 TDD 循环模式 |
| 测试框架 | - | pytest + coverage | ✅ Python 标准测试工具 |

**版本要求**：
- Python: 3.11+（已满足）
- Vue: 3.x（已满足）
- TypeScript: 5.x（已满足）
- pytest: 7.x+（需安装）
- coverage: 7.x+（需安装）

---

## 二、架构设计要点

### 2.1 整体架构

本方案在现有 Orchestrator 架构基础上扩展，保持黑板模式（Blackboard Pattern）不变。

```
┌─────────────────────────────────────────────────────────────┐
│                    Web UI (Vue 3 Frontend)                   │
├──────────────┬──────────────┬──────────────┬────────────────┤
│  Documents   │   Progress   │   Summary    │   其他标签      │
│  文档管理     │   进度可视化  │   迭代摘要    │   (已有)       │
└──────┬───────┴──────┬───────┴──────┬───────┴────────────────┘
       │              │              │
       │ API Calls    │ API Calls    │ API Calls
       ▼              ▼              ▼
┌─────────────────────────────────────────────────────────────┐
│              HTTP Server (ui/server.py)                      │
├──────────────┬──────────────┬──────────────┬────────────────┤
│ 文档管理 API  │ 进度查询 API  │ 状态管理 API  │   其他 API     │
└──────┬───────┴──────┬───────┴──────┬───────┴────────────────┘
       │              │              │
       ▼              ▼              ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│ file_ops.py  │ │ progress.py  │ │ summary.py   │
│ 文件操作      │ │ 进度计算      │ │ 摘要解析      │
└──────┬───────┘ └──────┬───────┘ └──────┬───────┘
       │                │                │
       ▼                ▼                ▼
┌─────────────────────────────────────────────────────────────┐
│                  Blackboard (memory/)                        │
├──────────────┬──────────────┬──────────────┬────────────────┤
│uploaded_docs/│ dev_plan.md  │finish_review │   其他文件      │
│  (新增)      │              │_config.json  │                │
└──────────────┴──────────────┴──────────────┴────────────────┘
```

**关键组件职责**：
- **Documents Tab**：文档上传、列表、引用、验收配置管理
- **Progress Tab**：实时进度展示、里程碑跟踪、日志查看
- **Summary Tab**：优化的迭代历史展示
- **progress.py**：dev_plan.md 解析和进度计算引擎
- **uploaded_docs/**：用户上传文档的存储目录

### 2.2 数据模型设计要点

#### 核心数据结构

**ProgressInfo** (新增)：
- `total_tasks`: int - 总任务数
- `completed_tasks`: int - 已完成任务数（DONE + VERIFIED）
- `verified_tasks`: int - 已验证任务数
- `in_progress_tasks`: int - 进行中任务数
- `blocked_tasks`: int - 阻塞任务数
- `todo_tasks`: int - 待办任务数
- `completion_percentage`: float - 完成百分比
- `verification_percentage`: float - 验证百分比
- `current_milestone`: str - 当前里程碑 ID
- `milestones`: list[MilestoneProgress] - 各里程碑进度

**MilestoneProgress** (新增)：
- `milestone_id`: str - 里程碑 ID (M0, M1, M2...)
- `milestone_name`: str - 里程碑名称
- `total_tasks`: int - 该里程碑总任务数
- `completed_tasks`: int - 已完成任务数
- `verified_tasks`: int - 已验证任务数
- `percentage`: float - 完成百分比

**UploadedDocument** (新增)：
- `filename`: str - 文件名
- `path`: str - 相对路径
- `category`: str - 分类 (requirements/specs/references)
- `size`: int - 文件大小（字节）
- `upload_time`: str - 上传时间戳

**IterationSummary** (扩展)：
- 新增字段：`progress`: ProgressInfo | None

#### 文件存储结构

```
orchestrator/memory/uploaded_docs/
├── requirements/          # 需求文档
│   ├── user_story_v1.md
│   └── feature_spec.md
├── specs/                # 规格说明
│   └── api_design.md
└── references/           # 参考文档
    └── architecture.md
```

### 2.3 核心机制设计

#### 进度计算机制

**设计原则**：
- 实时解析：每次 API 调用时解析 dev_plan.md
- 无状态计算：不缓存，确保数据一致性
- 容错处理：解析失败返回默认值

**计算流程**：
1. 读取 `orchestrator/memory/dev_plan.md`
2. 使用正则表达式匹配任务：`### M(\d+)-T(\d+): (.+)`
3. 提取每个任务的 `status` 字段
4. 按里程碑分组统计各状态任务数
5. 计算百分比和当前里程碑
6. 返回 ProgressInfo 对象

**状态映射**：
- TODO → todo_tasks
- DOING → in_progress_tasks
- BLOCKED → blocked_tasks
- DONE → completed_tasks
- VERIFIED → verified_tasks + completed_tasks

#### 文档引用机制

**引用格式**：
```
用户输入：查看需求文档 @doc:requirements/user_story_v1.md

转换为：查看需求文档 [参考: orchestrator/memory/uploaded_docs/requirements/user_story_v1.md]
```

**MAIN 代理处理**：
- 识别引用标记并读取文档内容
- 将文档内容注入到上下文中
- 基于文档内容做出决策

#### 验收配置集成

**操作流程**：
1. 用户在 Documents Tab 点击"加入验收"
2. 前端调用 `POST /api/add_to_finish_review`
3. 后端读取 `finish_review_config.json`
4. 将文档路径追加到 `docs` 数组
5. 原子写入更新后的配置
6. FINISH_REVIEW 代理在下次执行时读取新配置

### 2.4 API 端点设计

| 端点 | 方法 | 功能 | 输入 | 输出 |
|------|------|------|------|------|
| `/api/uploaded_docs` | GET | 获取文档列表 | - | `list[UploadedDocument]` |
| `/api/upload_doc` | POST | 上传文档 | `{filename, content, category}` | `{success, path}` |
| `/api/uploaded_docs/<path>` | DELETE | 删除文档 | path | `{success}` |
| `/api/add_to_finish_review` | POST | 加入验收配置 | `{doc_path}` | `{success}` |
| `/api/progress` | GET | 获取进度信息 | - | `ProgressInfo` |

**安全约束**：
- 路径验证：防止目录遍历攻击
- 文件类型限制：仅允许 `.md` 文件
- 大小限制：单文件最大 5MB
- 文件名校验：仅允许字母、数字、下划线、连字符

---

## 三、核心功能实现要点

### 3.1 TDD 工作流修复（最高优先级）

**功能描述**：修复 MAIN 代理决策规则，建立 TEST → DEV → TEST → REVIEW 的 TDD 循环

**实现步骤**：
1. 修改 `orchestrator/memory/prompts/subagent_prompt_main.md` 决策规则
2. 在决策规则中增加强制 TEST 触发条件：
   - 代码变更后必须 TEST
   - 新功能必须先 TEST（写测试）后 DEV（实现）
   - DONE 状态必须先 TEST 验证后 REVIEW 审阅
3. 在 `orchestrator/types.py` 中增加任务类型标记
4. 在 `orchestrator/workflow.py` 中实现 TDD 循环逻辑
5. 修改 `subagent_prompt_dev.md`，禁止 DEV 跳过测试

**关键点**：
- 决策规则优先级：TEST 优先级提升到第 3 位（仅次于 USER 和 FINISH）
- 强制触发条件：明确且可执行，不依赖 MAIN 的主观判断
- 循环模式：TEST（写测试）→ DEV（实现）→ TEST（验证）→ REVIEW（审阅）
- 职责分离：TEST 只写测试，DEV 只写代码，REVIEW 只审阅

**性能优化**：
- 缓存测试结果：避免重复运行相同测试
- 并行测试：支持多个测试文件并行执行
- 增量测试：只运行受影响的测试

**输入输出**：
- 输入：dev_plan 任务状态、上一轮代理类型
- 输出：next_agent 决策（TEST/DEV/REVIEW）

**注意事项**：
- 向后兼容：旧的 dev_plan 仍能正常工作
- 渐进式启用：通过配置开关控制是否启用 TDD 模式
- 测试失败处理：TEST 失败时必须派发 DEV 修复，形成闭环

### 3.2 MAIN 决策规则重构

**功能描述**：重写 MAIN 代理的决策规则，明确 TEST 触发条件

**实现步骤**：
1. 备份当前 `subagent_prompt_main.md`
2. 重写决策规则章节，新规则如下：
   ```
   ## 决策规则（从高到低优先级）

   1. 重大抉择 → USER

   2. 全面完成 → FINISH

   3. 【新增】代码变更后必须测试：
      - 若上一轮是 DEV 且报告显示代码变更 → 强制 TEST
      - 工单：运行相关测试，验证变更未破坏现有功能

   4. 【新增】新功能必须先写测试：
      - 若 dev_plan 中有 TODO 任务且 test_required=true → 先 TEST 后 DEV
      - TEST 工单：编写测试用例（预期失败）
      - DEV 工单：实现功能使测试通过

   5. 报告失败/阻塞 → 按问题归属派发
      - 测试失败 → DEV（修复代码）
      - 测试缺失 → TEST（补充测试）
      - 证据不足 → REVIEW（取证）

   6. DONE 未 VERIFIED → 先 TEST 后 REVIEW
      - TEST 工单：运行测试并报告结果
      - REVIEW 工单：基于测试结果审阅代码

   7. TODO/DOING/BLOCKED → 按类型派发
      - 新功能 → TEST（先写测试）
      - Bug 修复 → TEST（先写复现测试）
      - 重构 → REVIEW（先评估影响）

   8. 信息不足 → REVIEW
   ```
3. 在 history_append 中记录决策依据
4. 添加决策日志，便于调试和优化

**关键点**：
- 规则明确性：每条规则都有清晰的触发条件和输出
- 可验证性：决策过程可追溯，便于调试
- 强制性：关键规则（如代码变更后测试）不可跳过

**输入输出**：
- 输入：dev_plan、上一轮代理报告、任务类型
- 输出：next_agent + reason + task

**注意事项**：
- 规则冲突处理：按优先级顺序，高优先级规则优先
- 特殊情况处理：某些任务确实不需要测试时，需在 dev_plan 中明确标记
- 用户覆盖：用户可以通过 USER 决策覆盖 MAIN 的决策

### 3.3 dev_plan 结构扩展

**功能描述**：扩展 dev_plan.md 格式，支持测试与实现分离

**实现步骤**：
1. 设计新的任务结构：
   ```markdown
   ### M0-T1: 用户登录功能

   #### 测试阶段
   - status: DONE
   - test_file: tests/test_login.py
   - test_cases: 5 个（详见测试文件）
   - coverage: 95%
   - evidence: Iteration 2 - TEST 报告

   #### 实现阶段
   - status: DONE
   - impl_file: src/auth/login.py
   - changes: 实现 login() 函数
   - evidence: Iteration 4 - DEV 报告

   #### 审阅阶段
   - status: VERIFIED
   - review_result: PASS
   - evidence: Iteration 6 - REVIEW 报告
   ```
2. 修改 `orchestrator/validation.py` 中的 dev_plan 验证逻辑
3. 更新 MAIN 代理的 dev_plan 更新逻辑
4. 提供迁移脚本，将旧格式转换为新格式

**关键点**：
- 向后兼容：旧格式仍能正常解析
- 阶段独立：测试、实现、审阅各自独立，可并行进行
- 证据链完整：每个阶段都有明确的证据

**输入输出**：
- 输入：旧格式 dev_plan
- 输出：新格式 dev_plan

**注意事项**：
- 迁移策略：渐进式迁移，不强制一次性转换
- 兼容性测试：确保新旧格式都能正常工作
- 文档更新：更新 dev_plan 编写指南

### 3.4 测试覆盖率门禁

**功能描述**：在 verification_policy.json 中增加测试覆盖率要求

**实现步骤**：
1. 修改 `orchestrator/memory/verification_policy.json`：
   ```json
   {
     "test_requirements": {
       "min_coverage": 80,
       "required_test_types": ["unit", "integration"],
       "must_pass_before_review": true
     },
     "verification_rules": {
       "DONE_to_VERIFIED": {
         "required_evidence": [
           "test_report_with_pass_status",
           "coverage_report_above_threshold",
           "review_approval"
         ]
       }
     }
   }
   ```
2. 在 `orchestrator/validation.py` 中实现覆盖率检查
3. MAIN 决策时检查覆盖率，不达标则派发 TEST
4. REVIEW 审阅时验证覆盖率报告

**关键点**：
- 门禁强制性：覆盖率不达标不能 VERIFIED
- 灵活配置：不同项目可配置不同的覆盖率要求
- 报告可视化：覆盖率报告在 UI 中展示

**输入输出**：
- 输入：测试覆盖率报告
- 输出：是否通过门禁

**注意事项**：
- 覆盖率计算：使用 coverage.py 工具
- 排除文件：测试文件、配置文件不计入覆盖率
- 渐进式提升：初期可设置较低阈值（如 60%），逐步提升

### 3.5 文档上传管理功能

**功能描述**：提供 Web UI 文档上传、列表、删除和验收配置集成功能

**实现步骤**：
1. 创建 `orchestrator/memory/uploaded_docs/` 目录及子目录（requirements/specs/references）
2. 在 `ui/server.py` 中添加文档管理 API 处理函数
3. 实现文件上传：接收 Base64 编码内容，验证并保存到指定分类目录
4. 实现文档列表：遍历目录，返回文件元数据（名称、路径、大小、时间）
5. 实现文档删除：验证路径后删除文件
6. 实现验收配置集成：读取 JSON，追加路径，原子写入

**关键点**：
- 路径安全：使用 `os.path.normpath` 和 `os.path.abspath` 防止目录遍历
- 文件验证：检查扩展名（仅 .md）、大小（< 5MB）、文件名格式
- 原子写入：使用临时文件 + rename 确保配置文件完整性
- 错误处理：捕获 IO 异常，返回明确错误信息

**输入输出**：
- 上传输入：`{filename: str, content: str (Base64), category: str}`
- 上传输出：`{success: bool, path: str, error: str?}`
- 列表输出：`[{filename, path, category, size, upload_time}, ...]`

**注意事项**：
- 文件名冲突：自动追加时间戳后缀
- 并发上传：使用文件锁保护目录操作
- 磁盘空间：检查可用空间，拒绝超限上传

### 3.2 进度计算引擎

**功能描述**：实时解析 dev_plan.md，计算任务进度和里程碑完成度

**实现步骤**：
1. 创建 `orchestrator/progress.py` 模块
2. 实现 `_parse_dev_plan_progress()` 函数：
   - 读取 dev_plan.md 文件内容
   - 使用正则 `r'### (M\d+)-T\d+: (.+)'` 匹配任务标题
   - 使用正则 `r'- status: (\w+)'` 提取状态
   - 按里程碑分组统计各状态任务数
3. 计算总体进度百分比和验证百分比
4. 识别当前里程碑（最后一个未完成的里程碑）
5. 返回 ProgressInfo 结构

**关键点**：
- 容错解析：status 缺失时默认为 TODO
- 里程碑提取：从任务 ID 中提取 M0, M1, M2...
- 百分比计算：`(completed + verified) / total * 100`
- 当前里程碑：第一个 percentage < 100 的里程碑

**性能优化**：
- 文件缓存：记录文件 mtime，未变化时返回缓存结果
- 正则预编译：模块级别编译正则表达式
- 早期返回：文件不存在时返回空进度

**输入输出**：
- 输入：无（读取固定路径文件）
- 输出：`ProgressInfo` 对象

**注意事项**：
- 文件锁定：读取时使用共享锁，避免与写入冲突
- 编码处理：使用 UTF-8 编码读取，处理 BOM
- 异常处理：文件不存在、格式错误时返回默认值

### 3.3 进度可视化组件

**功能描述**：在 Progress 标签页展示总体进度、里程碑进度和任务统计

**实现步骤**：
1. 在 `App.vue` 中将 Logs 标签重命名为 Progress
2. 添加 `progress` 响应式状态变量
3. 实现 `fetchProgress()` 函数：调用 `/api/progress` 获取数据
4. 在 Progress 标签页中渲染：
   - 总体进度条（双层：验证进度 + 完成进度）
   - 任务状态统计卡片（5 种状态）
   - 里程碑列表（每个里程碑一个进度条）
   - 折叠的日志面板
5. 使用 CSS 动画实现进度条过渡效果

**关键点**：
- 双层进度条：使用 `position: absolute` 叠加，z-index 控制层级
- 颜色编码：verified(绿)、done(蓝)、doing(橙)、blocked(红)、todo(灰)
- 响应式布局：使用 flexbox，移动端自动换行
- 实时更新：每 5 秒轮询一次进度 API

**性能优化**：
- 虚拟滚动：里程碑数量 > 10 时使用虚拟列表
- 防抖更新：进度变化时使用 300ms 防抖避免频繁重渲染
- CSS 动画：使用 GPU 加速的 transform 属性

**输入输出**：
- 输入：ProgressInfo 对象
- 输出：可视化 UI 组件

**注意事项**：
- 百分比精度：显示时保留 1 位小数
- 零任务处理：total_tasks = 0 时显示"暂无任务"
- 加载状态：数据获取中显示骨架屏

### 3.4 文档引用选择器

**功能描述**：在用户输入框中提供文档引用下拉选择和自动插入功能

**实现步骤**：
1. 在 Message 标签页和 New Task 模态框中添加引用选择器
2. 实现 `fetchUploadedDocs()` 函数获取文档列表
3. 渲染多选下拉框，显示文档文件名
4. 实现 `insertDocReference()` 函数：
   - 获取选中的文档路径
   - 格式化为 `@doc:category/filename.md`
   - 插入到 textarea 光标位置
5. 实现路径复制功能（复制完整绝对路径）

**关键点**：
- 光标位置：使用 `selectionStart` 和 `selectionEnd` 获取插入位置
- 多文档引用：支持一次插入多个引用，用空格分隔
- 引用格式：前端使用简洁格式 `@doc:`，后端转换为完整路径
- 实时同步：文档上传后立即刷新选择器列表

**输入输出**：
- 输入：选中的文档路径数组
- 输出：插入引用后的文本内容

**注意事项**：
- 文本框焦点：插入后保持焦点，方便继续输入
- 引用去重：同一文档不重复插入
- 格式提示：显示引用格式说明

### 3.5 总结代理进度分析

**功能描述**：增强总结代理，使其能够分析进度并输出到迭代摘要

**实现步骤**：
1. 修改 `orchestrator/memory/prompts/subagent_prompt_summary.md`
2. 添加"进度分析职责"章节，说明需要：
   - 读取 dev_plan.md
   - 计算进度指标
   - 识别进度变化
   - 输出到 JSON 的 progress 字段
3. 提供输出格式示例（包含 ProgressInfo 结构）
4. 修改 `summary.py` 中的 `_parse_iteration_summary()`
5. 添加 `progress` 字段的解析和验证逻辑

**关键点**：
- 提示词清晰：明确说明 progress 字段为可选，但强烈建议提供
- 格式示例：提供完整的 JSON 示例，包含所有字段
- 容错解析：progress 缺失时不报错，设为 None
- 向后兼容：旧的迭代摘要（无 progress）仍能正常解析

**输入输出**：
- 输入：dev_plan.md 内容
- 输出：包含 progress 的 IterationSummary

**注意事项**：
- LLM 输出稳定性：使用结构化提示词提高输出一致性
- 字段验证：检查 progress 对象的必需字段
- 默认值处理：字段缺失时使用合理默认值

### 3.6 迭代摘要可读性优化

**功能描述**：重新设计 Summary 标签页，使用卡片式布局和时间线展示

**实现步骤**：
1. 重构 Summary 标签页的 HTML 结构
2. 使用迭代卡片（iteration-card）包裹每个迭代
3. 卡片内分区域展示：
   - 头部：迭代号、代理、进度徽章
   - 决策：MAIN 决策和理由
   - 任务：子代理任务摘要
   - 步骤：时间线样式的执行步骤
   - 结果：子代理报告摘要
   - 产物：关键输出文件
   - 进度：迷你进度条和统计
4. 实现时间线样式：步骤编号 + 连接线 + 内容
5. 添加响应式样式和悬停效果

**关键点**：
- 信息层次：使用字体大小、颜色、间距区分重要性
- 时间线连接线：使用 CSS `::before` 伪元素绘制
- 进度徽章：根据完成度显示不同颜色
- 折叠展开：长内容支持折叠，点击展开

**性能优化**：
- 虚拟滚动：迭代数量 > 20 时使用虚拟列表
- 懒加载：初始仅渲染最近 10 个迭代
- 图片懒加载：产物中的图片使用 lazy loading

**输入输出**：
- 输入：IterationSummary 数组
- 输出：优化的可视化展示

**注意事项**：
- 空状态处理：无迭代历史时显示提示信息
- 长文本截断：超过 200 字符的文本显示"展开"按钮
- 移动端适配：小屏幕下调整布局和字体大小


## 四、TDD 测试规范

### 4.1 测试分层策略

**E2E Tests（端到端测试）**：
- 完整用户流程测试
- 文档上传 → 引用 → 验收配置 → FINISH 执行
- 进度展示 → 迭代执行 → 进度更新

**Integration Tests（集成测试）**：
- API 端点测试
- 进度计算模块测试
- 文件操作与 JSON 配置集成测试

**Unit Tests（单元测试）**：
- 进度解析函数测试
- 路径验证函数测试
- 前端组件单元测试

### 4.2 核心测试用例

**测试1: 文档上传功能**
- Given: 用户选择一个 .md 文件（2MB）
- When: 点击上传按钮，选择 requirements 分类
- Then: 文件成功保存到 `orchestrator/memory/uploaded_docs/requirements/`，返回成功响应

**验收条件**：
- ✅ 文件内容完整无损
- ✅ 文件名符合规范（无特殊字符）
- ✅ 文档列表立即更新

**测试2: 文档引用插入**
- Given: 已上传文档 `user_story.md`，用户在 Message 输入框中
- When: 选择该文档并点击"插入引用"
- Then: 输入框中插入 `@doc:requirements/user_story.md`，光标位置正确

**验收条件**：
- ✅ 引用格式正确
- ✅ 光标位置在引用之后
- ✅ 支持多文档引用

**测试3: 验收配置集成**
- Given: 已上传文档 `api_spec.md`
- When: 点击"加入验收"按钮
- Then: `finish_review_config.json` 的 `docs` 数组包含该文档路径

**验收条件**：
- ✅ JSON 格式正确
- ✅ 路径为相对路径
- ✅ 不重复添加

**测试4: 进度计算准确性**
- Given: dev_plan.md 包含 20 个任务（5 VERIFIED, 3 DONE, 2 DOING, 1 BLOCKED, 9 TODO）
- When: 调用 `/api/progress`
- Then: 返回正确的进度统计

**验收条件**：
- ✅ total_tasks = 20
- ✅ verified_tasks = 5
- ✅ completed_tasks = 8
- ✅ completion_percentage = 40.0
- ✅ verification_percentage = 25.0

**测试5: 里程碑进度计算**
- Given: dev_plan.md 包含 M0（5任务全VERIFIED）、M1（10任务3DONE）
- When: 调用 `/api/progress`
- Then: 返回正确的里程碑进度

**验收条件**：
- ✅ M0 percentage = 100.0
- ✅ M1 percentage = 30.0
- ✅ current_milestone = "M1"

**测试6: 进度可视化渲染**
- Given: 获取到 ProgressInfo 数据
- When: 切换到 Progress 标签页
- Then: 正确渲染进度条和统计卡片

**验收条件**：
- ✅ 进度条宽度与百分比一致
- ✅ 5种状态卡片显示正确数字
- ✅ 里程碑列表按顺序显示

**测试7: 总结代理进度输出**
- Given: 执行一次完整迭代
- When: 总结代理生成迭代摘要
- Then: 输出 JSON 包含 progress 字段

**验收条件**：
- ✅ progress 字段结构正确
- ✅ 进度数据与 dev_plan.md 一致
- ✅ 历史文件正确保存

**测试8: 迭代摘要可读性**
- Given: 有 5 个历史迭代
- When: 切换到 Summary 标签页
- Then: 以卡片形式展示，时间线清晰

**验收条件**：
- ✅ 卡片按迭代倒序排列
- ✅ 步骤以时间线形式展示
- ✅ 进度徽章颜色正确

### 4.3 测试覆盖率要求

| 模块 | 单元测试 | 集成测试 | E2E测试 | 目标覆盖率 |
|------|---------|---------|---------|-----------|
| progress.py | ✅ | ✅ | - | 90% |
| ui/server.py (新增API) | ✅ | ✅ | ✅ | 85% |
| App.vue (新增组件) | ✅ | - | ✅ | 80% |
| summary.py (扩展) | ✅ | ✅ | - | 90% |

### 4.4 CI/CD 集成要点

**关键步骤**：
1. 代码提交触发 CI
2. 运行单元测试（pytest）
3. 运行前端测试（vitest）
4. 运行集成测试
5. 生成覆盖率报告
6. 覆盖率 < 80% 则失败

**测试触发条件**：
- 每次 push 到 main 分支
- 每次 pull request
- 每日定时测试（夜间）

---

## 五、实施计划

### 5.1 总体时间线

```
Week 1          Week 2          Week 3          Week 4
├─────────────┼─────────────┼─────────────┼─────────────┤
│ 文档管理     │ 进度计算     │ 前端可视化   │ 测试&优化   │
│ 后端API     │ 总结代理     │ Summary优化  │ 文档&部署   │
└─────────────┴─────────────┴─────────────┴─────────────┘
   M1: 基础      M2: 核心       M3: 完善      M4: 交付
```

### 5.2 Week 1: 文档管理基础

**目标**：完成文档上传、列表、删除和验收配置集成

**任务清单**：

| 任务 | 负责人 | 工作量 | 优先级 |
|------|--------|--------|--------|
| 创建 uploaded_docs 目录结构 | 后端 | 0.5h | P0 |
| 实现文档上传 API | 后端 | 4h | P0 |
| 实现文档列表 API | 后端 | 2h | P0 |
| 实现文档删除 API | 后端 | 2h | P0 |
| 实现验收配置集成 API | 后端 | 3h | P0 |
| Documents 标签页 UI | 前端 | 6h | P0 |
| 文档引用选择器 | 前端 | 4h | P0 |
| 单元测试 | 测试 | 4h | P1 |

**交付物**：
- `orchestrator/memory/uploaded_docs/` 目录
- `ui/server.py` 新增 4 个 API 端点
- `App.vue` Documents 标签页
- 单元测试文件

**验收标准**：
- ✅ 可通过 UI 上传 .md 文件
- ✅ 文档列表正确显示
- ✅ 可删除已上传文档
- ✅ 可一键加入验收配置
- ✅ 单元测试覆盖率 > 85%

### 5.3 Week 2: 进度计算与总结代理

**目标**：实现进度计算引擎和总结代理进度分析能力

**任务清单**：

| 任务 | 负责人 | 工作量 | 优先级 |
|------|--------|--------|--------|
| 创建 progress.py 模块 | 后端 | 6h | P0 |
| 实现 dev_plan.md 解析 | 后端 | 4h | P0 |
| 实现进度统计计算 | 后端 | 3h | P0 |
| 实现 /api/progress 端点 | 后端 | 2h | P0 |
| 扩展 IterationSummary 类型 | 后端 | 1h | P0 |
| 修改总结代理提示词 | 后端 | 3h | P0 |
| 修改 summary.py 解析逻辑 | 后端 | 3h | P0 |
| 进度计算单元测试 | 测试 | 4h | P1 |
| 集成测试 | 测试 | 3h | P1 |

**交付物**：
- `orchestrator/progress.py`
- `types.py` 新增类型定义
- `subagent_prompt_summary.md` 更新
- `summary.py` 扩展
- 测试文件

**验收标准**：
- ✅ 进度计算准确无误
- ✅ 支持多里程碑统计
- ✅ 总结代理输出包含 progress
- ✅ 向后兼容旧格式
- ✅ 测试覆盖率 > 90%

### 5.4 Week 3: 前端可视化与优化

**目标**：实现进度可视化和迭代摘要优化

**任务清单**：

| 任务 | 负责人 | 工作量 | 优先级 |
|------|--------|--------|--------|
| Progress 标签页重构 | 前端 | 6h | P0 |
| 总体进度条组件 | 前端 | 3h | P0 |
| 任务状态统计卡片 | 前端 | 3h | P0 |
| 里程碑进度列表 | 前端 | 4h | P0 |
| 日志折叠面板 | 前端 | 2h | P1 |
| Summary 标签页重构 | 前端 | 6h | P0 |
| 迭代卡片组件 | 前端 | 4h | P0 |
| 时间线样式实现 | 前端 | 3h | P0 |
| CSS 动画优化 | 前端 | 2h | P1 |
| 响应式布局调整 | 前端 | 3h | P1 |

**交付物**：
- `App.vue` Progress 标签页
- `App.vue` Summary 标签页优化
- `style.css` 新增样式

**验收标准**：
- ✅ 进度可视化清晰直观
- ✅ 动画流畅无卡顿
- ✅ 移动端显示正常
- ✅ 迭代摘要层次清晰
- ✅ 时间线样式美观

### 5.5 Week 4: 测试、优化与文档

**目标**：完成全面测试、性能优化和文档编写

**任务清单**：

| 任务 | 负责人 | 工作量 | 优先级 |
|------|--------|--------|--------|
| E2E 测试编写 | 测试 | 6h | P0 |
| 性能测试与优化 | 全栈 | 4h | P1 |
| Bug 修复 | 全栈 | 6h | P0 |
| 用户文档编写 | 文档 | 4h | P1 |
| API 文档更新 | 文档 | 2h | P1 |
| 部署脚本更新 | 运维 | 2h | P1 |
| 用户验收测试 | 测试 | 4h | P0 |

**交付物**：
- E2E 测试套件
- 性能优化报告
- 用户使用文档
- API 文档更新

**验收标准**：
- ✅ 所有测试通过
- ✅ 覆盖率 > 80%
- ✅ 无已知 P0/P1 Bug
- ✅ 文档完整准确
- ✅ 用户验收通过

---

## 六、风险管理

### 6.1 技术风险

| 风险 | 概率 | 影响 | 缓解措施 | 应急方案 |
|------|------|------|----------|----------|
| dev_plan.md 格式不一致 | 中 | 高 | 增强正则容错，支持多种格式 | 提供格式校验工具 |
| 文件上传并发冲突 | 低 | 中 | 使用文件锁保护 | 限制并发上传数 |
| 进度计算性能问题 | 低 | 中 | 实现文件缓存机制 | 限制 dev_plan 大小 |
| 前端渲染性能 | 中 | 中 | 虚拟滚动、懒加载 | 分页显示历史 |
| LLM 输出格式不稳定 | 中 | 中 | 容错解析、默认值 | 降级为无进度模式 |

### 6.2 项目风险

| 风险 | 概率 | 影响 | 缓解措施 | 应急方案 |
|------|------|------|----------|----------|
| 需求变更 | 中 | 中 | 模块化设计，易扩展 | 快速迭代调整 |
| 测试时间不足 | 低 | 高 | 提前编写测试用例 | 延长 Week 4 |
| 兼容性问题 | 低 | 中 | 保持向后兼容 | 提供迁移脚本 |
| 用户接受度低 | 低 | 高 | 早期用户反馈 | 提供旧版切换 |

### 6.3 回滚计划

**触发条件**：
- 关键功能失效（文档上传、进度计算）
- 性能严重下降（> 50%）
- 数据丢失或损坏

**回滚步骤**：
1. 停止 Orchestrator 服务
2. 恢复 `ui/server.py` 到上一版本
3. 恢复 `App.vue` 到上一版本
4. 删除 `progress.py` 模块（如果导致问题）
5. 重启服务并验证基本功能

**回滚验证**：
- ✅ 原有功能正常运行
- ✅ 无数据丢失
- ✅ 日志正常显示

---

## 七、成功标准

### 7.1 功能完整性

| 功能模块 | 实现百分比 | 验证方法 |
|---------|-----------|---------|
| 文档上传管理 | 100% | 手动测试 + 自动化测试 |
| 文档引用选择 | 100% | 手动测试 |
| 验收配置集成 | 100% | 集成测试 |
| 进度计算引擎 | 100% | 单元测试 + 集成测试 |
| 进度可视化 | 100% | 手动测试 + 截图对比 |
| 总结代理增强 | 100% | E2E 测试 |
| 迭代摘要优化 | 100% | 手动测试 + 用户反馈 |

**总体功能完整性目标**: 100%

### 7.2 性能指标

| 指标 | 目标 | 测试方法 |
|------|------|---------|
| 文档上传响应时间 | < 2s (5MB文件) | 性能测试 |
| 进度计算耗时 | < 500ms (100任务) | 单元测试计时 |
| 进度页面渲染时间 | < 1s | 前端性能分析 |
| Summary 页面加载 | < 2s (50迭代) | 前端性能分析 |
| API 响应时间 | < 200ms (平均) | 压力测试 |

### 7.3 质量指标

| 指标 | 目标 | 测试方法 |
|------|------|---------|
| 单元测试覆盖率 | > 85% | pytest-cov |
| 集成测试覆盖率 | > 75% | 集成测试报告 |
| E2E 测试覆盖率 | > 60% | E2E 测试报告 |
| P0 Bug 数量 | 0 | Bug 跟踪系统 |
| P1 Bug 数量 | < 3 | Bug 跟踪系统 |

### 7.4 用户体验指标

| 指标 | 目标 | 测试方法 |
|------|------|---------|
| 文档上传成功率 | > 99% | 日志统计 |
| 进度数据准确率 | 100% | 人工验证 |
| UI 响应流畅度 | 60 FPS | 性能监控 |
| 用户满意度 | > 4.0/5.0 | 用户调研 |
| 学习曲线 | < 10分钟上手 | 用户观察 |

---

## 八、关键实现细节

### 8.1 路径安全验证

**机制**：
- 使用 `os.path.normpath()` 规范化路径
- 使用 `os.path.abspath()` 转换为绝对路径
- 检查路径是否在允许的目录内

**配置参数**：
- `ALLOWED_UPLOAD_DIR`: `orchestrator/memory/uploaded_docs/`
- `MAX_FILE_SIZE`: 5MB
- `ALLOWED_EXTENSIONS`: ['.md']

### 8.2 进度计算优化

**缓存策略**：
- 记录 dev_plan.md 的 mtime
- mtime 未变化时返回缓存结果
- 缓存有效期：5秒

**正则优化**：
```python
# 模块级别预编译
TASK_PATTERN = re.compile(r'### (M\d+)-T\d+: (.+)')
STATUS_PATTERN = re.compile(r'- status: (\w+)')
```

**性能目标**：
- 100 任务解析 < 100ms
- 500 任务解析 < 500ms

### 8.3 前端状态管理

**状态结构**：
```typescript
interface AppState {
  progress: ProgressInfo | null
  uploadedDocs: UploadedDocument[]
  summaryHistory: IterationSummary[]
  // ... 其他状态
}
```

**更新策略**：
- progress: 每 5 秒轮询
- uploadedDocs: 上传/删除后立即刷新
- summaryHistory: 迭代完成后刷新

### 8.4 错误处理策略

**分类处理**：
- **用户错误**：友好提示，不记录日志（如文件格式错误）
- **系统错误**：记录详细日志，显示通用错误信息
- **网络错误**：自动重试 3 次，失败后提示

**错误信息格式**：
```json
{
  "success": false,
  "error": "文件大小超过限制（最大 5MB）",
  "error_code": "FILE_TOO_LARGE"
}
```

---

## 九、总结与建议

### 9.1 方案必要性

**评级**: ⭐⭐⭐⭐⭐ (5/5)

**理由**：
1. **显著提升用户体验**：文档管理和进度可视化是当前最大痛点
2. **提高开发效率**：减少手动操作，节省每次迭代 3-5 分钟
3. **增强系统透明度**：实时进度展示让用户清楚了解任务状态
4. **降低操作门槛**：UI 操作替代手动编辑文件，降低出错率
5. **完善系统功能**：补齐文档管理和进度跟踪的功能缺失

### 9.2 技术可行性

**评级**: ⭐⭐⭐⭐ (4/5)

**支撑点**：
1. **技术栈成熟**：Vue 3 + Python，团队熟悉，无学习成本
2. **架构兼容**：在现有架构上扩展，不破坏原有功能
3. **实现简单**：无复杂算法，主要是 CRUD 和数据展示
4. **风险可控**：模块化设计，易于测试和回滚
5. **性能可接受**：预估性能指标在合理范围内

**风险点**：
- LLM 输出格式稳定性（已有容错方案）

### 9.3 实施建议

1. **优先级排序**：先实现文档管理（Week 1），再实现进度可视化（Week 2-3）
2. **增量发布**：每周发布一个可用版本，快速获取用户反馈
3. **用户参与**：邀请核心用户参与 Week 1 和 Week 3 的验收测试
4. **文档先行**：提前编写用户文档，与开发同步进行
5. **性能监控**：部署后持续监控性能指标，及时优化

### 9.4 长期规划

方案完成后，系统将具备以下能力：

1. **完整的文档生命周期管理**：上传、引用、验收、归档
2. **实时的任务进度跟踪**：总体进度、里程碑进度、任务状态
3. **直观的信息可视化**：进度条、统计卡片、时间线展示
4. **增强的代理协作能力**：总结代理能够分析和报告进度
5. **优化的用户交互体验**：减少手动操作，提高操作效率
6. **可扩展的架构基础**：为未来功能扩展（如任务看板、甘特图）奠定基础
7. **完善的测试体系**：高覆盖率的自动化测试，保障系统稳定性
8. **清晰的系统透明度**：用户随时了解项目进展和任务状态

---

**文档版本**: v1.0  
**最后更新**: 2026-01-19  
**文档路径**: `/home/zxh/ainovel_v3/doc/优化方案.md`  
**预计实施周期**: 4 周  
**预计工作量**: 约 150 人时
